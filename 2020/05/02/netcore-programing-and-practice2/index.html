<!DOCTYPE HTML>
<html lang="zh-CN">


<head><meta name="generator" content="Hexo 3.9.0">
    <meta charset="utf-8">
    <meta name="keywords" content="NetCore 开发实战（2）——微服务实战, Bosch SEU chaoqiang Mechanics Eletronics 超强 micro-service Intelligent-Manufacturing MES">
    <meta name="description" content="26 | 工程结构概览：定义应用分层及依赖关系从这一节开始进入微服务实战部分
这一节主要探讨工程的结构和应用的分层
在应用的分层这里定义了四个层次：

领域模型层

基础设施层

应用层

共享层


可以通过代码来看一下
共享层一共建立三">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>NetCore 开发实战（2）——微服务实战 | chaoqiang&#39;s Blog</title>
    <link rel="icon" type="image/png" href="/favicon.png">

    <link rel="stylesheet" type="text/css" href="/libs/awesome/css/all.css">
    <link rel="stylesheet" type="text/css" href="/libs/materialize/materialize.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/aos/aos.css">
    <link rel="stylesheet" type="text/css" href="/libs/animate/animate.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/lightGallery/css/lightgallery.min.css">
    <link rel="stylesheet" type="text/css" href="/css/matery.css">
    <link rel="stylesheet" type="text/css" href="/css/my.css">
    
    <script src="/libs/jquery/jquery.min.js"></script>
    
<link rel="stylesheet" href="/css/prism-tomorrow.css" type="text/css">
<link rel="stylesheet" href="/css/prism-line-numbers.css" type="text/css"></head>


<body>
    <header class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="nav-wrapper head-container">
            <div class="brand-logo">
                <a href="/" class="waves-effect waves-light">
                    
                    <span class="logo-span">chaoqiang's Blog</span>
                </a>
            </div>
            

<a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fas fa-bars"></i></a>
<ul class="right nav-menu">
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/" class="waves-effect waves-light">
      
      <i class="fas fa-home" style="zoom: 0.6;"></i>
      
      <span>首页</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/tags" class="waves-effect waves-light">
      
      <i class="fas fa-tags" style="zoom: 0.6;"></i>
      
      <span>标签</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/categories" class="waves-effect waves-light">
      
      <i class="fas fa-bookmark" style="zoom: 0.6;"></i>
      
      <span>分类</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/archives" class="waves-effect waves-light">
      
      <i class="fas fa-archive" style="zoom: 0.6;"></i>
      
      <span>归档</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/about" class="waves-effect waves-light">
      
      <i class="fas fa-user-circle" style="zoom: 0.6;"></i>
      
      <span>关于</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/contact" class="waves-effect waves-light">
      
      <i class="fas fa-comments" style="zoom: 0.6;"></i>
      
      <span>留言板</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/friends" class="waves-effect waves-light">
      
      <i class="fas fa-address-book" style="zoom: 0.6;"></i>
      
      <span>友情链接</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/AV" class="waves-effect waves-light">

      
      <i class="fas fa-list" style="zoom: 0.6;"></i>
      
      <span>Medias</span>
      <i class="fas fa-chevron-down" aria-hidden="true" style="zoom: 0.6;"></i>
    </a>
    <ul class="sub-nav menus_item_child ">
      
      <li>
        <a href="/Music">
          
          <i class="fas fa-music" style="margin-top: -20px; zoom: 0.6;"></i>
          
          <span>Musics</span>
        </a>
      </li>
      
      <li>
        <a href="/Movie">
          
          <i class="fas fa-film" style="margin-top: -20px; zoom: 0.6;"></i>
          
          <span>Movies</span>
        </a>
      </li>
      
      <li>
        <a href="/Book">
          
          <i class="fas fa-book" style="margin-top: -20px; zoom: 0.6;"></i>
          
          <span>Books</span>
        </a>
      </li>
      
      <li>
        <a href="/AV">
          
          <i class="fas fa-image" style="margin-top: -20px; zoom: 0.6;"></i>
          
          <span>Galleries</span>
        </a>
      </li>
      
    </ul>
    
  </li>
  
  <li>
    <a href="#searchModal" class="modal-trigger waves-effect waves-light">
      <i id="searchIcon" class="fas fa-search" title="搜索" style="zoom: 0.85;"></i>
    </a>
  </li>
</ul>

<div id="mobile-nav" class="side-nav sidenav">

    <div class="mobile-head bg-color">
        
        <div class="logo-name">chaoqiang's Blog</div>
        <div class="logo-desc">
            
            博世互联工业 | 智能制造 | 微服务架构 | 东南大学 | 机械电子工程
            
        </div>
    </div>

    

    <ul class="menu-list mobile-menu-list">
        
        <li class="m-nav-item">
	  
		<a href="/" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-home"></i>
			
			首页
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/tags" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-tags"></i>
			
			标签
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/categories" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-bookmark"></i>
			
			分类
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/archives" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-archive"></i>
			
			归档
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/about" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-user-circle"></i>
			
			关于
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/contact" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-comments"></i>
			
			留言板
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/friends" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-address-book"></i>
			
			友情链接
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="javascript:;">
			
				<i class="fa-fw fas fa-list"></i>
			
			Medias
			<span class="m-icon"><i class="fas fa-chevron-right"></i></span>
		</a>
            <ul  style="background:  ;" >
              
                <li>   
				
                  <a href="/Music " style="margin-left:75px";>
				  
				   <i class="fa fas fa-music" style="position: absolute;left:50px" ></i>
			      
		          <span>Musics</span>
                  </a>
                </li>
              
                <li>   
				
                  <a href="/Movie " style="margin-left:75px";>
				  
				   <i class="fa fas fa-film" style="position: absolute;left:50px" ></i>
			      
		          <span>Movies</span>
                  </a>
                </li>
              
                <li>   
				
                  <a href="/Book " style="margin-left:75px";>
				  
				   <i class="fa fas fa-book" style="position: absolute;left:50px" ></i>
			      
		          <span>Books</span>
                  </a>
                </li>
              
                <li>   
				
                  <a href="/AV " style="margin-left:75px";>
				  
				   <i class="fa fas fa-image" style="position: absolute;left:50px" ></i>
			      
		          <span>Galleries</span>
                  </a>
                </li>
               
            </ul>
          
        </li>
        
        
        <li><div class="divider"></div></li>
        <li>
            <a href="https://github.com/Zhengchaoqiang" class="waves-effect waves-light" target="_blank">
                <i class="fab fa-github-square fa-fw"></i>Fork Me
            </a>
        </li>
        
    </ul>
</div>

        </div>

        
            <style>
    .nav-transparent .github-corner {
        display: none !important;
    }

    .github-corner {
        position: absolute;
        z-index: 10;
        top: 0;
        right: 0;
        border: 0;
        transform: scale(1.1);
    }

    .github-corner svg {
        color: #0f9d58;
        fill: #fff;
        height: 64px;
        width: 64px;
    }

    .github-corner:hover .octo-arm {
        animation: a 0.56s ease-in-out;
    }

    .github-corner .octo-arm {
        animation: none;
    }

    @keyframes a {
        0%,
        to {
            transform: rotate(0);
        }
        20%,
        60% {
            transform: rotate(-25deg);
        }
        40%,
        80% {
            transform: rotate(10deg);
        }
    }
</style>

<a href="https://github.com/Zhengchaoqiang" class="github-corner tooltipped hide-on-med-and-down" target="_blank"
   data-tooltip="Fork Me" data-position="left" data-delay="50">
    <svg viewBox="0 0 250 250" aria-hidden="true">
        <path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path>
        <path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2"
              fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path>
        <path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z"
              fill="currentColor" class="octo-body"></path>
    </svg>
</a>
        
    </nav>

</header>

    
<script src="/libs/cryptojs/crypto-js.min.js"></script>
<script>
    (function() {
        let pwd = '';
        if (pwd && pwd.length > 0) {
            if (pwd !== CryptoJS.SHA256(prompt('请输入访问本文章的密码')).toString(CryptoJS.enc.Hex)) {
                alert('密码错误，将返回主页！');
                location.href = '/';
            }
        }
    })();
</script>




<div class="bg-cover pd-header post-cover" style="background-image: url('/medias/featureimages/4.jpg')">
    <div class="container" style="right: 0px;left: 0px;">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <h1 class="description center-align post-title">NetCore 开发实战（2）——微服务实战</h1>
                </div>
            </div>
        </div>
    </div>
</div>




<main class="post-container content">

    
    <link rel="stylesheet" href="/libs/tocbot/tocbot.css">
<style>
    #articleContent h1::before,
    #articleContent h2::before,
    #articleContent h3::before,
    #articleContent h4::before,
    #articleContent h5::before,
    #articleContent h6::before {
        display: block;
        content: " ";
        height: 100px;
        margin-top: -100px;
        visibility: hidden;
    }

    #articleContent :focus {
        outline: none;
    }

    .toc-fixed {
        position: fixed;
        top: 64px;
    }

    .toc-widget {
        width: 345px;
        padding-left: 20px;
    }

    .toc-widget .toc-title {
        margin: 35px 0 15px 0;
        padding-left: 17px;
        font-size: 1.5rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    .toc-widget ol {
        padding: 0;
        list-style: none;
    }

    #toc-content {
        height: calc(100vh - 250px);
        overflow: auto;
    }

    #toc-content ol {
        padding-left: 10px;
    }

    #toc-content ol li {
        padding-left: 10px;
    }

    #toc-content .toc-link:hover {
        color: #42b983;
        font-weight: 700;
        text-decoration: underline;
    }

    #toc-content .toc-link::before {
        background-color: transparent;
        max-height: 25px;
    }

    #toc-content .is-active-link {
        color: #42b983;
    }

    #toc-content .is-active-link::before {
        background-color: #42b983;
    }

    #floating-toc-btn {
        position: fixed;
        right: 15px;
        bottom: 76px;
        padding-top: 15px;
        margin-bottom: 0;
        z-index: 998;
    }

    #floating-toc-btn .btn-floating {
        width: 48px;
        height: 48px;
    }

    #floating-toc-btn .btn-floating i {
        line-height: 48px;
        font-size: 1.4rem;
    }
</style>
<div class="row">
    <div id="main-content" class="col s12 m12 l9">
        <!-- 文章内容详情 -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            <div class="row tag-cate">
                <div class="col s7">
                    
                    <div class="article-tag">
                        
                            <a href="/tags/Net-Core/">
                                <span class="chip bg-color">Net Core</span>
                            </a>
                        
                    </div>
                    
                </div>
                <div class="col s5 right-align">
                    
                    <div class="post-cate">
                        <i class="fas fa-bookmark fa-fw icon-category"></i>
                        
                            <a href="/categories/NetCore-开发实战/" class="post-category">
                                NetCore 开发实战
                            </a>
                        
                    </div>
                    
                </div>
            </div>

            <div class="post-info">
                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-minus fa-fw"></i>发布日期:&nbsp;&nbsp;
                    2020-05-02
                </div>
                

                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-check fa-fw"></i>更新日期:&nbsp;&nbsp;
                    2020-06-14
                </div>
                

                
                <div class="info-break-policy">
                    <i class="far fa-file-word fa-fw"></i>文章字数:&nbsp;&nbsp;
                    13.7k
                </div>
                

                
                <div class="info-break-policy">
                    <i class="far fa-clock fa-fw"></i>阅读时长:&nbsp;&nbsp;
                    56 分
                </div>
                

                
                    <div id="busuanzi_container_page_pv" class="info-break-policy">
                        <i class="far fa-eye fa-fw"></i>阅读次数:&nbsp;&nbsp;
                        <span id="busuanzi_value_page_pv"></span>
                    </div>
				
            </div>

        </div>
        <hr class="clearfix">
        <div class="card-content article-card-content">
            <div id="articleContent">
                <h2 id="26-工程结构概览：定义应用分层及依赖关系"><a href="#26-工程结构概览：定义应用分层及依赖关系" class="headerlink" title="26 | 工程结构概览：定义应用分层及依赖关系"></a>26 | 工程结构概览：定义应用分层及依赖关系</h2><p>从这一节开始进入微服务实战部分</p>
<p>这一节主要探讨工程的结构和应用的分层</p>
<p>在应用的分层这里定义了四个层次：</p>
<ol>
<li><p>领域模型层</p>
</li>
<li><p>基础设施层</p>
</li>
<li><p>应用层</p>
</li>
<li><p>共享层</p>
</li>
</ol>
<p>可以通过代码来看一下</p>
<p><strong>共享层</strong>一共建立三个工程：</p>
<ol>
<li><p><strong>GeekTime.Core</strong>：主要承载基础的简单的类型，比如说异常或者一些帮助类</p>
</li>
<li><p><strong>GeekTime.Domain.Abstractions</strong>：抽象层，领域的抽象是指在领域模型可以定义一些基类或者接口，领域事件接口，领域事件处理接口，还有 Entity 的接口和 Entity 的基类</p>
</li>
<li><p><strong>GeekTime.Infrastructure.Core</strong>：基础设施的核心层，是指对仓储，还有 EFContext 定义一些共享代码</p>
</li>
</ol>
<p><img src="https://cdn.jsdelivr.net/gh/shw2018/cdn@1.0/sakura/img/loader/orange.progress-bar-stripe-loader.svg" data-original="https://img2020.cnblogs.com/blog/1412316/202003/1412316-20200319002637498-786809398.jpg" alt=""></p>
<p>这些包实际上在不同的项目里面都可以共享，所以建议的做法是把这些代码都通过私有的 NuGet 的仓库来存储，然后其他的工程可以使用 NuGet 包来直接引用即可</p>
<p><strong>领域模型层</strong>就是定义领域模型的地方，这里面会有不同的聚合，还有领域事件，不同的聚合下面就是领域模型</p>
<p><img src="https://cdn.jsdelivr.net/gh/shw2018/cdn@1.0/sakura/img/loader/orange.progress-bar-stripe-loader.svg" data-original="https://img2020.cnblogs.com/blog/1412316/202003/1412316-20200319002646413-1686646180.jpg" alt=""></p>
<p><strong>基础设施层</strong>是仓储层和一些共享代码的实现，这里只定义了仓储层的实现，包括 EF 的 DomainContext，还有 Order 的仓储层，User 的仓储层，还定义了领域模型与数据库之间的映射关系，就是在 EntityConfigurations 这目录下面去定义</p>
<p><img src="https://cdn.jsdelivr.net/gh/shw2018/cdn@1.0/sakura/img/loader/orange.progress-bar-stripe-loader.svg" data-original="https://img2020.cnblogs.com/blog/1412316/202003/1412316-20200319002655706-884151308.jpg" alt=""></p>
<p><strong>应用层</strong>分两个，一个工程是 API 层，是用来承载 Web API 或者 Web 应用的，另外一个是后台任务，这个就是用来执行一些特殊的 Job，作为 Job 的宿主运行的，它可以是一个控制台的应用程序</p>
<p>在 Web 层，Web API 层，也分了几个关键目录 Application，Controllers，Extensions，Infrastructure</p>
<p><strong>基础设施层</strong>会放一些身份认证缓存之类的与基础设施交互相关的一些代码</p>
<p><strong>扩展层</strong>主要是将服务注册进容器的代码和中间件配置的代码，也就是两扩展方法，一个是对 ServiceCollection 的扩展，一个是对 ApplicationBuilder 的扩展</p>
<p>控制器层主要用来定义 Web API，这一层就是定义前后端交互的接口</p>
<p>应用层使用了 *<em>CQRS *</em>的设计模式，就是命令与查询职责分离，把命令放在一个目录，把查询放在一个目录，同样的这里还有两个事件处理的目录，一个是领域模型，领域事件的处理，一个是集成事件的处理</p>
<p><img src="https://cdn.jsdelivr.net/gh/shw2018/cdn@1.0/sakura/img/loader/orange.progress-bar-stripe-loader.svg" data-original="https://img2020.cnblogs.com/blog/1412316/202003/1412316-20200319002705177-42272528.jpg" alt=""></p>
<p>再看一下各层之间的依赖关系</p>
<p>Shared 层实际上是不依赖任何层次的，它存储了共享的代码，被各个工程共享</p>
<p>GeekTime.Core，GeekTime.Domain.Abstractions 是不依赖任何工程的，而 GeekTime.Infrastructure.Core 依赖了 GeekTime.Domain.Abstractions，实现了仓储，比如说仓储会依赖 IAggregateRoot 接口</p>
<pre class="line-numbers language-csharp"><code class="language-csharp"><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">IRepository</span><span class="token operator">&lt;</span>TEntity<span class="token operator">></span> <span class="token keyword">where</span> TEntity <span class="token punctuation">:</span> Entity<span class="token punctuation">,</span> IAggregateRoot<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p><img src="https://cdn.jsdelivr.net/gh/shw2018/cdn@1.0/sakura/img/loader/orange.progress-bar-stripe-loader.svg" data-original="https://img2020.cnblogs.com/blog/1412316/202003/1412316-20200319002713043-254228443.jpg" alt=""></p>
<p>领域模型需要继承模型的基类，并且实现一个聚合根的接口，表示它是一个聚合根</p>
<pre class="line-numbers language-csharp"><code class="language-csharp"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Order</span> <span class="token punctuation">:</span> Entity<span class="token operator">&lt;</span><span class="token keyword">long</span><span class="token operator">></span><span class="token punctuation">,</span> IAggregateRoot<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>领域事件需要实现一个领域事件的接口</p>
<pre class="line-numbers language-csharp"><code class="language-csharp"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OrderCreatedDomainEvent</span> <span class="token punctuation">:</span> IDomainEvent<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p><img src="https://cdn.jsdelivr.net/gh/shw2018/cdn@1.0/sakura/img/loader/orange.progress-bar-stripe-loader.svg" data-original="https://img2020.cnblogs.com/blog/1412316/202003/1412316-20200319002723847-2117213011.jpg" alt=""></p>
<p>基础设施层是一个独立的程序集，实现了仓储的部分，定义了一个 Order 的仓储</p>
<pre class="line-numbers language-csharp"><code class="language-csharp"><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">IOrderRepository</span> <span class="token punctuation">:</span> IRepository<span class="token operator">&lt;</span>Order<span class="token punctuation">,</span> <span class="token keyword">long</span><span class="token operator">></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>还定义了 Order 仓储的实现</p>
<pre class="line-numbers language-csharp"><code class="language-csharp"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OrderRepository</span> <span class="token punctuation">:</span> Repository<span class="token operator">&lt;</span>Order<span class="token punctuation">,</span> <span class="token keyword">long</span><span class="token punctuation">,</span> DomainContext<span class="token operator">></span><span class="token punctuation">,</span> IOrderRepository
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token function">OrderRepository</span><span class="token punctuation">(</span>DomainContext context<span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token keyword">base</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这里可以看到仓储实际上依赖了基础设施层共享代码里面的仓储的定义 IRepository，这样就可以复用仓储层的代码，这样定义 OrderRepository 就会比较简单，可以复用 Repository 的一些实现</p>
<pre class="line-numbers language-csharp"><code class="language-csharp"><span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">Repository</span><span class="token operator">&lt;</span>TEntity<span class="token punctuation">,</span> TKey<span class="token punctuation">,</span> TDbContext<span class="token operator">></span> <span class="token punctuation">:</span> Repository<span class="token operator">&lt;</span>TEntity<span class="token punctuation">,</span> TDbContext<span class="token operator">></span><span class="token punctuation">,</span> IRepository<span class="token operator">&lt;</span>TEntity<span class="token punctuation">,</span> TKey<span class="token operator">></span> <span class="token keyword">where</span> TEntity <span class="token punctuation">:</span> Entity<span class="token operator">&lt;</span>TKey<span class="token operator">></span><span class="token punctuation">,</span> IAggregateRoot <span class="token keyword">where</span> TDbContext <span class="token punctuation">:</span> EFContext
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token function">Repository</span><span class="token punctuation">(</span>TDbContext context<span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token keyword">base</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">virtual</span> <span class="token keyword">bool</span> <span class="token function">Delete</span><span class="token punctuation">(</span>TKey id<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">var</span> entity <span class="token operator">=</span> DbContext<span class="token punctuation">.</span><span class="token generic-method function">Find<span class="token punctuation">&lt;</span>TEntity<span class="token punctuation">></span></span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>entity <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token keyword">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        DbContext<span class="token punctuation">.</span><span class="token function">Remove</span><span class="token punctuation">(</span>entity<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token keyword">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">virtual</span> <span class="token keyword">async</span> Task<span class="token operator">&lt;</span><span class="token keyword">bool</span><span class="token operator">></span> <span class="token function">DeleteAsync</span><span class="token punctuation">(</span>TKey id<span class="token punctuation">,</span> CancellationToken cancellationToken <span class="token operator">=</span> <span class="token keyword">default</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">var</span> entity <span class="token operator">=</span> <span class="token keyword">await</span> DbContext<span class="token punctuation">.</span><span class="token generic-method function">FindAsync<span class="token punctuation">&lt;</span>TEntity<span class="token punctuation">></span></span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> cancellationToken<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>entity <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token keyword">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        DbContext<span class="token punctuation">.</span><span class="token function">Remove</span><span class="token punctuation">(</span>entity<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token keyword">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">virtual</span> TEntity <span class="token function">Get</span><span class="token punctuation">(</span>TKey id<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">return</span> DbContext<span class="token punctuation">.</span><span class="token generic-method function">Find<span class="token punctuation">&lt;</span>TEntity<span class="token punctuation">></span></span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">virtual</span> <span class="token keyword">async</span> Task<span class="token operator">&lt;</span>TEntity<span class="token operator">></span> <span class="token function">GetAsync</span><span class="token punctuation">(</span>TKey id<span class="token punctuation">,</span> CancellationToken cancellationToken <span class="token operator">=</span> <span class="token keyword">default</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">await</span> DbContext<span class="token punctuation">.</span><span class="token generic-method function">FindAsync<span class="token punctuation">&lt;</span>TEntity<span class="token punctuation">></span></span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> cancellationToken<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>已经实现了一些基本的方法，增删改查的方法</p>
<p>数据库访问的实现，继承了自己定义的 EFContext，EFContext 作为共享代码在各个工程里面复用</p>
<pre class="line-numbers language-csharp"><code class="language-csharp"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DomainContext</span> <span class="token punctuation">:</span> EFContext<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>另外一个比较特殊的是事务处理的对象，这个对象是用来管理整个应用程序的请求上下文中的事务，这样就可以避免手动地去处理事务，简化代码</p>
<pre class="line-numbers language-csharp"><code class="language-csharp"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DomainContextTransactionBehavior</span><span class="token operator">&lt;</span>TRequest<span class="token punctuation">,</span> TResponse<span class="token operator">></span> <span class="token punctuation">:</span> TransactionBehavior<span class="token operator">&lt;</span>DomainContext<span class="token punctuation">,</span> TRequest<span class="token punctuation">,</span> TResponse<span class="token operator">></span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token function">DomainContextTransactionBehavior</span><span class="token punctuation">(</span>DomainContext dbContext<span class="token punctuation">,</span> ICapPublisher capBus<span class="token punctuation">,</span> ILogger<span class="token operator">&lt;</span>DomainContextTransactionBehavior<span class="token operator">&lt;</span>TRequest<span class="token punctuation">,</span> TResponse<span class="token operator">></span><span class="token operator">></span> logger<span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token keyword">base</span><span class="token punctuation">(</span>dbContext<span class="token punctuation">,</span> capBus<span class="token punctuation">,</span> logger<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><img src="https://cdn.jsdelivr.net/gh/shw2018/cdn@1.0/sakura/img/loader/orange.progress-bar-stripe-loader.svg" data-original="https://img2020.cnblogs.com/blog/1412316/202003/1412316-20200319002735650-467693226.jpg" alt=""></p>
<p>应用层依赖了基础设施层，基础设施层又依赖了领域层</p>
<p>应用层实际上是把各层组装在一起的这一层，它是应用程序的一个宿主，协调各层之间的关系，以及组装代码都是在这里实现的</p>
<p><img src="https://cdn.jsdelivr.net/gh/shw2018/cdn@1.0/sakura/img/loader/orange.progress-bar-stripe-loader.svg" data-original="https://img2020.cnblogs.com/blog/1412316/202003/1412316-20200319002743167-1634287954.jpg" alt=""></p>
<p><strong>总结一下</strong>:</p>
<p>领域模型层专注于业务的设计，它不依赖于其他各层，它是相对独立的</p>
<p>基础设施的仓储层仅仅负责领域模型的存取，它不负责任何的业务逻辑代码的承载</p>
<p>推荐使用 CQRS 的模式来设计应用程序，使应用程序的代码结构更加的合理，在团队和项目膨胀的情况下，工程的可维护性不至于急剧的下降</p>
<p>Web API 是面向前端交互的接口，避免依赖领域模型</p>
<p>共享代码建议设计为共享包，使用私有的 NuGet 仓库来分发和管理</p>
<h2 id="27-定义Entity：区分领域模型的内在逻辑和外在行为"><a href="#27-定义Entity：区分领域模型的内在逻辑和外在行为" class="headerlink" title="27 | 定义Entity：区分领域模型的内在逻辑和外在行为"></a>27 | 定义Entity：区分领域模型的内在逻辑和外在行为</h2><p>上一节讲到领域模型分为两层</p>
<p>一层是抽象层，定义了公共的接口和类</p>
<p>另一层就是领域模型的定义层</p>
<p>先看一下抽象层的定义</p>
<ol>
<li>实体接口 IEntity</li>
</ol>
<pre class="line-numbers language-csharp"><code class="language-csharp"><span class="token keyword">namespace</span> GeekTime<span class="token punctuation">.</span>Domain
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">IEntity</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">GetKeys</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">IEntity</span><span class="token operator">&lt;</span>TKey<span class="token operator">></span> <span class="token punctuation">:</span> IEntity
    <span class="token punctuation">{</span>
        TKey Id <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>通常情况下实体只有一个 ID，但是也不排除存在多个 ID 的情况，所以这里的接口 IEntity 定义实现为多个 ID 的情况，而 IEntity 表示实体只有一个 Id</p>
<p>同样看一下 Entity 的定义</p>
<pre class="line-numbers language-csharp"><code class="language-csharp"><span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">Entity</span> <span class="token punctuation">:</span> IEntity

<span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">Entity</span><span class="token operator">&lt;</span>TKey<span class="token operator">></span> <span class="token punctuation">:</span> Entity<span class="token punctuation">,</span> IEntity<span class="token operator">&lt;</span>TKey<span class="token operator">></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>同样地定义了一个 Entity 和 Entity，这样就可以在实体上面定义一些共享的方法，比如 ToString</p>
<pre class="line-numbers language-csharp"><code class="language-csharp"><span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">Entity</span> <span class="token punctuation">:</span> IEntity
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">GetKeys</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">override</span> <span class="token keyword">string</span> <span class="token function">ToString</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// 输出当前实体的名称以及它的 Id 的清单</span>
        <span class="token keyword">return</span> $<span class="token string">"[Entity: {GetType().Name}] Keys = {string.Join("</span><span class="token punctuation">,</span><span class="token string">", GetKeys())}"</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>对于 Entity 定义了比较多的方法</p>
<pre class="line-numbers language-csharp"><code class="language-csharp"><span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">Entity</span><span class="token operator">&lt;</span>TKey<span class="token operator">></span> <span class="token punctuation">:</span> Entity<span class="token punctuation">,</span> IEntity<span class="token operator">&lt;</span>TKey<span class="token operator">></span>
<span class="token punctuation">{</span>
    <span class="token keyword">int</span><span class="token operator">?</span> _requestedHashCode<span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">virtual</span> TKey Id <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">protected</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">override</span> <span class="token keyword">object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">GetKeys</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">{</span> Id <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">/// &lt;summary></span>
    <span class="token comment" spellcheck="true">/// 表示对象是否相等</span>
    <span class="token comment" spellcheck="true">/// 这个方法的重载使我们可以正确的判断两个实体是否是同一个实体</span>
    <span class="token comment" spellcheck="true">/// 根据 Id 判断，如果没有 Id 的话，两个实体是不会相等的</span>
    <span class="token comment" spellcheck="true">/// &lt;/summary></span>
    <span class="token comment" spellcheck="true">/// &lt;param name="obj">&lt;/param></span>
    <span class="token comment" spellcheck="true">/// &lt;returns>&lt;/returns></span>
    <span class="token keyword">public</span> <span class="token keyword">override</span> <span class="token keyword">bool</span> <span class="token function">Equals</span><span class="token punctuation">(</span><span class="token keyword">object</span> obj<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>obj <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> <span class="token operator">!</span><span class="token punctuation">(</span>obj <span class="token keyword">is</span> Entity<span class="token operator">&lt;</span>TKey<span class="token operator">></span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span> <span class="token keyword">false</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>Object<span class="token punctuation">.</span><span class="token function">ReferenceEquals</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> obj<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span> <span class="token keyword">true</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">GetType</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> obj<span class="token punctuation">.</span><span class="token function">GetType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span> <span class="token keyword">false</span><span class="token punctuation">;</span>

        Entity<span class="token operator">&lt;</span>TKey<span class="token operator">></span> item <span class="token operator">=</span> <span class="token punctuation">(</span>Entity<span class="token operator">&lt;</span>TKey<span class="token operator">></span><span class="token punctuation">)</span>obj<span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>item<span class="token punctuation">.</span><span class="token function">IsTransient</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">IsTransient</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span> <span class="token keyword">false</span><span class="token punctuation">;</span>
        <span class="token keyword">else</span>
            <span class="token keyword">return</span> item<span class="token punctuation">.</span>Id<span class="token punctuation">.</span><span class="token function">Equals</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>Id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">/// &lt;summary></span>
    <span class="token comment" spellcheck="true">/// 这个方法用来辅助对比两个对象是否相等</span>
    <span class="token comment" spellcheck="true">/// &lt;/summary></span>
    <span class="token comment" spellcheck="true">/// &lt;returns>&lt;/returns></span>
    <span class="token keyword">public</span> <span class="token keyword">override</span> <span class="token keyword">int</span> <span class="token function">GetHashCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">IsTransient</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>_requestedHashCode<span class="token punctuation">.</span>HasValue<span class="token punctuation">)</span>
                _requestedHashCode <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>Id<span class="token punctuation">.</span><span class="token function">GetHashCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">^</span> <span class="token number">31</span><span class="token punctuation">;</span>

            <span class="token keyword">return</span> _requestedHashCode<span class="token punctuation">.</span>Value<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span>
            <span class="token keyword">return</span> <span class="token keyword">base</span><span class="token punctuation">.</span><span class="token function">GetHashCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">/// &lt;summary></span>
    <span class="token comment" spellcheck="true">/// 表示对象是否为全新创建的，未持久化的</span>
    <span class="token comment" spellcheck="true">/// &lt;/summary></span>
    <span class="token comment" spellcheck="true">/// &lt;returns>&lt;/returns></span>
    <span class="token keyword">public</span> <span class="token keyword">bool</span> <span class="token function">IsTransient</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// 如果它没有 Id 就表示它没有持久化</span>
        <span class="token keyword">return</span> EqualityComparer<span class="token operator">&lt;</span>TKey<span class="token operator">></span><span class="token punctuation">.</span>Default<span class="token punctuation">.</span><span class="token function">Equals</span><span class="token punctuation">(</span>Id<span class="token punctuation">,</span> <span class="token keyword">default</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">override</span> <span class="token keyword">string</span> <span class="token function">ToString</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">return</span> $<span class="token string">"[Entity: {GetType().Name}] Id = {Id}"</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">/// &lt;summary></span>
    <span class="token comment" spellcheck="true">/// 操作符 == 重载</span>
    <span class="token comment" spellcheck="true">/// 借助上面的 Equals 方法</span>
    <span class="token comment" spellcheck="true">/// 使得可以直接用 == 判断两个领域对象是否相等</span>
    <span class="token comment" spellcheck="true">/// &lt;/summary></span>
    <span class="token comment" spellcheck="true">/// &lt;param name="left">&lt;/param></span>
    <span class="token comment" spellcheck="true">/// &lt;param name="right">&lt;/param></span>
    <span class="token comment" spellcheck="true">/// &lt;returns>&lt;/returns></span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">bool</span> <span class="token keyword">operator</span> <span class="token operator">==</span><span class="token punctuation">(</span>Entity<span class="token operator">&lt;</span>TKey<span class="token operator">></span> left<span class="token punctuation">,</span> Entity<span class="token operator">&lt;</span>TKey<span class="token operator">></span> right<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>Object<span class="token punctuation">.</span><span class="token function">Equals</span><span class="token punctuation">(</span>left<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span> <span class="token punctuation">(</span>Object<span class="token punctuation">.</span><span class="token function">Equals</span><span class="token punctuation">(</span>right<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token keyword">true</span> <span class="token punctuation">:</span> <span class="token keyword">false</span><span class="token punctuation">;</span>
        <span class="token keyword">else</span>
            <span class="token keyword">return</span> left<span class="token punctuation">.</span><span class="token function">Equals</span><span class="token punctuation">(</span>right<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">/// &lt;summary></span>
    <span class="token comment" spellcheck="true">/// 操作符 != 重载</span>
    <span class="token comment" spellcheck="true">/// &lt;/summary></span>
    <span class="token comment" spellcheck="true">/// &lt;param name="left">&lt;/param></span>
    <span class="token comment" spellcheck="true">/// &lt;param name="right">&lt;/param></span>
    <span class="token comment" spellcheck="true">/// &lt;returns>&lt;/returns></span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">bool</span> <span class="token keyword">operator</span> <span class="token operator">!=</span><span class="token punctuation">(</span>Entity<span class="token operator">&lt;</span>TKey<span class="token operator">></span> left<span class="token punctuation">,</span> Entity<span class="token operator">&lt;</span>TKey<span class="token operator">></span> right<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token operator">!</span><span class="token punctuation">(</span>left <span class="token operator">==</span> right<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ol start="2">
<li>聚合根接口 IAggregateRoot</li>
</ol>
<pre class="line-numbers language-csharp"><code class="language-csharp"><span class="token keyword">namespace</span> GeekTime<span class="token punctuation">.</span>Domain
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">IAggregateRoot</span>
    <span class="token punctuation">{</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>聚合根接口实际上是一个空接口，它不实现任何的方法，它的作用是在实现仓储层的时候，让一个仓储对应一个聚合根</p>
<ol start="3">
<li>领域事件接口 IDomainEvent</li>
</ol>
<pre class="line-numbers language-csharp"><code class="language-csharp"><span class="token keyword">namespace</span> GeekTime<span class="token punctuation">.</span>Domain
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">IDomainEvent</span> <span class="token punctuation">:</span> INotification
    <span class="token punctuation">{</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ol start="4">
<li>域事件处理接口 IDomainEventHandler</li>
</ol>
<pre class="line-numbers language-csharp"><code class="language-csharp"><span class="token keyword">namespace</span> GeekTime<span class="token punctuation">.</span>Domain
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">IDomainEventHandler</span><span class="token operator">&lt;</span>TDomainEvent<span class="token operator">></span> <span class="token punctuation">:</span> INotificationHandler<span class="token operator">&lt;</span>TDomainEvent<span class="token operator">></span> 
        <span class="token keyword">where</span> TDomainEvent <span class="token punctuation">:</span> IDomainEvent
    <span class="token punctuation">{</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ol start="5">
<li>还有一个领域模型里面比较关键的值对象 ValueObject</li>
</ol>
<p>值对象的定义比较特殊，因为它是没有 Id 的，所以没有关于 Id 的定义，并且没有对值对象定义接口</p>
<p>重点实现了它是否相等的判断，也是重载了 Equals 这个方法和 GetHashCode 这个方法</p>
<pre class="line-numbers language-csharp"><code class="language-csharp"><span class="token keyword">protected</span> <span class="token keyword">static</span> <span class="token keyword">bool</span> <span class="token function">EqualOperator</span><span class="token punctuation">(</span>ValueObject left<span class="token punctuation">,</span> ValueObject right<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">ReferenceEquals</span><span class="token punctuation">(</span>left<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token operator">^</span> <span class="token function">ReferenceEquals</span><span class="token punctuation">(</span>right<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token function">ReferenceEquals</span><span class="token punctuation">(</span>left<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token operator">||</span> left<span class="token punctuation">.</span><span class="token function">Equals</span><span class="token punctuation">(</span>right<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">protected</span> <span class="token keyword">static</span> <span class="token keyword">bool</span> <span class="token function">NotEqualOperator</span><span class="token punctuation">(</span>ValueObject left<span class="token punctuation">,</span> ValueObject right<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token operator">!</span><span class="token punctuation">(</span><span class="token function">EqualOperator</span><span class="token punctuation">(</span>left<span class="token punctuation">,</span> right<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">override</span> <span class="token keyword">int</span> <span class="token function">GetHashCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">GetAtomicValues</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
     <span class="token punctuation">.</span><span class="token function">Select</span><span class="token punctuation">(</span>x <span class="token operator">=</span><span class="token operator">></span> x <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">?</span> x<span class="token punctuation">.</span><span class="token function">GetHashCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">)</span>
     <span class="token punctuation">.</span><span class="token function">Aggregate</span><span class="token punctuation">(</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> x <span class="token operator">^</span> y<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>它有一个特殊的抽象方法的定义，获取它的原子值</p>
<pre class="line-numbers language-csharp"><code class="language-csharp"><span class="token keyword">protected</span> <span class="token keyword">abstract</span> IEnumerable<span class="token operator">&lt;</span><span class="token keyword">object</span><span class="token operator">></span> <span class="token function">GetAtomicValues</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>这个方法的作用是将值对象的字段输出出来，作为唯一标识来判断两个对象是否相等，可以看到 Equals 的定义里面也是调用了获取原子值这个方法来判断它是否相等</p>
<pre class="line-numbers language-csharp"><code class="language-csharp"><span class="token keyword">public</span> <span class="token keyword">override</span> <span class="token keyword">bool</span> <span class="token function">Equals</span><span class="token punctuation">(</span><span class="token keyword">object</span> obj<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>obj <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> obj<span class="token punctuation">.</span><span class="token function">GetType</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token function">GetType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    ValueObject other <span class="token operator">=</span> <span class="token punctuation">(</span>ValueObject<span class="token punctuation">)</span>obj<span class="token punctuation">;</span>
    IEnumerator<span class="token operator">&lt;</span><span class="token keyword">object</span><span class="token operator">></span> thisValues <span class="token operator">=</span> <span class="token function">GetAtomicValues</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">GetEnumerator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    IEnumerator<span class="token operator">&lt;</span><span class="token keyword">object</span><span class="token operator">></span> otherValues <span class="token operator">=</span> other<span class="token punctuation">.</span><span class="token function">GetAtomicValues</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">GetEnumerator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span>thisValues<span class="token punctuation">.</span><span class="token function">MoveNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> otherValues<span class="token punctuation">.</span><span class="token function">MoveNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">ReferenceEquals</span><span class="token punctuation">(</span>thisValues<span class="token punctuation">.</span>Current<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token operator">^</span> <span class="token function">ReferenceEquals</span><span class="token punctuation">(</span>otherValues<span class="token punctuation">.</span>Current<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token keyword">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>thisValues<span class="token punctuation">.</span>Current <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>thisValues<span class="token punctuation">.</span>Current<span class="token punctuation">.</span><span class="token function">Equals</span><span class="token punctuation">(</span>otherValues<span class="token punctuation">.</span>Current<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token keyword">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token operator">!</span>thisValues<span class="token punctuation">.</span><span class="token function">MoveNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>otherValues<span class="token punctuation">.</span><span class="token function">MoveNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>接下来看一下定义的 Order 实体</p>
<pre><code>public class Order : Entity&lt;long&gt;, IAggregateRoot
{
    public string UserId { get; private set; }

    public string UserName { get; private set; }

    public Address Address { get; private set; }

    public int ItemCount { get; private set; }

    protected Order()
    { }

    public Order(string userId, string userName, int itemCount, Address address)
    {
        this.UserId = userId;
        this.UserName = userName;
        this.Address = address;
        this.ItemCount = itemCount;

        this.AddDomainEvent(new OrderCreatedDomainEvent(this));
    }

    public void ChangeAddress(Address address)
    {
        this.Address = address;
    }
}</code></pre><p>它首先实现了 Entity，这一个在上一节已经讲过，另外一个 Order 定义为一个聚合根，它需要实现聚合根接口 IAggregateRoot</p>
<p>实体中字段的 set 设置为 private，这样的好处是 Order 所有的数据的操作都应该由实体负责，而不应该被外部对象去操作，从而让领域模型符合封闭开放的原则</p>
<p>对于领域模型的操作，都应该是定义具有业务逻辑含义的方法来定义</p>
<p>比如说 ChangeAddress，就定义一个 ChangeAddress 的方法，把新的地址传进来，由领域模型负责赋值</p>
<p>这里面就可以添加一些地址的校验，比如新的地址是否能够与旧的地址距离太远</p>
<p>看一下地址的定义</p>
<pre class="line-numbers language-csharp"><code class="language-csharp"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Address</span> <span class="token punctuation">:</span> ValueObject
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">string</span> Street <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">private</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">string</span> City <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">private</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">string</span> ZipCode <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">private</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token function">Address</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token function">Address</span><span class="token punctuation">(</span><span class="token keyword">string</span> street<span class="token punctuation">,</span> <span class="token keyword">string</span> city<span class="token punctuation">,</span> <span class="token keyword">string</span> zipcode<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        Street <span class="token operator">=</span> street<span class="token punctuation">;</span>
        City <span class="token operator">=</span> city<span class="token punctuation">;</span>
        ZipCode <span class="token operator">=</span> zipcode<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">protected</span> <span class="token keyword">override</span> IEnumerable<span class="token operator">&lt;</span><span class="token keyword">object</span><span class="token operator">></span> <span class="token function">GetAtomicValues</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">yield</span> <span class="token keyword">return</span> Street<span class="token punctuation">;</span>
        <span class="token keyword">yield</span> <span class="token keyword">return</span> City<span class="token punctuation">;</span>
        <span class="token keyword">yield</span> <span class="token keyword">return</span> ZipCode<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>只能通过构造函数给值对象赋值，这里面需要注意的是重载了获取原子值的方法，使用了 yield return</p>
<p><strong>总结一下</strong></p>
<p>在定义领域模型的时候，首先领域模型的字段的修改应该设置为私有的</p>
<p>使用构造函数来表示对象的创建，它的初始值都是由构造函数的参数来赋值的</p>
<p>另外需要定义有业务含义的动作来操作模型的字段</p>
<p>领域模型只负责自己数据的处理，领域服务或者命令负责调用领域模型的业务动作</p>
<p>样就可以区分领域模型的内在逻辑和外在逻辑，使代码结构更加合理</p>
<h2 id="28-工作单元模式（UnitOfWork）：管理好你的事务"><a href="#28-工作单元模式（UnitOfWork）：管理好你的事务" class="headerlink" title="28 | 工作单元模式（UnitOfWork）：管理好你的事务"></a>28 | 工作单元模式（UnitOfWork）：管理好你的事务</h2><p>工作单元模式有如下几个特性：</p>
<ol>
<li><p>使用同一上下文</p>
</li>
<li><p>跟踪实体的状态</p>
</li>
<li><p>保障事务一致性</p>
</li>
</ol>
<p>我们对实体的操作，最终的状态都是应该如实保存到我们的存储中，进行持久化</p>
<p>接下来看一下代码</p>
<p>为了实现工作单元模式，这里定义了一个工作单元的接口</p>
<pre class="line-numbers language-csharp"><code class="language-csharp"><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">IUnitOfWork</span> <span class="token punctuation">:</span> IDisposable
<span class="token punctuation">{</span>
    Task<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">></span> <span class="token function">SaveChangesAsync</span><span class="token punctuation">(</span>CancellationToken cancellationToken <span class="token operator">=</span> <span class="token keyword">default</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    Task<span class="token operator">&lt;</span><span class="token keyword">bool</span><span class="token operator">></span> <span class="token function">SaveEntitiesAsync</span><span class="token punctuation">(</span>CancellationToken cancellationToken <span class="token operator">=</span> <span class="token keyword">default</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这两个方法的区别是：一个是返回的 int 是指我们影响的数据条数，另外一个返回 bool 表示我们保存是否成功，本质上这两个方法达到的效果是相同的</p>
<p>另外还定义了一个事务管理的接口</p>
<pre class="line-numbers language-csharp"><code class="language-csharp"><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">ITransaction</span>
<span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// 获取当前事务</span>
    IDbContextTransaction <span class="token function">GetCurrentTransaction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// 判断当前事务是否开启</span>
    <span class="token keyword">bool</span> HasActiveTransaction <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">// 开启事务</span>
    Task<span class="token operator">&lt;</span>IDbContextTransaction<span class="token operator">></span> <span class="token function">BeginTransactionAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// 提交事务</span>
    Task <span class="token function">CommitTransactionAsync</span><span class="token punctuation">(</span>IDbContextTransaction transaction<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// 事务回滚</span>
    <span class="token keyword">void</span> <span class="token function">RollbackTransaction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>在实现上我们是借助 EF 来实现工作单元模式的</p>
<p>看一下 EFContext 的定义</p>
<pre class="line-numbers language-csharp"><code class="language-csharp"><span class="token comment" spellcheck="true">/// &lt;summary></span>
<span class="token comment" spellcheck="true">/// DbContext 是 EF 的基类，然后实现了 UnitOfWork 的接口和事务的接口</span>
<span class="token comment" spellcheck="true">/// &lt;/summary></span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">EFContext</span> <span class="token punctuation">:</span> DbContext<span class="token punctuation">,</span> IUnitOfWork<span class="token punctuation">,</span> ITransaction
<span class="token punctuation">{</span>
    <span class="token keyword">protected</span> IMediator _mediator<span class="token punctuation">;</span>
    ICapPublisher _capBus<span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// 后面的章节会详细讲到这两个参数</span>
    <span class="token keyword">public</span> <span class="token function">EFContext</span><span class="token punctuation">(</span>DbContextOptions options<span class="token punctuation">,</span> IMediator mediator<span class="token punctuation">,</span> ICapPublisher capBus<span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token keyword">base</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        _mediator <span class="token operator">=</span> mediator<span class="token punctuation">;</span>
        _capBus <span class="token operator">=</span> capBus<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token preprocessor property">#<span class="token directive keyword">region</span> IUnitOfWork</span>

    <span class="token keyword">public</span> <span class="token keyword">async</span> Task<span class="token operator">&lt;</span><span class="token keyword">bool</span><span class="token operator">></span> <span class="token function">SaveEntitiesAsync</span><span class="token punctuation">(</span>CancellationToken cancellationToken <span class="token operator">=</span> <span class="token keyword">default</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">var</span> result <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">base</span><span class="token punctuation">.</span><span class="token function">SaveChangesAsync</span><span class="token punctuation">(</span>cancellationToken<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">//await _mediator.DispatchDomainEventsAsync(this);</span>
        <span class="token keyword">return</span> <span class="token keyword">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">//// 可以看到这个方法实际上与上面的方法是相同的，所以这个方法可以不实现</span>
    <span class="token comment" spellcheck="true">//public override Task&lt;int> SaveChangesAsync(bool acceptAllChangesOnSuccess, CancellationToken cancellationToken = default)</span>
    <span class="token comment" spellcheck="true">//{</span>
    <span class="token comment" spellcheck="true">//    return base.SaveChangesAsync(acceptAllChangesOnSuccess, cancellationToken);</span>
    <span class="token comment" spellcheck="true">//}</span>

    <span class="token preprocessor property">#<span class="token directive keyword">endregion</span></span>

    <span class="token preprocessor property">#<span class="token directive keyword">region</span> ITransaction</span>

    <span class="token keyword">private</span> IDbContextTransaction _currentTransaction<span class="token punctuation">;</span><span class="token comment" spellcheck="true">// 把当前的事务用一个字段存储</span>

    <span class="token keyword">public</span> IDbContextTransaction <span class="token function">GetCurrentTransaction</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> _currentTransaction<span class="token punctuation">;</span><span class="token comment" spellcheck="true">// 获取当前的事务就是返回存储的私有对象</span>

    <span class="token keyword">public</span> <span class="token keyword">bool</span> HasActiveTransaction <span class="token operator">=</span><span class="token operator">></span> _currentTransaction <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// 事务是否开启是判断当前这个事务是否为空</span>

    <span class="token comment" spellcheck="true">/// &lt;summary></span>
    <span class="token comment" spellcheck="true">/// 开启事务</span>
    <span class="token comment" spellcheck="true">/// &lt;/summary></span>
    <span class="token comment" spellcheck="true">/// &lt;returns>&lt;/returns></span>
    <span class="token keyword">public</span> Task<span class="token operator">&lt;</span>IDbContextTransaction<span class="token operator">></span> <span class="token function">BeginTransactionAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>_currentTransaction <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        _currentTransaction <span class="token operator">=</span> Database<span class="token punctuation">.</span><span class="token function">BeginTransaction</span><span class="token punctuation">(</span>_capBus<span class="token punctuation">,</span> autoCommit<span class="token punctuation">:</span> <span class="token keyword">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> Task<span class="token punctuation">.</span><span class="token function">FromResult</span><span class="token punctuation">(</span>_currentTransaction<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">/// &lt;summary></span>
    <span class="token comment" spellcheck="true">/// 提交事务</span>
    <span class="token comment" spellcheck="true">/// &lt;/summary></span>
    <span class="token comment" spellcheck="true">/// &lt;param name="transaction">当前事务&lt;/param></span>
    <span class="token comment" spellcheck="true">/// &lt;returns>&lt;/returns></span>
    <span class="token keyword">public</span> <span class="token keyword">async</span> Task <span class="token function">CommitTransactionAsync</span><span class="token punctuation">(</span>IDbContextTransaction transaction<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>transaction <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ArgumentNullException</span><span class="token punctuation">(</span><span class="token function">nameof</span><span class="token punctuation">(</span>transaction<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>transaction <span class="token operator">!=</span> _currentTransaction<span class="token punctuation">)</span> <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">InvalidOperationException</span><span class="token punctuation">(</span>$<span class="token string">"Transaction {transaction.TransactionId} is not current"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">try</span>
        <span class="token punctuation">{</span>
            <span class="token keyword">await</span> <span class="token function">SaveChangesAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// 将当前所有的变更都保存到数据库</span>
            transaction<span class="token punctuation">.</span><span class="token function">Commit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">catch</span>
        <span class="token punctuation">{</span>
            <span class="token function">RollbackTransaction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">throw</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">finally</span>
        <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>_currentTransaction <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// 最终需要把当前事务进行释放，并且置为空</span>
                <span class="token comment" spellcheck="true">// 这样就可以多次的开启事务和提交事务</span>
                _currentTransaction<span class="token punctuation">.</span><span class="token function">Dispose</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                _currentTransaction <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">/// &lt;summary></span>
    <span class="token comment" spellcheck="true">/// 回滚</span>
    <span class="token comment" spellcheck="true">/// &lt;/summary></span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">RollbackTransaction</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">try</span>
        <span class="token punctuation">{</span>
            _currentTransaction<span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">Rollback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">finally</span>
        <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>_currentTransaction <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                _currentTransaction<span class="token punctuation">.</span><span class="token function">Dispose</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                _currentTransaction <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token preprocessor property">#<span class="token directive keyword">endregion</span></span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>另外一个我们还是需要关注的一点就是如何管理我们的事务</p>
<p>这里有一个类 TransactionBehavior，这个类是用来注入我们的事务的管理过程的，具体它是怎么工作的在后续的章节会讲到，这里先关注它的实现过程</p>
<pre class="line-numbers language-csharp"><code class="language-csharp"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TransactionBehavior</span><span class="token operator">&lt;</span>TDbContext<span class="token punctuation">,</span> TRequest<span class="token punctuation">,</span> TResponse<span class="token operator">></span> <span class="token punctuation">:</span> IPipelineBehavior<span class="token operator">&lt;</span>TRequest<span class="token punctuation">,</span> TResponse<span class="token operator">></span> <span class="token keyword">where</span> TDbContext <span class="token punctuation">:</span> EFContext
<span class="token punctuation">{</span>
    ILogger _logger<span class="token punctuation">;</span>
    TDbContext _dbContext<span class="token punctuation">;</span>
    ICapPublisher _capBus<span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token function">TransactionBehavior</span><span class="token punctuation">(</span>TDbContext dbContext<span class="token punctuation">,</span> ICapPublisher capBus<span class="token punctuation">,</span> ILogger logger<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        _dbContext <span class="token operator">=</span> dbContext <span class="token operator">?</span><span class="token operator">?</span> <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ArgumentNullException</span><span class="token punctuation">(</span><span class="token function">nameof</span><span class="token punctuation">(</span>dbContext<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        _capBus <span class="token operator">=</span> capBus <span class="token operator">?</span><span class="token operator">?</span> <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ArgumentNullException</span><span class="token punctuation">(</span><span class="token function">nameof</span><span class="token punctuation">(</span>capBus<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        _logger <span class="token operator">=</span> logger <span class="token operator">?</span><span class="token operator">?</span> <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ArgumentNullException</span><span class="token punctuation">(</span><span class="token function">nameof</span><span class="token punctuation">(</span>logger<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">async</span> Task<span class="token operator">&lt;</span>TResponse<span class="token operator">></span> <span class="token function">Handle</span><span class="token punctuation">(</span>TRequest request<span class="token punctuation">,</span> CancellationToken cancellationToken<span class="token punctuation">,</span> RequestHandlerDelegate<span class="token operator">&lt;</span>TResponse<span class="token operator">></span> next<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">var</span> response <span class="token operator">=</span> <span class="token keyword">default</span><span class="token punctuation">(</span>TResponse<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">var</span> typeName <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">GetGenericTypeName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">try</span>
        <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// 首先判断当前是否有开启事务</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>_dbContext<span class="token punctuation">.</span>HasActiveTransaction<span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                <span class="token keyword">return</span> <span class="token keyword">await</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token comment" spellcheck="true">// 定义了一个数据库操作执行的策略，比如说可以在里面嵌入一些重试的逻辑，这里创建了一个默认的策略</span>
            <span class="token keyword">var</span> strategy <span class="token operator">=</span> _dbContext<span class="token punctuation">.</span>Database<span class="token punctuation">.</span><span class="token function">CreateExecutionStrategy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">await</span> strategy<span class="token punctuation">.</span><span class="token function">ExecuteAsync</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span>
            <span class="token punctuation">{</span>
                Guid transactionId<span class="token punctuation">;</span>
                <span class="token keyword">using</span> <span class="token punctuation">(</span><span class="token keyword">var</span> transaction <span class="token operator">=</span> <span class="token keyword">await</span> _dbContext<span class="token punctuation">.</span><span class="token function">BeginTransactionAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token keyword">using</span> <span class="token punctuation">(</span>_logger<span class="token punctuation">.</span><span class="token function">BeginScope</span><span class="token punctuation">(</span><span class="token string">"TransactionContext:{TransactionId}"</span><span class="token punctuation">,</span> transaction<span class="token punctuation">.</span>TransactionId<span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">{</span>
                    _logger<span class="token punctuation">.</span><span class="token function">LogInformation</span><span class="token punctuation">(</span><span class="token string">"----- 开始事务 {TransactionId} ({@Command})"</span><span class="token punctuation">,</span> transaction<span class="token punctuation">.</span>TransactionId<span class="token punctuation">,</span> typeName<span class="token punctuation">,</span> request<span class="token punctuation">)</span><span class="token punctuation">;</span>

                    response <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// next 实际上是指我们的后续操作，这里的模式有点像之前讲的中间件模式</span>

                    _logger<span class="token punctuation">.</span><span class="token function">LogInformation</span><span class="token punctuation">(</span><span class="token string">"----- 提交事务 {TransactionId} {CommandName}"</span><span class="token punctuation">,</span> transaction<span class="token punctuation">.</span>TransactionId<span class="token punctuation">,</span> typeName<span class="token punctuation">)</span><span class="token punctuation">;</span>

                    <span class="token keyword">await</span> _dbContext<span class="token punctuation">.</span><span class="token function">CommitTransactionAsync</span><span class="token punctuation">(</span>transaction<span class="token punctuation">)</span><span class="token punctuation">;</span>

                    transactionId <span class="token operator">=</span> transaction<span class="token punctuation">.</span>TransactionId<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">return</span> response<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> ex<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            _logger<span class="token punctuation">.</span><span class="token function">LogError</span><span class="token punctuation">(</span>ex<span class="token punctuation">,</span> <span class="token string">"处理事务出错 {CommandName} ({@Command})"</span><span class="token punctuation">,</span> typeName<span class="token punctuation">,</span> request<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">throw</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>回过头来看一下我们的 EFContext，EFContext 实现 IUnitOfWork，工作单元模式的核心，它实现了事务的管理和工作单元模式，我们就可以借助 EFContext 来实现我们的仓储层</p>
<h2 id="29-定义仓储：使用EF-Core实现仓储层"><a href="#29-定义仓储：使用EF-Core实现仓储层" class="headerlink" title="29 | 定义仓储：使用EF Core实现仓储层"></a>29 | 定义仓储：使用EF Core实现仓储层</h2><p>首先定义仓储层的接口，以及仓储层实现的基类，抽象类</p>
<p>仓储层的接口</p>
<pre class="line-numbers language-csharp"><code class="language-csharp"><span class="token keyword">namespace</span> GeekTime<span class="token punctuation">.</span>Infrastructure<span class="token punctuation">.</span>Core
<span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">/// &lt;summary></span>
    <span class="token comment" spellcheck="true">/// 包含普通实体的仓储</span>
    <span class="token comment" spellcheck="true">/// 约束 TEntity 必须是继承 Entity 的基类，必须实现聚合根 IAggregateRoot</span>
    <span class="token comment" spellcheck="true">/// 也就是说仓储里面存储的对象必须是一个聚合根对象</span>
    <span class="token comment" spellcheck="true">/// &lt;/summary></span>
    <span class="token comment" spellcheck="true">/// &lt;typeparam name="TEntity">&lt;/typeparam></span>
    <span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">IRepository</span><span class="token operator">&lt;</span>TEntity<span class="token operator">></span> <span class="token keyword">where</span> TEntity <span class="token punctuation">:</span> Entity<span class="token punctuation">,</span> IAggregateRoot
    <span class="token punctuation">{</span>
        IUnitOfWork UnitOfWork <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
        TEntity <span class="token function">Add</span><span class="token punctuation">(</span>TEntity entity<span class="token punctuation">)</span><span class="token punctuation">;</span>
        Task<span class="token operator">&lt;</span>TEntity<span class="token operator">></span> <span class="token function">AddAsync</span><span class="token punctuation">(</span>TEntity entity<span class="token punctuation">,</span> CancellationToken cancellationToken <span class="token operator">=</span> <span class="token keyword">default</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        TEntity <span class="token function">Update</span><span class="token punctuation">(</span>TEntity entity<span class="token punctuation">)</span><span class="token punctuation">;</span>
        Task<span class="token operator">&lt;</span>TEntity<span class="token operator">></span> <span class="token function">UpdateAsync</span><span class="token punctuation">(</span>TEntity entity<span class="token punctuation">,</span> CancellationToken cancellationToken <span class="token operator">=</span> <span class="token keyword">default</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">bool</span> <span class="token function">Remove</span><span class="token punctuation">(</span>Entity entity<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// 由于没有指定主键，只能根据当前实体进行删除操作</span>
        Task<span class="token operator">&lt;</span><span class="token keyword">bool</span><span class="token operator">></span> <span class="token function">RemoveAsync</span><span class="token punctuation">(</span>Entity entity<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">/// &lt;summary></span>
    <span class="token comment" spellcheck="true">/// 包含指定主键的类型的实体的仓储</span>
    <span class="token comment" spellcheck="true">/// 继承了上面的接口 IRepository&lt;TEntity>，也就是说拥有了上面定义的所有方法</span>
    <span class="token comment" spellcheck="true">/// 另外一个，它实现了几个跟 Id 相关的操作的方法</span>
    <span class="token comment" spellcheck="true">/// &lt;/summary></span>
    <span class="token comment" spellcheck="true">/// &lt;typeparam name="TEntity">&lt;/typeparam></span>
    <span class="token comment" spellcheck="true">/// &lt;typeparam name="TKey">&lt;/typeparam></span>
    <span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">IRepository</span><span class="token operator">&lt;</span>TEntity<span class="token punctuation">,</span> TKey<span class="token operator">></span> <span class="token punctuation">:</span> IRepository<span class="token operator">&lt;</span>TEntity<span class="token operator">></span> <span class="token keyword">where</span> TEntity <span class="token punctuation">:</span> Entity<span class="token operator">&lt;</span>TKey<span class="token operator">></span><span class="token punctuation">,</span> IAggregateRoot
    <span class="token punctuation">{</span>
        <span class="token keyword">bool</span> <span class="token function">Delete</span><span class="token punctuation">(</span>TKey id<span class="token punctuation">)</span><span class="token punctuation">;</span>
        Task<span class="token operator">&lt;</span><span class="token keyword">bool</span><span class="token operator">></span> <span class="token function">DeleteAsync</span><span class="token punctuation">(</span>TKey id<span class="token punctuation">,</span> CancellationToken cancellationToken <span class="token operator">=</span> <span class="token keyword">default</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        TEntity <span class="token function">Get</span><span class="token punctuation">(</span>TKey id<span class="token punctuation">)</span><span class="token punctuation">;</span>
        Task<span class="token operator">&lt;</span>TEntity<span class="token operator">></span> <span class="token function">GetAsync</span><span class="token punctuation">(</span>TKey id<span class="token punctuation">,</span> CancellationToken cancellationToken <span class="token operator">=</span> <span class="token keyword">default</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>具体抽象类的实现</p>
<pre class="line-numbers language-csharp"><code class="language-csharp"><span class="token keyword">namespace</span> GeekTime<span class="token punctuation">.</span>Infrastructure<span class="token punctuation">.</span>Core
<span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">/// &lt;summary></span>
    <span class="token comment" spellcheck="true">/// 定义普通实体的仓储</span>
    <span class="token comment" spellcheck="true">/// 定义约束 TDbContext 必须是 EFContext，也就是仓储必须依赖于 EFContext 及其子类</span>
    <span class="token comment" spellcheck="true">/// 将来就可以把自己定义的比如 DomainContext 作为泛型参数传入 Repository，就可以很快捷地定义出来自己的仓储</span>
    <span class="token comment" spellcheck="true">/// &lt;/summary></span>
    <span class="token comment" spellcheck="true">/// &lt;typeparam name="TEntity">&lt;/typeparam></span>
    <span class="token comment" spellcheck="true">/// &lt;typeparam name="TDbContext">&lt;/typeparam></span>
    <span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">Repository</span><span class="token operator">&lt;</span>TEntity<span class="token punctuation">,</span> TDbContext<span class="token operator">></span> <span class="token punctuation">:</span> IRepository<span class="token operator">&lt;</span>TEntity<span class="token operator">></span> <span class="token keyword">where</span> TEntity <span class="token punctuation">:</span> Entity<span class="token punctuation">,</span> IAggregateRoot <span class="token keyword">where</span> TDbContext <span class="token punctuation">:</span> EFContext
    <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// 具体实现需要依赖 DbContext</span>
        <span class="token keyword">protected</span> <span class="token keyword">virtual</span> TDbContext DbContext <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>

        <span class="token keyword">public</span> <span class="token function">Repository</span><span class="token punctuation">(</span>TDbContext context<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>DbContext <span class="token operator">=</span> context<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">public</span> <span class="token keyword">virtual</span> IUnitOfWork UnitOfWork <span class="token operator">=</span><span class="token operator">></span> DbContext<span class="token punctuation">;</span><span class="token comment" spellcheck="true">// 因为 DbContext， EFContext 实际上实现了 IUnitOfWork，所以直接返回</span>

        <span class="token comment" spellcheck="true">// 下面这些方法都是 EntityFramework 提供的能力，所以就能通过简单的几行代码来实现基本的仓储操作</span>

        <span class="token keyword">public</span> <span class="token keyword">virtual</span> TEntity <span class="token function">Add</span><span class="token punctuation">(</span>TEntity entity<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token keyword">return</span> DbContext<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span>entity<span class="token punctuation">)</span><span class="token punctuation">.</span>Entity<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">public</span> <span class="token keyword">virtual</span> Task<span class="token operator">&lt;</span>TEntity<span class="token operator">></span> <span class="token function">AddAsync</span><span class="token punctuation">(</span>TEntity entity<span class="token punctuation">,</span> CancellationToken cancellationToken <span class="token operator">=</span> <span class="token keyword">default</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token keyword">return</span> Task<span class="token punctuation">.</span><span class="token function">FromResult</span><span class="token punctuation">(</span><span class="token function">Add</span><span class="token punctuation">(</span>entity<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">public</span> <span class="token keyword">virtual</span> TEntity <span class="token function">Update</span><span class="token punctuation">(</span>TEntity entity<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token keyword">return</span> DbContext<span class="token punctuation">.</span><span class="token function">Update</span><span class="token punctuation">(</span>entity<span class="token punctuation">)</span><span class="token punctuation">.</span>Entity<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">public</span> <span class="token keyword">virtual</span> Task<span class="token operator">&lt;</span>TEntity<span class="token operator">></span> <span class="token function">UpdateAsync</span><span class="token punctuation">(</span>TEntity entity<span class="token punctuation">,</span> CancellationToken cancellationToken <span class="token operator">=</span> <span class="token keyword">default</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token keyword">return</span> Task<span class="token punctuation">.</span><span class="token function">FromResult</span><span class="token punctuation">(</span><span class="token function">Update</span><span class="token punctuation">(</span>entity<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">public</span> <span class="token keyword">virtual</span> <span class="token keyword">bool</span> <span class="token function">Remove</span><span class="token punctuation">(</span>Entity entity<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            DbContext<span class="token punctuation">.</span><span class="token function">Remove</span><span class="token punctuation">(</span>entity<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token keyword">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">public</span> <span class="token keyword">virtual</span> Task<span class="token operator">&lt;</span><span class="token keyword">bool</span><span class="token operator">></span> <span class="token function">RemoveAsync</span><span class="token punctuation">(</span>Entity entity<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token keyword">return</span> Task<span class="token punctuation">.</span><span class="token function">FromResult</span><span class="token punctuation">(</span><span class="token function">Remove</span><span class="token punctuation">(</span>entity<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">/// &lt;summary></span>
    <span class="token comment" spellcheck="true">/// 定义主键的实体的仓储</span>
    <span class="token comment" spellcheck="true">/// &lt;/summary></span>
    <span class="token comment" spellcheck="true">/// &lt;typeparam name="TEntity">&lt;/typeparam></span>
    <span class="token comment" spellcheck="true">/// &lt;typeparam name="TKey">&lt;/typeparam></span>
    <span class="token comment" spellcheck="true">/// &lt;typeparam name="TDbContext">&lt;/typeparam></span>
    <span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">Repository</span><span class="token operator">&lt;</span>TEntity<span class="token punctuation">,</span> TKey<span class="token punctuation">,</span> TDbContext<span class="token operator">></span> <span class="token punctuation">:</span> Repository<span class="token operator">&lt;</span>TEntity<span class="token punctuation">,</span> TDbContext<span class="token operator">></span><span class="token punctuation">,</span> IRepository<span class="token operator">&lt;</span>TEntity<span class="token punctuation">,</span> TKey<span class="token operator">></span> <span class="token keyword">where</span> TEntity <span class="token punctuation">:</span> Entity<span class="token operator">&lt;</span>TKey<span class="token operator">></span><span class="token punctuation">,</span> IAggregateRoot <span class="token keyword">where</span> TDbContext <span class="token punctuation">:</span> EFContext
    <span class="token punctuation">{</span>
        <span class="token keyword">public</span> <span class="token function">Repository</span><span class="token punctuation">(</span>TDbContext context<span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token keyword">base</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
        <span class="token punctuation">}</span>

        <span class="token comment" spellcheck="true">/// &lt;summary></span>
        <span class="token comment" spellcheck="true">/// 根据 Id 从 DbContext 获取 Entity，然后再 Remove</span>
        <span class="token comment" spellcheck="true">/// 这样的好处是可以跟踪对象的状态</span>
        <span class="token comment" spellcheck="true">/// 坏处是任意的删除都需要先去数据库里面做查询</span>
        <span class="token comment" spellcheck="true">/// &lt;/summary></span>
        <span class="token comment" spellcheck="true">/// &lt;param name="id">&lt;/param></span>
        <span class="token comment" spellcheck="true">/// &lt;returns>&lt;/returns></span>
        <span class="token keyword">public</span> <span class="token keyword">virtual</span> <span class="token keyword">bool</span> <span class="token function">Delete</span><span class="token punctuation">(</span>TKey id<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token keyword">var</span> entity <span class="token operator">=</span> DbContext<span class="token punctuation">.</span><span class="token generic-method function">Find<span class="token punctuation">&lt;</span>TEntity<span class="token punctuation">></span></span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>entity <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                <span class="token keyword">return</span> <span class="token keyword">false</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            DbContext<span class="token punctuation">.</span><span class="token function">Remove</span><span class="token punctuation">(</span>entity<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token keyword">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">public</span> <span class="token keyword">virtual</span> <span class="token keyword">async</span> Task<span class="token operator">&lt;</span><span class="token keyword">bool</span><span class="token operator">></span> <span class="token function">DeleteAsync</span><span class="token punctuation">(</span>TKey id<span class="token punctuation">,</span> CancellationToken cancellationToken <span class="token operator">=</span> <span class="token keyword">default</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token keyword">var</span> entity <span class="token operator">=</span> <span class="token keyword">await</span> DbContext<span class="token punctuation">.</span><span class="token generic-method function">FindAsync<span class="token punctuation">&lt;</span>TEntity<span class="token punctuation">></span></span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> cancellationToken<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>entity <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                <span class="token keyword">return</span> <span class="token keyword">false</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            DbContext<span class="token punctuation">.</span><span class="token function">Remove</span><span class="token punctuation">(</span>entity<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token keyword">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">public</span> <span class="token keyword">virtual</span> TEntity <span class="token function">Get</span><span class="token punctuation">(</span>TKey id<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token keyword">return</span> DbContext<span class="token punctuation">.</span><span class="token generic-method function">Find<span class="token punctuation">&lt;</span>TEntity<span class="token punctuation">></span></span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">public</span> <span class="token keyword">virtual</span> <span class="token keyword">async</span> Task<span class="token operator">&lt;</span>TEntity<span class="token operator">></span> <span class="token function">GetAsync</span><span class="token punctuation">(</span>TKey id<span class="token punctuation">,</span> CancellationToken cancellationToken <span class="token operator">=</span> <span class="token keyword">default</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token keyword">await</span> DbContext<span class="token punctuation">.</span><span class="token generic-method function">FindAsync<span class="token punctuation">&lt;</span>TEntity<span class="token punctuation">></span></span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> cancellationToken<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>实现自己的 DbContext</p>
<p>DomainContext</p>
<pre class="line-numbers language-csharp"><code class="language-csharp"><span class="token keyword">namespace</span> GeekTime<span class="token punctuation">.</span>Infrastructure
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DomainContext</span> <span class="token punctuation">:</span> EFContext
    <span class="token punctuation">{</span>
        <span class="token keyword">public</span> <span class="token function">DomainContext</span><span class="token punctuation">(</span>DbContextOptions options<span class="token punctuation">,</span> IMediator mediator<span class="token punctuation">,</span> ICapPublisher capBus<span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token keyword">base</span><span class="token punctuation">(</span>options<span class="token punctuation">,</span> mediator<span class="token punctuation">,</span> capBus<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">public</span> DbSet<span class="token operator">&lt;</span>Order<span class="token operator">></span> Orders <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>

        <span class="token keyword">public</span> DbSet<span class="token operator">&lt;</span>User<span class="token operator">></span> Users <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>

        <span class="token keyword">protected</span> <span class="token keyword">override</span> <span class="token keyword">void</span> <span class="token function">OnModelCreating</span><span class="token punctuation">(</span>ModelBuilder modelBuilder<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token preprocessor property">#<span class="token directive keyword">region</span> 注册领域模型与数据库的映射关系</span>
            modelBuilder<span class="token punctuation">.</span><span class="token function">ApplyConfiguration</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">OrderEntityTypeConfiguration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            modelBuilder<span class="token punctuation">.</span><span class="token function">ApplyConfiguration</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">UserEntityTypeConfiguration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token preprocessor property">#<span class="token directive keyword">endregion</span></span>
            <span class="token keyword">base</span><span class="token punctuation">.</span><span class="token function">OnModelCreating</span><span class="token punctuation">(</span>modelBuilder<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>映射关系，针对每一个领域模型创建一个 EntityTypeConfiguration</p>
<p>OrderEntityTypeConfiguration</p>
<pre class="line-numbers language-csharp"><code class="language-csharp"><span class="token keyword">namespace</span> GeekTime<span class="token punctuation">.</span>Infrastructure<span class="token punctuation">.</span>EntityConfigurations
<span class="token punctuation">{</span>
    <span class="token keyword">class</span> <span class="token class-name">OrderEntityTypeConfiguration</span> <span class="token punctuation">:</span> IEntityTypeConfiguration<span class="token operator">&lt;</span>Order<span class="token operator">></span>
    <span class="token punctuation">{</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">Configure</span><span class="token punctuation">(</span>EntityTypeBuilder<span class="token operator">&lt;</span>Order<span class="token operator">></span> builder<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// 定义主键</span>
            builder<span class="token punctuation">.</span><span class="token function">HasKey</span><span class="token punctuation">(</span>p <span class="token operator">=</span><span class="token operator">></span> p<span class="token punctuation">.</span>Id<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">//builder.ToTable("order");</span>
            <span class="token comment" spellcheck="true">//builder.Property(p => p.UserId).HasMaxLength(20);</span>
            <span class="token comment" spellcheck="true">//builder.Property(p => p.UserName).HasMaxLength(30);</span>

            <span class="token comment" spellcheck="true">// 定义导航属性</span>
            builder<span class="token punctuation">.</span><span class="token function">OwnsOne</span><span class="token punctuation">(</span>o <span class="token operator">=</span><span class="token operator">></span> o<span class="token punctuation">.</span>Address<span class="token punctuation">,</span> a <span class="token operator">=</span><span class="token operator">></span>
                <span class="token punctuation">{</span>
                    a<span class="token punctuation">.</span><span class="token function">WithOwner</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment" spellcheck="true">//a.Property(p => p.City).HasMaxLength(20);</span>
                    <span class="token comment" spellcheck="true">//a.Property(p => p.Street).HasMaxLength(50);</span>
                    <span class="token comment" spellcheck="true">//a.Property(p => p.ZipCode).HasMaxLength(10);</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>UserEntityTypeConfiguration</p>
<pre class="line-numbers language-csharp"><code class="language-csharp"><span class="token keyword">namespace</span> GeekTime<span class="token punctuation">.</span>Infrastructure<span class="token punctuation">.</span>EntityConfigurations
<span class="token punctuation">{</span>
    <span class="token keyword">class</span> <span class="token class-name">UserEntityTypeConfiguration</span> <span class="token punctuation">:</span> IEntityTypeConfiguration<span class="token operator">&lt;</span>User<span class="token operator">></span>
    <span class="token punctuation">{</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">Configure</span><span class="token punctuation">(</span>EntityTypeBuilder<span class="token operator">&lt;</span>User<span class="token operator">></span> builder<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            builder<span class="token punctuation">.</span><span class="token function">HasKey</span><span class="token punctuation">(</span>p <span class="token operator">=</span><span class="token operator">></span> p<span class="token punctuation">.</span>Id<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>事务处理</p>
<p>要实现对 DomainContext 的事务处理的话，仅仅需要创建一个类 DomainContextTransactionBehavior</p>
<pre class="line-numbers language-csharp"><code class="language-csharp"><span class="token keyword">namespace</span> GeekTime<span class="token punctuation">.</span>Infrastructure
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DomainContextTransactionBehavior</span><span class="token operator">&lt;</span>TRequest<span class="token punctuation">,</span> TResponse<span class="token operator">></span> <span class="token punctuation">:</span> TransactionBehavior<span class="token operator">&lt;</span>DomainContext<span class="token punctuation">,</span> TRequest<span class="token punctuation">,</span> TResponse<span class="token operator">></span>
    <span class="token punctuation">{</span>
        <span class="token keyword">public</span> <span class="token function">DomainContextTransactionBehavior</span><span class="token punctuation">(</span>DomainContext dbContext<span class="token punctuation">,</span> ICapPublisher capBus<span class="token punctuation">,</span> ILogger<span class="token operator">&lt;</span>DomainContextTransactionBehavior<span class="token operator">&lt;</span>TRequest<span class="token punctuation">,</span> TResponse<span class="token operator">></span><span class="token operator">></span> logger<span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token keyword">base</span><span class="token punctuation">(</span>dbContext<span class="token punctuation">,</span> capBus<span class="token punctuation">,</span> logger<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>为了演示效果，在应用程序启动时，添加一行代码</p>
<p>Startup</p>
<pre class="line-numbers language-csharp"><code class="language-csharp"><span class="token comment" spellcheck="true">// 这一行代码的作用是创建一个 Scope，在这个范围内创建 DomainContext</span>
<span class="token keyword">using</span> <span class="token punctuation">(</span><span class="token keyword">var</span> scope <span class="token operator">=</span> app<span class="token punctuation">.</span>ApplicationServices<span class="token punctuation">.</span><span class="token function">CreateScope</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">var</span> dc <span class="token operator">=</span> scope<span class="token punctuation">.</span>ServiceProvider<span class="token punctuation">.</span><span class="token generic-method function">GetService<span class="token punctuation">&lt;</span>DomainContext<span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// 确定数据库已经创建，如果数据库没有创建，这个时候会执行数据库的自动创建过程，根据模型创建数据库</span>
    dc<span class="token punctuation">.</span>Database<span class="token punctuation">.</span><span class="token function">EnsureCreated</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>数据库的注册部分</p>
<p>ServiceCollectionExtensions</p>
<pre class="line-numbers language-csharp"><code class="language-csharp"><span class="token comment" spellcheck="true">/// &lt;summary></span>
<span class="token comment" spellcheck="true">/// 这个定义就是将连接字符串配置到 dDomainContext</span>
<span class="token comment" spellcheck="true">/// &lt;/summary></span>
<span class="token comment" spellcheck="true">/// &lt;param name="services">&lt;/param></span>
<span class="token comment" spellcheck="true">/// &lt;param name="connectionString">&lt;/param></span>
<span class="token comment" spellcheck="true">/// &lt;returns>&lt;/returns></span>
<span class="token keyword">public</span> <span class="token keyword">static</span> IServiceCollection <span class="token function">AddMySqlDomainContext</span><span class="token punctuation">(</span><span class="token keyword">this</span> IServiceCollection services<span class="token punctuation">,</span> <span class="token keyword">string</span> connectionString<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">return</span> services<span class="token punctuation">.</span><span class="token function">AddDomainContext</span><span class="token punctuation">(</span>builder <span class="token operator">=</span><span class="token operator">></span>
    <span class="token punctuation">{</span>
        builder<span class="token punctuation">.</span><span class="token function">UseMySql</span><span class="token punctuation">(</span>connectionString<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这一行代码的调用位置是在 ConfigureServices 里面</p>
<pre class="line-numbers language-csharp"><code class="language-csharp"><span class="token comment" spellcheck="true">// 从配置中获取字符串</span>
services<span class="token punctuation">.</span><span class="token function">AddMySqlDomainContext</span><span class="token punctuation">(</span>Configuration<span class="token punctuation">.</span><span class="token generic-method function">GetValue<span class="token punctuation">&lt;</span><span class="token keyword">string</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token string">"Mysql"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>启动程序，运行过程中 EF 框架会根据定义的实体映射关系生成数据库，可在 Mysql 数据库中查看生成结果</p>
<p>接着丰富一下 Order 的映射关系</p>
<pre class="line-numbers language-csharp"><code class="language-csharp"><span class="token keyword">namespace</span> GeekTime<span class="token punctuation">.</span>Infrastructure<span class="token punctuation">.</span>EntityConfigurations
<span class="token punctuation">{</span>
    <span class="token keyword">class</span> <span class="token class-name">OrderEntityTypeConfiguration</span> <span class="token punctuation">:</span> IEntityTypeConfiguration<span class="token operator">&lt;</span>Order<span class="token operator">></span>
    <span class="token punctuation">{</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">Configure</span><span class="token punctuation">(</span>EntityTypeBuilder<span class="token operator">&lt;</span>Order<span class="token operator">></span> builder<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// 定义主键</span>
            builder<span class="token punctuation">.</span><span class="token function">HasKey</span><span class="token punctuation">(</span>p <span class="token operator">=</span><span class="token operator">></span> p<span class="token punctuation">.</span>Id<span class="token punctuation">)</span><span class="token punctuation">;</span>
            builder<span class="token punctuation">.</span><span class="token function">ToTable</span><span class="token punctuation">(</span><span class="token string">"order"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// 修改表名为 order，不带 s</span>
            builder<span class="token punctuation">.</span><span class="token function">Property</span><span class="token punctuation">(</span>p <span class="token operator">=</span><span class="token operator">></span> p<span class="token punctuation">.</span>UserId<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">HasMaxLength</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// 修改字段长度</span>
            builder<span class="token punctuation">.</span><span class="token function">Property</span><span class="token punctuation">(</span>p <span class="token operator">=</span><span class="token operator">></span> p<span class="token punctuation">.</span>UserName<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">HasMaxLength</span><span class="token punctuation">(</span><span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment" spellcheck="true">// 定义导航属性</span>
            <span class="token comment" spellcheck="true">// OwnsOne 的方式可以将 Address 这个值类型作为同一个表的字段来设置</span>
            builder<span class="token punctuation">.</span><span class="token function">OwnsOne</span><span class="token punctuation">(</span>o <span class="token operator">=</span><span class="token operator">></span> o<span class="token punctuation">.</span>Address<span class="token punctuation">,</span> a <span class="token operator">=</span><span class="token operator">></span>
                <span class="token punctuation">{</span>
                    a<span class="token punctuation">.</span><span class="token function">WithOwner</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    a<span class="token punctuation">.</span><span class="token function">Property</span><span class="token punctuation">(</span>p <span class="token operator">=</span><span class="token operator">></span> p<span class="token punctuation">.</span>City<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">HasMaxLength</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    a<span class="token punctuation">.</span><span class="token function">Property</span><span class="token punctuation">(</span>p <span class="token operator">=</span><span class="token operator">></span> p<span class="token punctuation">.</span>Street<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">HasMaxLength</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    a<span class="token punctuation">.</span><span class="token function">Property</span><span class="token punctuation">(</span>p <span class="token operator">=</span><span class="token operator">></span> p<span class="token punctuation">.</span>ZipCode<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">HasMaxLength</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>启动程序，可以看到数据库修改结果</p>
<p>这说明可以在仓储层定义领域模型与数据库的映射关系，这个映射关系可以组织为一个目录，为每一个领域模型设置一个类型来定义，并且这个过程是强类型的，这样的结构，便于后期维护</p>
<p>另外仓储层的话，定义了一个 IOrderRepository，仅仅实现了 IRepository 泛型接口，引进 Order，由于 Order 实际上有一个主键是 long，所以这里把主键类型也传给 IRepository</p>
<pre class="line-numbers language-csharp"><code class="language-csharp"><span class="token keyword">namespace</span> GeekTime<span class="token punctuation">.</span>Infrastructure<span class="token punctuation">.</span>Repositories
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">IOrderRepository</span> <span class="token punctuation">:</span> IRepository<span class="token operator">&lt;</span>Order<span class="token punctuation">,</span> <span class="token keyword">long</span><span class="token operator">></span>
    <span class="token punctuation">{</span>

    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>Order</p>
<pre class="line-numbers language-csharp"><code class="language-csharp"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Order</span> <span class="token punctuation">:</span> Entity<span class="token operator">&lt;</span><span class="token keyword">long</span><span class="token operator">></span><span class="token punctuation">,</span> IAggregateRoot<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>这样子，Order 的仓储就定义完毕</p>
<p>那么 Order 仓储的实现也非常简单，仅仅需要继承 Repository，把 Order，long，DomainContext 传入泛型 Repository 即可，这里还实现了 IOrderRepository</p>
<pre class="line-numbers language-csharp"><code class="language-csharp"><span class="token keyword">namespace</span> GeekTime<span class="token punctuation">.</span>Infrastructure<span class="token punctuation">.</span>Repositories
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OrderRepository</span> <span class="token punctuation">:</span> Repository<span class="token operator">&lt;</span>Order<span class="token punctuation">,</span> <span class="token keyword">long</span><span class="token punctuation">,</span> DomainContext<span class="token operator">></span><span class="token punctuation">,</span> IOrderRepository
    <span class="token punctuation">{</span>
        <span class="token keyword">public</span> <span class="token function">OrderRepository</span><span class="token punctuation">(</span>DomainContext context<span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token keyword">base</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>通过这样简单的继承，可以复用之前定义的代码，快速实现仓储层的定义</p>
<p>可以通过代码提升看到仓储层是有 Add，Update，Remove，Delete 方法，还有 UnitOfWork 的属性</p>
<p><img src="https://cdn.jsdelivr.net/gh/shw2018/cdn@1.0/sakura/img/loader/orange.progress-bar-stripe-loader.svg" data-original="https://img2020.cnblogs.com/blog/1412316/202003/1412316-20200322001730753-633009317.png" alt=""></p>
<p><img src="https://cdn.jsdelivr.net/gh/shw2018/cdn@1.0/sakura/img/loader/orange.progress-bar-stripe-loader.svg" data-original="https://img2020.cnblogs.com/blog/1412316/202003/1412316-20200322001738276-1845895458.png" alt=""></p>
<p>这样一来就完成了仓储层的定义，可以看到仓储层的代码非常的薄，仅仅包含了一些接口的定义和类的继承，需要自定义一些方法的时候，可以在仓储层定义一些特殊方法，比如 AddABC 等特殊的逻辑都可以在这里去实现</p>
<pre class="line-numbers language-csharp"><code class="language-csharp"><span class="token keyword">namespace</span> GeekTime<span class="token punctuation">.</span>Infrastructure<span class="token punctuation">.</span>Repositories
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OrderRepository</span> <span class="token punctuation">:</span> Repository<span class="token operator">&lt;</span>Order<span class="token punctuation">,</span> <span class="token keyword">long</span><span class="token punctuation">,</span> DomainContext<span class="token operator">></span><span class="token punctuation">,</span> IOrderRepository
    <span class="token punctuation">{</span>
        <span class="token keyword">public</span> <span class="token function">OrderRepository</span><span class="token punctuation">(</span>DomainContext context<span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token keyword">base</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">AddABC</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>

    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>另外一个在组织领域模型和数据库的关系的时候，可以很清晰的看到，是在 EntityConfiguration 这个目录下面，为每一个模型定义一个映射类，当领域模型越来越复杂，数据库的结构越来越复杂的时候，这样的组织结构会非常的清晰</p>
<p><img src="https://cdn.jsdelivr.net/gh/shw2018/cdn@1.0/sakura/img/loader/orange.progress-bar-stripe-loader.svg" data-original="https://img2020.cnblogs.com/blog/1412316/202003/1412316-20200322001752157-1564773848.png" alt=""></p>
<h2 id="30-领域事件：提升业务内聚，实现模块解耦"><a href="#30-领域事件：提升业务内聚，实现模块解耦" class="headerlink" title="30 | 领域事件：提升业务内聚，实现模块解耦"></a>30 | 领域事件：提升业务内聚，实现模块解耦</h2><p>我们在领域的抽象层定义了领域事件和领域事件处理的接口</p>
<p>IDomainEvent</p>
<pre class="line-numbers language-csharp"><code class="language-csharp"><span class="token keyword">namespace</span> GeekTime<span class="token punctuation">.</span>Domain
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">IDomainEvent</span> <span class="token punctuation">:</span> INotification
    <span class="token punctuation">{</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这是一个空接口，它只是标记出来某一个对象是否是领域事件，INotification 也是一个空接口，它是 MediatR 框架的一个接口，是用来实现事件传递用的</p>
<pre class="line-numbers language-csharp"><code class="language-csharp"><span class="token keyword">namespace</span> MediatR
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">INotification</span>
    <span class="token punctuation">{</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>接着是 IDomainEventHandler</p>
<pre class="line-numbers language-csharp"><code class="language-csharp"><span class="token keyword">namespace</span> GeekTime<span class="token punctuation">.</span>Domain
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">IDomainEventHandler</span><span class="token operator">&lt;</span>TDomainEvent<span class="token operator">></span> <span class="token punctuation">:</span> INotificationHandler<span class="token operator">&lt;</span>TDomainEvent<span class="token operator">></span> 
        <span class="token keyword">where</span> TDomainEvent <span class="token punctuation">:</span> IDomainEvent
    <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">//这里我们使用了INotificationHandler的Handle方法来作为处理方法的定义</span>
        <span class="token comment" spellcheck="true">//Task Handle(TDomainEvent domainEvent, CancellationToken cancellationToken);</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>同样这个接口也是继承了 IDomainEventHandler 接口，它有一个泛型参数是 TDomainEvent，这个 TDomainEvent 约束必须为 IDomainEvent，也就是说处理程序只处理 IDomainEvent 作为入参</p>
<p>实际上该方法已经在 INotificationHandler 中定义好了，所以这里不需要重新定义，只是告诉大家它的定义是什么样子的</p>
<p>在 Entity 中对领域事件代码的处理</p>
<pre class="line-numbers language-csharp"><code class="language-csharp"><span class="token keyword">private</span> List<span class="token operator">&lt;</span>IDomainEvent<span class="token operator">></span> _domainEvents<span class="token punctuation">;</span>
<span class="token keyword">public</span> IReadOnlyCollection<span class="token operator">&lt;</span>IDomainEvent<span class="token operator">></span> DomainEvents <span class="token operator">=</span><span class="token operator">></span> _domainEvents<span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">AsReadOnly</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">AddDomainEvent</span><span class="token punctuation">(</span>IDomainEvent eventItem<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    _domainEvents <span class="token operator">=</span> _domainEvents <span class="token operator">?</span><span class="token operator">?</span> <span class="token keyword">new</span> <span class="token class-name">List</span><span class="token operator">&lt;</span>IDomainEvent<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    _domainEvents<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span>eventItem<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">RemoveDomainEvent</span><span class="token punctuation">(</span>IDomainEvent eventItem<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    _domainEvents<span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">Remove</span><span class="token punctuation">(</span>eventItem<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">ClearDomainEvents</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    _domainEvents<span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">Clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>将领域事件做一个实体的属性存储进来，它应该是一个列表，因为在一个实体操作过程中间可能会发生多件事情，领域事件应该是可以被实体模型之外的代码读到，所以暴露一个 ReadOnly 的 Collection</p>
<p>这里还提供几个方法：添加领域事件，移除领域事件，清除领域事件</p>
<p>这些方法都是在领域模型内部进行调用的</p>
<p>可以看一下之前定义的 Order</p>
<pre class="line-numbers language-csharp"><code class="language-csharp"><span class="token keyword">public</span> <span class="token function">Order</span><span class="token punctuation">(</span><span class="token keyword">string</span> userId<span class="token punctuation">,</span> <span class="token keyword">string</span> userName<span class="token punctuation">,</span> <span class="token keyword">int</span> itemCount<span class="token punctuation">,</span> Address address<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>UserId <span class="token operator">=</span> userId<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>UserName <span class="token operator">=</span> userName<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>Address <span class="token operator">=</span> address<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>ItemCount <span class="token operator">=</span> itemCount<span class="token punctuation">;</span>

    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">AddDomainEvent</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">OrderCreatedDomainEvent</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">ChangeAddress</span><span class="token punctuation">(</span>Address address<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>Address <span class="token operator">=</span> address<span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">//this.AddDomainEvent(new OrderAddressChangedDomainEvent(this));</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>当我们构造一个全新的 Order 的时候，实际上这里可以定义一个事件叫做 OrderCreatedDomainEvent，这个领域事件它的构造函数的入参就是一个 Order，当我们调用 Order 的构造函数时，实际上我们的行为就是在创建一个全新的 Order，所以在这里添加一个事件 AddDomainEvent</p>
<p>同理的比如说 ChangeAddress 被调用了，我们在这里实际上可以定义一个 OrderAddressChangedDomainEvent 类似这样子的领域事件出来</p>
<p>大家可以看到领域事件的构造和添加都应该是在领域模型的方法内完成的，而不应该是被外界的代码去调用创建，因为这些事件都是领域模型内部发生的事件</p>
<p>接着看看 OrderCreatedDomainEvent 的定义</p>
<pre class="line-numbers language-csharp"><code class="language-csharp"><span class="token keyword">namespace</span> GeekTime<span class="token punctuation">.</span>Domain<span class="token punctuation">.</span>Events
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OrderCreatedDomainEvent</span> <span class="token punctuation">:</span> IDomainEvent
    <span class="token punctuation">{</span>
        <span class="token keyword">public</span> Order Order <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">private</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
        <span class="token keyword">public</span> <span class="token function">OrderCreatedDomainEvent</span><span class="token punctuation">(</span>Order order<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>Order <span class="token operator">=</span> order<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>那我们如何处理我们的领域事件，接收领域事件的处理应该定义在应用层</p>
<pre class="line-numbers language-csharp"><code class="language-csharp"><span class="token keyword">namespace</span> GeekTime<span class="token punctuation">.</span>API<span class="token punctuation">.</span>Application<span class="token punctuation">.</span>DomainEventHandlers
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OrderCreatedDomainEventHandler</span> <span class="token punctuation">:</span> IDomainEventHandler<span class="token operator">&lt;</span>OrderCreatedDomainEvent<span class="token operator">></span>
    <span class="token punctuation">{</span>
        ICapPublisher _capPublisher<span class="token punctuation">;</span>
        <span class="token keyword">public</span> <span class="token function">OrderCreatedDomainEventHandler</span><span class="token punctuation">(</span>ICapPublisher capPublisher<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            _capPublisher <span class="token operator">=</span> capPublisher<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">public</span> <span class="token keyword">async</span> Task <span class="token function">Handle</span><span class="token punctuation">(</span>OrderCreatedDomainEvent notification<span class="token punctuation">,</span> CancellationToken cancellationToken<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token keyword">await</span> _capPublisher<span class="token punctuation">.</span><span class="token function">PublishAsync</span><span class="token punctuation">(</span><span class="token string">"OrderCreated"</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">OrderCreatedIntegrationEvent</span><span class="token punctuation">(</span>notification<span class="token punctuation">.</span>Order<span class="token punctuation">.</span>Id<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>它继承了 IDomainEventHandler，这个接口是上面讲到的领域事件处理器的接口，它的泛型入参就是要处理的事件的类型 OrderCreatedDomainEvent</p>
<p>为了简单演示起见，这里的逻辑是当我们创建一个新的订单时，我们向 EventBus 发布一条事件，叫做 OrderCreated 这个事件</p>
<p>我们在 OrderController 的 CreateOrder 定义了一个 CreateOrderCommand</p>
<pre class="line-numbers language-csharp"><code class="language-csharp"><span class="token punctuation">[</span>HttpPost<span class="token punctuation">]</span>
<span class="token keyword">public</span> <span class="token keyword">async</span> Task<span class="token operator">&lt;</span><span class="token keyword">long</span><span class="token operator">></span> <span class="token function">CreateOrder</span><span class="token punctuation">(</span><span class="token punctuation">[</span>FromBody<span class="token punctuation">]</span>CreateOrderCommand cmd<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">await</span> _mediator<span class="token punctuation">.</span><span class="token function">Send</span><span class="token punctuation">(</span>cmd<span class="token punctuation">,</span> HttpContext<span class="token punctuation">.</span>RequestAborted<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>CreateOrderCommand</p>
<pre class="line-numbers language-csharp"><code class="language-csharp"><span class="token keyword">namespace</span> GeekTime<span class="token punctuation">.</span>API<span class="token punctuation">.</span>Application<span class="token punctuation">.</span>Commands
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CreateOrderCommand</span> <span class="token punctuation">:</span> IRequest<span class="token operator">&lt;</span><span class="token keyword">long</span><span class="token operator">></span>
    <span class="token punctuation">{</span>

        <span class="token comment" spellcheck="true">//ublic CreateOrderCommand() { }</span>
        <span class="token keyword">public</span> <span class="token function">CreateOrderCommand</span><span class="token punctuation">(</span><span class="token keyword">int</span> itemCount<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            ItemCount <span class="token operator">=</span> itemCount<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">public</span> <span class="token keyword">long</span> ItemCount <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">private</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>CreateOrderCommandHandler</p>
<pre class="line-numbers language-csharp"><code class="language-csharp"><span class="token keyword">public</span> <span class="token keyword">async</span> Task<span class="token operator">&lt;</span><span class="token keyword">long</span><span class="token operator">></span> <span class="token function">Handle</span><span class="token punctuation">(</span>CreateOrderCommand request<span class="token punctuation">,</span> CancellationToken cancellationToken<span class="token punctuation">)</span>
<span class="token punctuation">{</span>

    <span class="token keyword">var</span> address <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Address</span><span class="token punctuation">(</span><span class="token string">"wen san lu"</span><span class="token punctuation">,</span> <span class="token string">"hangzhou"</span><span class="token punctuation">,</span> <span class="token string">"310000"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">var</span> order <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Order</span><span class="token punctuation">(</span><span class="token string">"xiaohong1999"</span><span class="token punctuation">,</span> <span class="token string">"xiaohong"</span><span class="token punctuation">,</span> <span class="token number">25</span><span class="token punctuation">,</span> address<span class="token punctuation">)</span><span class="token punctuation">;</span>

    _orderRepository<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span>order<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">await</span> _orderRepository<span class="token punctuation">.</span>UnitOfWork<span class="token punctuation">.</span><span class="token function">SaveEntitiesAsync</span><span class="token punctuation">(</span>cancellationToken<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> order<span class="token punctuation">.</span>Id<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>我们在 CreateOrderCommandHandler 里面创建了一个 Order，然后保存进仓储，调用了 UnitOfWork 的 SaveEntitiesAsync</p>
<p>启动程序，直接执行，调用我们的方法，可以看到我们先进入到了创建订单的处理系统（CreateOrderCommandHandler），接着进入到了领域事件发布的 Publish 的代码（MediatorExtension），当仓储存储完毕之后，进入到了 OrderCreatedDomainEventHandler，也就是说我们在创建完我们的领域模型并将其保存之后，我们的领域事件的处理程序才触发</p>
<p>在之前讲解实现 UnitOfWork 的时候（EFContext），我们的 SaveEntitiesAsync 里面只有一行代码是 SaveChangesAsync，这里添加了一行代码，是发送领域事件的代码 DispatchDomainEventsAsync</p>
<pre class="line-numbers language-csharp"><code class="language-csharp"><span class="token keyword">public</span> <span class="token keyword">async</span> Task<span class="token operator">&lt;</span><span class="token keyword">bool</span><span class="token operator">></span> <span class="token function">SaveEntitiesAsync</span><span class="token punctuation">(</span>CancellationToken cancellationToken <span class="token operator">=</span> <span class="token keyword">default</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">var</span> result <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">base</span><span class="token punctuation">.</span><span class="token function">SaveChangesAsync</span><span class="token punctuation">(</span>cancellationToken<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">//await _mediator.DispatchDomainEventsAsync(this);</span>
    <span class="token keyword">return</span> <span class="token keyword">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这就是 MediatorExtension 中看到的 DispatchDomainEventsAsync</p>
<pre class="line-numbers language-csharp"><code class="language-csharp"><span class="token keyword">namespace</span> GeekTime<span class="token punctuation">.</span>Infrastructure<span class="token punctuation">.</span>Core<span class="token punctuation">.</span>Extensions
<span class="token punctuation">{</span>
    <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">MediatorExtension</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">async</span> Task <span class="token function">DispatchDomainEventsAsync</span><span class="token punctuation">(</span><span class="token keyword">this</span> IMediator mediator<span class="token punctuation">,</span> DbContext ctx<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token keyword">var</span> domainEntities <span class="token operator">=</span> ctx<span class="token punctuation">.</span>ChangeTracker
                <span class="token punctuation">.</span><span class="token generic-method function">Entries<span class="token punctuation">&lt;</span>Entity<span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">Where</span><span class="token punctuation">(</span>x <span class="token operator">=</span><span class="token operator">></span> x<span class="token punctuation">.</span>Entity<span class="token punctuation">.</span>DomainEvents <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> x<span class="token punctuation">.</span>Entity<span class="token punctuation">.</span>DomainEvents<span class="token punctuation">.</span><span class="token function">Any</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">var</span> domainEvents <span class="token operator">=</span> domainEntities
                <span class="token punctuation">.</span><span class="token function">SelectMany</span><span class="token punctuation">(</span>x <span class="token operator">=</span><span class="token operator">></span> x<span class="token punctuation">.</span>Entity<span class="token punctuation">.</span>DomainEvents<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">ToList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            domainEntities<span class="token punctuation">.</span><span class="token function">ToList</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">ForEach</span><span class="token punctuation">(</span>entity <span class="token operator">=</span><span class="token operator">></span> entity<span class="token punctuation">.</span>Entity<span class="token punctuation">.</span><span class="token function">ClearDomainEvents</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token keyword">var</span> domainEvent <span class="token keyword">in</span> domainEvents<span class="token punctuation">)</span>
                <span class="token keyword">await</span> mediator<span class="token punctuation">.</span><span class="token function">Publish</span><span class="token punctuation">(</span>domainEvent<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>大家可以看到我们发送领域事件实际上是这么一个过程：我们从当前要保存的 EntityContext 里面去跟踪我们的实体，然后从跟踪到的实体的对象中获取到我们当前的 Event，如果 Event 是存在的，就把它取出来，然后将实体内的 Event 进行清除，再然后将这些 Event 逐条地通过中间件发送出去，并且找到对应的 Handler 处理</p>
<p>定义领域事件实际上也非常简单，只需要在领域模型创建一个 Events 的目录，然后将领域事件都定义在这里，领域事件需要继承 IDomainEvent，领域事件的处理器都定义在 DomainEventHandler，在应用层这个目录下面，我们可以为每一个事件都定义我们的处理程序</p>
<p>总结一下</p>
<p>领域模型内创建事件：我们不要在领域模型的外面去构造事件，然后传递给领域模型，因为整个领域事件是由领域的业务逻辑触发的，而不是说外面的对模型的操作触发的</p>
<p>另外就是针对领域事件应该定义专有的领域事件处理类，就像我们刚才演示的，在一个特定的目录，对每一个事件进行定义处理类</p>
<p>还有一个就是在同一个事务里面去处理我们的领域事件，实际上我们也可以选择在不同的事务里面处理，如果需要在不同的事务里面去处理领域事件的时候，我们就需要考虑一致性的问题，考虑中间出错，消息丢失的问题</p>
<h2 id="31-APIController：定义API的最佳实践"><a href="#31-APIController：定义API的最佳实践" class="headerlink" title="31 | APIController：定义API的最佳实践"></a>31 | APIController：定义API的最佳实践</h2><p>首先看一个传统意义上三层架构定义的 Controller</p>
<pre class="line-numbers language-csharp"><code class="language-csharp"><span class="token punctuation">[</span>HttpPost<span class="token punctuation">]</span>
<span class="token keyword">public</span> Task<span class="token operator">&lt;</span><span class="token keyword">long</span><span class="token operator">></span> <span class="token function">CreateOrder</span><span class="token punctuation">(</span><span class="token punctuation">[</span>FromBody<span class="token punctuation">]</span>CreateOrderVeiwModel viewModel<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">var</span> model <span class="token operator">=</span> viewModel<span class="token punctuation">.</span><span class="token function">ToModel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token keyword">await</span> orderService<span class="token punctuation">.</span><span class="token function">CreateOrder</span><span class="token punctuation">(</span>model<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">OrderService</span> <span class="token punctuation">:</span> IOrderService
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">long</span> <span class="token function">CreateOrder</span><span class="token punctuation">(</span>CreateOrderModel model<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">var</span> address <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Address</span><span class="token punctuation">(</span><span class="token string">"wen san lu"</span><span class="token punctuation">,</span> <span class="token string">"hangzhou"</span><span class="token punctuation">,</span> <span class="token string">"310000"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">var</span> order <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Order</span><span class="token punctuation">(</span><span class="token string">"xiaohong1999"</span><span class="token punctuation">,</span> <span class="token string">"xiaohong"</span><span class="token punctuation">,</span> <span class="token number">25</span><span class="token punctuation">,</span> address<span class="token punctuation">)</span><span class="token punctuation">;</span>

        _orderRepository<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span>order<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">await</span> _orderRepository<span class="token punctuation">.</span>UnitOfWork<span class="token punctuation">.</span><span class="token function">SaveEntitiesAsync</span><span class="token punctuation">(</span>cancellationToken<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> order<span class="token punctuation">.</span>Id<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>可以看到这里的 Controller 负责模型转换，还负责服务调用，服务里面实际上就是领域模型的操作部分</p>
<p>随着业务逻辑的越来越复杂，Controller 会越来越膨胀，在 DDD 领域驱动设计的理念下，我们更倾向于把应用程序的每一层明确区分，然后层与层之间的界限应该是明确的，在实现上面应该也是隔离的</p>
<p>Controller 这一层负责与前端用户的交互，它主要的责任就是定义输入和输出，实现身份认证，授权功能，它不应该处理领域模型，处理仓储，所以不建议以上的写法，不建议在 Controller 里面写模型转换和服务调用</p>
<pre class="line-numbers language-csharp"><code class="language-csharp"><span class="token keyword">namespace</span> GeekTime<span class="token punctuation">.</span>API<span class="token punctuation">.</span>Controllers
<span class="token punctuation">{</span>
    <span class="token punctuation">[</span><span class="token function">Route</span><span class="token punctuation">(</span><span class="token string">"api/[controller]"</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
    <span class="token punctuation">[</span>ApiController<span class="token punctuation">]</span>
    <span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OrderController</span> <span class="token punctuation">:</span> ControllerBase
    <span class="token punctuation">{</span>
        IMediator _mediator<span class="token punctuation">;</span>
        <span class="token keyword">public</span> <span class="token function">OrderController</span><span class="token punctuation">(</span>IMediator mediator<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            _mediator <span class="token operator">=</span> mediator<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token punctuation">[</span>HttpPost<span class="token punctuation">]</span>
        <span class="token keyword">public</span> <span class="token keyword">async</span> Task<span class="token operator">&lt;</span><span class="token keyword">long</span><span class="token operator">></span> <span class="token function">CreateOrder</span><span class="token punctuation">(</span><span class="token punctuation">[</span>FromBody<span class="token punctuation">]</span>CreateOrderCommand cmd<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token keyword">await</span> _mediator<span class="token punctuation">.</span><span class="token function">Send</span><span class="token punctuation">(</span>cmd<span class="token punctuation">,</span> HttpContext<span class="token punctuation">.</span>RequestAborted<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token punctuation">[</span>HttpGet<span class="token punctuation">]</span>
        <span class="token keyword">public</span> <span class="token keyword">async</span> Task<span class="token operator">&lt;</span>List<span class="token operator">&lt;</span><span class="token keyword">string</span><span class="token operator">></span><span class="token operator">></span> <span class="token function">QueryOrder</span><span class="token punctuation">(</span><span class="token punctuation">[</span>FromBody<span class="token punctuation">]</span>MyOrderQuery myOrderQuery<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token keyword">await</span> _mediator<span class="token punctuation">.</span><span class="token function">Send</span><span class="token punctuation">(</span>myOrderQuery<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这里使用了中间者模式 Mediator，它通过把命令发送出去，然后我们在 Commands 目录下面定义了每一个命令的 handler，这样就可以将业务逻辑的部分和 Controller 处理的部分，输入输出定义的部分进行隔离，我们的 Controller 还需要去定义路由的规则，路由验证的规则</p>
<p>再看一下 Controller 的构造函数，从设计上建议 Controller 所依赖的服务都通过它的构造函数注入进来，之前有讲过，通过容器进行属性注入的方式，但这种方式我们并不推荐使用，当一个 Controller 依赖了很多服务的时候，可以发现有一部分服务是大部分的 Action 都会依赖到的，有一部分服务只是个别 Action 依赖到的，这个时候就可以使用 FromServices，而不需要在构造函数里面注入它，这样有个好处是在编写单元测试的时候，可以在容器里面 Mock 所有的服务</p>
<pre class="line-numbers language-csharp"><code class="language-csharp"><span class="token keyword">public</span> <span class="token keyword">async</span> Task<span class="token operator">&lt;</span><span class="token keyword">long</span><span class="token operator">></span> <span class="token function">CreateOrder</span><span class="token punctuation">(</span><span class="token punctuation">[</span>FromServices<span class="token punctuation">]</span> IEventBus eventBus<span class="token punctuation">,</span> <span class="token punctuation">[</span>FromBody<span class="token punctuation">]</span>CreateOrderCommand cmd<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>这里不建议使用属性注入的方式来注入服务，是因为使用属性注入的时候，会把这些属性，比如说 IOrderService，有可能由其他代码 set 我们的 OrderService，造成意外的情况，使我们的代码的维护不可控</p>
<pre class="line-numbers language-csharp"><code class="language-csharp"><span class="token keyword">public</span> IOrderService orderService <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>还有一个关键的点是建议尽可能定义异步的 action，尽可能地使用 async 和 await 这样的组合来实现我们的代码，这样对提高我们应用程序的吞吐量是有一定的帮助的</p>
<p><strong>总结一下</strong></p>
<p>APIController 实际上是负责了对前端用户的输入输出的定义，它还负责了身份验证，授权，Url 定义的部分</p>
<p>APIController 不应该负责业务逻辑的承载，应该把这些职责交给我们命令处理程序或者说领域服务来定义</p>
<p>再一个我们也讲解了 APIController 在注入服务时的一些方法，通过构造函数的注入，通过 FromServices 的方式获取服务，不建议的做法时使用属性注入的方式注入</p>
<h2 id="32-集成事件：解决跨微服务的最终一致性"><a href="#32-集成事件：解决跨微服务的最终一致性" class="headerlink" title="32 | 集成事件：解决跨微服务的最终一致性"></a>32 | 集成事件：解决跨微服务的最终一致性</h2><p>首先看一下集成事件的工作原理</p>
<p><img src="https://cdn.jsdelivr.net/gh/shw2018/cdn@1.0/sakura/img/loader/orange.progress-bar-stripe-loader.svg" data-original="https://img2020.cnblogs.com/blog/1412316/202003/1412316-20200326001626117-1275463266.png" alt=""></p>
<p>它的目的时为了实现系统的集成，它主要是用于系统里面多个微服务之间相互传递事件</p>
<p>集成事件的实现方式有两种，一种是图上显示的发布订阅的方式，通过 EventBus，还有一种方式是通过观察者模式，由观察者将事件发送给关注事件的人</p>
<p>接着看一下代码上的定义</p>
<p>在 Application 目录下面定义了一个集成事件的目录 IntegrationEvents</p>
<p>OrderCreatedIntegrationEvent</p>
<pre class="line-numbers language-csharp"><code class="language-csharp"><span class="token keyword">namespace</span> GeekTime<span class="token punctuation">.</span>API<span class="token punctuation">.</span>Application<span class="token punctuation">.</span>IntegrationEvents
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OrderCreatedIntegrationEvent</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">public</span> <span class="token function">OrderCreatedIntegrationEvent</span><span class="token punctuation">(</span><span class="token keyword">long</span> orderId<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> OrderId <span class="token operator">=</span> orderId<span class="token punctuation">;</span>
        <span class="token keyword">public</span> <span class="token keyword">long</span> OrderId <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>得益于基础设施的发展，现在实际上可以借助一些开源框架，很轻松的实现集成事件的发布和订阅的能力</p>
<p>在发布端可以看一下这里的代码</p>
<pre class="line-numbers language-csharp"><code class="language-csharp"><span class="token keyword">namespace</span> GeekTime<span class="token punctuation">.</span>API<span class="token punctuation">.</span>Application<span class="token punctuation">.</span>DomainEventHandlers
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OrderCreatedDomainEventHandler</span> <span class="token punctuation">:</span> IDomainEventHandler<span class="token operator">&lt;</span>OrderCreatedDomainEvent<span class="token operator">></span>
    <span class="token punctuation">{</span>
        ICapPublisher _capPublisher<span class="token punctuation">;</span>
        <span class="token keyword">public</span> <span class="token function">OrderCreatedDomainEventHandler</span><span class="token punctuation">(</span>ICapPublisher capPublisher<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            _capPublisher <span class="token operator">=</span> capPublisher<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">public</span> <span class="token keyword">async</span> Task <span class="token function">Handle</span><span class="token punctuation">(</span>OrderCreatedDomainEvent notification<span class="token punctuation">,</span> CancellationToken cancellationToken<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token keyword">await</span> _capPublisher<span class="token punctuation">.</span><span class="token function">PublishAsync</span><span class="token punctuation">(</span><span class="token string">"OrderCreated"</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">OrderCreatedIntegrationEvent</span><span class="token punctuation">(</span>notification<span class="token punctuation">.</span>Order<span class="token punctuation">.</span>Id<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这里我们定义了一个领域事件，它的作用就是将我们的集成事件发送出去，具体是要发送到 RabbitMQ 还是 kafka 这些消息队列中间件里面是可配置的，对于业务逻辑来讲的话，它是透明的</p>
<p>这里有一个 ICapPublisher 接口，这个接口实际上是由中国的开源社区开发的一个框架，借助这个框架，我们可以轻松的实现消息的发布和订阅</p>
<p>那我们如何来订阅其他微服务发出的消息呢？</p>
<pre class="line-numbers language-csharp"><code class="language-csharp"><span class="token keyword">namespace</span> GeekTime<span class="token punctuation">.</span>API<span class="token punctuation">.</span>Application<span class="token punctuation">.</span>IntegrationEvents
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SubscriberService</span> <span class="token punctuation">:</span> ISubscriberService<span class="token punctuation">,</span> ICapSubscribe
    <span class="token punctuation">{</span>
        IMediator _mediator<span class="token punctuation">;</span>
        <span class="token keyword">public</span> <span class="token function">SubscriberService</span><span class="token punctuation">(</span>IMediator mediator<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            _mediator <span class="token operator">=</span> mediator<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token punctuation">[</span><span class="token function">CapSubscribe</span><span class="token punctuation">(</span><span class="token string">"OrderPaymentSucceeded"</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">OrderPaymentSucceeded</span><span class="token punctuation">(</span>OrderPaymentSucceededIntegrationEvent @<span class="token keyword">event</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">//Do SomeThing</span>
        <span class="token punctuation">}</span>

        <span class="token punctuation">[</span><span class="token function">CapSubscribe</span><span class="token punctuation">(</span><span class="token string">"OrderCreated"</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">OrderCreated</span><span class="token punctuation">(</span>OrderCreatedIntegrationEvent @<span class="token keyword">event</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">//Do SomeThing</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>我们可以通过订阅服务，它同样也是借助了 Cap 的组件，我们实现了 ICapPublisher 这个接口，就可以将服务标记成我们的订阅服务</p>
<p>另外我们的订阅方法，订阅的处理函数上面，标记 CapSubscribe 这个属性，将我们要订阅的事件名放在这里，我们就可以订阅到这个事件了</p>
<pre class="line-numbers language-csharp"><code class="language-csharp"><span class="token keyword">namespace</span> GeekTime<span class="token punctuation">.</span>API<span class="token punctuation">.</span>Application<span class="token punctuation">.</span>IntegrationEvents
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OrderPaymentSucceededIntegrationEvent</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">public</span> <span class="token function">OrderPaymentSucceededIntegrationEvent</span><span class="token punctuation">(</span><span class="token keyword">long</span> orderId<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> OrderId <span class="token operator">=</span> orderId<span class="token punctuation">;</span>
        <span class="token keyword">public</span> <span class="token keyword">long</span> OrderId <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>我们可以看到集成事件定义的话，它是没有接口和基类的约束的，因为在异构的系统里面，对于集成事件来讲的定义是相对比较灵活的，我们的建议是用这种简单的类型来承载它即可</p>
<p><strong>总结一下</strong></p>
<p>集成事件实际上也是由领域的业务逻辑驱动的，它本质上也是领域事件，只是说它是跨服务的领域事件</p>
<p>另外一个集成事件大部分场景是领域事件驱动的，也有可能是一些比如说定时任务触发的，由于集成事件是跨微服务来传递信息的，所以我们没办法通过事务来处理，那就需要借助 Cap 这样的框架来实现最终的一致性</p>
<p>当然我们建议仅在必要的情况下定义和使用集成事件，因为一旦引入集成事件，比如 EventBus，我们应用程序的版本控制，比如说我们发布新版本的时候，新旧版本的事件的发布和订阅都会受到影响，这个时候我们没办法使我们的应用程序成为一个单纯的无状态的程序，在更新新版本的时候，那么就会带来新的负担，兼容性方面我们会需要做更多的工作</p>
<h2 id="33-集成事件：使用RabbitMQ来实现EventBus"><a href="#33-集成事件：使用RabbitMQ来实现EventBus" class="headerlink" title="33 | 集成事件：使用RabbitMQ来实现EventBus"></a>33 | 集成事件：使用RabbitMQ来实现EventBus</h2><p>这一节我们来讲解如何通过 CAP 组件和 RabbitMQ 来实现 EventBus</p>
<p>要实现 EventBus，我们这里借助了 RabbitMQ，它的整个安装和使用的体验是非常人性化的，如果是在 Windows 下开发的话，它可以有 Windows 的 installer，也可以在其它的操作系统下安装和使用，当然它也支持 Docker 的模式，我们可以在以下的地址获取到安装包和安装方法的说明</p>
<p><a href="https://www.rabbitmq.com/download.html" target="_blank" rel="noopener">https://www.rabbitmq.com/download.html</a></p>
<p>另一个就是在 .NET Core 社区比较知名的 CAP 框架，这个框架是由我们国人开发的，它实现了开箱即用的 EventBus 的实现，我们可以通过简单的配置，就能把 RabbitMQ 集成进来，并且实现我们的集成事件的处理</p>
<p><a href="https://github.com/dotnetcore/CAP" target="_blank" rel="noopener">https://github.com/dotnetcore/CAP</a></p>
<p>我们来看一下 CAP 框架的实现架构</p>
<p><img src="https://cdn.jsdelivr.net/gh/shw2018/cdn@1.0/sakura/img/loader/orange.progress-bar-stripe-loader.svg" data-original="https://img2020.cnblogs.com/blog/1412316/202003/1412316-20200327003016423-1571983673.png" alt=""></p>
<p>它实际上实现了一个叫 OutBox 的设计模式，就是在我们的每个微服务，比如说微服务 A 的数据库 A，在这个数据库内部它建立了两张表，一张叫 publish 事件表和一张叫 receiver 事件表，这两张事件表用来记录微服务 A 发出的和微服务 A 收到的事件</p>
<p>当我们要发出事件时，我们会把事件的存储逻辑与我们的业务逻辑的事务合并，在同一个事务里提交，也就意味着当我们的业务逻辑提交成功时，我们的事件表里面的事件是一定存在的，它是与我们的业务逻辑的事务是强绑定的</p>
<p>如果说我们的业务逻辑失败了，事务回滚了，这条事件是不会出现在我们的事件表里的，这样子就可以做到说我们要发送的事件一定是与业务逻辑是一致的</p>
<p>接下来由我们组件来负责将事件表里的事件全部都发送到 EventBus，比如说 RabbitMQ 消息队列里面去，由接收方订阅</p>
<p>对于订阅的事件的话，设计的模式也是同理，当我们的应用程序在消息队列获取到信息的时候，它就会将这些消息持久化到我们的数据库的 Receive 事件表里，这样我们就可以在本地进行事件的处理，失败重试等操作，这些都是由 CAP 框架完成的，我们仅需要去做简单的配置，关注发布和订阅的业务逻辑即可</p>
<p>我们看一下代码，刚才有提到 CAP 的架构，关键的一点是需要事件的存储与我们的业务逻辑在同一个事务里，所以说我们在处理事务的逻辑部分的话，需要嵌入 CAP 的一部分代码，我们看一下 EFContext 的定义</p>
<pre class="line-numbers language-csharp"><code class="language-csharp"><span class="token keyword">public</span> <span class="token function">EFContext</span><span class="token punctuation">(</span>DbContextOptions options<span class="token punctuation">,</span> IMediator mediator<span class="token punctuation">,</span> ICapPublisher capBus<span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token keyword">base</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    _mediator <span class="token operator">=</span> mediator<span class="token punctuation">;</span>
    _capBus <span class="token operator">=</span> capBus<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>之前有关注到有一个叫 ICapPublisher 这个入参，关键的是这一行代码我们需要关注一下</p>
<pre class="line-numbers language-csharp"><code class="language-csharp">_currentTransaction <span class="token operator">=</span> Database<span class="token punctuation">.</span><span class="token function">BeginTransaction</span><span class="token punctuation">(</span>_capBus<span class="token punctuation">,</span> autoCommit<span class="token punctuation">:</span> <span class="token keyword">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>这一行代码的作用是创建事务，我们可以看到创建事务的过程中，我们把 ICapPublisher 也传入给了这个方法的构造函数，实际上这个方法是由 CAP 的组件提供的，它的核心作用就是将我们要发送的事件与我们的业务的存储都放在同一个事务内部，这样子我们就可以使得事务提交时或者回滚时，我们的事件与业务逻辑的存取都是一致的</p>
<p>然后我们再来看一下配置的部分，写在 ServiceCollectionExtensions 下面</p>
<pre class="line-numbers language-csharp"><code class="language-csharp"><span class="token keyword">public</span> <span class="token keyword">static</span> IServiceCollection <span class="token function">AddEventBus</span><span class="token punctuation">(</span><span class="token keyword">this</span> IServiceCollection services<span class="token punctuation">,</span> IConfiguration configuration<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    services<span class="token punctuation">.</span><span class="token generic-method function">AddTransient<span class="token punctuation">&lt;</span>ISubscriberService<span class="token punctuation">,</span> SubscriberService<span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    services<span class="token punctuation">.</span><span class="token function">AddCap</span><span class="token punctuation">(</span>options <span class="token operator">=</span><span class="token operator">></span>
    <span class="token punctuation">{</span>
        options<span class="token punctuation">.</span><span class="token generic-method function">UseEntityFramework<span class="token punctuation">&lt;</span>DomainContext<span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        options<span class="token punctuation">.</span><span class="token function">UseRabbitMQ</span><span class="token punctuation">(</span>options <span class="token operator">=</span><span class="token operator">></span>
        <span class="token punctuation">{</span>
            configuration<span class="token punctuation">.</span><span class="token function">GetSection</span><span class="token punctuation">(</span><span class="token string">"RabbitMQ"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Bind</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">//options.UseDashboard();</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> services<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>我们这里定义了一个 AddEventBus，可以看到将我们之前演示的代码订阅服务注入进来，然后 Services 最重点的代码是 AddCap，我们需要告诉 CAP 框架我们是针对 DomainContext 来实现我们的 EventBus，EventBus 与 DomainContext 共享我们的数据库连接，下面一行代码是指我们要用 RabbitMQ 来作为我们 EventBus 的消息队列的存储，这里可以看到使用了一个 Bind 的方法将我们的配置绑定到 RabbitMQ 的 options 上面去</p>
<p>我们可以看一下我们的配置</p>
<pre class="line-numbers language-csharp"><code class="language-csharp">  <span class="token string">"RabbitMQ"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
    <span class="token string">"HostName"</span><span class="token punctuation">:</span> <span class="token string">"localhost"</span><span class="token punctuation">,</span>
    <span class="token string">"UserName"</span><span class="token punctuation">:</span> <span class="token string">"admin"</span><span class="token punctuation">,</span>
    <span class="token string">"Password"</span><span class="token punctuation">:</span> <span class="token string">"123456"</span><span class="token punctuation">,</span>
    <span class="token string">"VirtualHost"</span><span class="token punctuation">:</span> <span class="token string">"geektime"</span><span class="token punctuation">,</span>
    <span class="token string">"ExchangeName"</span><span class="token punctuation">:</span> <span class="token string">"geek_queue"</span>
  <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这里可以看到我们定义了一个 RabbitMQ 的配置，然后这里面会有我们的 host，因为是本地安装的，所以访问地址就是 localhost，VirtualHost 是 RabbitMQ 一个比较特殊的设置，它的作用是将 RabbitMQ 的空间区分为不同的空间，你可以认为这是一个租户，相同的 VirtualHost，大家都可以认为是一个 RabbitMQ 的集群，最下面的 ExchangeName 就是队列需要订阅的 Exchange 的名称，消息的发布和订阅都是通过这个 Exchange 来的</p>
<p>然后我们在 Startup 这里添加一行</p>
<pre class="line-numbers language-csharp"><code class="language-csharp">services<span class="token punctuation">.</span><span class="token function">AddEventBus</span><span class="token punctuation">(</span>Configuration<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>这样我们就配置完成了</p>
<h2 id="33-集成事件：使用RabbitMQ来实现EventBus-1"><a href="#33-集成事件：使用RabbitMQ来实现EventBus-1" class="headerlink" title="33 | 集成事件：使用RabbitMQ来实现EventBus"></a>33 | 集成事件：使用RabbitMQ来实现EventBus</h2><p>为了演示我们的发布和订阅的话，我们在这里的代码做一些稍微的调整</p>
<pre class="line-numbers language-csharp"><code class="language-csharp"><span class="token keyword">namespace</span> GeekTime<span class="token punctuation">.</span>API<span class="token punctuation">.</span>Application<span class="token punctuation">.</span>DomainEventHandlers
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OrderCreatedDomainEventHandler</span> <span class="token punctuation">:</span> IDomainEventHandler<span class="token operator">&lt;</span>OrderCreatedDomainEvent<span class="token operator">></span>
    <span class="token punctuation">{</span>
        ICapPublisher _capPublisher<span class="token punctuation">;</span>
        <span class="token keyword">public</span> <span class="token function">OrderCreatedDomainEventHandler</span><span class="token punctuation">(</span>ICapPublisher capPublisher<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            _capPublisher <span class="token operator">=</span> capPublisher<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">public</span> <span class="token keyword">async</span> Task <span class="token function">Handle</span><span class="token punctuation">(</span>OrderCreatedDomainEvent notification<span class="token punctuation">,</span> CancellationToken cancellationToken<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token keyword">await</span> _capPublisher<span class="token punctuation">.</span><span class="token function">PublishAsync</span><span class="token punctuation">(</span><span class="token string">"OrderCreated"</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">OrderCreatedIntegrationEvent</span><span class="token punctuation">(</span>notification<span class="token punctuation">.</span>Order<span class="token punctuation">.</span>Id<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这里我们发布了一个 OrderCreated 的集成事件，然后订阅一个 OrderCreated</p>
<pre class="line-numbers language-csharp"><code class="language-csharp"><span class="token keyword">namespace</span> GeekTime<span class="token punctuation">.</span>API<span class="token punctuation">.</span>Application<span class="token punctuation">.</span>IntegrationEvents
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SubscriberService</span> <span class="token punctuation">:</span> ISubscriberService<span class="token punctuation">,</span> ICapSubscribe
    <span class="token punctuation">{</span>
        IMediator _mediator<span class="token punctuation">;</span>
        <span class="token keyword">public</span> <span class="token function">SubscriberService</span><span class="token punctuation">(</span>IMediator mediator<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            _mediator <span class="token operator">=</span> mediator<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token punctuation">[</span><span class="token function">CapSubscribe</span><span class="token punctuation">(</span><span class="token string">"OrderPaymentSucceeded"</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">OrderPaymentSucceeded</span><span class="token punctuation">(</span>OrderPaymentSucceededIntegrationEvent @<span class="token keyword">event</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">//Do SomeThing</span>
        <span class="token punctuation">}</span>

        <span class="token punctuation">[</span><span class="token function">CapSubscribe</span><span class="token punctuation">(</span><span class="token string">"OrderCreated"</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">OrderCreated</span><span class="token punctuation">(</span>OrderCreatedIntegrationEvent @<span class="token keyword">event</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">//Do SomeThing</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>通过标注属性，我们就可以完成订阅</p>
<p>也就是说我们创建一个订单的时，我们会触发订单创建的领域事件，订单创建的领域事件又发送了一个订单创建的集成事件，然后我们在订阅服务里面订阅了订单创建的集成事件</p>
<p>在发布和订阅的地方分别打上一个断点，启动程序，可以看到整个流程</p>
<p>我们再梳理一下整个流程，首先我们创建了一个订单，这个订单触发了我们的 OrderCreated 的领域事件，OrderCreated 的领域事件的处理器像我们的 EventBus 发布了一个 OrderCreated 的集成事件，我们在订阅服务的地方订阅了这个事件，所以我们可以接收到并且做出相应的处理</p>
<p>我们观察一下数据库的表，一共有四张表，cap.publish 和 cap.received 这两张表分别对应发送事件表和接收事件表，order 和 user 这两张表是我们的领域模型表</p>
<p>整个 CAP 的框架，它的实现原理其实有两个关键点，一个是事件表，一个就是事务控制，也就是说将事件的存储嵌入到我们的业务逻辑的事务里面去，这样子我们就可以保证我们的业务与事件是要么都能存储成功，要么都失败</p>
<p>整个 CAP 框架它的应用性是非常强的，非常建议在处理集成事件的时候使用这个框架</p>
<h2 id="34-MediatR：轻松实现命令查询职责分离模式（CQRS）"><a href="#34-MediatR：轻松实现命令查询职责分离模式（CQRS）" class="headerlink" title="34 | MediatR：轻松实现命令查询职责分离模式（CQRS）"></a>34 | MediatR：轻松实现命令查询职责分离模式（CQRS）</h2><p>核心对象</p>
<ul>
<li>IMeditator</li>
<li>IRequese、IRequest</li>
<li>IRequestHandler&lt;in TRequest, TResponse&gt;</li>
</ul>
<p>首先我们安装了 MediatR 的 8.0 的组件包，还安装了依赖注入框架的扩展包，以及依赖注入框架的核心组件包</p>
<ul>
<li>MediatR</li>
<li>MediatR.Extensions.Microsoft.DependencyInjection</li>
<li>Microsoft.Extensions.DependencyInjection</li>
</ul>
<p>大家可以观察到 MediatR 的包名和命名空间少了一个 o，猜测是作者故意这样设计的，因为它具体实现里面会有一个接口和类是 Mediator，如果设置同名的话会有一些引用上的问题</p>
<pre class="line-numbers language-csharp"><code class="language-csharp"><span class="token keyword">var</span> services <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ServiceCollection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

services<span class="token punctuation">.</span><span class="token function">AddMediatR</span><span class="token punctuation">(</span><span class="token keyword">typeof</span><span class="token punctuation">(</span>Program<span class="token punctuation">)</span><span class="token punctuation">.</span>Assembly<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>我们在这里构建一个 ServiceCollection，然后通过一行代码将我们当前的程序集注入进去，它就可以扫描我们当前程序集相关的类，下面看一下我们定义的两个类</p>
<pre class="line-numbers language-csharp"><code class="language-csharp"><span class="token keyword">internal</span> <span class="token keyword">class</span> <span class="token class-name">MyCommand</span> <span class="token punctuation">:</span> IRequest<span class="token operator">&lt;</span><span class="token keyword">long</span><span class="token operator">></span>
<span class="token punctuation">{</span> 
    <span class="token keyword">public</span> <span class="token keyword">string</span> CommandName <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">internal</span> <span class="token keyword">class</span> <span class="token class-name">MyCommandHandler</span> <span class="token punctuation">:</span> IRequestHandler<span class="token operator">&lt;</span>MyCommand<span class="token punctuation">,</span> <span class="token keyword">long</span><span class="token operator">></span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> Task<span class="token operator">&lt;</span><span class="token keyword">long</span><span class="token operator">></span> <span class="token function">Handle</span><span class="token punctuation">(</span>MyCommand request<span class="token punctuation">,</span> CancellationToken cancellationToken<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span>$<span class="token string">"MyCommandHandler执行命令：{request.CommandName}"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> Task<span class="token punctuation">.</span><span class="token function">FromResult</span><span class="token punctuation">(</span>10L<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>第一个类是 MyCommand，它实现了 IRequest 接口，这个接口就代表中介者要执行的命令</p>
<p>第二个类是 MyCommandHandler，它实现了 IRequestHandler 的接口，这个就是我们对命令的处理器的定义</p>
<pre class="line-numbers language-csharp"><code class="language-csharp"><span class="token keyword">var</span> serviceProvider <span class="token operator">=</span> services<span class="token punctuation">.</span><span class="token function">BuildServiceProvider</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> mediator <span class="token operator">=</span> serviceProvider<span class="token punctuation">.</span><span class="token generic-method function">GetService<span class="token punctuation">&lt;</span>IMediator<span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">await</span> mediator<span class="token punctuation">.</span><span class="token function">Send</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">MyCommand</span> <span class="token punctuation">{</span> CommandName <span class="token operator">=</span> <span class="token string">"cmd01"</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>我们从容器里面获取一个 IMediator，然后通过 send 方法发送一个 MyCommand 命令，我们构造了一个新的 MyCommand 的实例传给它</p>
<p>启动程序，输出如下：</p>
<pre><code>MyCommandHandler执行命令：cmd01</code></pre><p>我们可以看到 MyCommandHandler 的 Handle 方法执行了，它输出了 MyCommandHandler 的执行命令 cmd01</p>
<p>这样子，这个中介者它有什么好处呢?</p>
<p>大家可以看到，通过中介者模式，我们将命令的构造和命令的处理可以分离开，那么命令的处理如何知道要处理哪个命令呢，就是通过我们泛型的约束来定义的，我们这里为 IRequestHandler 填入了 MyCommand 类型，所以我们能明确知道 MyCommandHandler 是用来处理 MyCommand 的</p>
<p>如果说我在程序里面实现了多个 Handler，我们可以试验一下</p>
<pre class="line-numbers language-csharp"><code class="language-csharp"><span class="token keyword">internal</span> <span class="token keyword">class</span> <span class="token class-name">MyCommandHandlerV2</span> <span class="token punctuation">:</span> IRequestHandler<span class="token operator">&lt;</span>MyCommand<span class="token punctuation">,</span> <span class="token keyword">long</span><span class="token operator">></span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> Task<span class="token operator">&lt;</span><span class="token keyword">long</span><span class="token operator">></span> <span class="token function">Handle</span><span class="token punctuation">(</span>MyCommand request<span class="token punctuation">,</span> CancellationToken cancellationToken<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span>$<span class="token string">"MyCommandHandlerV2执行命令：{request.CommandName}"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> Task<span class="token punctuation">.</span><span class="token function">FromResult</span><span class="token punctuation">(</span>10L<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">internal</span> <span class="token keyword">class</span> <span class="token class-name">MyCommandHandler</span> <span class="token punctuation">:</span> IRequestHandler<span class="token operator">&lt;</span>MyCommand<span class="token punctuation">,</span> <span class="token keyword">long</span><span class="token operator">></span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> Task<span class="token operator">&lt;</span><span class="token keyword">long</span><span class="token operator">></span> <span class="token function">Handle</span><span class="token punctuation">(</span>MyCommand request<span class="token punctuation">,</span> CancellationToken cancellationToken<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span>$<span class="token string">"MyCommandHandler执行命令：{request.CommandName}"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> Task<span class="token punctuation">.</span><span class="token function">FromResult</span><span class="token punctuation">(</span>10L<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>启动程序，输出如下：</p>
<pre><code>MyCommandHandlerV2执行命令：cmd01</code></pre><p>大家可以看到我们输出的是 V2 执行命令</p>
<p>我们把代码进行一个调整，把这个定义移到后面</p>
<pre class="line-numbers language-csharp"><code class="language-csharp"><span class="token keyword">internal</span> <span class="token keyword">class</span> <span class="token class-name">MyCommandHandler</span> <span class="token punctuation">:</span> IRequestHandler<span class="token operator">&lt;</span>MyCommand<span class="token punctuation">,</span> <span class="token keyword">long</span><span class="token operator">></span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> Task<span class="token operator">&lt;</span><span class="token keyword">long</span><span class="token operator">></span> <span class="token function">Handle</span><span class="token punctuation">(</span>MyCommand request<span class="token punctuation">,</span> CancellationToken cancellationToken<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span>$<span class="token string">"MyCommandHandler执行命令：{request.CommandName}"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> Task<span class="token punctuation">.</span><span class="token function">FromResult</span><span class="token punctuation">(</span>10L<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">internal</span> <span class="token keyword">class</span> <span class="token class-name">MyCommandHandlerV2</span> <span class="token punctuation">:</span> IRequestHandler<span class="token operator">&lt;</span>MyCommand<span class="token punctuation">,</span> <span class="token keyword">long</span><span class="token operator">></span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> Task<span class="token operator">&lt;</span><span class="token keyword">long</span><span class="token operator">></span> <span class="token function">Handle</span><span class="token punctuation">(</span>MyCommand request<span class="token punctuation">,</span> CancellationToken cancellationToken<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span>$<span class="token string">"MyCommandHandlerV2执行命令：{request.CommandName}"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> Task<span class="token punctuation">.</span><span class="token function">FromResult</span><span class="token punctuation">(</span>10L<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>启动程序，输出如下：</p>
<pre><code>MyCommandHandler执行命令：cmd01</code></pre><p>大家可以看到我们这次输出的并不是 V2，而是之前的那个命令，为什么会这样子呢？是因为实际上 mediator 对于 IRequestHandler 的扫描，它是有顺序的，后面扫描到的会替换前面扫描到的 Handler，它只会识别其中最后注册进去的一个，也就是说我们在处理 RequestHandler 的时候，我们要注意在注册时仅注册需要的那个</p>
<p>我们再来看看我们的应用程序，回到我们之前的工程里</p>
<pre class="line-numbers language-csharp"><code class="language-csharp"><span class="token keyword">namespace</span> GeekTime<span class="token punctuation">.</span>API<span class="token punctuation">.</span>Application<span class="token punctuation">.</span>Commands
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CreateOrderCommandHandler</span> <span class="token punctuation">:</span> IRequestHandler<span class="token operator">&lt;</span>CreateOrderCommand<span class="token punctuation">,</span> <span class="token keyword">long</span><span class="token operator">></span>
    <span class="token punctuation">{</span>
        IOrderRepository _orderRepository<span class="token punctuation">;</span>
        ICapPublisher _capPublisher<span class="token punctuation">;</span>
        <span class="token keyword">public</span> <span class="token function">CreateOrderCommandHandler</span><span class="token punctuation">(</span>IOrderRepository orderRepository<span class="token punctuation">,</span> ICapPublisher capPublisher<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            _orderRepository <span class="token operator">=</span> orderRepository<span class="token punctuation">;</span>
            _capPublisher <span class="token operator">=</span> capPublisher<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">public</span> <span class="token keyword">async</span> Task<span class="token operator">&lt;</span><span class="token keyword">long</span><span class="token operator">></span> <span class="token function">Handle</span><span class="token punctuation">(</span>CreateOrderCommand request<span class="token punctuation">,</span> CancellationToken cancellationToken<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>

            <span class="token keyword">var</span> address <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Address</span><span class="token punctuation">(</span><span class="token string">"wen san lu"</span><span class="token punctuation">,</span> <span class="token string">"hangzhou"</span><span class="token punctuation">,</span> <span class="token string">"310000"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">var</span> order <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Order</span><span class="token punctuation">(</span><span class="token string">"xiaohong1999"</span><span class="token punctuation">,</span> <span class="token string">"xiaohong"</span><span class="token punctuation">,</span> <span class="token number">25</span><span class="token punctuation">,</span> address<span class="token punctuation">)</span><span class="token punctuation">;</span>

            _orderRepository<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span>order<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">await</span> _orderRepository<span class="token punctuation">.</span>UnitOfWork<span class="token punctuation">.</span><span class="token function">SaveEntitiesAsync</span><span class="token punctuation">(</span>cancellationToken<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> order<span class="token punctuation">.</span>Id<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>我们可以看到我们的 CreateOrderCommandHandler 实现的是 IRequestHandler，这也就是解释了为什么之前我们并没有显示的调用 CreateOrderCommandHandler，代码却能够执行到这里的原因</p>
<p>实际上我们在定义我的查询的时候，也可以这样定义，例如我们定义一个 MyOrderQuery，把订单的所有名称都输出出去</p>
<pre class="line-numbers language-csahrp"><code class="language-csahrp">namespace GeekTime.API.Application.Queries
{
    public class MyOrderQuery : IRequest<List<string>>
    {
        public MyOrderQuery(string userName) => UserName = userName;

        public string UserName { get; private set; }
    }
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>我们再定义一个查询器，这里就可以从各种地方查询到我们的数据然后返回出去</p>
<pre class="line-numbers language-csharp"><code class="language-csharp"><span class="token keyword">namespace</span> GeekTime<span class="token punctuation">.</span>API<span class="token punctuation">.</span>Application<span class="token punctuation">.</span>Queries
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyOrderQueryHandler</span> <span class="token punctuation">:</span> IRequestHandler<span class="token operator">&lt;</span>MyOrderQuery<span class="token punctuation">,</span> List<span class="token operator">&lt;</span><span class="token keyword">string</span><span class="token operator">></span><span class="token operator">></span>
    <span class="token punctuation">{</span>
        <span class="token keyword">public</span> Task<span class="token operator">&lt;</span>List<span class="token operator">&lt;</span><span class="token keyword">string</span><span class="token operator">></span><span class="token operator">></span> <span class="token function">Handle</span><span class="token punctuation">(</span>MyOrderQuery request<span class="token punctuation">,</span> CancellationToken cancellationToken<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token keyword">return</span> Task<span class="token punctuation">.</span><span class="token function">FromResult</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">List</span><span class="token operator">&lt;</span><span class="token keyword">string</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>实际上我们这样子就完成了查询和查询处理的定义</p>
<p>我们可以在 Controller 定义</p>
<pre class="line-numbers language-csharp"><code class="language-csharp"><span class="token punctuation">[</span>HttpGet<span class="token punctuation">]</span>
<span class="token keyword">public</span> <span class="token keyword">async</span> Task<span class="token operator">&lt;</span>List<span class="token operator">&lt;</span><span class="token keyword">string</span><span class="token operator">></span><span class="token operator">></span> <span class="token function">QueryOrder</span><span class="token punctuation">(</span><span class="token punctuation">[</span>FromBody<span class="token punctuation">]</span>MyOrderQuery myOrderQuery<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">await</span> _mediator<span class="token punctuation">.</span><span class="token function">Send</span><span class="token punctuation">(</span>myOrderQuery<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这样就完成了查询和查询处理逻辑的分离</p>
<p>我们执行命令是同样的实现方式，我们这样子做的话可以将我们的查询的输入和处理定义在一个目录下面，也可以将我们的命令的定义和命令的执行放在一个目录下面，使我们的 Controller 关注于身份认证或者基础设施缓存等等一些逻辑的处理，它不再关心说我的业务逻辑是怎么样子的</p>
<h2 id="35-MediatR：让领域事件处理更加优雅"><a href="#35-MediatR：让领域事件处理更加优雅" class="headerlink" title="35 | MediatR：让领域事件处理更加优雅"></a>35 | MediatR：让领域事件处理更加优雅</h2><p>核心对象</p>
<ul>
<li><p>IMediator</p>
</li>
<li><p>INotification</p>
</li>
<li><p>INotificationHandler</p>
</li>
</ul>
<p>这两个与之前的 Request 的行为是不一样的，接下来看一下代码</p>
<pre class="line-numbers language-csharp"><code class="language-csharp"><span class="token keyword">internal</span> <span class="token keyword">class</span> <span class="token class-name">MyEvent</span> <span class="token punctuation">:</span> INotification
<span class="token punctuation">{</span> 
    <span class="token keyword">public</span> <span class="token keyword">string</span> EventName <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">internal</span> <span class="token keyword">class</span> <span class="token class-name">MyEventHandler</span> <span class="token punctuation">:</span> INotificationHandler<span class="token operator">&lt;</span>MyEvent<span class="token operator">></span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> Task <span class="token function">Handle</span><span class="token punctuation">(</span>MyEvent notification<span class="token punctuation">,</span> CancellationToken cancellationToken<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span>$<span class="token string">"MyEventHandler执行：{notification.EventName}"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> Task<span class="token punctuation">.</span>CompletedTask<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">internal</span> <span class="token keyword">class</span> <span class="token class-name">MyEventHandlerV2</span> <span class="token punctuation">:</span> INotificationHandler<span class="token operator">&lt;</span>MyEvent<span class="token operator">></span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> Task <span class="token function">Handle</span><span class="token punctuation">(</span>MyEvent notification<span class="token punctuation">,</span> CancellationToken cancellationToken<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span>$<span class="token string">"MyEventHandlerV2执行：{notification.EventName}"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> Task<span class="token punctuation">.</span>CompletedTask<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-csharp"><code class="language-csharp"><span class="token comment" spellcheck="true">//await mediator.Send(new MyCommand { CommandName = "cmd01" });</span>
<span class="token keyword">await</span> mediator<span class="token punctuation">.</span><span class="token function">Publish</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">MyEvent</span> <span class="token punctuation">{</span> EventName <span class="token operator">=</span> <span class="token string">"event01"</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>之前 mediator 使用了 Send 的方式来处理 Command，它还有一个方法 Publish，这个方法的入参是一个 INotification</p>
<p>启动程序，输出如下：</p>
<pre class="line-numbers language-csharp"><code class="language-csharp">MyEventHandler执行：event01
MyEventHandlerV2执行：event01<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>与之前的 IRequest 不同的是，INotification 是可以注册多个 Handler 的，它是一个一对多的关系，借助它就可以对领域事件定义多个处理器来处理</p>
<p>接着看一下之前云服务的代码</p>
<pre class="line-numbers language-csharp"><code class="language-csharp"><span class="token keyword">public</span> <span class="token keyword">async</span> Task<span class="token operator">&lt;</span><span class="token keyword">bool</span><span class="token operator">></span> <span class="token function">SaveEntitiesAsync</span><span class="token punctuation">(</span>CancellationToken cancellationToken <span class="token operator">=</span> <span class="token keyword">default</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">var</span> result <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">base</span><span class="token punctuation">.</span><span class="token function">SaveChangesAsync</span><span class="token punctuation">(</span>cancellationToken<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">await</span> _mediator<span class="token punctuation">.</span><span class="token function">DispatchDomainEventsAsync</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token keyword">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>之前在 IUnitOfWork 定义的时候讲过一个发送领域事件的方法 DispatchDomainEventsAsync，看一下这个方法的定义</p>
<pre class="line-numbers language-csharp"><code class="language-csharp"><span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">MediatorExtension</span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">async</span> Task <span class="token function">DispatchDomainEventsAsync</span><span class="token punctuation">(</span><span class="token keyword">this</span> IMediator mediator<span class="token punctuation">,</span> DbContext ctx<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">var</span> domainEntities <span class="token operator">=</span> ctx<span class="token punctuation">.</span>ChangeTracker
            <span class="token punctuation">.</span><span class="token generic-method function">Entries<span class="token punctuation">&lt;</span>Entity<span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">Where</span><span class="token punctuation">(</span>x <span class="token operator">=</span><span class="token operator">></span> x<span class="token punctuation">.</span>Entity<span class="token punctuation">.</span>DomainEvents <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> x<span class="token punctuation">.</span>Entity<span class="token punctuation">.</span>DomainEvents<span class="token punctuation">.</span><span class="token function">Any</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">var</span> domainEvents <span class="token operator">=</span> domainEntities
            <span class="token punctuation">.</span><span class="token function">SelectMany</span><span class="token punctuation">(</span>x <span class="token operator">=</span><span class="token operator">></span> x<span class="token punctuation">.</span>Entity<span class="token punctuation">.</span>DomainEvents<span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">ToList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        domainEntities<span class="token punctuation">.</span><span class="token function">ToList</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">ForEach</span><span class="token punctuation">(</span>entity <span class="token operator">=</span><span class="token operator">></span> entity<span class="token punctuation">.</span>Entity<span class="token punctuation">.</span><span class="token function">ClearDomainEvents</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token keyword">var</span> domainEvent <span class="token keyword">in</span> domainEvents<span class="token punctuation">)</span>
            <span class="token keyword">await</span> mediator<span class="token punctuation">.</span><span class="token function">Publish</span><span class="token punctuation">(</span>domainEvent<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>可以看到这里是将所有的实体内的领域事件全部都查找出来，然后通过 mediator 的 Publish 发送领域事件，具体的领域事件的处理注册在 mediator 里面，这里定义了一个 OrderCreatedDomainEventHandler</p>
<pre class="line-numbers language-csharp"><code class="language-csharp"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OrderCreatedDomainEventHandler</span> <span class="token punctuation">:</span> IDomainEventHandler<span class="token operator">&lt;</span>OrderCreatedDomainEvent<span class="token operator">></span>
<span class="token punctuation">{</span>
    ICapPublisher _capPublisher<span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token function">OrderCreatedDomainEventHandler</span><span class="token punctuation">(</span>ICapPublisher capPublisher<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        _capPublisher <span class="token operator">=</span> capPublisher<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">async</span> Task <span class="token function">Handle</span><span class="token punctuation">(</span>OrderCreatedDomainEvent notification<span class="token punctuation">,</span> CancellationToken cancellationToken<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">await</span> _capPublisher<span class="token punctuation">.</span><span class="token function">PublishAsync</span><span class="token punctuation">(</span><span class="token string">"OrderCreated"</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">OrderCreatedIntegrationEvent</span><span class="token punctuation">(</span>notification<span class="token punctuation">.</span>Order<span class="token punctuation">.</span>Id<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>它继承自 IDomainEventHandler，而 IDomainEventHandler 继承自 INotificationHandler</p>
<pre class="line-numbers language-csharp"><code class="language-csharp"><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">IDomainEventHandler</span><span class="token operator">&lt;</span>TDomainEvent<span class="token operator">></span> <span class="token punctuation">:</span> INotificationHandler<span class="token operator">&lt;</span>TDomainEvent<span class="token operator">></span> 
    <span class="token keyword">where</span> TDomainEvent <span class="token punctuation">:</span> IDomainEvent
<span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">//这里我们使用了INotificationHandler的Handle方法来作为处理方法的定义</span>
    Task <span class="token function">Handle</span><span class="token punctuation">(</span>TDomainEvent domainEvent<span class="token punctuation">,</span> CancellationToken cancellationToken<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这也就是为什么 IDomainEventHandler 会识别到 DomainEvent 并且进行处理，同样的在定义 DomainEvent 的时候，也需要标识它是一个 DomainEvent</p>
<pre class="line-numbers language-csharp"><code class="language-csharp"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OrderCreatedDomainEvent</span> <span class="token punctuation">:</span> IDomainEvent
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> Order Order <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">private</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token function">OrderCreatedDomainEvent</span><span class="token punctuation">(</span>Order order<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>Order <span class="token operator">=</span> order<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>而 DomainEvent 实际上也是继承自 INotification</p>
<pre class="line-numbers language-csharp"><code class="language-csharp"><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">IDomainEvent</span> <span class="token punctuation">:</span> INotification
<span class="token punctuation">{</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>这也就意味着 EventHandler 可以正确的识别到对应的 Event 并且进行处理，这都是 MediatR 的核心能力</p>
<p>领域事件都是定义在 event 目录下，与领域模型定义在一起，所有的领域事件都继承 DomainEvent，分布于这个目录</p>
<p>领域事件的处理 Handler 都定义在 Application 应用层的 Application 下面的 DomainEventHandlers 目录下面</p>
<p>这样的好处是事件的定义与事件的处理是分开的，并且非常的明确知道有哪些领域事件，有哪些领域事件的处理程序</p>
<p>关于 MediatR 再补充一部分内容，在 TransactionBehavior 内可以看到这个类实际上继承自 IPipelineBehavior</p>
<pre class="line-numbers language-csharp"><code class="language-csharp"><span class="token keyword">namespace</span> MediatR
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">IPipelineBehavior</span><span class="token operator">&lt;</span><span class="token keyword">in</span> TRequest<span class="token punctuation">,</span> TResponse<span class="token operator">></span>
    <span class="token punctuation">{</span>
        Task<span class="token operator">&lt;</span>TResponse<span class="token operator">></span> <span class="token function">Handle</span><span class="token punctuation">(</span>TRequest request<span class="token punctuation">,</span> CancellationToken cancellationToken<span class="token punctuation">,</span> RequestHandlerDelegate<span class="token operator">&lt;</span>TResponse<span class="token operator">></span> next<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这个接口的作用是在命令或者事件处理的之前或者之后插入逻辑，它的执行的方式有点像中间件的方式，在 Handler 的入参里面有一个 next 的参数，就是指 CommandHandler 或者 EventHandler 的执行的逻辑，在这里就可以决定 Handler 的具体执行之前或者之后，插入一些逻辑</p>
<pre class="line-numbers language-csharp"><code class="language-csharp"><span class="token keyword">public</span> <span class="token keyword">async</span> Task<span class="token operator">&lt;</span>TResponse<span class="token operator">></span> <span class="token function">Handle</span><span class="token punctuation">(</span>TRequest request<span class="token punctuation">,</span> CancellationToken cancellationToken<span class="token punctuation">,</span> RequestHandlerDelegate<span class="token operator">&lt;</span>TResponse<span class="token operator">></span> next<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">var</span> response <span class="token operator">=</span> <span class="token keyword">default</span><span class="token punctuation">(</span>TResponse<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">var</span> typeName <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">GetGenericTypeName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">try</span>
    <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// 首先判断当前是否有开启事务</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>_dbContext<span class="token punctuation">.</span>HasActiveTransaction<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token keyword">await</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment" spellcheck="true">// 定义了一个数据库操作执行的策略，比如说可以在里面嵌入一些重试的逻辑，这里创建了一个默认的策略</span>
        <span class="token keyword">var</span> strategy <span class="token operator">=</span> _dbContext<span class="token punctuation">.</span>Database<span class="token punctuation">.</span><span class="token function">CreateExecutionStrategy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">await</span> strategy<span class="token punctuation">.</span><span class="token function">ExecuteAsync</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span>
        <span class="token punctuation">{</span>
            Guid transactionId<span class="token punctuation">;</span>
            <span class="token keyword">using</span> <span class="token punctuation">(</span><span class="token keyword">var</span> transaction <span class="token operator">=</span> <span class="token keyword">await</span> _dbContext<span class="token punctuation">.</span><span class="token function">BeginTransactionAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">using</span> <span class="token punctuation">(</span>_logger<span class="token punctuation">.</span><span class="token function">BeginScope</span><span class="token punctuation">(</span><span class="token string">"TransactionContext:{TransactionId}"</span><span class="token punctuation">,</span> transaction<span class="token punctuation">.</span>TransactionId<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                _logger<span class="token punctuation">.</span><span class="token function">LogInformation</span><span class="token punctuation">(</span><span class="token string">"----- 开始事务 {TransactionId} ({@Command})"</span><span class="token punctuation">,</span> transaction<span class="token punctuation">.</span>TransactionId<span class="token punctuation">,</span> typeName<span class="token punctuation">,</span> request<span class="token punctuation">)</span><span class="token punctuation">;</span>

                response <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// next 实际上是指我们的后续操作，这里的模式有点像之前讲的中间件模式</span>

                _logger<span class="token punctuation">.</span><span class="token function">LogInformation</span><span class="token punctuation">(</span><span class="token string">"----- 提交事务 {TransactionId} {CommandName}"</span><span class="token punctuation">,</span> transaction<span class="token punctuation">.</span>TransactionId<span class="token punctuation">,</span> typeName<span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token keyword">await</span> _dbContext<span class="token punctuation">.</span><span class="token function">CommitTransactionAsync</span><span class="token punctuation">(</span>transaction<span class="token punctuation">)</span><span class="token punctuation">;</span>

                transactionId <span class="token operator">=</span> transaction<span class="token punctuation">.</span>TransactionId<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> response<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> ex<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        _logger<span class="token punctuation">.</span><span class="token function">LogError</span><span class="token punctuation">(</span>ex<span class="token punctuation">,</span> <span class="token string">"处理事务出错 {CommandName} ({@Command})"</span><span class="token punctuation">,</span> typeName<span class="token punctuation">,</span> request<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">throw</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这里实现里在执行命令之前判断事务是否开启，如果事务开启的话继续执行后面的逻辑，如果事务没有开启，先开启事务，再执行后面的逻辑</p>
<script>
        document.querySelectorAll('.github-emoji')
          .forEach(el => {
            if (!el.dataset.src) { return; }
            const img = document.createElement('img');
            img.style = 'display:none !important;';
            img.src = el.dataset.src;
            img.addEventListener('error', () => {
              img.remove();
              el.style.color = 'inherit';
              el.style.backgroundImage = 'none';
              el.style.background = 'none';
            });
            img.addEventListener('load', () => {
              img.remove();
            });
            document.body.appendChild(img);
          });
      </script>
            </div>
            <hr/>

            

    <div class="reprint" id="reprint-statement">
        
            <div class="reprint__author">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-user">
                        文章作者:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="https://www.zhengchaoqiang.com" rel="external nofollow noreferrer">Chaoqiang</a>
                </span>
            </div>
            <div class="reprint__type">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-link">
                        文章链接:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="https://www.zhengchaoqiang.com/2020/05/02/netcore-programing-and-practice2/">https://www.zhengchaoqiang.com/2020/05/02/netcore-programing-and-practice2/</a>
                </span>
            </div>
            <div class="reprint__notice">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-copyright">
                        版权声明:
                    </i>
                </span>
                <span class="reprint-info">
                    本博客所有文章除特別声明外，均采用
                    <a href="https://creativecommons.org/licenses/by/4.0/deed.zh" rel="external nofollow noreferrer" target="_blank">CC BY 4.0</a>
                    许可协议。转载请注明来源
                    <a href="https://www.zhengchaoqiang.com" target="_blank">Chaoqiang</a>
                    !
                </span>
            </div>
        
    </div>

    <script async defer>
      document.addEventListener("copy", function (e) {
        let toastHTML = '<span>复制成功，请遵循本文的转载规则</span><button class="btn-flat toast-action" onclick="navToReprintStatement()" style="font-size: smaller">查看</a>';
        M.toast({html: toastHTML})
      });

      function navToReprintStatement() {
        $("html, body").animate({scrollTop: $("#reprint-statement").offset().top - 80}, 800);
      }
    </script>



            <div class="tag_share" style="display: block;">
                <div class="post-meta__tag-list" style="display: inline-block;">
                    
                        <div class="article-tag">
                            
                                <a href="/tags/Net-Core/">
                                    <span class="chip bg-color">Net Core</span>
                                </a>
                            
                        </div>
                    
                </div>
                <div class="post_share" style="zoom: 80%; width: fit-content; display: inline-block; float: right; margin: -0.15rem 0;">
                    <link rel="stylesheet" type="text/css" href="/libs/share/css/share.min.css">

<div id="article-share">
    
    
    <div class="social-share" data-sites="twitter,facebook,google,qq,qzone,wechat,weibo,douban,linkedin" data-wechat-qrcode-helper="<p>微信扫一扫即可分享！</p>"></div>
    <script src="/libs/share/js/social-share.min.js"></script>
    

    

</div>

                </div>
            </div>
            
                <style>
    #reward {
        margin: 40px 0;
        text-align: center;
    }

    #reward .reward-link {
        font-size: 1.4rem;
        line-height: 38px;
    }

    #reward .btn-floating:hover {
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.2), 0 5px 15px rgba(0, 0, 0, 0.2);
    }

    #rewardModal {
        width: 320px;
        height: 350px;
    }

    #rewardModal .reward-title {
        margin: 15px auto;
        padding-bottom: 5px;
    }

    #rewardModal .modal-content {
        padding: 10px;
    }

    #rewardModal .close {
        position: absolute;
        right: 15px;
        top: 15px;
        color: rgba(0, 0, 0, 0.5);
        font-size: 1.3rem;
        line-height: 20px;
        cursor: pointer;
    }

    #rewardModal .close:hover {
        color: #ef5350;
        transform: scale(1.3);
        -moz-transform:scale(1.3);
        -webkit-transform:scale(1.3);
        -o-transform:scale(1.3);
    }

    #rewardModal .reward-tabs {
        margin: 0 auto;
        width: 210px;
    }

    .reward-tabs .tabs {
        height: 38px;
        margin: 10px auto;
        padding-left: 0;
    }

    .reward-content ul {
        padding-left: 0 !important;
    }

    .reward-tabs .tabs .tab {
        height: 38px;
        line-height: 38px;
    }

    .reward-tabs .tab a {
        color: #fff;
        background-color: #ccc;
    }

    .reward-tabs .tab a:hover {
        background-color: #ccc;
        color: #fff;
    }

    .reward-tabs .wechat-tab .active {
        color: #fff !important;
        background-color: #22AB38 !important;
    }

    .reward-tabs .alipay-tab .active {
        color: #fff !important;
        background-color: #019FE8 !important;
    }

    .reward-tabs .reward-img {
        width: 210px;
        height: 210px;
    }
</style>

<div id="reward">
    <a href="#rewardModal" class="reward-link modal-trigger btn-floating btn-medium waves-effect waves-light red">赏</a>

    <!-- Modal Structure -->
    <div id="rewardModal" class="modal">
        <div class="modal-content">
            <a class="close modal-close"><i class="fas fa-times"></i></a>
            <h4 class="reward-title">你要请我吃糖嘛!</h4>
            <div class="reward-content">
                <div class="reward-tabs">
                    <ul class="tabs row">
                        <li class="tab col s6 alipay-tab waves-effect waves-light"><a href="#alipay">支付宝</a></li>
                        <li class="tab col s6 wechat-tab waves-effect waves-light"><a href="#wechat">微 信</a></li>
                    </ul>
                    <div id="alipay">
                        <img src="" class="reward-img" alt="支付宝打赏二维码">
                    </div>
                    <div id="wechat">
                        <img src="/medias/reward/wechatpay.png" class="reward-img" alt="微信打赏二维码">
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    $(function () {
        $('.tabs').tabs();
    });
</script>
            
        </div>
    </div>

    

    

    

    

    
        <style>
    .valine-card {
        margin: 1.5rem auto;
    }

    .valine-card .card-content {
        padding: 20px 20px 5px 20px;
    }

    #vcomments textarea {
        box-sizing: border-box;
        background: url("/medias/comment_bg.png") 100% 100% no-repeat;
    }

    #vcomments p {
        margin: 2px 2px 10px;
        font-size: 1.05rem;
        line-height: 1.78rem;
    }

    #vcomments blockquote p {
        text-indent: 0.2rem;
    }

    #vcomments a {
        padding: 0 2px;
        color: #4cbf30;
        font-weight: 500;
        text-decoration: none;
    }

    #vcomments img {
        max-width: 100%;
        height: auto;
        cursor: pointer;
    }

    #vcomments ol li {
        list-style-type: decimal;
    }

    #vcomments ol,
    ul {
        display: block;
        padding-left: 2em;
        word-spacing: 0.05rem;
    }

    #vcomments ul li,
    ol li {
        display: list-item;
        line-height: 1.8rem;
        font-size: 1rem;
    }

    #vcomments ul li {
        list-style-type: disc;
    }

    #vcomments ul ul li {
        list-style-type: circle;
    }

    #vcomments table, th, td {
        padding: 12px 13px;
        border: 1px solid #dfe2e5;
    }

    #vcomments table, th, td {
        border: 0;
    }

    table tr:nth-child(2n), thead {
        background-color: #fafafa;
    }

    #vcomments table th {
        background-color: #f2f2f2;
        min-width: 80px;
    }

    #vcomments table td {
        min-width: 80px;
    }

    #vcomments h1 {
        font-size: 1.85rem;
        font-weight: bold;
        line-height: 2.2rem;
    }

    #vcomments h2 {
        font-size: 1.65rem;
        font-weight: bold;
        line-height: 1.9rem;
    }

    #vcomments h3 {
        font-size: 1.45rem;
        font-weight: bold;
        line-height: 1.7rem;
    }

    #vcomments h4 {
        font-size: 1.25rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    #vcomments h5 {
        font-size: 1.1rem;
        font-weight: bold;
        line-height: 1.4rem;
    }

    #vcomments h6 {
        font-size: 1rem;
        line-height: 1.3rem;
    }

    #vcomments p {
        font-size: 1rem;
        line-height: 1.5rem;
    }

    #vcomments hr {
        margin: 12px 0;
        border: 0;
        border-top: 1px solid #ccc;
    }

    #vcomments blockquote {
        margin: 15px 0;
        border-left: 5px solid #42b983;
        padding: 1rem 0.8rem 0.3rem 0.8rem;
        color: #666;
        background-color: rgba(66, 185, 131, .1);
    }

    #vcomments pre {
        font-family: monospace, monospace;
        padding: 1.2em;
        margin: .5em 0;
        background: #272822;
        overflow: auto;
        border-radius: 0.3em;
        tab-size: 4;
    }

    #vcomments code {
        font-family: monospace, monospace;
        padding: 1px 3px;
        font-size: 0.92rem;
        color: #e96900;
        background-color: #f8f8f8;
        border-radius: 2px;
    }

    #vcomments pre code {
        font-family: monospace, monospace;
        padding: 0;
        color: #e8eaf6;
        background-color: #272822;
    }

    #vcomments pre[class*="language-"] {
        padding: 1.2em;
        margin: .5em 0;
    }

    #vcomments code[class*="language-"],
    pre[class*="language-"] {
        color: #e8eaf6;
    }

    #vcomments [type="checkbox"]:not(:checked), [type="checkbox"]:checked {
        position: inherit;
        margin-left: -1.3rem;
        margin-right: 0.4rem;
        margin-top: -1px;
        vertical-align: middle;
        left: unset;
        visibility: visible;
    }

    #vcomments b,
    strong {
        font-weight: bold;
    }

    #vcomments dfn {
        font-style: italic;
    }

    #vcomments small {
        font-size: 85%;
    }

    #vcomments cite {
        font-style: normal;
    }

    #vcomments mark {
        background-color: #fcf8e3;
        padding: .2em;
    }

    #vcomments table, th, td {
        padding: 12px 13px;
        border: 1px solid #dfe2e5;
    }

    table tr:nth-child(2n), thead {
        background-color: #fafafa;
    }

    #vcomments table th {
        background-color: #f2f2f2;
        min-width: 80px;
    }

    #vcomments table td {
        min-width: 80px;
    }

    #vcomments [type="checkbox"]:not(:checked), [type="checkbox"]:checked {
        position: inherit;
        margin-left: -1.3rem;
        margin-right: 0.4rem;
        margin-top: -1px;
        vertical-align: middle;
        left: unset;
        visibility: visible;
    }
</style>

<div class="card valine-card" data-aos="fade-up">
    <div class="comment_headling" style="font-size: 20px; font-weight: 700; position: relative; left: 20px; top: 15px; padding-bottom: 5px;">
        <i class="fas fa-comments fa-fw" aria-hidden="true"></i>
        <span>评论</span>
    </div>
    <div id="vcomments" class="card-content" style="display: grid">
    </div>
</div>

<script src="/libs/valine/av-min.js"></script>
<script src="/libs/valine/Valine.min.js"></script>
<script>
    new Valine({
        el: '#vcomments',
        appId: 'n7QWLgVufdyFqbDlUDEznVhx-gzGzoHsz',
        appKey: 'YGPdAIijkOPzqgi0LlHI52ex',
        notify: 'true' === 'true',
        verify: 'true' === 'true',
        visitor: 'true' === 'true',
        avatar: 'mm',
        pageSize: '10',
        lang: 'zh-cn',
        placeholder: 'just go go'
    });
</script>

    

    

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge left-badge text-color">
                <i class="fas fa-chevron-left"></i>&nbsp;上一篇</div>
            <div class="card">
                <a href="/2020/05/23/netcore-authentication-authorization/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/2.jpg" class="responsive-img" alt="Netcore认证授权与IdentityServer4（1）鉴权授权源码">
                        
                        <span class="card-title">Netcore认证授权与IdentityServer4（1）鉴权授权源码</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            主要概要这个文章主要来聊一聊Net Core中的认证与授权，以及Net Core生态中非常火热的IdentityServer4这个组件的使用，主要内容如下：

鉴权授权流程变化
源码解读鉴权
源码解读多授权策略
JWT和Identity


                        
                    </div>
                    <div class="publish-info">
                        <span class="publish-date">
                            <i class="far fa-clock fa-fw icon-date"></i>2020-05-23
                        </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/Net-Core-Learning-Series/" class="post-category">
                                    .Net Core Learning Series
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/Net-Core/">
                        <span class="chip bg-color">Net Core</span>
                    </a>
                    
                    <a href="/tags/Authentication/">
                        <span class="chip bg-color">Authentication</span>
                    </a>
                    
                    <a href="/tags/Authorization/">
                        <span class="chip bg-color">Authorization</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge right-badge text-color">
                下一篇&nbsp;<i class="fas fa-chevron-right"></i>
            </div>
            <div class="card">
                <a href="/2020/04/19/netcore-programing-and-practice/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/20.jpg" class="responsive-img" alt="NetCore 开发实战（1）——必备知识">
                        
                        <span class="card-title">NetCore 开发实战（1）——必备知识</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            01 | 简介为什么要学习 .NET Core
微软大力支持推动 .Net 技术生态发展
跨平台：更多的开发环境和部署环境选择，尤其是对 Docker 和 Kubernetes 的良好支持，快速构建微服务并部署到云基础设施中，实现高可用，可
                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="far fa-clock fa-fw icon-date"></i>2020-04-19
                            </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/NetCore-开发实战/" class="post-category">
                                    NetCore 开发实战
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/Net-Core/">
                        <span class="chip bg-color">Net Core</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
    </div>
</article>

</div>


<script>
    $('#articleContent').on('copy', function (e) {
        // IE8 or earlier browser is 'undefined'
        if (typeof window.getSelection === 'undefined') return;

        var selection = window.getSelection();
        // if the selection is short let's not annoy our users.
        if (('' + selection).length < Number.parseInt('120')) {
            return;
        }

        // create a div outside of the visible area and fill it with the selected text.
        var bodyElement = document.getElementsByTagName('body')[0];
        var newdiv = document.createElement('div');
        newdiv.style.position = 'absolute';
        newdiv.style.left = '-99999px';
        bodyElement.appendChild(newdiv);
        newdiv.appendChild(selection.getRangeAt(0).cloneContents());

        // we need a <pre> tag workaround.
        // otherwise the text inside "pre" loses all the line breaks!
        if (selection.getRangeAt(0).commonAncestorContainer.nodeName === 'PRE') {
            newdiv.innerHTML = "<pre>" + newdiv.innerHTML + "</pre>";
        }

        var url = document.location.href;
        newdiv.innerHTML += '<br />'
            + '来源: chaoqiang&#39;s Blog<br />'
            + '文章作者: chaoqiang<br />'
            + '文章链接: <a href="' + url + '">' + url + '</a><br />'
            + '本文章著作权归作者所有，任何形式的转载都请注明出处。';

        selection.selectAllChildren(newdiv);
        window.setTimeout(function () {bodyElement.removeChild(newdiv);}, 200);
    });
</script>


<!-- 代码块功能依赖 -->
<script type="text/javascript" src="/libs/codeBlock/codeBlockFuction.js"></script>

<!-- 代码语言 -->

<script type="text/javascript" src="/libs/codeBlock/codeLang.js"></script>


<!-- 代码块复制 -->

<script type="text/javascript" src="/libs/codeBlock/codeCopy.js"></script>


<!-- 代码块收缩 -->

<script type="text/javascript" src="/libs/codeBlock/codeShrink.js"></script>


<!-- 代码块折行 -->

<style type="text/css">
code[class*="language-"], pre[class*="language-"] { white-space: pre !important; }
</style>


    </div>
    <div id="toc-aside" class="expanded col l3 hide-on-med-and-down">
        <div class="toc-widget">
            <div class="toc-title"><i class="far fa-list-alt"></i>&nbsp;&nbsp;目录</div>
            <div id="toc-content"></div>
        </div>
    </div>
</div>

<!-- TOC 悬浮按钮. -->

<div id="floating-toc-btn" class="hide-on-med-and-down">
    <a class="btn-floating btn-large bg-color">
        <i class="fas fa-list-ul"></i>
    </a>
</div>


<script src="/libs/tocbot/tocbot.min.js"></script>
<script>
    $(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            collapseDepth: Number('0'),
            headingSelector: 'h2, h3, h4'
        });

        // modify the toc link href to support Chinese.
        let i = 0;
        let tocHeading = 'toc-heading-';
        $('#toc-content a').each(function () {
            $(this).attr('href', '#' + tocHeading + (++i));
        });

        // modify the heading title id to support Chinese.
        i = 0;
        $('#articleContent').children('h2, h3, h4').each(function () {
            $(this).attr('id', tocHeading + (++i));
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });

        
        /* 修复文章卡片 div 的宽度. */
        let fixPostCardWidth = function (srcId, targetId) {
            let srcDiv = $('#' + srcId);
            if (srcDiv.length === 0) {
                return;
            }

            let w = srcDiv.width();
            if (w >= 450) {
                w = w + 21;
            } else if (w >= 350 && w < 450) {
                w = w + 18;
            } else if (w >= 300 && w < 350) {
                w = w + 16;
            } else {
                w = w + 14;
            }
            $('#' + targetId).width(w);
        };

        // 切换TOC目录展开收缩的相关操作.
        const expandedClass = 'expanded';
        let $tocAside = $('#toc-aside');
        let $mainContent = $('#main-content');
        $('#floating-toc-btn .btn-floating').click(function () {
            if ($tocAside.hasClass(expandedClass)) {
                $tocAside.removeClass(expandedClass).hide();
                $mainContent.removeClass('l9');
            } else {
                $tocAside.addClass(expandedClass).show();
                $mainContent.addClass('l9');
            }
            fixPostCardWidth('artDetail', 'prenext-posts');
        });
        
    });
</script>

    

</main>



    <footer class="page-footer bg-color">
    <div class="container row center-align">
        <div class="col s12 m8 l8 copy-right">
            <span>
                <div>
                    <span style="color:#ffffff;">Copyright&copy; 2020 chaoqiang. All Rights Reserved</span>
                </div>
                
                <div style="width:500px;margin:0 auto; padding:0px 0;">
                    <a target="_blank" href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=32050702010849" style="display:inline-block;text-decoration:none;height:20px;line-height:20px;">
                        <img src="https://blog-icp-1257411902.cos.ap-shanghai.myqcloud.com/icp.png" style="float:left;"/>
                        <span style="float:left;height:20px;line-height:20px;margin: 0px 0px 0px 5px; color:#ffffff;">苏公网安备 32050702010849号 苏ICP备20017637号</span>
                    </a>
                    <!-- <span style="height:20px;line-height:20px;margin: 0px 0px 0px 5px; color:#ffffff;"> 苏ICP备20017637号</span> -->
                </div>
            </span>
            <span id="sitetime"></span>
        </div>

    
    </div>
</footer>

<div class="progress-bar"></div>

<script language=javascript>
    function siteTime() {
        window.setTimeout("siteTime()", 1000);
        var seconds = 1000;
        var minutes = seconds * 60;
        var hours = minutes * 60;
        var days = hours * 24;
        var years = days * 365;
        var today = new Date();
        var todayYear = today.getFullYear();
        var todayMonth = today.getMonth() + 1;
        var todayDate = today.getDate();
        var todayHour = today.getHours();
        var todayMinute = today.getMinutes();
        var todaySecond = today.getSeconds();

        /* Date.UTC() -- 返回date对象距世界标准时间(UTC)1970年1月1日午夜之间的毫秒数(时间戳)
        year - 作为date对象的年份，为4位年份值
        month - 0-11之间的整数，做为date对象的月份
        day - 1-31之间的整数，做为date对象的天数
        hours - 0(午夜24点)-23之间的整数，做为date对象的小时数
        minutes - 0-59之间的整数，做为date对象的分钟数
        seconds - 0-59之间的整数，做为date对象的秒数
        microseconds - 0-999之间的整数，做为date对象的毫秒数 */

        var t1 = Date.UTC(2019, 08, 10, 00, 00, 00); //北京时间2019-8-1 00:00:00
        var t2 = Date.UTC(todayYear, todayMonth, todayDate, todayHour, todayMinute, todaySecond);
        var diff = t2 - t1;
        var diffYears = Math.floor(diff / years);
        var diffDays = Math.floor((diff / days) - diffYears * 365);
        var diffHours = Math.floor((diff - (diffYears * 365 + diffDays) * days) / hours);
        var diffMinutes = Math.floor((diff - (diffYears * 365 + diffDays) * days - diffHours * hours) / minutes);
        var diffSeconds = Math.floor((diff - (diffYears * 365 + diffDays) * days - diffHours * hours - diffMinutes *
            minutes) / seconds);
        document.getElementById("sitetime").innerHTML = "本站已勉强运行 " + diffYears + " 年 " + diffDays + " 天 " + diffHours +
            " 小时 " + diffMinutes + " 分钟 " + diffSeconds + " 秒" ;
    } /*因为建站时间还没有一年，就将之注释掉了。需要的可以取消*/
    siteTime();
</script>






    <!-- 搜索遮罩框 -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fas fa-search"></i>&nbsp;&nbsp;搜索</span>
            <input type="search" id="searchInput" name="s" placeholder="请输入搜索的关键字"
                   class="search-input">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script src="/js/search.js"></script>
<script type="text/javascript">
$(function () {
    searchFunc("/" + "search.xml", 'searchInput', 'searchResult');
});
</script>
    <!-- 回到顶部按钮 -->
<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fas fa-arrow-up"></i>
    </a>
</div>


    <script src="/libs/materialize/materialize.min.js"></script>
    <script src="/libs/masonry/masonry.pkgd.min.js"></script>
    <script src="/libs/aos/aos.js"></script>
    <script src="/libs/scrollprogress/scrollProgress.min.js"></script>
    <script src="/libs/lightGallery/js/lightgallery-all.min.js"></script>
    <script src="/js/matery.js"></script>

    <!-- Global site tag (gtag.js) - Google Analytics -->


    <!-- Baidu Analytics -->

    <!-- Baidu Push -->

<script>
    (function () {
        var bp = document.createElement('script');
        var curProtocol = window.location.protocol.split(':')[0];
        if (curProtocol === 'https') {
            bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
        } else {
            bp.src = 'http://push.zhanzhang.baidu.com/push.js';
        }
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(bp, s);
    })();
</script>

    
    <script src="/libs/others/clicklove.js" async="async"></script>
    
    
    <script async src="/libs/others/busuanzi.pure.mini.js"></script>
    

    

    

    
    <script type="text/javascript" color="0,0,255"
        pointColor="0,0,255" opacity='0.7'
        zIndex="-1" count="99"
        src="/libs/background/canvas-nest.js"></script>
    

    

    
    
    
    <script src="/libs/instantpage/instantpage.js" type="module"></script>
    

     <!-- Chaoqiang shw2018 add 2019.08.28 -->
     <script type="text/javascript">
        var OriginTitile = document.title,
            st;
        document.addEventListener("visibilitychange", function () {
            document.hidden ? (document.title = "看不见我🙈~看不见我🙈~", clearTimeout(st)) : (document.title =
                "(๑•̀ㅂ•́) ✧被发现了～", st = setTimeout(function () {
                    document.title = OriginTitile
                }, 3e3))
        })
    </script>

    <!-- 鼠标点击烟花爆炸效果  Chaoqiang shw2018 add 2019.09.09 -->
    
        <canvas class="fireworks" style="position: fixed; left: 0; top: 0; z-index: 1; pointer-events: none;"></canvas>
        <script type="text/javascript" src="//cdn.bootcss.com/animejs/2.2.0/anime.min.js"></script>
        <script type="text/javascript" src="/js/fireworks.js"></script>
    

    <!-- 背景雪花飘落特效Chaoqiang shw2018 add 2019.09.10 -->
    

    <!-- 鼠标点击文字特效 Chaoqiang shw2018 add 2019.09.10-->
    
        <script src="/js/wenzi.js" type="text/javascript"></script>
    

    <!-- 背景雪花飘落特效 Chaoqiang shw2018 add 2019.09.10 -->
    

    <!-- 在线聊天工具  Chaoqiang shw2018 add 2019.09.11 -->
    

<script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"log":false,"model":{"jsonPath":"/live2dw/assets/wanko.model.json"},"display":{"position":"left","width":150,"height":200},"mobile":{"show":false},"react":{"opacity":0.7}});</script><script>
            window.imageLazyLoadSetting = {
                isSPA: false,
                preloadRatio: 1,
                processImages: null,
            };
        </script><script>window.addEventListener("load",function(){var t=/\.(gif|jpg|jpeg|tiff|png)$/i,r=/^data:image\/[a-z]+;base64,/;Array.prototype.slice.call(document.querySelectorAll("img[data-original]")).forEach(function(a){var e=a.parentNode;"A"===e.tagName&&(e.href.match(t)||e.href.match(r))&&(e.href=a.dataset.original)})});</script><script>!function(n){n.imageLazyLoadSetting.processImages=o;var e=n.imageLazyLoadSetting.isSPA,i=n.imageLazyLoadSetting.preloadRatio||1,r=Array.prototype.slice.call(document.querySelectorAll("img[data-original]"));function o(){e&&(r=Array.prototype.slice.call(document.querySelectorAll("img[data-original]")));for(var t,a=0;a<r.length;a++)0<=(t=(t=r[a]).getBoundingClientRect()).bottom&&0<=t.left&&t.top<=(n.innerHeight*i||document.documentElement.clientHeight*i)&&function(){var t,e,n,i,o=r[a];t=o,e=function(){r=r.filter(function(t){return o!==t})},n=new Image,i=t.getAttribute("data-original"),n.onload=function(){t.src=i,e&&e()},t.src!==i&&(n.src=i)}()}o(),n.addEventListener("scroll",function(){var t,e;t=o,e=n,clearTimeout(t.tId),t.tId=setTimeout(function(){t.call(e)},500)})}(this);</script></body>

</html>
