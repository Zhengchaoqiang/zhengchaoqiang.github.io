<!DOCTYPE HTML>
<html lang="zh-CN">


<head><meta name="generator" content="Hexo 3.9.0">
    <meta charset="utf-8">
    <meta name="keywords" content="Angular Crash Tutorial, Bosch SEU chaoqiang Mechanics Eletronics 超强 micro-service Intelligent-Manufacturing MES">
    <meta name="description" content="1.Angular 快速入门这是一个非常基础的快速入门教程，比较注重概念模型的构建。掌握这门框架的精髓，可以这门理解：

当有人提到 Spring 的时候，你的大脑里面第一个想到的一定是 DI、IoC、AOP 这些核心概念；
当有人提到 H">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Angular Crash Tutorial | chaoqiang&#39;s Blog</title>
    <link rel="icon" type="image/png" href="/favicon.png">

    <link rel="stylesheet" type="text/css" href="/libs/awesome/css/all.css">
    <link rel="stylesheet" type="text/css" href="/libs/materialize/materialize.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/aos/aos.css">
    <link rel="stylesheet" type="text/css" href="/libs/animate/animate.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/lightGallery/css/lightgallery.min.css">
    <link rel="stylesheet" type="text/css" href="/css/matery.css">
    <link rel="stylesheet" type="text/css" href="/css/my.css">
    
    <script src="/libs/jquery/jquery.min.js"></script>
    
<link rel="stylesheet" href="/css/prism-tomorrow.css" type="text/css">
<link rel="stylesheet" href="/css/prism-line-numbers.css" type="text/css"></head>


<body>
    <header class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="nav-wrapper head-container">
            <div class="brand-logo">
                <a href="/" class="waves-effect waves-light">
                    
                    <span class="logo-span">chaoqiang's Blog</span>
                </a>
            </div>
            

<a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fas fa-bars"></i></a>
<ul class="right nav-menu">
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/" class="waves-effect waves-light">
      
      <i class="fas fa-home" style="zoom: 0.6;"></i>
      
      <span>首页</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/tags" class="waves-effect waves-light">
      
      <i class="fas fa-tags" style="zoom: 0.6;"></i>
      
      <span>标签</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/categories" class="waves-effect waves-light">
      
      <i class="fas fa-bookmark" style="zoom: 0.6;"></i>
      
      <span>分类</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/archives" class="waves-effect waves-light">
      
      <i class="fas fa-archive" style="zoom: 0.6;"></i>
      
      <span>归档</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/about" class="waves-effect waves-light">
      
      <i class="fas fa-user-circle" style="zoom: 0.6;"></i>
      
      <span>关于</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/contact" class="waves-effect waves-light">
      
      <i class="fas fa-comments" style="zoom: 0.6;"></i>
      
      <span>留言板</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/friends" class="waves-effect waves-light">
      
      <i class="fas fa-address-book" style="zoom: 0.6;"></i>
      
      <span>友情链接</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/AV" class="waves-effect waves-light">

      
      <i class="fas fa-list" style="zoom: 0.6;"></i>
      
      <span>Medias</span>
      <i class="fas fa-chevron-down" aria-hidden="true" style="zoom: 0.6;"></i>
    </a>
    <ul class="sub-nav menus_item_child ">
      
      <li>
        <a href="/Music">
          
          <i class="fas fa-music" style="margin-top: -20px; zoom: 0.6;"></i>
          
          <span>Musics</span>
        </a>
      </li>
      
      <li>
        <a href="/Movie">
          
          <i class="fas fa-film" style="margin-top: -20px; zoom: 0.6;"></i>
          
          <span>Movies</span>
        </a>
      </li>
      
      <li>
        <a href="/Book">
          
          <i class="fas fa-book" style="margin-top: -20px; zoom: 0.6;"></i>
          
          <span>Books</span>
        </a>
      </li>
      
      <li>
        <a href="/AV">
          
          <i class="fas fa-image" style="margin-top: -20px; zoom: 0.6;"></i>
          
          <span>Galleries</span>
        </a>
      </li>
      
    </ul>
    
  </li>
  
  <li>
    <a href="#searchModal" class="modal-trigger waves-effect waves-light">
      <i id="searchIcon" class="fas fa-search" title="搜索" style="zoom: 0.85;"></i>
    </a>
  </li>
</ul>

<div id="mobile-nav" class="side-nav sidenav">

    <div class="mobile-head bg-color">
        
        <div class="logo-name">chaoqiang's Blog</div>
        <div class="logo-desc">
            
            博世互联工业 | 智能制造 | 微服务架构 | 东南大学 | 机械电子工程
            
        </div>
    </div>

    

    <ul class="menu-list mobile-menu-list">
        
        <li class="m-nav-item">
	  
		<a href="/" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-home"></i>
			
			首页
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/tags" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-tags"></i>
			
			标签
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/categories" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-bookmark"></i>
			
			分类
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/archives" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-archive"></i>
			
			归档
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/about" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-user-circle"></i>
			
			关于
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/contact" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-comments"></i>
			
			留言板
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/friends" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-address-book"></i>
			
			友情链接
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="javascript:;">
			
				<i class="fa-fw fas fa-list"></i>
			
			Medias
			<span class="m-icon"><i class="fas fa-chevron-right"></i></span>
		</a>
            <ul  style="background:  ;" >
              
                <li>   
				
                  <a href="/Music " style="margin-left:75px";>
				  
				   <i class="fa fas fa-music" style="position: absolute;left:50px" ></i>
			      
		          <span>Musics</span>
                  </a>
                </li>
              
                <li>   
				
                  <a href="/Movie " style="margin-left:75px";>
				  
				   <i class="fa fas fa-film" style="position: absolute;left:50px" ></i>
			      
		          <span>Movies</span>
                  </a>
                </li>
              
                <li>   
				
                  <a href="/Book " style="margin-left:75px";>
				  
				   <i class="fa fas fa-book" style="position: absolute;left:50px" ></i>
			      
		          <span>Books</span>
                  </a>
                </li>
              
                <li>   
				
                  <a href="/AV " style="margin-left:75px";>
				  
				   <i class="fa fas fa-image" style="position: absolute;left:50px" ></i>
			      
		          <span>Galleries</span>
                  </a>
                </li>
               
            </ul>
          
        </li>
        
        
        <li><div class="divider"></div></li>
        <li>
            <a href="https://github.com/Zhengchaoqiang" class="waves-effect waves-light" target="_blank">
                <i class="fab fa-github-square fa-fw"></i>Fork Me
            </a>
        </li>
        
    </ul>
</div>

        </div>

        
            <style>
    .nav-transparent .github-corner {
        display: none !important;
    }

    .github-corner {
        position: absolute;
        z-index: 10;
        top: 0;
        right: 0;
        border: 0;
        transform: scale(1.1);
    }

    .github-corner svg {
        color: #0f9d58;
        fill: #fff;
        height: 64px;
        width: 64px;
    }

    .github-corner:hover .octo-arm {
        animation: a 0.56s ease-in-out;
    }

    .github-corner .octo-arm {
        animation: none;
    }

    @keyframes a {
        0%,
        to {
            transform: rotate(0);
        }
        20%,
        60% {
            transform: rotate(-25deg);
        }
        40%,
        80% {
            transform: rotate(10deg);
        }
    }
</style>

<a href="https://github.com/Zhengchaoqiang" class="github-corner tooltipped hide-on-med-and-down" target="_blank"
   data-tooltip="Fork Me" data-position="left" data-delay="50">
    <svg viewBox="0 0 250 250" aria-hidden="true">
        <path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path>
        <path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2"
              fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path>
        <path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z"
              fill="currentColor" class="octo-body"></path>
    </svg>
</a>
        
    </nav>

</header>

    
<script src="/libs/cryptojs/crypto-js.min.js"></script>
<script>
    (function() {
        let pwd = '';
        if (pwd && pwd.length > 0) {
            if (pwd !== CryptoJS.SHA256(prompt('请输入访问本文章的密码')).toString(CryptoJS.enc.Hex)) {
                alert('密码错误，将返回主页！');
                location.href = '/';
            }
        }
    })();
</script>




<div class="bg-cover pd-header post-cover" style="background-image: url('/medias/featureimages/19.jpg')">
    <div class="container" style="right: 0px;left: 0px;">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <h1 class="description center-align post-title">Angular Crash Tutorial</h1>
                </div>
            </div>
        </div>
    </div>
</div>




<main class="post-container content">

    
    <link rel="stylesheet" href="/libs/tocbot/tocbot.css">
<style>
    #articleContent h1::before,
    #articleContent h2::before,
    #articleContent h3::before,
    #articleContent h4::before,
    #articleContent h5::before,
    #articleContent h6::before {
        display: block;
        content: " ";
        height: 100px;
        margin-top: -100px;
        visibility: hidden;
    }

    #articleContent :focus {
        outline: none;
    }

    .toc-fixed {
        position: fixed;
        top: 64px;
    }

    .toc-widget {
        width: 345px;
        padding-left: 20px;
    }

    .toc-widget .toc-title {
        margin: 35px 0 15px 0;
        padding-left: 17px;
        font-size: 1.5rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    .toc-widget ol {
        padding: 0;
        list-style: none;
    }

    #toc-content {
        height: calc(100vh - 250px);
        overflow: auto;
    }

    #toc-content ol {
        padding-left: 10px;
    }

    #toc-content ol li {
        padding-left: 10px;
    }

    #toc-content .toc-link:hover {
        color: #42b983;
        font-weight: 700;
        text-decoration: underline;
    }

    #toc-content .toc-link::before {
        background-color: transparent;
        max-height: 25px;
    }

    #toc-content .is-active-link {
        color: #42b983;
    }

    #toc-content .is-active-link::before {
        background-color: #42b983;
    }

    #floating-toc-btn {
        position: fixed;
        right: 15px;
        bottom: 76px;
        padding-top: 15px;
        margin-bottom: 0;
        z-index: 998;
    }

    #floating-toc-btn .btn-floating {
        width: 48px;
        height: 48px;
    }

    #floating-toc-btn .btn-floating i {
        line-height: 48px;
        font-size: 1.4rem;
    }
</style>
<div class="row">
    <div id="main-content" class="col s12 m12 l9">
        <!-- 文章内容详情 -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            <div class="row tag-cate">
                <div class="col s7">
                    
                    <div class="article-tag">
                        
                            <a href="/tags/Angular/">
                                <span class="chip bg-color">Angular</span>
                            </a>
                        
                    </div>
                    
                </div>
                <div class="col s5 right-align">
                    
                    <div class="post-cate">
                        <i class="fas fa-bookmark fa-fw icon-category"></i>
                        
                            <a href="/categories/Angular-Crash-Tutorial/" class="post-category">
                                Angular Crash Tutorial
                            </a>
                        
                    </div>
                    
                </div>
            </div>

            <div class="post-info">
                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-minus fa-fw"></i>发布日期:&nbsp;&nbsp;
                    2020-03-12
                </div>
                

                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-check fa-fw"></i>更新日期:&nbsp;&nbsp;
                    2020-06-14
                </div>
                

                
                <div class="info-break-policy">
                    <i class="far fa-file-word fa-fw"></i>文章字数:&nbsp;&nbsp;
                    40.1k
                </div>
                

                
                <div class="info-break-policy">
                    <i class="far fa-clock fa-fw"></i>阅读时长:&nbsp;&nbsp;
                    152 分
                </div>
                

                
                    <div id="busuanzi_container_page_pv" class="info-break-policy">
                        <i class="far fa-eye fa-fw"></i>阅读次数:&nbsp;&nbsp;
                        <span id="busuanzi_value_page_pv"></span>
                    </div>
				
            </div>

        </div>
        <hr class="clearfix">
        <div class="card-content article-card-content">
            <div id="articleContent">
                <h2 id="1-Angular-快速入门"><a href="#1-Angular-快速入门" class="headerlink" title="1.Angular 快速入门"></a>1.Angular 快速入门</h2><p>这是一个非常基础的快速入门教程，比较注重概念模型的构建。掌握这门框架的精髓，可以这门理解：</p>
<ul>
<li>当有人提到 Spring 的时候，你的大脑里面第一个想到的一定是 DI、IoC、AOP 这些核心概念；</li>
<li>当有人提到 Hibernate、MyBatis、JPA 的时候，你的大脑里面立即会浮现出 ORM 的概念；</li>
<li>当有人提到 React 的时候，你想到的应该是 VDOM、JSX；</li>
<li>当有人提到 jQuery 的时候，你首先想到的应该是 $，对吧？</li>
</ul>
<p>因此，可以看到，任何一个成功的框架都有自己独创的“概念模型”，或者叫“核心价值”也可以，这是框架本身存在的价值，这些核心概念是你掌握这门框架应该紧扣的主线，而不是上来就陷入到茫茫多的技术细节里面去。</p>
<h3 id="1-1-Angular-的核心概念模型"><a href="#1-1-Angular-的核心概念模型" class="headerlink" title="1.1 Angular 的核心概念模型"></a>1.1 Angular 的核心概念模型</h3><p>既然如此，问题就来了，新版本的 Angular 的核心概念是什么呢？<br>非常简单，一切都是围绕着“组件”（Component）的概念展开的：</p>
<p><img src="https://cdn.jsdelivr.net/gh/shw2018/cdn@1.0/sakura/img/loader/orange.progress-bar-stripe-loader.svg" data-original="https://images.gitbook.cn/86a9de10-e25f-11e8-aea1-e3c6bbbc3251" alt="Component"></p>
<ul>
<li>Component（组件）是整个框架的核心，也是终极目标。“组件化”的意义有 2 个：第一是分治，因为有了组件之后，我们可以把各种逻辑封装在组件内部，避免混在一起；第二是复用，封装成组件之后不仅可以在项目内部复用，而且可以沉淀下来跨项目复用。</li>
<li>NgModule（模块）是组织业务代码的利器，按照你自己的业务场景，把组件、服务、路由打包到模块里面，形成一个个的积木块，然后再用这些积木块来搭建出高楼大厦。</li>
<li>Router（路由）的角色也非常重要，它有 3 个重要的作用：第一是封装浏览器的 History 操作；第二是负责异步模块的加载；第三是管理组件的生命周期。</li>
</ul>
<p>所以，在这个系列的文章里面，Component、NgModule、Router 加起来会占据绝大部分篇幅，而一些琐碎的小特性会被忽略掉。我相信，你只要紧扣“组件化”这个主线，就能站在一个很高的角度统摄全局，从而掌握到这门框架的精髓。</p>
<h3 id="1-2-一些常见的问题"><a href="#1-2-一些常见的问题" class="headerlink" title="1.2 一些常见的问题"></a>1.2 一些常见的问题</h3><h4 id="浏览器兼容性"><a href="#浏览器兼容性" class="headerlink" title="浏览器兼容性"></a>浏览器兼容性</h4><p>关于 Angular 的浏览器兼容性，请看下图：</p>
<p><img src="https://cdn.jsdelivr.net/gh/shw2018/cdn@1.0/sakura/img/loader/orange.progress-bar-stripe-loader.svg" data-original="https://images.gitbook.cn/b11ec620-ac61-11e9-b99d-87fbe4d2a696" alt=""></p>
<p>有一些国内的开发者会来争论兼容 IE 的问题，下面展示一些事实：</p>
<ul>
<li>第一个事实是：天猫已经于 2016 年 4 月宣布放弃支持 IE6、7、8。而根据百度流量研究院的统计，截止到 2019 年 5 月，IE8 以下的浏览器在国内也只有 5.69% 的份额了：</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/shw2018/cdn@1.0/sakura/img/loader/orange.progress-bar-stripe-loader.svg" data-original="https://images.gitbook.cn/ed6a4280-ac61-11e9-add6-13ebc1d14b27" alt=""></p>
<p><a href="http://tongji.baidu.com/data/browser" target="_blank" rel="noopener">数据来源</a>，不值得为了这么少的市场份额付出那么多的研发和维护成本。</p>
<ul>
<li>第二个事实是：截至 2019 年 5 月底，Chrome 的全球市场份额已经高达 61.06%，加上 Safari 、Firefox 的份额，所有这些能完美支持 Web 标准的浏览器加起来，份额已经远远超过 80%。</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/shw2018/cdn@1.0/sakura/img/loader/orange.progress-bar-stripe-loader.svg" data-original="https://images.gitbook.cn/0df7b1e0-ac62-11e9-9941-c769c68ebd94" alt=""></p>
<p><a href="http://gs.statcounter.com/browser-market-share" target="_blank" rel="noopener">数据来源</a>。</p>
<ul>
<li>第三个事实是：微软 2018 年底宣布，后续新的浏览器会采用 Chromium 内核，并且已经与 2019 年初给出了预览版。如果有兴趣，<a href="https://www.microsoftedgeinsider.com/en-us/" target="_blank" rel="noopener">可以到微软的官方网站来下载</a>。这就意味着，到 2019 年底的时候，基于 Chrome 内核的浏览器全球市场份额将会达到 85% 左右。因此，请不要再花那么多钱和时间来解决“浏览器兼容性问题”了，后面根本就不存在这个问题！</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/shw2018/cdn@1.0/sakura/img/loader/orange.progress-bar-stripe-loader.svg" data-original="https://images.gitbook.cn/78934280-ac62-11e9-b243-f31642e7dba4" alt=""></p>
<p>你完全可以用以上事实去说服你的客户。</p>
<h4 id="命名约定"><a href="#命名约定" class="headerlink" title="命名约定"></a>命名约定</h4><p>老版本使用 AngularJS 指代，所有新版本都叫做 Angular。原因很好理解，因为老版本是用 JS 开发的，所以带一个 JS 后缀，而新版本是基于 TypeScript 的，带 JS 后缀不合适。</p>
<h4 id="关于TypeScript"><a href="#关于TypeScript" class="headerlink" title="关于TypeScript"></a>关于TypeScript</h4><p><img src="https://cdn.jsdelivr.net/gh/shw2018/cdn@1.0/sakura/img/loader/orange.progress-bar-stripe-loader.svg" data-original="https://images.gitbook.cn/d4fc0750-ac62-11e9-9941-c769c68ebd94" alt=""></p>
<p>这个系列的文章不会单独讲 TypeScript，TypeScript 不难，JavaScript 才难。<br>TypeScript 不该成为学习Angular的障碍。相反，一旦写熟练了之后，TypeScript 可以非常有效地提升编码效率和程序可读性。</p>
<h4 id="关于-Angular-的版本"><a href="#关于-Angular-的版本" class="headerlink" title="关于 Angular 的版本"></a>关于 Angular 的版本</h4><p>官方的版本发布计划是：</p>
<ul>
<li>每 6 个月发布一个主版本（第一位版本号，主版本）</li>
<li>每个主版本发布 1 到 3 个小版本（第二位版本号，feature 版本号）</li>
<li>每周发布一个补丁版本（第三位版本号，hotfix 版本号）</li>
</ul>
<p>根据官方的解释，Angular 2.0 之后会保证向下兼容，只有升级主版本的时候才会做一些 breaking change。所以这个系列文章里面不再强调版本号，涉及到的所有实例代码都已经升级到了当前最新的 8.0 版本（2019-07）。</p>
<h3 id="1-3-内容结构"><a href="#1-3-内容结构" class="headerlink" title="1.3 内容结构"></a>1.3 内容结构</h3><p>本专栏共分 3 大部分：</p>
<ul>
<li>第一部分：从第 1 篇到第 10 篇，围绕组件、模块、路由三大概念，兼顾服务、RxJS、表单、i18n 等小工具，全面解释 Angular 的基本用法。</li>
<li>第二部分：第 11 篇，专门解释依赖注入，这是 Angular 比较有特色的内容，这部分内容比较有深度，虽然在日常开发中使用不多，但是理解它能够更加深入理解 Angular。</li>
<li>第三部分：从第 12 篇到第 16 篇，介绍产品级案例项目 OpenWMS、PWA 案例、一些参考资源以及三个新版本特性附录</li>
</ul>
<h2 id="2-快速搭建开发环境"><a href="#2-快速搭建开发环境" class="headerlink" title="2.快速搭建开发环境"></a>2.快速搭建开发环境</h2><h3 id="2-1-Node-js"><a href="#2-1-Node-js" class="headerlink" title="2.1 Node.js"></a>2.1 Node.js</h3><p>2009 年，Node.js 发布了第一个版本，标志着前端开发正式告别了刀耕火种的原始状态，开始进入工业化时代。</p>
<p>在 Node.js 出现之前，前端开发领域有很多事情我们是做不到的，比如：</p>
<ul>
<li>JS 代码的合并、压缩、混淆</li>
<li>CSS 预处理</li>
<li>前端自动化测试</li>
</ul>
<p>而这一切在 Node.js 出现之后都得到了很好的解决。</p>
<ul>
<li>对 JS 代码的预处理经历了 Grunt、Gulp 的短暂辉煌之后，终于在 Webpack 这里形成了事实标准的局面。</li>
<li>CSS 的预处理也从 LESS 发展到了 SASS 等。</li>
<li>自动化测试一直是前端开发中的一个巨大痛点，由于前端在运行时严重依赖浏览器环境，导致我们一直无法像测试后端代码那样可以去编写测试用例。在有了 Node.js 之后，我们终于有了 Karma + Jasmine 这样的单元测试组合，也有了基于 WebDriverJS 这样的可以和浏览器进行通讯的集成测试神器。</li>
</ul>
<p>就前端开发目前整体的状态来说，无论你使用什么框架，Node.js、Webpack、SASS、Karma + Jasmine、WebDriverJS 这个组合是无论如何绕不过去的。如果你用过其他前端框架的话，就知道手动配置这些东西有多痛苦了，那一坨配置文件没有半天功夫是搞不定的。</p>
<h3 id="2-2-angular-cli"><a href="#2-2-angular-cli" class="headerlink" title="2.2 @angular/cli"></a>2.2 @angular/cli</h3><p><img src="https://cdn.jsdelivr.net/gh/shw2018/cdn@1.0/sakura/img/loader/orange.progress-bar-stripe-loader.svg" data-original="https://images.gitbook.cn/4b1f3900-e3c5-11e8-a1c4-731a3e37324c" alt=""></p>
<p>在开发 Angular 应用的时候，当然也离不开大量基于 Node.js 的工具，我们需要 TypeScript compiler、Webpack、Karma、Jasmine、Protracter 等模块。</p>
<p>有相关经验的开发者都知道，自己从头开始去搭建一套基于 webpack 的开发环境是一件非常麻烦的事情。很多初学者在搭建环境这一步上面消耗了过多的精力，导致学习热情受到了沉重的打击。</p>
<p>当团队规模比较大的时候，在每个人的机器上配置环境需要消耗大量的时间。有一些团队为了避开这个坑，利用 Docker 来做开发环境的同步和版本升级，看起来也是一个非常不错的方案。</p>
<p>Angular 项目组从一开始就注意到了这个问题，因此有了 @angular/cli 这个神器，它的底层基于 webpack，集成了以上提到的所有 Node.js 组件。你只要装好 @angular/cli 就够了，而不需要自己从头一步一步安装那些 Node.js 插件。</p>
<p>当然，在安装 @angular/cli 之前需要先把 Node.js 安装好，<a href="https://nodejs.org/" target="_blank" rel="noopener">请到官方网站下载安装包</a> ，安装过程和普通软件没有区别。装好 Node.js 之后就可以安装 @angular/cli 了，由于 npm 会自动访问海外的服务器，因而强烈推荐使用 cnpm 进行安装：</p>
<pre><code>npm i -g cnpm --registry=https://registry.npm.taobao.org

cnpm i -g @angular/cli
</code></pre><p>cnpm 是淘宝发布的一款工具，会自动把 npm 上面的所有包定时同步到国内的服务器上来（目前大约 10 分钟全量同步一次），cnpm 本身也是一款 Node.js 模块。由于 cnpm 的服务器在国内，因而中文开发者用它装东西比较快。除了定时同步 npm 模块之外，cnpm 还做了一些其他的事情，比如把某些包预先编译好了缓存在服务器上，这样就不用拉源码到你本地进行编译了。有人抱怨使用 cnpm 安装的目录结构和 npm 不同，包括还有其他一些小坑，如果你非常在意这些，可以使用 nrm 来管理多个 registry。nrm 本身也是一个 Node.js 模块，你可以这样安装：</p>
<pre class="line-numbers language-typescript"><code class="language-typescript">npm i <span class="token operator">-</span>g nrm
<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>然后你就可以用 nrm 来随时切换 registry 了，比如：</p>
<pre><code>nrm use cnpm
</code></pre><p>这样就不用每次都用 cnpm 进行安装了，直接使用 npm 即可。</p>
<p>@angular/cli 安装成功之后你的终端里面将会多出一个名叫 ng 的命令，敲下 ng，将会显示完整的帮助文档：</p>
<p><img src="https://cdn.jsdelivr.net/gh/shw2018/cdn@1.0/sakura/img/loader/orange.progress-bar-stripe-loader.svg" data-original="https://images.gitbook.cn/3ec779e0-ac67-11e9-add6-13ebc1d14b27" alt=""></p>
<p>官方文档里面列出了所有这些命令的含义和示例，<a href="https://angular.io/cli/" target="_blank" rel="noopener">链接在这里</a>。<strong>但是请注意，官方提供的 cli 文档过于简单，有非常多的细节都没有提到，所以你懂的，请跟着我的 demo 走。</strong></p>
<h3 id="2-3-创建第一个项目"><a href="#2-3-创建第一个项目" class="headerlink" title="2.3 创建第一个项目"></a>2.3 创建第一个项目</h3><p>我们来创建第一个入门项目 HelloAngular，请在你的终端里面运行：</p>
<pre><code>ng new HelloAngular
</code></pre><p>@angular/cli 将会自动帮你把目录结构创建好，并且会自动生成一些模板化的文件，就像这样：</p>
<p><img src="https://cdn.jsdelivr.net/gh/shw2018/cdn@1.0/sakura/img/loader/orange.progress-bar-stripe-loader.svg" data-original="https://images.gitbook.cn/6bb0ab20-ac67-11e9-add6-13ebc1d14b27" alt=""></p>
<p><strong>请特别注意：</strong> @angular/cli 在自动生成好项目骨架之后，会立即自动使用 npm 来安装所依赖的 Node 模块，因此这里我们要 Ctrl+C 终止掉，然后自己进入项目的根目录，使用 cnpm 来进行安装。</p>
<p><img src="https://cdn.jsdelivr.net/gh/shw2018/cdn@1.0/sakura/img/loader/orange.progress-bar-stripe-loader.svg" data-original="https://images.gitbook.cn/9d8181b0-ac67-11e9-add6-13ebc1d14b27" alt="enter image description here"></p>
<p>安装完成之后，使用 ng serve 命令启动项目：</p>
<p><img src="https://cdn.jsdelivr.net/gh/shw2018/cdn@1.0/sakura/img/loader/orange.progress-bar-stripe-loader.svg" data-original="https://images.gitbook.cn/ab185ba0-ac67-11e9-b243-f31642e7dba4" alt="enter image description here"></p>
<p>打开你的浏览器，访问默认的 4200 端口，看到以下界面说明环境 OK 了：</p>
<p><img src="https://cdn.jsdelivr.net/gh/shw2018/cdn@1.0/sakura/img/loader/orange.progress-bar-stripe-loader.svg" data-original="https://images.gitbook.cn/b76836a0-ac67-11e9-b99d-87fbe4d2a696" alt=""></p>
<p>请注意以下几点。</p>
<ul>
<li><strong>这里是 serve，不是 server，serve 是服务，动词；server 是服务器，名词。</strong>，我看到一些初学者经常坑在这个地方。</li>
<li>如果你需要修改端口号，可以用 ng serve –port **** 来进行指定。</li>
<li>ng serve –open 可以自动打开你默认的浏览器。</li>
<li>如果你想让编译的包更小一些，可以使用 ng serve –prod，@angular/cli 会启用 TreeShaking 特性，加了参数之后编译的过程也会慢很多。因此，在正常的开发过程里面请不要加 –prod 参数。</li>
<li>ng serve 是在内存里面生成项目，如果你想看到项目编译之后的产物，请运行 ng build。构建最终产品版本可以加参数，ng build –prod。</li>
</ul>
<p>ng 提供了很多非常好用的工具，除了可以利用 ng new 来自动创建项目骨架之外，它还可以帮助我们创建 Angular 里面所涉及到的很多模块，最常用的几个如下。</p>
<ul>
<li>自动创建组件：<strong>ng generate component MyComponent</strong>，可以简写成<strong>ng g c MyComponent</strong>。创建组件的时候也可以带路径，如 <strong>ng generate component mydir/MyComponent</strong></li>
<li>自动创建指令：ng g d MyDirective</li>
<li>自动创建服务：ng g s MyService</li>
<li>构建项目：ng build，如果你想构建最终的产品版本，可以用 ng build –prod</li>
</ul>
<p>更多的命令和参数请在终端里面敲 ng g –help 仔细查看，尽快熟悉这些工具可以非常显著地提升你的编码效率。</p>
<p><img src="https://cdn.jsdelivr.net/gh/shw2018/cdn@1.0/sakura/img/loader/orange.progress-bar-stripe-loader.svg" data-original="https://images.gitbook.cn/3870ef20-ad13-11e9-8f3f-792c82c0addc" alt=""></p>
<h3 id="2-4-一些常见的坑"><a href="#2-4-一些常见的坑" class="headerlink" title="2.4 一些常见的坑"></a>2.4 一些常见的坑</h3><p>@angular/cli 这种“全家桶”式的设计带来了很大的方便，同时也有一些人不太喜欢，因为很多底层的东西被屏蔽掉了，开发者不能天马行空地自由发挥。比如，@angular/cli 把底层 webpack 的配置文件屏蔽掉了，很多喜欢自己手动配 webpack 的开发者就感到很不爽。</p>
<p>对于国内的开发者来说，上面这些其实不是最重要的，国内开发者碰到的坑主要是由两点引起的：</p>
<ul>
<li>第一点是网络问题，比如 node-sass 这个模块你很有可能就安装不上，原因你懂的；</li>
<li>第二点是开发环境导致的问题，国内使用 Windows 平台的开发者比例依然巨大，而 @angular/cli 在 Windows 平台上有一些非常恶心的依赖，比如它需要依赖 Python 环境、Visual Studio 环境，这是因为某些 Node.js 的模块需要下载到你的本地进行源码编译。</li>
</ul>
<p>因此，如果你的开发平台是 Windows，请特别注意：</p>
<ul>
<li>如果你知道如何给 npm 配置代理，也知道如何翻墙，请首选 npm 来安装@angular/cli 。</li>
<li>否则，请使用 cnpm 来安装 @angular/cli，原因有三：<br>（1）cnpm 的缓存服务器在国内，你装东西的速度会快很多；<br>（2）用 cnpm 可以帮你避开某些模块装不上的问题，因为它在服务器上面做了缓存；<br>（3）cnpm 还把一些包都预编译好了缓存在服务端，比如 node-sass。使用 cnpm 不需要在你本地进行源码编译，因此你的机器上可以没有那一大堆麻烦的环境。</li>
<li>推荐装一个 nrm 来自动切换 registry：npm i -g nrm。</li>
<li>如果 cli 安装失败，请手动把 node_modules 目录删掉重试一遍，全局的 @angular/cli 也需要删掉重装，cnpm uninstall -g @angular/cli。</li>
<li>如果 node_modules 删不掉，爆出路径过长之类的错误，请尝试用一些文件粉碎机之类的工具强行删除。这是 npm 的锅，与 Angular 无关。</li>
<li>最新版本的 @angular/cli 经常会有 bug，尤其是在 Windows 平台上面，因此请不要追新版本追太紧。如果你发现了莫名其妙的问题，请尝试降低一个主版本试试。这一点非常重要，很多初学者会非常困惑，代码什么都没改，就升级了一下环境，然后就各种编译报错。如果你愿意，<a href="https://github.com/angular/angular-cli/issues" target="_blank" rel="noopener">去官方提 issue 是个很不错的办法</a>。</li>
<li>对于 MAC 用户或者 *nix 用户，请特别注意权限问题，命令前面最好加上 sudo，保证有 root 权限。</li>
<li>无论你用什么开发环境，安装的过程中请仔细看 log。很多朋友没有看 log 的习惯，报错的时候直接懵掉，根本不知道发生了什么。</li>
</ul>
<h3 id="2-5-VS-Code"><a href="#2-5-VS-Code" class="headerlink" title="2.5 VS Code"></a>2.5 VS Code</h3><p><img src="https://cdn.jsdelivr.net/gh/shw2018/cdn@1.0/sakura/img/loader/orange.progress-bar-stripe-loader.svg" data-original="https://images.gitbook.cn/03569c70-ad1f-11e9-a760-01c165706a91" alt=""></p>
<p>如你所知，一直以来，前端开发领域并没有一款特别好用的开发和调试工具。</p>
<ul>
<li>WebStorm 很强大，但是吃资源很严重。</li>
<li>Sublime Text 插件很多，可惜要收费，而国内的企业还没有养成花钱购买开发工具的习惯。</li>
<li>Chrome 的开发者工具很好用，但是要直接调试 TypeScript 很麻烦。</li>
</ul>
<p>因此，Visual Studio Code（简称 VS Code）才会呈现出爆炸性增长的趋势。它是微软开发的一款<a href="https://github.com/Microsoft/vscode" target="_blank" rel="noopener">前端编辑器</a>，完全开源免费。VS Code 底层是 Electron，界面本身是用 TypeScript 开发的。对于 Angular 开发者来说，当然要强烈推荐 VS Code。最值得一提的是，从 1.14 开始，可以直接在 VS Code 里面调试 TypeScript 代码。</p>
<h4 id="第一步：环境配置"><a href="#第一步：环境配置" class="headerlink" title="第一步：环境配置"></a>第一步：环境配置</h4><ul>
<li>确保 Chrome 安装在默认位置。</li>
<li>确保 VS Code 里面安装了 Debugger for Chrome 这个插件。</li>
<li>把 @angular/cli 安装到全局空间 npm install -g @angular/cli，国内用户请使用 cnpm 进行安装。注意，你最好升级到最新版本的 @angular/cli，避免版本兼容问题。</li>
<li>用 @angular/cli 创建新项目 ng new my-app，本来就已经用 @angular/cli 创建的项目请忽略这一步，继续往下走，因为只要是 cli 创建的项目，后面的步骤都是有效的。</li>
<li>用 VS Code 打开项目，进入项目根目录。</li>
</ul>
<h4 id="第二步：配置-launch-json"><a href="#第二步：配置-launch-json" class="headerlink" title="第二步：配置 launch.json"></a>第二步：配置 launch.json</h4><p><img src="https://cdn.jsdelivr.net/gh/shw2018/cdn@1.0/sakura/img/loader/orange.progress-bar-stripe-loader.svg" data-original="https://images.gitbook.cn/cf1397f0-ad1f-11e9-b1a9-0994986ea855" alt="enter image description here"> <img src="https://cdn.jsdelivr.net/gh/shw2018/cdn@1.0/sakura/img/loader/orange.progress-bar-stripe-loader.svg" data-original="https://gitbook.cn/gitchat/column/undefined/topic/5d4bbc6c7c00c637972766ce" alt=""></p>
<p>请参照以上步骤打开 launch.json 配置文件。</p>
<p><img src="https://cdn.jsdelivr.net/gh/shw2018/cdn@1.0/sakura/img/loader/orange.progress-bar-stripe-loader.svg" data-original="https://images.gitbook.cn/e1549900-ad1f-11e9-b015-0198f673a736" alt="enter image description here"></p>
<p>请把你本地 launch.json 文件里面的内容改成这样：</p>
<pre><code>{
    "version": "0.2.0",
    "configurations": [
        {
            "type": "chrome",
            "request": "launch",
            "name": "Chrome",
            "url": "http://localhost:4200",
            "webRoot": "${workspaceRoot}"
        }
    ]
}</code></pre><h4 id="第三步：开始-Debug"><a href="#第三步：开始-Debug" class="headerlink" title="第三步：开始 Debug"></a>第三步：开始 Debug</h4><p>在你的 app.component.ts 的构造函数里面打个断点，我本地是这样打断点的：</p>
<p><img src="https://cdn.jsdelivr.net/gh/shw2018/cdn@1.0/sakura/img/loader/orange.progress-bar-stripe-loader.svg" data-original="https://images.gitbook.cn/fa7c91d0-ad1f-11e9-8f3f-792c82c0addc" alt="enter image description here"></p>
<p>打开终端，进入项目根目录，运行 ng serve 启动项目，<strong>然后从 VS Code 的 debug 界面启动 Chrome</strong>：</p>
<p><img src="https://cdn.jsdelivr.net/gh/shw2018/cdn@1.0/sakura/img/loader/orange.progress-bar-stripe-loader.svg" data-original="https://images.gitbook.cn/0bb4fc80-ad20-11e9-b1a9-0994986ea855" alt=""></p>
<p><strong>注意，你可能需要 F5 刷新一下 Chrome 才能进入断点！</strong></p>
<p><img src="https://cdn.jsdelivr.net/gh/shw2018/cdn@1.0/sakura/img/loader/orange.progress-bar-stripe-loader.svg" data-original="https://images.gitbook.cn/1c6858b0-ad20-11e9-b1a9-0994986ea855" alt="enter image description here"></p>
<p>VSCode 的插件市场上有大量的插件可供选择，比如彩虹缩进、智能提示、自动补齐标签之类的功能，将会大幅度提升你的开发效率，这里列出了 10 款我自己日常使用的插件供你参考，<a href="http://www.ngfans.net/topic/195/post" target="_blank" rel="noopener">详见这里</a>。</p>
<h3 id="2-6-webpack-bundle-analyzer"><a href="#2-6-webpack-bundle-analyzer" class="headerlink" title="2.6 webpack-bundle-analyzer"></a>2.6 webpack-bundle-analyzer</h3><p>在真实的业务项目中，我们会用到大量的第三方开源组件，例如图形库 ECharts、组件库 PrimeNG 等。</p>
<p>有很多开发者在引入这些组件库之后，没有注意到体积问题，导致最终编译出来的包体积过大，比如我自己的 OpenWMS 项目，以下是 build 出来的体积：</p>
<p><img src="https://cdn.jsdelivr.net/gh/shw2018/cdn@1.0/sakura/img/loader/orange.progress-bar-stripe-loader.svg" data-original="https://images.gitbook.cn/4924d4a0-ad20-11e9-a760-01c165706a91" alt=""></p>
<p>用 webpack-bundle-analyzer 分析之后可以看到各个模块在编译之后所占的体积：</p>
<p><img src="https://cdn.jsdelivr.net/gh/shw2018/cdn@1.0/sakura/img/loader/orange.progress-bar-stripe-loader.svg" data-original="https://images.gitbook.cn/7312c740-ad20-11e9-a760-01c165706a91" alt=""></p>
<p>可以看到，主要是因为 ECharts 和 PrimeNG 占的体积比较大，建议在使用的时候做一下异步，用不到的组件不要一股脑全部导入进来。</p>
<p><a href="https://github.com/webpack-contrib/webpack-bundle-analyzer" target="_blank" rel="noopener">webpack-bundle-analyzer 的用法和详细文档详见这里</a>。</p>
<h3 id="2-7-小结"><a href="#2-7-小结" class="headerlink" title="2.7 小结"></a>2.7 小结</h3><p>目前，无论你使用什么前端框架，都必然要使用到各种 Node.js 工具，Angular 也不例外。</p>
<p>与其他框架不同，Angular 从一开始就走的“全家桶”式的设计思路，因此 @angular/cli 这款工具里面集成了日常开发需要使用的所有 Node 模块，使用 @angular/cli 可以大幅度降低搭建开发环境的难度。</p>
<h2 id="3-Schematics与代码生成器"><a href="#3-Schematics与代码生成器" class="headerlink" title="3.Schematics与代码生成器"></a>3.Schematics与代码生成器</h2><h3 id="3-1-angular-cli-内置的add命令"><a href="#3-1-angular-cli-内置的add命令" class="headerlink" title="3.1 @angular/cli 内置的add命令"></a>3.1 @angular/cli 内置的add命令</h3><p>6.0 的时候 @angular/cli 新增了一个命令 ng add。<br>以前，如果我们需要引用一些第三方的 UI 库或者工具库，只能自己手动安装配置，过程中需要修改很多配置文件，非常繁琐，ng add 主要就是用来解决这个问题的。<br>如果你引用的第三方库支持了 ng add，那么整个过程全部是自动化的，以下这些事情 ng add 都会帮你自动完成：</p>
<ul>
<li>自动修改 package.json</li>
<li>自动使用 npm 安装依赖包</li>
<li>自动修改相关的配置文件，如果有的话</li>
<li>自动修改对应的模块引用文件</li>
<li>自动修改一些 CSS 样式文件</li>
</ul>
<p>接下来我们就来上手试一试 ng add 命令的用法，以官方的例子为基础，在上面做一些改进。</p>
<h4 id="第一步：创建一个新项目"><a href="#第一步：创建一个新项目" class="headerlink" title="第一步：创建一个新项目"></a>第一步：创建一个新项目</h4><pre class="line-numbers language-typescript"><code class="language-typescript">ng <span class="token keyword">new</span> <span class="token class-name">learn</span><span class="token operator">-</span>ng<span class="token operator">-</span>add<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<ul>
<li>创建过程中选择需要 router 模块</li>
<li>样式语法选择 SCSS</li>
</ul>
<h4 id="第二步：自动引入-angular-material"><a href="#第二步：自动引入-angular-material" class="headerlink" title="第二步：自动引入 @angular/material"></a>第二步：自动引入 @angular/material</h4><p>在项目根目录里面执行：</p>
<pre class="line-numbers language-typescript"><code class="language-typescript">ng add @angular<span class="token operator">/</span>material<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p><img src="https://cdn.jsdelivr.net/gh/shw2018/cdn@1.0/sakura/img/loader/orange.progress-bar-stripe-loader.svg" data-original="https://images.gitbook.cn/031c0040-ad26-11e9-8f3f-792c82c0addc" alt="ng Add"><br>可以看到，ng add 帮我们自动修改了这些文件:<br><img src="https://cdn.jsdelivr.net/gh/shw2018/cdn@1.0/sakura/img/loader/orange.progress-bar-stripe-loader.svg" data-original="https://images.gitbook.cn/15206d80-ad26-11e9-b1a9-0994986ea855" alt="ng modify file"><br><strong>国内的开发者请注意：官方提供的 Material 这个 UI 组件库会自动应用 Google 的一些字体文件，这一点比较讨厌，你需要手动把这些字体文件下载到项目里面，然后引用你自己项目中的路径。</strong></p>
<h4 id="第三步：自动创建-Material-风格导航栏"><a href="#第三步：自动创建-Material-风格导航栏" class="headerlink" title="第三步：自动创建 Material 风格导航栏"></a>第三步：自动创建 Material 风格导航栏</h4><pre class="line-numbers language-typescript"><code class="language-typescript">ng generate @angular<span class="token operator">/</span>material<span class="token punctuation">:</span>material<span class="token operator">-</span>nav <span class="token operator">--</span>name<span class="token operator">=</span>my<span class="token operator">-</span>nav<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p><img src="https://cdn.jsdelivr.net/gh/shw2018/cdn@1.0/sakura/img/loader/orange.progress-bar-stripe-loader.svg" data-original="https://images.gitbook.cn/2c5f8210-ad26-11e9-a760-01c165706a91" alt="Navigation"></p>
<h4 id="第四步：使用上面的导航栏"><a href="#第四步：使用上面的导航栏" class="headerlink" title="第四步：使用上面的导航栏"></a>第四步：使用上面的导航栏</h4><p>稍稍修改一些代码，来使用上面自动生成的导航栏。<br>把 app.component.html 里面的内容清空，然后使用上面新建的导航栏：</p>
<pre class="line-numbers language-html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>app-my-nav</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>app-my-nav</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>用 ng serve 启动项目，然后你就可以看到 Material 风格的导航条了：<br><img src="https://cdn.jsdelivr.net/gh/shw2018/cdn@1.0/sakura/img/loader/orange.progress-bar-stripe-loader.svg" data-original="https://images.gitbook.cn/3e5437e0-ad26-11e9-a760-01c165706a91" alt="material navigation"></p>
<h4 id="第五步：继续修改，做一个完整的例子"><a href="#第五步：继续修改，做一个完整的例子" class="headerlink" title="第五步：继续修改，做一个完整的例子"></a>第五步：继续修改，做一个完整的例子</h4><p>我们在以上内容的基础上继续修改：继续生成两个组件，然后加上异步路由配置，就可以得到了一个典型的项目界面了。<br><strong>注意：为了使用异步路由，我们这里在官方的例子上面做了一些改进，请参考我下面的步骤。</strong></p>
<pre class="line-numbers language-javascript"><code class="language-javascript">ng g module myDashboard 
ng g @angular<span class="token operator">/</span>material<span class="token punctuation">:</span>material<span class="token operator">-</span>dashboard <span class="token operator">--</span>name<span class="token operator">=</span>my<span class="token operator">-</span>dashboard 
ng g module myTable 
ng g @angular<span class="token operator">/</span>material<span class="token punctuation">:</span>material<span class="token operator">-</span>table <span class="token operator">--</span>name<span class="token operator">=</span>my<span class="token operator">-</span>table<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>此时我们的项目代码结构如下：<br><img src="https://cdn.jsdelivr.net/gh/shw2018/cdn@1.0/sakura/img/loader/orange.progress-bar-stripe-loader.svg" data-original="https://images.gitbook.cn/4d0645d0-ad26-11e9-b015-0198f673a736" alt="Folder Structure"><br>接下来：</p>
<ul>
<li>请参考 app.routing.module.ts 里面的路由配置，给上面的两个异步模块都加上独立的路由配置。</li>
<li>修改导航条里面的 routerLink，指向对应的路由配置。</li>
</ul>
<p>然后就可以得到两个很漂亮的界面了：<br><img src="https://cdn.jsdelivr.net/gh/shw2018/cdn@1.0/sakura/img/loader/orange.progress-bar-stripe-loader.svg" data-original="https://images.gitbook.cn/5ca265a0-ad26-11e9-b1a9-0994986ea855" alt="NiceUI1"><br><img src="https://cdn.jsdelivr.net/gh/shw2018/cdn@1.0/sakura/img/loader/orange.progress-bar-stripe-loader.svg" data-original="https://images.gitbook.cn/69d7bea0-ad26-11e9-8f3f-792c82c0addc" alt="NiceUI2"><br><strong>从这个例子你可以看到，ng add 和 ng generate 的功能非常强大，日常工作中的那些任务大多数能自动完成，只有很少的部分需要手动修改。</strong></p>
<h3 id="3-2-ng-add背后的Schematics代码生成器"><a href="#3-2-ng-add背后的Schematics代码生成器" class="headerlink" title="3.2 ng add背后的Schematics代码生成器"></a>3.2 ng add背后的Schematics代码生成器</h3><p><strong>请注意：初学者可以跳过这一段，这块是比较高级的内容，等你用熟悉了之后再回来研究不迟。单独使用 Schematics 比较麻烦，因为模板本身也是代码，也是需要维护的。另外，Schematics 特性本身还处于“实验”状态，官方提供的文档不全。</strong></p>
<p>@angular/cli 内部用来自动生成代码的工具叫做 Schematics ：<br><img src="https://cdn.jsdelivr.net/gh/shw2018/cdn@1.0/sakura/img/loader/orange.progress-bar-stripe-loader.svg" data-original="https://images.gitbook.cn/7acabbe0-ad26-11e9-b1a9-0994986ea855" alt="Schematics "><br>能支持的所有 Schematics 如下：<br><img src="https://cdn.jsdelivr.net/gh/shw2018/cdn@1.0/sakura/img/loader/orange.progress-bar-stripe-loader.svg" data-original="https://images.gitbook.cn/8866ed00-ad26-11e9-b015-0198f673a736" alt="Schematics  List"><br>如上图，当我们使用 ng g c &lt;组件名&gt; 的时候，它实际上调用了底层的 Schematics 来生成组件对应的 4 个文件。</p>
<p>Schematics 是框架无关的，它可以脱离 Angular 环境使用，因此你也可以把它单独拿出来，用来自动生成其他框架的代码。为了演示自定义 Schematic 的方法，我已经整合好了 2 个项目，请看运行效果：<br><img src="https://cdn.jsdelivr.net/gh/shw2018/cdn@1.0/sakura/img/loader/orange.progress-bar-stripe-loader.svg" data-original="https://images.gitbook.cn/95fd78d0-ad26-11e9-a760-01c165706a91" alt="Schematics "><br><strong>请特别注意：由于 @angular/schematics 是 cli 工具的组成部分，它的版本号与 cli 之间有对应关系。因此，如果你不确定对应关系是什么，请不要修改以上两个示例项目中的 package.json，升级必挂。</strong> <a href="https://www.npmjs.com/package/@angular-devkit/schematics" target="_blank" rel="noopener">更多文档和模板语法请参考这里</a><br>你可以利用 Schematics 来创建自己的代码生成器，可以参考以下步骤：</p>
<ul>
<li>npm i -g @angular-devkit/schematics-cli</li>
<li>用 schematics 命令创建一个新项目 schematics blank –name=learn-schematics</li>
<li>创建 schema.json 和 schema.ts 接口，修改 collection.json，指向自己创建的 shema.json 配置文件</li>
<li>修改 index.ts ，加一些生成代码的逻辑，可以参考 @angluar/cli 内部的代码</li>
<li>创建 files 目录和模板文件，目录名和文件名本身也可以参数化</li>
<li>构建项目：npm run build</li>
<li>链接到全局，方便本地调试：npm link</li>
<li>准备测试 schema ，用 @angular/cli 创建一个全新的项目 test-learn-schematics 并装好依赖。cd 到新项目 test-learn-schematics，链接 npm link learn-schematics，然后尝试用我们自定义的规则来生成一个组件 ng g my-component My –service –name=”damo” –collection learn-schematics –force</li>
</ul>
<h3 id="3-3-Workspace-与多项目支持"><a href="#3-3-Workspace-与多项目支持" class="headerlink" title="3.3 Workspace 与多项目支持"></a>3.3 Workspace 与多项目支持</h3><p>从 6.0 开始，@angular/cli 支持 workspace 特性，之所以能支持 workspace，也是因为背后有 Schematics 这个底层的工具。</p>
<p>有了 workspace 这个机制之后，可以在一个项目里面配置多个子项目，cli 会根据里面的配置进行依赖管理、校验、编译等等操作。</p>
<p><img src="https://cdn.jsdelivr.net/gh/shw2018/cdn@1.0/sakura/img/loader/orange.progress-bar-stripe-loader.svg" data-original="https://images.gitbook.cn/a815e340-ad26-11e9-b015-0198f673a736" alt="workspace "></p>
<p><a href="https://github.com/angular/angular-cli/wiki/angular-workspace" target="_blank" rel="noopener">关于 workspace 官方的完整文档在这里</a>。</p>
<h3 id="3-4-参考资源"><a href="#3-4-参考资源" class="headerlink" title="3.4 参考资源"></a>3.4 参考资源</h3><ul>
<li><a href="https://gitee.com/learn-angular-series/learn-ng-add" target="_blank" rel="noopener">本节涉及到的实例代码请点击这里查看</a></li>
<li><a href="https://www.npmjs.com/package/@angular-devkit/schematics" target="_blank" rel="noopener">Schematics 的用法文档，请点击这里查看</a></li>
<li><a href="https://github.com/angular/angular-cli/wiki" target="_blank" rel="noopener">@angular/cli 官方的 wiki 文档，请点击这里查看</a></li>
<li><a href="https://angular.io/guide/workspace-config" target="_blank" rel="noopener">workspace 多项目配置，请点击这里查看</a></li>
<li><a href="https://blog.angular.io/schematics-an-introduction-dc1dfbc2a2b2" target="_blank" rel="noopener">Angular 官方 blog 里面关于 Schematics 的解释，请点击这里查看</a></li>
</ul>
<h2 id="4-组件-概述"><a href="#4-组件-概述" class="headerlink" title="4.[组件]概述"></a>4.[组件]概述</h2><p>几乎所有前端框架都在玩“组件化”，而且最近都不约而同地选择了“标签化”这种思路，Angular 也不例外。</p>
<p>对新版本的 Angular 来说，一切都是围绕着“组件化”展开的，组件是 Angular 的核心概念模型。</p>
<p>以下是一个最简单的 Angular 组件定义：</p>
<p><img src="https://cdn.jsdelivr.net/gh/shw2018/cdn@1.0/sakura/img/loader/orange.progress-bar-stripe-loader.svg" data-original="https://images.gitbook.cn/131ef0d0-ad29-11e9-a760-01c165706a91" alt="Component"></p>
<ul>
<li>@Component：这是一个 Decorator（装饰器），其作用类似于 Java 里面的 Annotation（注解）。Decorator 这个特性目前处于 Stage 2（草稿）状态，还不是 ECMA 的正式规范，<a href="https://tc39.github.io/proposal-decorators/#decorator-semantics" target="_blank" rel="noopener">具体可参考这里</a>。</li>
<li>selector：组件的标签名，外部使用者可以这样来使用以上组件：<app-root>。默认情况下，ng 命令生成出来的组件都会带上一个 app 前缀，如果你不喜欢，可以在 angular-cli.json 里面修改 prefix 配置项，设置为空字符串将会不带任何前缀。</app-root></li>
<li>templateUrl：引用外部 HTML 模板。如果你想直接编写内联模板，可以使用 template，支持 ES6 引入的“模板字符串”写法，<a href="http://es6.ruanyifeng.com/#docs/string" target="_blank" rel="noopener">具体可参考这里</a>。</li>
<li>styleUrls：引用外部 CSS 样式文件，这是一个数组，也就意味着可以引用多份 CSS 文件。</li>
<li>export class AppComponent：这是 ES6 里面引入的模块和 class 定义方式。</li>
</ul>
<h2 id="5-组件-把-CSS-预编译器改成-SASS"><a href="#5-组件-把-CSS-预编译器改成-SASS" class="headerlink" title="5.[组件]把 CSS 预编译器改成 SASS"></a>5.[组件]把 CSS 预编译器改成 SASS</h2><p>SASS 是一款非常好用的 CSS 预编译器，Bootstrap 官方从 4.0 开始已经切换到了 SASS。</p>
<h3 id="5-1-创建项目的时候指定"><a href="#5-1-创建项目的时候指定" class="headerlink" title="5.1 创建项目的时候指定"></a>5.1 创建项目的时候指定</h3><p>@angular/cli 当前（2019-06）最新的版本是 8.0，可以支持多款 CSS 预编译器，你可以在创建项目的过程中指定：</p>
<p><img src="https://cdn.jsdelivr.net/gh/shw2018/cdn@1.0/sakura/img/loader/orange.progress-bar-stripe-loader.svg" data-original="https://images.gitbook.cn/72144200-ad2b-11e9-8f3f-792c82c0addc" alt="scss"></p>
<h3 id="5-2-手动修改"><a href="#5-2-手动修改" class="headerlink" title="5.2 手动修改"></a>5.2 手动修改</h3><p>某些老项目可能需要手动修改预编译器的类型，所以我把手动修改的方法也留下来备查。</p>
<p>目前（2019-06），@angular/cli 创建项目的时候没有自动使用 SASS 作为预编译器，我们需要自己手动修改一些配置文件，请按照以下步骤依次修改：</p>
<ul>
<li><p>angular-cli.json 里面的 styleExt 改成 scss</p>
<p><img src="https://cdn.jsdelivr.net/gh/shw2018/cdn@1.0/sakura/img/loader/orange.progress-bar-stripe-loader.svg" data-original="https://images.gitbook.cn/8a3949c0-ad2b-11e9-b1a9-0994986ea855" alt="styleExt"></p>
</li>
</ul>
<p>当后面再使用 ng g c *** 自动创建组件的时候，默认就会生成 .scss 后缀的样式文件了。</p>
<ul>
<li>angular-cli.json 里面的 styles.css 后缀改成 .scss</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/shw2018/cdn@1.0/sakura/img/loader/orange.progress-bar-stripe-loader.svg" data-original="https://images.gitbook.cn/9ac3e840-ad2b-11e9-b015-0198f673a736" alt="scss"></p>
<ul>
<li><p>src 下面 style.css 改成 style.scss</p>
<p><img src="https://cdn.jsdelivr.net/gh/shw2018/cdn@1.0/sakura/img/loader/orange.progress-bar-stripe-loader.svg" data-original="https://images.gitbook.cn/d25ed4e0-ad2b-11e9-a760-01c165706a91" alt="scss"></p>
</li>
<li><p>app.component.scss</p>
<p><img src="https://cdn.jsdelivr.net/gh/shw2018/cdn@1.0/sakura/img/loader/orange.progress-bar-stripe-loader.svg" data-original="https://images.gitbook.cn/e6cfae40-ad2b-11e9-8f3f-792c82c0addc" alt="scss"></p>
</li>
<li><p>app.component.ts 里面对应修改</p>
<p><img src="https://cdn.jsdelivr.net/gh/shw2018/cdn@1.0/sakura/img/loader/orange.progress-bar-stripe-loader.svg" data-original="https://images.gitbook.cn/fda7c3a0-ad2b-11e9-b015-0198f673a736" alt="scss"></p>
</li>
</ul>
<p>改完之后，重新 ng serve，打开浏览器查看效果。</p>
<p><a href="http://sass-lang.com/" target="_blank" rel="noopener">SASS 的 API 请参考官方网站</a>。</p>
<p><strong>SASS 只是一个预编译器，它支持所有 CSS 原生语法。利用 SASS 可以提升你的 CSS 编码效率，增强 CSS 代码的可维护性，但是千万不要幻想从此就可以不用学习 CSS 基础知识了。</strong></p>
<h2 id="6-组件-模板的使用"><a href="#6-组件-模板的使用" class="headerlink" title="6.[组件]模板的使用"></a>6.[组件]模板的使用</h2><p>模板是编写 Angular 组件最重要的一环，你必须深入理解以下知识点才能玩转 Angular 模板：</p>
<ul>
<li>对比各种 JS 模板引擎的设计思路</li>
<li>Mustache（八字胡）语法</li>
<li>模板内的局部变量</li>
<li>属性绑定、事件绑定、双向绑定</li>
<li>在模板里面使用结构型指令 <em>ngIf、</em>ngFor、ngSwitch</li>
<li>在模板里面使用属性型指令 NgClass、NgStyle、NgModel</li>
<li>在模板里面使用管道格式化数据</li>
<li>一些小 feature：安全导航、非空断言</li>
</ul>
<p><strong>“深入理解”的含义是：你需要很自如地运用这些 API，写代码的时候不翻阅 API 文档。</strong></p>
<p><strong>因为很多新手之所以编码效率不高，其中一个主要的原因就是在编码过程中不停翻文档、查资料。</strong></p>
<h3 id="6-1-对比各种-JS-模板引擎的设计思路"><a href="#6-1-对比各种-JS-模板引擎的设计思路" class="headerlink" title="6.1 对比各种 JS 模板引擎的设计思路"></a>6.1 对比各种 JS 模板引擎的设计思路</h3><p>几乎每一款前端框架都会提供自己的模板语法：</p>
<ul>
<li>在 jQuery 如日中天的时代，有 Handlebars 那种功能超强的模板</li>
<li>React 推崇 JSX 模板语法</li>
<li>当然还有 Angular 提供的那种与“指令”紧密结合的模板语法</li>
</ul>
<p>综合来说，无论是哪一种前端模板，大家都比较推崇“轻逻辑”（logic-less）的设计思路。<br>何为“轻逻辑”？<br>简而言之，所谓“轻逻辑”就是说，你不能在模板里面编写非常复杂的 JavaScript 表达式。比如，Angular 的模板语法就有规定：</p>
<ul>
<li>你不能在模板里面 new 对象</li>
<li>不能使用 =、+=、-= 这类的表达式</li>
<li>不能用 ++、– 运算符</li>
<li>不能使用位运算符</li>
</ul>
<p>为什么要“轻逻辑”？<br><strong>最重要的原因是怕影响运行性能，因为模板可能会被执行很多次。</strong><br>比如你编写了以下 Angular 模板：</p>
<pre class="line-numbers language-html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ul</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span> <span class="token attr-name">*ngFor</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>let race of races<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
        {{race.name}}
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ul</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>很明显，浏览器不认识 *ngFor 和  这种语法，因此必须在浏览器里面进行“编译”，获得对应的模板函数，然后再把数据传递给模板函数，最终结合起来获得一堆 HTML 标签，然后才能把这一堆标签插入到 DOM 树里面去。</p>
<p>如果启用了 AOT，处理的步骤有一些变化，@angular/cli 会对模板进行“静态编译”，避免在浏览器里面动态编译的过程。</p>
<p>而 Handlebars 这种模板引擎完全是运行时编译模板字符串的，你可以编写以下代码：</p>
<pre><code>//定义模板字符串
var source=`
&lt;ul&gt;
    {{#each races}}
        &lt;li&gt;{{name}}&lt;/li&gt;
    {{/each}}
&lt;/ul&gt;
`;</code></pre><p>//在运行时把模板字符串编译成 JS 函数<br><code>var templateFn=Handlebars.compile(source);</code></p>
<p>//把数据传给模板函数，获得最终的 HTML</p>
<pre class="line-numbers language-typescript"><code class="language-typescript"><span class="token keyword">var</span> html<span class="token operator">=</span><span class="token function">templateFn</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
    <span class="token punctuation">{</span>name<span class="token punctuation">:</span><span class="token string">'人族'</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>name<span class="token punctuation">:</span><span class="token string">'神族'</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>name<span class="token punctuation">:</span><span class="token string">'虫族'</span><span class="token punctuation">}</span>
<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>`<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>注意到 Handlebars.compile 这个调用了吧？这个地方的本质是在运行时把模板字符串“编译”成了一个 JS 函数。</p>
<p>鉴于 JS 解释执行的特性，你可能会担忧这里会有性能问题。这种担忧是合理的，但是 Handlebars 是一款非常优秀的模板引擎，它在内部做了各种优化和缓存处理。模板字符串一般只会在第一次被调用的时候编译一次，Handlebars 会把编译好的函数缓存起来，后面再次调用的时候会从缓存里面获取，而不会多次进行“编译”。</p>
<p>上面我们多次提到了“编译”这个词，因此很显然这里有一个东西是无法避免的，那就是我们必须提供一个 JS 版的“编译器”，让这个“编译器”运行在浏览器里面，这样才能在运行时把用户编写的模板字符串“编译”成模板函数。</p>
<p>有一些模板引擎会真的去用 JS 编写一款“编译器”出来，比如 Angular 和 Handlebars，它们都真的编写了一款 JS（TS）版的编译器。而有一些简单的模板引擎，例如 Underscore 里面的模板函数，只是用正则表达式做了字符串替换而已，显得特别简陋。这种简陋的模板引擎对模板的写法有非常多的限制，因为它不是真正的编译器，能支持的语法特性非常有限。</p>
<p>因此，评估一款模板引擎的强弱，最核心的东西就是评估它的“编译器”做得怎么样。但是不管怎么说，毕竟是 JS 版的“编译器”，我们不可能把它做得像 G++ 那么强大，也没有必要做得那么强大，因为这个 JS 版的编译器需要在浏览器里面运行，搞得太复杂浏览器拖不动！</p>
<p>以上就是为什么大多数模板引擎都要强调“轻逻辑”的最根本原因。</p>
<p>对于 Angular 来说，强调“轻逻辑”还有另一个原因：在组件的整个生命周期里面，模板函数会被执行很多次。你可以想象，Angular 每次要刷新组件外观的时候，都需要去调用一下模板函数，如果你在模板里面编写了非常复杂的代码，一定会增加渲染时间，用户一定会感到界面有“卡顿”。</p>
<p>人眼的视觉延迟大约是 100ms 到 400ms 之间，如果整个页面的渲染时间超过 400ms，界面基本上就卡得没法用了。有一些做游戏的开发者会追求 60fps 刷新率的细腻感觉，60 分之 1 秒约等于 16.7ms，如果 UI 整体的渲染时间超过了 16.7ms，就没法达到这个要求了。</p>
<p>轻逻辑（logic-less）带来了效率的提升，也带来了一些不方便，比如很多模板引擎都实现了 if 语句，但是没有实现 else，因此开发者们在编写复杂业务逻辑的时候模板代码会显得非常啰嗦。</p>
<p>目前来说，并没有完美的方案能同时兼顾运行效率和语法表现能力，这里只能取一个平衡。</p>
<h3 id="6-2-Mustache-语法"><a href="#6-2-Mustache-语法" class="headerlink" title="6.2 Mustache 语法"></a>6.2 Mustache 语法</h3><p>Mustache 语法也就是你们说的双花括号语法 ，老外觉得它像八字胡子，很奇怪啊，难道老外喜欢侧着头看东西？<br>好消息是，很多模板引擎都接受了 Mustache 语法，这样一来学习量又降低了不少，开心吧？</p>
<p>关于 Mustache 语法，你需要掌握 3 点：</p>
<ul>
<li>它可以获取到组件里面定义的属性值</li>
<li>它可以自动计算简单的数学表达式，如加减乘除、取模</li>
<li>它可以获得方法的返回值</li>
</ul>
<p>请依次看例子。<br>插值语法关键代码实例：</p>
<pre class="line-numbers language-html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h3</span><span class="token punctuation">></span></span>
    欢迎来到{{title}}！
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h3</span><span class="token punctuation">></span></span>
public title = '假的星际争霸2'; 

//简单的数学表达式求值：
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h3</span><span class="token punctuation">></span></span>1+1={{1+1}}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h3</span><span class="token punctuation">></span></span>

//调用组件里面定义的方法：
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h3</span><span class="token punctuation">></span></span>可以调用方法{{getVal()}}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h3</span><span class="token punctuation">></span></span>
public getVal():any{
    return 65535;
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="6-3-模板内的局部变量"><a href="#6-3-模板内的局部变量" class="headerlink" title="6.3 模板内的局部变量"></a>6.3 模板内的局部变量</h3><pre><code>&lt;input #heroInput&gt;
&lt;p&gt;{{heroInput.value}}&lt;/p&gt;</code></pre><p>有一些同学会追问，如果我在模板里面定义的局部变量和组件内部的属性重名会怎么样呢？<br>如果真的出现了重名，Angular 会按照以下优先级来进行处理：</p>
<p><code>模板局部变量 &gt; 指令中的同名变量 &gt; 组件中的同名属性。</code></p>
<p>这种优先级规则和 JSP 里面的变量取值规则非常类似，对比一下很好理解对不对？你可以自己写代码测试一下。</p>
<h3 id="6-4-值绑定"><a href="#6-4-值绑定" class="headerlink" title="6.4 值绑定"></a>6.4 值绑定</h3><p>值绑定是用方括号来做的，写法：</p>
<pre><code>&lt;img [src]="imgSrc" /&gt;
public imgSrc:string="./assets/imgs/1.jpg";</code></pre><p>很明显，这种绑定是单向的。</p>
<h3 id="6-4-事件绑定"><a href="#6-4-事件绑定" class="headerlink" title="6.4 事件绑定"></a>6.4 事件绑定</h3><p>事件绑定是用圆括号来做的，写法：</p>
<pre class="line-numbers language-html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>btn btn-success<span class="token punctuation">"</span></span> <span class="token attr-name">(click)</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>btnClick($event)<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>测试事件<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>对应 Component 内部的方法定义：</p>
<pre class="line-numbers language-typescript"><code class="language-typescript"><span class="token keyword">public</span> <span class="token function">btnClick</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span><span class="token punctuation">:</span><span class="token keyword">void</span><span class="token punctuation">{</span>
    <span class="token function">alert</span><span class="token punctuation">(</span><span class="token string">"测试事件绑定！"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<h3 id="6-5-双向绑定"><a href="#6-5-双向绑定" class="headerlink" title="6.5 双向绑定"></a>6.5 双向绑定</h3><p>双向绑定是通过方括号里面套一个圆括号来做的，模板写法：</p>
<pre class="line-numbers language-html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>font-resizer</span> <span class="token attr-name">[(size)]</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>fontSizePx<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>font-resizer</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>对应组件内部的属性定义：</p>
<pre class="line-numbers language-typescript"><code class="language-typescript"><span class="token keyword">public</span> fontSizePx<span class="token punctuation">:</span><span class="token keyword">number</span><span class="token operator">=</span><span class="token number">14</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>AngularJS 是第一个把“双向数据绑定”这个特性带到前端来的框架，这也是 AngularJS 当年最受开发者追捧的特性，之一。</p>
<p>根据 AngularJS 团队当年讲的故事，“双向数据绑定”这个特性可以大幅度压缩前端代码的规模。大家可以回想一下 jQuery 时代的做法，如果要实现类似的效果，是不是要自己去编写大量的代码？尤其是那种大规模的表单，一大堆的赋值和取值操作，都是非常丑陋的“面条”代码，而有了“双向数据绑定”特性之后，一个绑定表达式就搞定。</p>
<p>目前，主流的几款前端框架都已经接受了“双向数据绑定”这个特性。</p>
<p>当然，也有一些人不喜欢“双向数据绑定”，还有人专门写了文章来进行批判，也算是前端一景。</p>
<h3 id="6-6-在模板里面使用结构型指令"><a href="#6-6-在模板里面使用结构型指令" class="headerlink" title="6.6 在模板里面使用结构型指令"></a>6.6 在模板里面使用结构型指令</h3><p>Angular 有 3 个内置的结构型指令：<em>ngIf、</em>ngFor、ngSwitch。ngSwitch 的语法比较啰嗦，使用频率小一些。</p>
<p>*ngIf 代码实例:</p>
<pre class="line-numbers language-html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span> <span class="token attr-name">*ngIf</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>isShow<span class="token punctuation">"</span></span><span class="token style-attr language-css"><span class="token attr-name"> <span class="token attr-name">style</span></span><span class="token punctuation">="</span><span class="token attr-value"><span class="token property">background-color</span><span class="token punctuation">:</span><span class="token hexcode">#ff3300</span></span><span class="token punctuation">"</span></span><span class="token punctuation">></span></span>显示还是不显示？<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>btn btn-success<span class="token punctuation">"</span></span> <span class="token attr-name">(click)</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>toggleShow()<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>控制显示隐藏<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<pre class="line-numbers language-typescript"><code class="language-typescript"><span class="token keyword">public</span> isShow<span class="token punctuation">:</span><span class="token keyword">boolean</span><span class="token operator">=</span><span class="token keyword">true</span><span class="token punctuation">;</span>
<span class="token keyword">public</span> <span class="token function">toggleShow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span><span class="token keyword">void</span><span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>isShow<span class="token operator">=</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>isShow<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>*ngFor 代码实例：</p>
<pre class="line-numbers language-html"><code class="language-html">
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span> <span class="token attr-name">*ngFor</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>let race of races;let i<span class="token punctuation">=</span>index;<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
    {{i+1}}-{{race.name}}
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-typescript"><code class="language-typescript"><span class="token keyword">public</span> races<span class="token punctuation">:</span><span class="token keyword">Array</span><span class="token operator">=</span><span class="token punctuation">[</span>
    <span class="token punctuation">{</span>name<span class="token punctuation">:</span><span class="token string">"人族"</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>name<span class="token punctuation">:</span><span class="token string">"虫族"</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>name<span class="token punctuation">:</span><span class="token string">"神族"</span><span class="token punctuation">}</span>
<span class="token punctuation">]</span><span class="token punctuation">;</span> <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>*ngSwitch 代码实例：</p>
<pre class="line-numbers language-html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">[ngSwitch]</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>mapStatus<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span> <span class="token attr-name">*ngSwitchCase</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>0<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>下载中...<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span> <span class="token attr-name">*ngSwitchCase</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>1<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>正在读取...<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span> <span class="token attr-name">*ngSwitchDefault</span><span class="token punctuation">></span></span>系统繁忙...<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-typescript"><code class="language-typescript"><span class="token keyword">public</span> mapStatus<span class="token punctuation">:</span><span class="token keyword">number</span><span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p><strong>特别注意：一个 HTML 标签上只能同时使用一个结构型的指令。</strong></p>
<p>因为“结构型”指令会修改 DOM 结构，如果在一个标签上使用多个结构型指令，大家都一起去修改 DOM 结构，到时候到底谁说了算？</p>
<p>那么需要在同一个 HTML 上使用多个结构型指令应该怎么办呢？有两个办法：</p>
<ul>
<li>加一层空的 div 标签</li>
<li>加一层 <ng-container></ng-container></li>
</ul>
<h3 id="6-7-在模板里面使用属性型指令"><a href="#6-7-在模板里面使用属性型指令" class="headerlink" title="6.7 在模板里面使用属性型指令"></a>6.7 在模板里面使用属性型指令</h3><p>使用频率比较高的 3 个内置指令是：NgClass、NgStyle、NgModel。</p>
<p>NgClass 使用案例代码：</p>
<pre class="line-numbers language-html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">[ngClass]</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>currentClasses<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>同时批量设置多个样式<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>btn btn-success<span class="token punctuation">"</span></span> <span class="token attr-name">(click)</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>setCurrentClasses()<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>设置<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<pre class="line-numbers language-typescript"><code class="language-typescript"><span class="token keyword">public</span> currentClasses<span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">public</span> canSave<span class="token punctuation">:</span> <span class="token keyword">boolean</span> <span class="token operator">=</span> <span class="token keyword">true</span><span class="token punctuation">;</span>
<span class="token keyword">public</span> isUnchanged<span class="token punctuation">:</span> <span class="token keyword">boolean</span> <span class="token operator">=</span> <span class="token keyword">true</span><span class="token punctuation">;</span>
<span class="token keyword">public</span> isSpecial<span class="token punctuation">:</span> <span class="token keyword">boolean</span> <span class="token operator">=</span> <span class="token keyword">true</span><span class="token punctuation">;</span>

<span class="token function">setCurrentClasses</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>currentClasses <span class="token operator">=</span> <span class="token punctuation">{</span>
        <span class="token string">'saveable'</span><span class="token punctuation">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>canSave<span class="token punctuation">,</span>
        <span class="token string">'modified'</span><span class="token punctuation">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>isUnchanged<span class="token punctuation">,</span>
        <span class="token string">'special'</span><span class="token punctuation">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>isSpecial
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-css"><code class="language-css"><span class="token selector"><span class="token class">.saveable</span></span><span class="token punctuation">{</span>
    <span class="token property">font-size</span><span class="token punctuation">:</span> <span class="token number">18</span>px<span class="token punctuation">;</span>
<span class="token punctuation">}</span> 
<span class="token selector"><span class="token class">.modified</span> </span><span class="token punctuation">{</span>
    <span class="token property">font-weight</span><span class="token punctuation">:</span> bold<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token selector"><span class="token class">.special</span></span><span class="token punctuation">{</span>
    <span class="token property">background-color</span><span class="token punctuation">:</span> <span class="token hexcode">#ff3300</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>NgStyle 使用案例代码：</p>
<pre class="line-numbers language-html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">[ngStyle]</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>currentStyles<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
    用NgStyle批量修改内联样式！
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>btn btn-success<span class="token punctuation">"</span></span> <span class="token attr-name">(click)</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>setCurrentStyles()<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>设置<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-typescript"><code class="language-typescript"><span class="token keyword">public</span> currentStyles<span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token keyword">public</span> canSave<span class="token punctuation">:</span><span class="token keyword">boolean</span><span class="token operator">=</span><span class="token keyword">false</span><span class="token punctuation">;</span>
<span class="token keyword">public</span> isUnchanged<span class="token punctuation">:</span><span class="token keyword">boolean</span><span class="token operator">=</span><span class="token keyword">false</span><span class="token punctuation">;</span>
<span class="token keyword">public</span> isSpecial<span class="token punctuation">:</span><span class="token keyword">boolean</span><span class="token operator">=</span><span class="token keyword">false</span><span class="token punctuation">;</span>

<span class="token function">setCurrentStyles</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>currentStyles <span class="token operator">=</span> <span class="token punctuation">{</span>
        <span class="token string">'font-style'</span><span class="token punctuation">:</span>  <span class="token keyword">this</span><span class="token punctuation">.</span>canSave      <span class="token operator">?</span> <span class="token string">'italic'</span> <span class="token punctuation">:</span> <span class="token string">'normal'</span><span class="token punctuation">,</span>
        <span class="token string">'font-weight'</span><span class="token punctuation">:</span> <span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>isUnchanged <span class="token operator">?</span> <span class="token string">'bold'</span>   <span class="token punctuation">:</span> <span class="token string">'normal'</span><span class="token punctuation">,</span>
        <span class="token string">'font-size'</span><span class="token punctuation">:</span>   <span class="token keyword">this</span><span class="token punctuation">.</span>isSpecial    <span class="token operator">?</span> <span class="token string">'36px'</span>   <span class="token punctuation">:</span> <span class="token string">'12px'</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>ngStyle 这种方式相当于在代码里面写 CSS 样式，比较丑陋，违反了注意点分离的原则，而且将来不太好修改，非常不建议这样写。</p>
<p>NgModel 使用案例代码：</p>
<pre class="line-numbers language-html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>text-danger<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>ngModel只能用在表单类的元素上面<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">[(ngModel)]</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>currentRace.name<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">></span></span>{{currentRace.name}}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-typescript"><code class="language-typescript"><span class="token keyword">public</span> currentRace<span class="token punctuation">:</span><span class="token keyword">any</span><span class="token operator">=</span><span class="token punctuation">{</span>name<span class="token punctuation">:</span><span class="token string">"随机种族"</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>请注意，如果你需要使用 NgModel 来进行双向数据绑定，必须要在对应的模块里面 import FormsModule 。</p>
<h3 id="6-8-管道"><a href="#6-8-管道" class="headerlink" title="6.8 管道"></a>6.8 管道</h3><p>管道的一个典型作用是用来格式化数据，来一个最简单的例子：</p>
<p><code>{{currentTime | date:'yyyy-MM-dd HH:mm:ss'}}</code></p>
<pre class="line-numbers language-typescript"><code class="language-typescript"><span class="token keyword">public</span> currentTime<span class="token punctuation">:</span> Date <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>Angular 里面一共内置了 17 个指令（有一些已经过时了）：</p>
<p><img src="https://cdn.jsdelivr.net/gh/shw2018/cdn@1.0/sakura/img/loader/orange.progress-bar-stripe-loader.svg" data-original="https://images.gitbook.cn/9572e7e0-ad2d-11e9-8f3f-792c82c0addc" alt="enter image description here"></p>
<p>在复杂的业务场景里面，17 个指令肯定不够用，如果需要自定义指令，请查看这里的例子： <a href="https://angular.io/guide/pipes" target="_blank" rel="noopener">https://angular.io/guide/pipes</a> 。<br>管道还有另一个典型的作用，就是用来做国际化，后面有一个独立的小节专门演示 Angular 的国际化写法。</p>
<h2 id="7-组件-组件间通讯"><a href="#7-组件-组件间通讯" class="headerlink" title="7.[组件]组件间通讯"></a>7.[组件]组件间通讯</h2><p>组件就像零散的积木，我们需要把这些积木按照一定的规则拼装起来，而且要让它们互相之间能进行通讯，这样才能构成一个有机的完整系统。</p>
<p>在真实的应用中，组件最终会构成树形结构，就像人类社会中的家族树一样：</p>
<p><img src="https://cdn.jsdelivr.net/gh/shw2018/cdn@1.0/sakura/img/loader/orange.progress-bar-stripe-loader.svg" data-original="https://images.gitbook.cn/1290c0f0-ad31-11e9-a760-01c165706a91" alt="component communication"></p>
<p>在树形结构里面，组件之间有几种典型的关系：父子关系、兄弟关系、没有直接关系。</p>
<p>相应地，组件之间有以下几种典型的通讯方案：</p>
<ul>
<li>直接的父子关系：父组件直接访问子组件的 public 属性和方法</li>
<li>直接的父子关系：借助于 @Input 和 @Output 进行通讯</li>
<li>没有直接关系：借助于 Service 单例进行通讯</li>
<li>利用 cookie 和 localstorage 进行通讯</li>
<li>利用 session 进行通讯</li>
</ul>
<p>无论你使用什么前端框架，组件之间的通讯都离开不以上几种方案，这些方案与具体框架无关。</p>
<h3 id="7-1-直接调用"><a href="#7-1-直接调用" class="headerlink" title="7.1 直接调用"></a>7.1 直接调用</h3><p>对于有直接父子关系的组件，父组件可以直接访问子组件里面 public 型的属性和方法，示例代码片段如下：</p>
<pre class="line-numbers language-html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>child</span> <span class="token attr-name">#child</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>child</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">(click)</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>child.childFn()<span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>btn btn-success<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>调用子组件方法<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>显然，子组件里面必须暴露一个 public 型的 childFn 方法，就像这样：</p>
<pre class="line-numbers language-typescript"><code class="language-typescript"><span class="token keyword">public</span> <span class="token function">childFn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span><span class="token keyword">void</span><span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"子组件的名字是>"</span><span class="token operator">+</span><span class="token keyword">this</span><span class="token punctuation">.</span>panelTitle<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>以上是通过在模板里面定义局部变量的方式来直接调用子组件里面的 public 型方法。在父组件的内部也可以访问到子组件的实例，需要利用到 @ViewChild 装饰器，示例如下：</p>
<pre class="line-numbers language-typescript"><code class="language-typescript">@<span class="token function">ViewChild</span><span class="token punctuation">(</span>ChildComponent<span class="token punctuation">)</span>
<span class="token keyword">private</span> childComponent<span class="token punctuation">:</span> ChildComponent<span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>关于 @ViewChild 在后面的内容里面会有更详细的解释。</p>
<p>很明显，如果父组件直接访问子组件，那么两个组件之间的关系就被固定死了。父子两个组件紧密依赖，谁也离不开谁，也就都不能单独使用了。所以，除非你知道自己在做什么，最好不要直接在父组件里面直接访问子组件上的属性和方法，以免未来一改一大片。</p>
<h3 id="7-2-Input-和-Output"><a href="#7-2-Input-和-Output" class="headerlink" title="7.2 @Input 和 @Output"></a>7.2 @Input 和 @Output</h3><p>我们可以利用 @Input 装饰器，让父组件直接给子组件传递参数，子组件上这样写：</p>
<pre class="line-numbers language-typescript"><code class="language-typescript">@<span class="token function">Input</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> panelTitle<span class="token punctuation">:</span><span class="token keyword">string</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>父组件上可以这样设置 panelTitle 这个参数：</p>
<pre class="line-numbers language-html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>child</span> <span class="token attr-name">panelTitle</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>一个新的标题<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>child</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>@Output 的本质是事件机制，我们可以利用它来监听子组件上派发的事件，子组件上这样写：</p>
<pre class="line-numbers language-typescript"><code class="language-typescript">@<span class="token function">Output</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> follow<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">EventEmitter</span><span class="token operator">&lt;</span><span class="token keyword">string</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>触发 follow 事件的方式如下：</p>
<pre class="line-numbers language-typescript"><code class="language-typescript"><span class="token keyword">this</span><span class="token punctuation">.</span>follow<span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span><span class="token string">"follow"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>父组件上可以这样监听 follow 事件：</p>
<pre class="line-numbers language-typescript"><code class="language-typescript"><span class="token operator">&lt;</span>child <span class="token punctuation">(</span>follow<span class="token punctuation">)</span><span class="token operator">=</span><span class="token string">"doSomething()"</span><span class="token operator">></span><span class="token operator">&lt;</span><span class="token operator">/</span>child<span class="token operator">></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>我们可以利用 @Output 来自定义事件，监听自定义事件的方式也是通过小圆括号，与监听 HTML 原生事件的方式一模一样。</p>
<h3 id="7-3-利用-Service-单例进行通讯"><a href="#7-3-利用-Service-单例进行通讯" class="headerlink" title="7.3 利用 Service 单例进行通讯"></a>7.3 利用 Service 单例进行通讯</h3><p><img src="https://cdn.jsdelivr.net/gh/shw2018/cdn@1.0/sakura/img/loader/orange.progress-bar-stripe-loader.svg" data-original="https://images.gitbook.cn/659d3260-b8d0-11e9-8b62-c350e3466c22" alt=""><br>如果你在根模块（一般是 app.module.ts）的 providers 里面注册一个 Service，那么这个 Service 就是全局单例的，这样一来我们就可以利用这个单例的 Service 在不同的组件之间进行通讯了。</p>
<ul>
<li>比较粗暴的方式：我们可以在 Service 里面定义 public 型的共享变量，然后让不同的组件都来访问这块变量，从而达到共享数据的目的。</li>
<li>优雅一点的方式：利用 RxJS，在 Service 里面定义一个 public 型的 Subject（主题），然后让所有组件都来 subscribe（订阅）这个主题，类似于一种“事件总线”的效果。</li>
</ul>
<p>实例代码片段：</p>
<pre class="line-numbers language-typescript"><code class="language-typescript"><span class="token keyword">import</span> <span class="token punctuation">{</span> Injectable <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@angular/core'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Observable <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'rxjs/Observable'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Subject <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'rxjs/Subject'</span><span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">/**
 * 用来充当事件总线的 Service
 */</span>
@<span class="token function">Injectable</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">EventBusService</span> <span class="token punctuation">{</span>
  <span class="token keyword">public</span> eventBus<span class="token punctuation">:</span>Subject<span class="token operator">&lt;</span><span class="token keyword">string</span><span class="token operator">></span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Subject</span><span class="token operator">&lt;</span><span class="token keyword">string</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span>

<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-typescript"><code class="language-typescript"><span class="token keyword">import</span> <span class="token punctuation">{</span> Component<span class="token punctuation">,</span> OnInit <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@angular/core'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> EventBusService <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'../service/event-bus.service'</span><span class="token punctuation">;</span>

@<span class="token function">Component</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  selector<span class="token punctuation">:</span> <span class="token string">'child-1'</span><span class="token punctuation">,</span>
  templateUrl<span class="token punctuation">:</span> <span class="token string">'./child-1.component.html'</span><span class="token punctuation">,</span>
  styleUrls<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'./child-1.component.css'</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">Child1Component</span> <span class="token keyword">implements</span> <span class="token class-name">OnInit</span> <span class="token punctuation">{</span>

  <span class="token keyword">constructor</span><span class="token punctuation">(</span><span class="token keyword">public</span> eventBusService<span class="token punctuation">:</span>EventBusService<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span>

  <span class="token function">ngOnInit</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">public</span> <span class="token function">triggerEventBus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span><span class="token keyword">void</span><span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>eventBusService<span class="token punctuation">.</span>eventBus<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token string">"第一个组件触发的事件"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-typescript"><code class="language-typescript"><span class="token keyword">import</span> <span class="token punctuation">{</span> Component<span class="token punctuation">,</span> OnInit <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@angular/core'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> EventBusService <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'../service/event-bus.service'</span><span class="token punctuation">;</span>

@<span class="token function">Component</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  selector<span class="token punctuation">:</span> <span class="token string">'child-2'</span><span class="token punctuation">,</span>
  templateUrl<span class="token punctuation">:</span> <span class="token string">'./child-2.component.html'</span><span class="token punctuation">,</span>
  styleUrls<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'./child-2.component.css'</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">Child2Component</span> <span class="token keyword">implements</span> <span class="token class-name">OnInit</span> <span class="token punctuation">{</span>
  <span class="token keyword">public</span> events<span class="token punctuation">:</span><span class="token keyword">Array</span><span class="token operator">&lt;</span><span class="token keyword">any</span><span class="token operator">>=</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

  <span class="token keyword">constructor</span><span class="token punctuation">(</span><span class="token keyword">public</span> eventBusService<span class="token punctuation">:</span>EventBusService<span class="token punctuation">)</span> <span class="token punctuation">{</span>

  <span class="token punctuation">}</span>

  <span class="token function">ngOnInit</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>eventBusService<span class="token punctuation">.</span>eventBus<span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token operator">=</span><span class="token operator">></span><span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>events<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>value<span class="token operator">+</span><span class="token string">"-"</span><span class="token operator">+</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="7-4-利用cookie或者localstorage进行通讯"><a href="#7-4-利用cookie或者localstorage进行通讯" class="headerlink" title="7.4 利用cookie或者localstorage进行通讯"></a>7.4 利用cookie或者localstorage进行通讯</h3><p><img src="https://cdn.jsdelivr.net/gh/shw2018/cdn@1.0/sakura/img/loader/orange.progress-bar-stripe-loader.svg" data-original="https://images.gitbook.cn/986efe30-b8d0-11e9-ba33-51636d56aead" alt=""><br>示例代码片段：</p>
<pre class="line-numbers language-typescript"><code class="language-typescript"><span class="token keyword">public</span> <span class="token function">writeData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span><span class="token keyword">void</span><span class="token punctuation">{</span>
    window<span class="token punctuation">.</span>localStorage<span class="token punctuation">.</span><span class="token function">setItem</span><span class="token punctuation">(</span><span class="token string">"json"</span><span class="token punctuation">,</span>JSON<span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span><span class="token punctuation">{</span>name<span class="token punctuation">:</span><span class="token string">'大漠穷秋'</span><span class="token punctuation">,</span>age<span class="token punctuation">:</span><span class="token number">18</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-typescript"><code class="language-typescript"><span class="token keyword">var</span> json<span class="token operator">=</span>window<span class="token punctuation">.</span>localStorage<span class="token punctuation">.</span><span class="token function">getItem</span><span class="token punctuation">(</span><span class="token string">"json"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">// window.localStorage.removeItem("json");</span>
<span class="token keyword">var</span> obj<span class="token operator">=</span>JSON<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>json<span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>obj<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>obj<span class="token punctuation">.</span>age<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><strong>很多同学写 Angular 代码的时候出现了思维定势，总感觉 Angular 会封装所有东西，实际上并非如此。比如 cookie、localstorage 这些东西都可以直接用原生的 API 进行操作的。千万别忘记原生的那些 API 啊，都能用的！</strong></p>
<h3 id="7-5-利用-session-进行通讯"><a href="#7-5-利用-session-进行通讯" class="headerlink" title="7.5 利用 session 进行通讯"></a>7.5 利用 session 进行通讯</h3><p><img src="https://cdn.jsdelivr.net/gh/shw2018/cdn@1.0/sakura/img/loader/orange.progress-bar-stripe-loader.svg" data-original="https://images.gitbook.cn/ba052b00-b8d0-11e9-ba33-51636d56aead" alt="session"></p>
<h3 id="7-6-小结"><a href="#7-6-小结" class="headerlink" title="7.6 小结"></a>7.6 小结</h3><p>组件间的通讯方案是通用的，无论你使用什么样的前端框架，都会面临这个问题，而解决的方案无外乎本文所列出的几种。</p>
<h2 id="8-组件-生命周期钩子"><a href="#8-组件-生命周期钩子" class="headerlink" title="8.[组件]生命周期钩子"></a>8.[组件]生命周期钩子</h2><p>我不打算在这里罗列 API，在官方网站上面有更详细的描述和例子：</p>
<blockquote>
<p><a href="https://angular.io/guide/lifecycle-hooks" target="_blank" rel="noopener">https://angular.io/guide/lifecycle-hooks</a></p>
</blockquote>
<p>在这一节里面我们只讨论以下 4 件事：</p>
<ul>
<li>什么是 UI 组件的生命周期？</li>
<li>Angular 组件的生命周期有什么特别的地方？</li>
<li>OnPush 策略的使用方式。</li>
<li>简要介绍脏检查的实现原理。</li>
</ul>
<h3 id="8-1-UI-组件的生命周期"><a href="#8-1-UI-组件的生命周期" class="headerlink" title="8.1 UI 组件的生命周期"></a>8.1 UI 组件的生命周期</h3><p><img src="https://cdn.jsdelivr.net/gh/shw2018/cdn@1.0/sakura/img/loader/orange.progress-bar-stripe-loader.svg" data-original="https://images.gitbook.cn/56550980-b8d1-11e9-a88b-c93a5ea3d618" alt="LifeCycle"></p>
<p>无论使用什么样的前端框架，只要编写 UI 组件，生命周期都是必须要考虑的重要内容。请展开你的想象，如果让你来设计 UI 系统，组件有几个重要的阶段一定是绕不开的，比如：</p>
<ul>
<li>初始化（init）阶段：在这个阶段你需要把组件 new 出来，把一些属性设置上去，等等这些操作。</li>
<li>渲染（render）阶段：在这个阶段需你要把组件的模板和数据结合起来，生成 HTML 标签结构，并且要整合到现有的 DOM 树里面去。</li>
<li>存活阶段：既然带有 UI，那么在组件的存活期内就一定会和用户进行交互。一般来说，带有 UI 的系统都是通过事件机制进行用户交互的。也就是说，这个阶段将会处理大量的用户事件：鼠标点击、键盘按键、手指触摸。</li>
<li>销毁（destory）阶段：最后，组件使用完了，需要把一些资源释放掉。最典型的操作：需要把组件上的所有事件全部清理干净，避免造成内存泄漏。</li>
</ul>
<p>在组件生命的不同阶段，框架一般会暴露出一些“接口”，开发者可以利用这些接口来实现一些自己的业务逻辑。这种接口在有些框架里面叫做“事件”，在 Angular 里面叫做“钩子”，但其底层的本质都是一样的。</p>
<h3 id="8-2-Angular-组件的生命周期钩子"><a href="#8-2-Angular-组件的生命周期钩子" class="headerlink" title="8.2 Angular 组件的生命周期钩子"></a>8.2 Angular 组件的生命周期钩子</h3><p><img src="https://cdn.jsdelivr.net/gh/shw2018/cdn@1.0/sakura/img/loader/orange.progress-bar-stripe-loader.svg" data-original="https://images.gitbook.cn/fbf2cda0-b8d1-11e9-a88b-c93a5ea3d618" alt="Hook"></p>
<ul>
<li>Angular 一共暴露了 8 个“钩子”，构造函数不算。</li>
<li>并没有组件或者指令会实现全部钩子。</li>
<li>绿色的 1357 会被执行很多次，2468 只会执行一次。</li>
<li>Content 和 View 相关的 4 个钩子只对组件有效，指令上不能使用。因为在新版本的 Angular 里面，指令不能带有 HTML 模板。指令没有自己的 UI，当然就没有 View 和 Content 相关的“钩子”了。</li>
<li>请不要在生命周期钩子里面实现复杂的业务逻辑，尤其是那 4 个会被反复执行的钩子，否则一定会造成界面卡顿。</li>
<li>对于 @Input 型的属性，在构造函数里面是取不到值的，在 ngOnInit 里面才有值。</li>
<li>在 ngAfterViewChecked 这个钩子里面不可以再修改组件内部被绑定的值，否则会抛出异常。</li>
</ul>
<p><strong>特别注意：对于业务开发者来说，一般只用到 ngOnInit 这个钩子，其它几个钩子在日常业务开发中是用不到的。</strong></p>
<h3 id="8-3-OnPush-策略"><a href="#8-3-OnPush-策略" class="headerlink" title="8.3 OnPush 策略"></a>8.3 OnPush 策略</h3><p>在真实的业务系统中，组件会构成 Tree 型结构，就像这样：</p>
<p><img src="https://cdn.jsdelivr.net/gh/shw2018/cdn@1.0/sakura/img/loader/orange.progress-bar-stripe-loader.svg" data-original="https://images.gitbook.cn/2634fac0-b8d2-11e9-8b62-c350e3466c22" alt=""></p>
<p>当某个叶子组件上的数据模型发生变化之后，就像这样：</p>
<p><img src="https://cdn.jsdelivr.net/gh/shw2018/cdn@1.0/sakura/img/loader/orange.progress-bar-stripe-loader.svg" data-original="https://images.gitbook.cn/2e36b150-b8d2-11e9-a88b-c93a5ea3d618" alt=""></p>
<p><strong>这时候，Angular 将会从根组件开始，遍历整颗组件树，把所有组件上的 ngDoCheck() 方法都调用一遍：</strong></p>
<p><img src="https://cdn.jsdelivr.net/gh/shw2018/cdn@1.0/sakura/img/loader/orange.progress-bar-stripe-loader.svg" data-original="https://images.gitbook.cn/3df57450-b8d2-11e9-ba33-51636d56aead" alt=""></p>
<p><strong>请注意，默认情况下，无论哪个叶子组件上发生了变化，都会把整个组件树遍历一遍。</strong>如果组件树非常庞大，嵌套非常深，很明显会有效率问题。在绝大部分时间里面，并不会出现每个组件都需要刷新的情况，根本没有必要每次都去全部遍历。所以 Angular 提供了一种叫做 OnPush 的策略，只要把某个组件上的检测策略设置为 OnPush，就可以忽略整个子树了，就像这样：</p>
<p><img src="https://cdn.jsdelivr.net/gh/shw2018/cdn@1.0/sakura/img/loader/orange.progress-bar-stripe-loader.svg" data-original="https://images.gitbook.cn/582abe70-b8d2-11e9-a88b-c93a5ea3d618" alt=""></p>
<p>很明显，使用了 OnPush 策略之后，检查效率将会获得大幅度的提升，尤其在组件的数量非常多的情况下：</p>
<p><img src="https://cdn.jsdelivr.net/gh/shw2018/cdn@1.0/sakura/img/loader/orange.progress-bar-stripe-loader.svg" data-original="https://images.gitbook.cn/5f786740-b8d2-11e9-ba33-51636d56aead" alt=""></p>
<p>Angular 内置的两种变更检测策略：</p>
<ul>
<li>Default：无论哪个组件发生了变化，从根组件开始全局遍历，调用每个组件上的 ngDoCheck() 钩子。</li>
<li>OnPush：<strong>只有当组件的 @Input 属性发生变化的时候才调用本组件的 ngDoCheck() 钩子。</strong></li>
</ul>
<p>有一些开发者建议 Angular 项目组把 OnPush 作为默认策略，但是目前还没有得到官方支持，或许在未来的某个版本里面会进行修改。</p>
<h3 id="8-4-了解一点点原理"><a href="#8-4-了解一点点原理" class="headerlink" title="8.4 了解一点点原理"></a>8.4 了解一点点原理</h3><p>如果你不想看到扯原理的内容，可以跳过这一小段。</p>
<p><img src="https://cdn.jsdelivr.net/gh/shw2018/cdn@1.0/sakura/img/loader/orange.progress-bar-stripe-loader.svg" data-original="https://images.gitbook.cn/78b3c100-b8d2-11e9-8b62-c350e3466c22" alt=""></p>
<p>大家都知道，AngularJS 是第一个把“双向数据绑定”这种设计带到前端领域来的框架，“双向数据绑定”最典型的场景就是对表单的处理。</p>
<p>双向数据绑定的目标很明确：数据模型发生变化之后，界面可以自动刷新；用户修改了界面上的内容之后，数据模型也会发生自动修改。</p>
<p>很明显，这里需要一种同步机制，在 Angular 里面这种同步机制叫做“变更检测”。</p>
<p>在老版本 AgnularJS 里面，变更检测机制实现得不太完善，经常会出现检测不到变更的情况，所以才有了让大家很厌烦的 $apply() 调用。</p>
<p>在新版本的 Angular 里面不再存在这个问题了，因为新版本的 Angular 使用 Zone.js 这个库，它会把所有可能导致数据模型发生变更的情况全部拦截掉，从而在数据发生变化的时候去通知 Angular 进行刷新。</p>
<p>有一些朋友可能会觉得奇怪，Zone.js 怎么这么牛叉？它内部到底是怎么玩的呢？</p>
<p>实际上要做到这一点并不复杂，因为在浏览器环境下，有可能导致数据模型发生变化的情况只有 3 种典型的回调：</p>
<ul>
<li>事件回调：鼠标、键盘、触摸</li>
<li>定时器回调：setTimeout 和 setInterval</li>
<li>Ajax 回调</li>
</ul>
<p>Zone.js 覆盖了所有原生实现，当开发者在调用这些函数的时候，并不是调用的原生方法，而是调用的 Zone.js 自己的实现，因此 Zone.js 就可以做一些自己的处理了。</p>
<p>也就是说 Zone.js 会负责通知 Angular：“数据模型发生变化了”！然后 Angular 的 ChangeDetector 就会在下一次 dirty check 的周期里面来检查哪些组件上的值发生了变化，然后做出相应的处理。</p>
<p>如果你的好奇心特别旺盛，这里有一篇非常长的文章，大约二十多页，详细解释了这一话题：</p>
<blockquote>
<p><a href="https://blog.thoughtram.io/angular/2016/02/22/angular-2-change-detection-explained.html" target="_blank" rel="noopener">https://blog.thoughtram.io/angular/2016/02/22/angular-2-change-detection-explained.html</a></p>
</blockquote>
<h2 id="9-组件-动效"><a href="#9-组件-动效" class="headerlink" title="9.[组件]动效"></a>9.[组件]动效</h2><h3 id="9-1-非常重要的说明"><a href="#9-1-非常重要的说明" class="headerlink" title="9.1 非常重要的说明"></a>9.1 非常重要的说明</h3><p>Angular 默认的动画模块使用的是 Web Animations 规范，这个规范目前处于 Editor’s Draft 状态（2017-09-22），详情请看这里：</p>
<blockquote>
<p><a href="https://w3c.github.io/web-animations/" target="_blank" rel="noopener">https://w3c.github.io/web-animations/</a></p>
</blockquote>
<p>目前，各大浏览器厂商对 Web Animations 规范的支持并不好，请看下图：</p>
<p><img src="https://cdn.jsdelivr.net/gh/shw2018/cdn@1.0/sakura/img/loader/orange.progress-bar-stripe-loader.svg" data-original="https://images.gitbook.cn/de64ed30-b8d2-11e9-ba33-51636d56aead" alt=""></p>
<p>（图片来自：<a href="http://caniuse.com/#feat=web-animation）" target="_blank" rel="noopener">http://caniuse.com/#feat=web-animation）</a></p>
<p>Web Animations 这套新的规范在 FireFox、Chrome、Opera 里面得到了完整的支持，而其它所有浏览器内核几乎都完全不支持，所以请慎重选择。我的建议是，请优先使用 CSS3 规范里面的 anmimation 方案：</p>
<blockquote>
<p><a href="https://www.w3schools.com/css/css3_animations.asp" target="_blank" rel="noopener">https://www.w3schools.com/css/css3_animations.asp</a></p>
</blockquote>
<h3 id="9-2-用法示范"><a href="#9-2-用法示范" class="headerlink" title="9.2 用法示范"></a>9.2 用法示范</h3><p>第一步，导入动画模块：</p>
<p><img src="https://cdn.jsdelivr.net/gh/shw2018/cdn@1.0/sakura/img/loader/orange.progress-bar-stripe-loader.svg" data-original="https://images.gitbook.cn/192ab3f0-b8d3-11e9-ba33-51636d56aead" alt=""></p>
<p>第二步，编写动效：</p>
<p><img src="https://cdn.jsdelivr.net/gh/shw2018/cdn@1.0/sakura/img/loader/orange.progress-bar-stripe-loader.svg" data-original="https://images.gitbook.cn/20660d40-b8d3-11e9-a194-19c3d4002b01" alt=""></p>
<p>flyIn 是这个动效的名称，后面我面就可以在组件里面引用 flynIn 这个名字了。</p>
<p>动效整体上是由“状态”和“转场”两个部分构成的：</p>
<ul>
<li>以上代码里面的星号（<em>）表示“不可见状态”，void 表示任意状态。这是两种内置的状态，</em>=&gt;void 表示是进场动画，而 void=&gt;* 表示离场动画。当然你也可以定义自己的状态名称，注意不要和内置的状态名称发生冲突。</li>
<li>keyframes 里面的内容是关键帧的定义，语法和 CSS3 里面定义动画的方式非常类似。</li>
</ul>
<p>第三步，在组件里面使用 flyIn 这个动效：</p>
<p><img src="https://cdn.jsdelivr.net/gh/shw2018/cdn@1.0/sakura/img/loader/orange.progress-bar-stripe-loader.svg" data-original="https://images.gitbook.cn/68b1be00-b8d3-11e9-a194-19c3d4002b01" alt=""></p>
<p><img src="https://cdn.jsdelivr.net/gh/shw2018/cdn@1.0/sakura/img/loader/orange.progress-bar-stripe-loader.svg" data-original="https://images.gitbook.cn/70e61d50-b8d3-11e9-a194-19c3d4002b01" alt=""></p>
<p>这个例子完整的代码在这里：</p>
<blockquote>
<p><a href="https://gitee.com/learn-angular-series/learn-component" target="_blank" rel="noopener">https://gitee.com/learn-angular-series/learn-component</a></p>
</blockquote>
<p>代码在 animation 分支上面，运行起来你可以看到这个效果界面：</p>
<p><img src="https://cdn.jsdelivr.net/gh/shw2018/cdn@1.0/sakura/img/loader/orange.progress-bar-stripe-loader.svg" data-original="https://images.gitbook.cn/8c2b9ef0-b8d3-11e9-a88b-c93a5ea3d618" alt=""></p>
<h3 id="9-3-小结"><a href="#9-3-小结" class="headerlink" title="9.3 小结"></a>9.3 小结</h3><p>Angular 官方的动效文档在这里：</p>
<blockquote>
<p><a href="https://angular.io/guide/animations" target="_blank" rel="noopener">https://angular.io/guide/animations</a></p>
</blockquote>
<p>如果你不愿意自己编写动效，推荐这个开源项目，它和 Angular 之间结合得比较紧：</p>
<blockquote>
<p><a href="https://github.com/jiayihu/ng-animate" target="_blank" rel="noopener">https://github.com/jiayihu/ng-animate</a></p>
</blockquote>
<h2 id="10-组件-动态组件"><a href="#10-组件-动态组件" class="headerlink" title="10.[组件]动态组件"></a>10.[组件]动态组件</h2><p>我们可以通过标签的方式使用组件，也可以通过代码的方式来动态创建组件。动态创建组件的过程是通过 ViewContainerRef 和 ComponentFactoryResolver 这两个工具类来配合完成的。</p>
<p>我们可以定义一个这样的模板：</p>
<pre class="line-numbers language-html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">#dyncomp</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>在组件定义里面需要首先 import 需要用到的工具类：</p>
<pre class="line-numbers language-typescript"><code class="language-typescript"><span class="token keyword">import</span> <span class="token punctuation">{</span> Component<span class="token punctuation">,</span> OnInit<span class="token punctuation">,</span>ViewChild<span class="token punctuation">,</span>ViewContainerRef<span class="token punctuation">,</span>ComponentFactoryResolver<span class="token punctuation">,</span> ComponentRef <span class="token punctuation">}</span> <span class="token keyword">from</span>  <span class="token string">'@angular/core'</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>组件内部这样写：</p>
<pre class="line-numbers language-typescript"><code class="language-typescript"><span class="token comment" spellcheck="true">//这里引用模板里面定义的 dyncomp 容器标签  </span>
@<span class="token function">ViewChild</span><span class="token punctuation">(</span><span class="token string">"dyncomp"</span><span class="token punctuation">,</span><span class="token punctuation">{</span>read<span class="token punctuation">:</span>ViewContainerRef<span class="token punctuation">}</span><span class="token punctuation">)</span> dyncomp<span class="token punctuation">:</span>ViewContainerRef<span class="token punctuation">;</span> 
comp1<span class="token punctuation">:</span>ComponentRef<span class="token operator">&lt;</span>Child11Component<span class="token operator">></span><span class="token punctuation">;</span> 
comp2<span class="token punctuation">:</span>ComponentRef<span class="token operator">&lt;</span>Child11Component<span class="token operator">></span><span class="token punctuation">;</span> 
<span class="token keyword">constructor</span><span class="token punctuation">(</span><span class="token keyword">private</span> resolver<span class="token punctuation">:</span>ComponentFactoryResolver<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>然后我们就可以在 ngAfterContentInit 这个钩子里面用代码来动态创建组件了：</p>
<pre class="line-numbers language-typescript"><code class="language-typescript"><span class="token function">ngAfterContentInit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span> 
  <span class="token keyword">const</span> childComp<span class="token operator">=</span><span class="token keyword">this</span><span class="token punctuation">.</span>resolver<span class="token punctuation">.</span><span class="token function">resolveComponentFactory</span><span class="token punctuation">(</span>Child11Component<span class="token punctuation">)</span><span class="token punctuation">;</span>     
  <span class="token keyword">this</span><span class="token punctuation">.</span>comp1<span class="token operator">=</span><span class="token keyword">this</span><span class="token punctuation">.</span>dyncomp<span class="token punctuation">.</span><span class="token function">createComponent</span><span class="token punctuation">(</span>childComp<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>对于创建出来的 comp1 这个组件，可以通过代码直接访问它的 public 型属性，也可以通过代码来 subscribe（订阅）comp1 上面发出来的事件，就像这样：</p>
<pre class="line-numbers language-typescript"><code class="language-typescript"><span class="token keyword">this</span><span class="token punctuation">.</span>comp1<span class="token punctuation">.</span>instance<span class="token punctuation">.</span>title<span class="token operator">=</span><span class="token string">"父层设置的新标题"</span><span class="token punctuation">;</span> 
<span class="token keyword">this</span><span class="token punctuation">.</span>comp1<span class="token punctuation">.</span>instance<span class="token punctuation">.</span>btnClick<span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token punctuation">(</span>param<span class="token punctuation">)</span><span class="token operator">=</span><span class="token operator">></span><span class="token punctuation">{</span> 
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"--->"</span><span class="token operator">+</span>param<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>对于用代码动态创建出来的组件，我们可以通过调用 destory() 方法来手动销毁：</p>
<pre class="line-numbers language-typescript"><code class="language-typescript"><span class="token keyword">public</span> <span class="token function">destoryChild</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span><span class="token keyword">void</span><span class="token punctuation">{</span> 
  <span class="token keyword">this</span><span class="token punctuation">.</span>comp1<span class="token punctuation">.</span><span class="token function">destroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
  <span class="token keyword">this</span><span class="token punctuation">.</span>comp2<span class="token punctuation">.</span><span class="token function">destroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>代码运行起来的效果如下：</p>
<p><img src="https://cdn.jsdelivr.net/gh/shw2018/cdn@1.0/sakura/img/loader/orange.progress-bar-stripe-loader.svg" data-original="https://images.gitbook.cn/fb944800-b8d3-11e9-a88b-c93a5ea3d618" alt=""></p>
<p><strong>注意：用代码动态创建组件这种方式在一般的业务开发里面不常用，而且可能存在一些隐藏的坑，如果你一定要用，请小心避雷。</strong></p>
<h2 id="11-组件-ShadowDOM"><a href="#11-组件-ShadowDOM" class="headerlink" title="11.[组件]ShadowDOM"></a>11.[组件]ShadowDOM</h2><p>根据 Angular 官方的说法，Angular 组件的设计灵感来源于 Web Component，在 Web Component 里面，ShadowDOM 是重要的组成部分。在底层，Angular 渲染组件的方式有 3 种：</p>
<ul>
<li>Native：采用 ShadowDOM 的模式来进行渲染。</li>
<li>Emulated：模拟模式。对于不能支持 ShadowDOM 模式的浏览器，Angular 在底层会采用模拟的方式来渲染组件，<strong>这是 Angular 默认的渲染模式</strong>。</li>
<li>None：不采用任何渲染模式。直接把组件的 HTML 结构和 CSS 样式插入到 DOM 流里面，这种方式很容易导致组件互相之间出现 CSS 命名污染的问题。</li>
</ul>
<p>在定义组件的时候，可以通过 encapsulation 配置项手动指定组件的渲染模式，关键代码如下：</p>
<pre class="line-numbers language-typescript"><code class="language-typescript">@<span class="token function">Component</span><span class="token punctuation">(</span><span class="token punctuation">{</span> 
  selector<span class="token punctuation">:</span> <span class="token string">'emulate-mode'</span><span class="token punctuation">,</span> 
  encapsulation<span class="token punctuation">:</span>ViewEncapsulation<span class="token punctuation">.</span>Emulated<span class="token punctuation">,</span><span class="token comment" spellcheck="true">//默认模式 </span>
  templateUrl<span class="token punctuation">:</span> <span class="token string">'./emulate-mode.component.html'</span><span class="token punctuation">,</span> 
  styleUrls<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'./emulate-mode.component.scss'</span><span class="token punctuation">]</span> 
<span class="token punctuation">}</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>请尝试修改 encapsulation 这个配置项来测试不同的效果。</p>
<p><strong>注意：Angular 官方在 2018 年的 NGConnet 大会上表示，在将来的某个版本中，会在内核里面把 ShadowDOM 设置为默认模式。因为这一变更会在内核层面进行，所以业务开发者不用改代码。</strong></p>
<p>本节案例运行起来的效果如下：</p>
<p><img src="https://cdn.jsdelivr.net/gh/shw2018/cdn@1.0/sakura/img/loader/orange.progress-bar-stripe-loader.svg" data-original="https://images.gitbook.cn/af07c3d0-b8d4-11e9-a88b-c93a5ea3d618" alt=""></p>
<p>注意点：</p>
<ul>
<li>ShadowDOM 模式的封装性更好，运行效率也更高。</li>
<li>ShadowDOM 在 W3C 的状态是 Working Draft（2017-09-22），如果你想深入研究参考以下链接：<a href="https://developer.mozilla.org/en-US/docs/Web/Web_Components/Shadow_DOM" target="_blank" rel="noopener">https://developer.mozilla.org/en-US/docs/Web/Web_Components/Shadow_DOM</a>、<a href="https://www.w3.org/TR/shadow-dom/" target="_blank" rel="noopener">https://www.w3.org/TR/shadow-dom/</a>。</li>
<li>ShadowDOM 目前只有 Chrome 和 Opera 支持得非常好，其它浏览器都非常糟糕：<img src="https://cdn.jsdelivr.net/gh/shw2018/cdn@1.0/sakura/img/loader/orange.progress-bar-stripe-loader.svg" data-original="https://images.gitbook.cn/e8043c40-b8d4-11e9-ba33-51636d56aead" alt=""></li>
<li>一般来说，你不需要自己手动指定组件的渲染模式，除非你自己知道在做什么。</li>
</ul>
<h2 id="12-组件-内容投影"><a href="#12-组件-内容投影" class="headerlink" title="12.[组件]内容投影"></a>12.[组件]内容投影</h2><h3 id="12-1-最简单的组件模板"><a href="#12-1-最简单的组件模板" class="headerlink" title="12.1 最简单的组件模板"></a>12.1 最简单的组件模板</h3><p>你编写了一个这样的面板组件：</p>
<p><img src="https://cdn.jsdelivr.net/gh/shw2018/cdn@1.0/sakura/img/loader/orange.progress-bar-stripe-loader.svg" data-original="https://images.gitbook.cn/0e2a0350-b8d5-11e9-ba33-51636d56aead" alt=""></p>
<p>组件对应的模板代码是这样的：</p>
<pre class="line-numbers language-html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>panel panel-primary<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>panel-heading<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>标题<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>panel-body<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
      内容
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>panel-footer<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
      底部
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="12-2-投影一块内容"><a href="#12-2-投影一块内容" class="headerlink" title="12.2 投影一块内容"></a>12.2 投影一块内容</h3><p>但是，你希望把面板里面的标题设计成可变的，让调用者能把这个标题传进来，而不是直接写死。这时候“内容投影”机制就可以派上用场了，我们可以这样来编写组件的模板：</p>
<pre class="line-numbers language-html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>panel panel-primary<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>panel-heading<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ng-content</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ng-content</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>panel-body<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
      内容
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>panel-footer<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
      底部
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>请注意以上模板里面的 <code>&lt;ng-content&gt;&lt;/ng-content&gt;</code>，你看可以把它想象成一个占位符，我们用它来先占住一块空间，等使用方把参数传递进来之后，再用真实的内容来替换它。使用方可以这样来传递参数：</p>
<pre class="line-numbers language-html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>test-child-two</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h3</span><span class="token punctuation">></span></span>这是父层投影进来的内容<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h3</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>test-child-two</span><span class="token punctuation">></span></span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>运行起来的效果是这样的：</p>
<p><img src="https://cdn.jsdelivr.net/gh/shw2018/cdn@1.0/sakura/img/loader/orange.progress-bar-stripe-loader.svg" data-original="https://images.gitbook.cn/57848c00-b8d5-11e9-a88b-c93a5ea3d618" alt=""></p>
<p>可以看到，标题的部分是由使用方从外部传递进来的。</p>
<h3 id="12-3-投影多块内容"><a href="#12-3-投影多块内容" class="headerlink" title="12.3 投影多块内容"></a>12.3 投影多块内容</h3><p>接着，问题又来了，你不仅希望面板的标题部分是动态的，你还希望面板的主体区域和底部区域全部都是动态的，应该怎么实现呢？</p>
<p>你可以这样编写组件的模板：</p>
<pre class="line-numbers language-html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>panel panel-primary<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>panel-heading<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ng-content</span> <span class="token attr-name">select</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>h3<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ng-content</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>panel-body<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ng-content</span> <span class="token attr-name">select</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>.my-class<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ng-content</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>panel-footer<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ng-content</span> <span class="token attr-name">select</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>p<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ng-content</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>然后使用方可以这样来使用你所编写的组件：</p>
<pre class="line-numbers language-html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>test-child-two</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h3</span><span class="token punctuation">></span></span>这是父层投影进来的内容<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h3</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>my-class<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>利用CSS选择器<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">></span></span>这是底部内容<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>test-child-two</span><span class="token punctuation">></span></span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>运行起来的效果是这样的：</p>
<p><img src="https://cdn.jsdelivr.net/gh/shw2018/cdn@1.0/sakura/img/loader/orange.progress-bar-stripe-loader.svg" data-original="https://images.gitbook.cn/7fd1c6f0-b8d5-11e9-ba33-51636d56aead" alt=""></p>
<p>你可能已经猜出来了，<code>&lt;ng-content&gt;&lt;/ng-content&gt;</code> 里面的那个 select 参数，其作用和 CSS 选择器非常类似。</p>
<p>这种投影多块内容的方式叫“多插槽模式”（multi-slot），你可以把 <code>&lt;ng-content&gt;&lt;/ng-content&gt;</code> 想形成一个一个的插槽，内容会被插入到这些插槽里面。</p>
<h3 id="12-4-投影一个复杂的组件"><a href="#12-4-投影一个复杂的组件" class="headerlink" title="12.4 投影一个复杂的组件"></a>12.4 投影一个复杂的组件</h3><p>到这里还没完，你不仅仅想投影简单的 HTML 标签到子层组件里面，你还希望把自己编写的一个组件投影进去，那又应该怎么办呢？</p>
<p>请看：</p>
<pre class="line-numbers language-html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>panel panel-primary<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>panel-heading<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ng-content</span> <span class="token attr-name">select</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>h3<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ng-content</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>panel-body<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ng-content</span> <span class="token attr-name">select</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>test-child-three<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ng-content</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>panel-footer<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ng-content</span> <span class="token attr-name">select</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>p<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ng-content</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>使用方可以这样来使用这个组件：</p>
<pre class="line-numbers language-html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>test-child-two</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h3</span><span class="token punctuation">></span></span>这是父层投影进来的内容<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h3</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>test-child-three</span> <span class="token attr-name">(sayhello)</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>doSomething()<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>test-child-three</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">></span></span>这是底部内容<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>test-child-two</span><span class="token punctuation">></span></span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>运行起来的效果是这样的：</p>
<p><img src="https://cdn.jsdelivr.net/gh/shw2018/cdn@1.0/sakura/img/loader/orange.progress-bar-stripe-loader.svg" data-original="https://images.gitbook.cn/d21bc190-b8d5-11e9-ba33-51636d56aead" alt=""></p>
<p>请注意 <code>&lt;ng-content select="test-child-three"&gt;&lt;/ng-content&gt;</code> 里面的内容，你把 select 属性设置成了子组件的名称。</p>
<p>同时，对于被投影的组件 <code>&lt;test-child-three&gt;&lt;/test-child-three&gt;</code> 来说，我们同样可以利用小圆括号的方式来进行事件绑定，就像上面例子里的 <code>(sayhello)="doSomething()"</code> 这样。</p>
<h3 id="12-5-内容投影这个特性存在的意义"><a href="#12-5-内容投影这个特性存在的意义" class="headerlink" title="12.5 内容投影这个特性存在的意义"></a>12.5 内容投影这个特性存在的意义</h3><p>如果没有“内容投影”特性我们也能活得很好，那么它就没有存在的必要了，而事实并非如此，如果没有“内容投影”，有些事情我们就没法做了，典型的有两类：</p>
<ul>
<li>组件标签不能嵌套使用。</li>
<li>不能优雅地包装原生的 HTML 标签。</li>
</ul>
<p>依次解释如下：</p>
<p>比如你自己编写了两个组件 my-comp-1 和 my-comp-2，如果没有内容投影，这两个组件就没办法嵌套使用，比如你想这样用就不行：</p>
<pre class="line-numbers language-html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>my-comp-1</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>my-comp-2</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>my-comp-2</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>my-comp-1</span><span class="token punctuation">></span></span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>因为没有“内容投影”机制，my-comp-1 无法感知到 my-comp-2 的存在，也无法和它进行交互。这明显有违 HTML 设计的初衷，因为 HTML 的本质是一种 XML 格式，标签能嵌套是最基本的特性，原生的 HTML 本身就有很多嵌套的情况：</p>
<pre class="line-numbers language-html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ul</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">></span></span>神族<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">></span></span>人族<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">></span></span>虫族<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ul</span><span class="token punctuation">></span></span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>在真实的业务开发里面，另一个典型的嵌套组件就是 Tab 页，以下代码是很常见的：</p>
<pre class="line-numbers language-html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>tab</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>pane</span> <span class="token attr-name">title</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>第一个标签页<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>pane</span> <span class="token attr-name">title</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>第二个标签页<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>pane</span> <span class="token attr-name">title</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>第三个标签页<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>tab</span><span class="token punctuation">></span></span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>如果没有内容投影机制，想要这样嵌套地使用自定义标签也是不可能的。</p>
<p>内容投影存在的第二个意义与组件的封装有关。</p>
<p>虽然 Angular 提供了 @Component 装饰器让开发者可以自定义标签，但是请不要忘记，自定义标签毕竟与 HTML 原生标签不一样，原生 HTML 标签上面默认带有很多属性、事件，而你自己定义标签是没有的。原生 HTML 标签上面暴露的属性和事件列表请参见 W3C 的规范：</p>
<blockquote>
<p><a href="https://www.w3schools.com/tags/ref_attributes.asp" target="_blank" rel="noopener">https://www.w3schools.com/tags/ref_attributes.asp</a></p>
</blockquote>
<p>从宏观的角度看，所有的自定义标签都只不过是一层“虚拟的壳子”，浏览器并不认识自定义标签，真正渲染出来的还是 div、form、input 之类的原生标签。所以，自定义标签只不过是一层逻辑上的抽象和包装，让人类更容易理解和组织自己的代码而已。</p>
<p>既然如此，自定义标签和HTML原生标签之间的关系是什么呢？本质上说，这是“装饰模式”的一种应用，而内容投影存在的意义就是可以让这个“装饰”的过程做得更加省力、更加优雅一些。</p>
<h3 id="12-6-接下来"><a href="#12-6-接下来" class="headerlink" title="12.6 接下来"></a>12.6 接下来</h3><p>我们已经学会了内容投影最基本的用法，但是故事并没有结束，接下来的问题又来了：</p>
<ul>
<li>如何访问投影进来的复杂组件？比如：如何访问被监听组件上的 public 属性？如何监听被投影组件上的事件？接下来的小节就来解决这个问题。</li>
<li>如何访问投影进来的 HTML 元素？比如：如何给被投影进来的 HTML 元素添加 CSS 样式？这个话题反而比访问被投影组件要复杂一些，在讲指令的那一个小节里面给例子来描述。</li>
</ul>
<h2 id="13-ContentChild-和-ContentC"><a href="#13-ContentChild-和-ContentC" class="headerlink" title="13.@ContentChild 和 @ContentC"></a>13.@ContentChild 和 @ContentC</h2><h3 id="13-1-ContentChild"><a href="#13-1-ContentChild" class="headerlink" title="13.1 @ContentChild"></a>13.1 @ContentChild</h3><p>我们可以利用 @ContentChild 这个装饰器来操控被投影进来的组件。</p>
<pre class="line-numbers language-html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>child-one</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>child-two</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>child-two</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>child-one</span><span class="token punctuation">></span></span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-typescript"><code class="language-typescript"><span class="token keyword">import</span> <span class="token punctuation">{</span> Component<span class="token punctuation">,</span> ContentChild<span class="token punctuation">,</span> ContentChildren<span class="token punctuation">,</span> ElementRef<span class="token punctuation">,</span> OnInit<span class="token punctuation">,</span> QueryList <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@angular/core'</span><span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">//注解的写法</span>
@<span class="token function">ContentChild</span><span class="token punctuation">(</span>ChildTwoComponent<span class="token punctuation">)</span>
childTwo<span class="token punctuation">:</span>ChildTwoComponent<span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">//在 ngAfterContentInit 钩子里面访问被投影进来的组件</span>
<span class="token function">ngAfterContentInit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span><span class="token keyword">void</span><span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>childTwo<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">//这里还可以访问 this.childTwo的public 型方法，监听 this.childTwo 所派发出来的事件</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="13-2-ContentChildren"><a href="#13-2-ContentChildren" class="headerlink" title="13.2 @ContentChildren"></a>13.2 @ContentChildren</h3><p>从名字可以看出来，@ContentChildren 是一个复数形式。当被投影进来的是一个组件列表的时候，我们可以用 @ContentChildren 来进行操控。</p>
<pre class="line-numbers language-html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>child-one</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>child-two</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>child-two</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>child-two</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>child-two</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>child-two</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>child-two</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>child-two</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>child-two</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>child-two</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>child-two</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>child-two</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>child-two</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>child-two</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>child-two</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>child-two</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>child-two</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>child-one</span><span class="token punctuation">></span></span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-typescript"><code class="language-typescript"><span class="token keyword">import</span> <span class="token punctuation">{</span> Component<span class="token punctuation">,</span> ContentChild<span class="token punctuation">,</span> ContentChildren<span class="token punctuation">,</span> ElementRef<span class="token punctuation">,</span> OnInit<span class="token punctuation">,</span> QueryList <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@angular/core'</span><span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">//这时候不是单个组件，是一个列表了 QueryList</span>
@<span class="token function">ContentChildren</span><span class="token punctuation">(</span>ChildTwoComponent<span class="token punctuation">)</span> 
childrenTwo<span class="token punctuation">:</span>QueryList<span class="token operator">&lt;</span>ChildTwoComponent<span class="token operator">></span><span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">//遍历列表</span>
<span class="token function">ngAfterContentInit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span><span class="token keyword">void</span><span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>childrenTwo<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span><span class="token operator">=</span><span class="token operator">></span><span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="14-ViewChild-与-ViewChildren"><a href="#14-ViewChild-与-ViewChildren" class="headerlink" title="14.@ViewChild 与 @ViewChildren"></a>14.@ViewChild 与 @ViewChildren</h2><h3 id="14-1-ViewChild"><a href="#14-1-ViewChild" class="headerlink" title="14.1 @ViewChild"></a>14.1 @ViewChild</h3><p>我们可以利用 @ViewChild 这个装饰器来操控直属的子组件。</p>
<pre class="line-numbers language-html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>panel panel-primary<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>panel-heading<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>父组件<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>panel-body<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>child-one</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>child-one</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-typescript"><code class="language-typescript"><span class="token keyword">import</span> <span class="token punctuation">{</span> Component<span class="token punctuation">,</span> OnInit<span class="token punctuation">,</span> ViewChild<span class="token punctuation">,</span> ViewChildren<span class="token punctuation">,</span> QueryList <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@angular/core'</span><span class="token punctuation">;</span>

@<span class="token function">ViewChild</span><span class="token punctuation">(</span>ChildOneComponent<span class="token punctuation">,</span><span class="token punctuation">{</span><span class="token keyword">static</span><span class="token punctuation">:</span><span class="token keyword">false</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
childOne<span class="token punctuation">:</span>ChildOneComponent<span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">//在 ngAfterViewInit 这个钩子里面可以直接访问子组件</span>
<span class="token function">ngAfterViewInit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span><span class="token keyword">void</span><span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>childOne<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">//用代码的方式订阅子组件上的事件</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>childOne<span class="token punctuation">.</span>helloEvent<span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token punctuation">(</span>param<span class="token punctuation">)</span><span class="token operator">=</span><span class="token operator">></span><span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>childOne<span class="token punctuation">.</span>title<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><strong>注意：8.0 这里有一个 breaking change，@ViewChild 这里提供了第二个参数，增强了一些功能。这里有详细的描述：<a href="https://angular.io/api/core/ViewChild" target="_blank" rel="noopener">https://angular.io/api/core/ViewChild</a>。</strong></p>
<h3 id="14-2-ViewChildren"><a href="#14-2-ViewChildren" class="headerlink" title="14.2 @ViewChildren"></a>14.2 @ViewChildren</h3><pre class="line-numbers language-html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>panel panel-primary<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>panel-heading<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>父组件<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>panel-body<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>child-one</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>child-one</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>child-one</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>child-one</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>child-one</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>child-one</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>child-one</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>child-one</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>child-one</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>child-one</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-typescript"><code class="language-typescript"><span class="token keyword">import</span> <span class="token punctuation">{</span> Component<span class="token punctuation">,</span> OnInit<span class="token punctuation">,</span> ViewChild<span class="token punctuation">,</span> ViewChildren<span class="token punctuation">,</span> QueryList <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@angular/core'</span><span class="token punctuation">;</span>

@<span class="token function">ViewChildren</span><span class="token punctuation">(</span>ChildOneComponent<span class="token punctuation">)</span>
children<span class="token punctuation">:</span>QueryList<span class="token operator">&lt;</span>ChildOneComponent<span class="token operator">></span><span class="token punctuation">;</span>

<span class="token function">ngAfterViewInit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span><span class="token keyword">void</span><span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>children<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span><span class="token operator">=</span><span class="token operator">></span><span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// console.log(item);</span>
        <span class="token comment" spellcheck="true">//动态监听子组件的事件</span>
        item<span class="token punctuation">.</span>helloEvent<span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token operator">=</span><span class="token operator">></span><span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="15-与Polymer-封装组件的方式简单对比"><a href="#15-与Polymer-封装组件的方式简单对比" class="headerlink" title="15.与Polymer 封装组件的方式简单对比"></a>15.与Polymer 封装组件的方式简单对比</h2><p>一些开发者认为 Angular 的组件设计不如 Polymer 那种直接继承原生 HTMLElement 的方式优雅。</p>
<p>以下是 Polymer 组件的定义方式：</p>
<p><img src="https://cdn.jsdelivr.net/gh/shw2018/cdn@1.0/sakura/img/loader/orange.progress-bar-stripe-loader.svg" data-original="https://images.gitbook.cn/3e6533d0-b8d7-11e9-a88b-c93a5ea3d618" alt=""></p>
<p>以下是 Polymer 的根类 Polymer.Element 的源代码：</p>
<p><img src="https://cdn.jsdelivr.net/gh/shw2018/cdn@1.0/sakura/img/loader/orange.progress-bar-stripe-loader.svg" data-original="https://images.gitbook.cn/4d5de7b0-b8d7-11e9-a194-19c3d4002b01" alt=""></p>
<p>可以看到，在 Polymer 中，开发者自定义标签的地位与浏览器原生标签完全是平等的，属性、事件、行为，都是平等的，Polymer 组件的渲染由浏览器内核直接完成。</p>
<p>Polymer 的这种封装方式和目前市面上的大部分前端框架都不一样，Polymer 直接继承原生 HTML 元素，而其它大部分框架都只是在“包装”、“装饰”原生 HTML 元素，这是两种完全不同的设计哲学。</p>
<blockquote>
<p><a href="https://www.polymer-project.org/" target="_blank" rel="noopener">https://www.polymer-project.org/</a></p>
</blockquote>
<p>目前，使用 Polymer 最著名的网站是 Google 自家的 YouTube：</p>
<p><img src="https://cdn.jsdelivr.net/gh/shw2018/cdn@1.0/sakura/img/loader/orange.progress-bar-stripe-loader.svg" data-original="https://images.gitbook.cn/d088b390-b8d7-11e9-a88b-c93a5ea3d618" alt=""></p>
<h2 id="16-封装并发布你自己的组件库"><a href="#16-封装并发布你自己的组件库" class="headerlink" title="16.封装并发布你自己的组件库"></a>16.封装并发布你自己的组件库</h2><h3 id="16-1-市面上可用的-Angular-组件库介绍"><a href="#16-1-市面上可用的-Angular-组件库介绍" class="headerlink" title="16.1 市面上可用的 Angular 组件库介绍"></a>16.1 市面上可用的 Angular 组件库介绍</h3><p>开源免费的组件库：</p>
<ul>
<li>PrimeNG：<a href="http://www.primefaces.org/primeng" target="_blank" rel="noopener">http://www.primefaces.org/primeng</a>，这款组件库做得比较早，代码质量比较高。Telerik 这家公司专门做各种 UI 组件库，jQuery/Flex/Angular，全部都有。</li>
<li>NG-Zorro：<a href="https://github.com/NG-ZORRO/ng-zorro-antd" target="_blank" rel="noopener">https://github.com/NG-ZORRO/ng-zorro-antd</a>，来自阿里云团队，外观是 AntDesign 风格。</li>
<li>Clarity：<a href="https://vmware.github.io/clarity/" target="_blank" rel="noopener">https://vmware.github.io/clarity/</a>，来自 Vmware 团队。</li>
<li>Angular-Material：<a href="https://github.com/angular/material2" target="_blank" rel="noopener">https://github.com/angular/material2</a>，Angular 官方提供的组件库。</li>
<li>Element-Angular：<a href="https://element-angular.faas.ele.me/guide/install" target="_blank" rel="noopener">https://element-angular.faas.ele.me/guide/install</a>，作者来自饿了么团队。</li>
<li>Jigsaw（七巧板）：<a href="https://github.com/rdkmaster/jigsaw" target="_blank" rel="noopener">https://github.com/rdkmaster/jigsaw</a>，来自 ZTE 中兴通讯。组件数量比较多，外观不够漂亮。</li>
<li>Ionic：<a href="https://ionic.io/" target="_blank" rel="noopener">https://ionic.io/</a>，专门为移动端打造的组件库，自带周边工具，生态很完善。</li>
</ul>
<p>收费版组件库：</p>
<ul>
<li>来自 Telerik 的 KendoUI for Angular：<a href="http://www.telerik.com/kendo-angular-ui/" target="_blank" rel="noopener">http://www.telerik.com/kendo-angular-ui/</a>，Telerik 的这套组件库的特色是组件的功能比较强大，尤其是 Grid，做得非常强大。</li>
</ul>
<h3 id="16-2-如何在项目里面引入开源组件库"><a href="#16-2-如何在项目里面引入开源组件库" class="headerlink" title="16.2 如何在项目里面引入开源组件库"></a>16.2 如何在项目里面引入开源组件库</h3><p>以 PrimeNG 为例，首先在 package.json 里面定义好依赖：</p>
<p><img src="https://cdn.jsdelivr.net/gh/shw2018/cdn@1.0/sakura/img/loader/orange.progress-bar-stripe-loader.svg" data-original="https://images.gitbook.cn/7fbe5ea0-b8d8-11e9-8b62-c350e3466c22" alt=""></p>
<p>然后打开终端用 cnpm install 安装 PrimeNG 到你本地，在你自己的业务模块里面 import 需要用到的组件模块就好了：</p>
<p><img src="https://cdn.jsdelivr.net/gh/shw2018/cdn@1.0/sakura/img/loader/orange.progress-bar-stripe-loader.svg" data-original="https://images.gitbook.cn/78bba180-b8d8-11e9-8b62-c350e3466c22" alt=""></p>
<p>从 Angular 6.0 开始，@angular/cli 增加了一个 <code>ng add</code> 命令，所有支持 Schematics 语法的组件库都可以通过这个命令自动整合，并且在创建你自己组件的时候可以指定需要哪种风格，详细的例子和解释请参考“1-2Schematics 与代码生成器”这一小节。</p>
<h3 id="16-3-如何把你的组件库发布到-npm-上去"><a href="#16-3-如何把你的组件库发布到-npm-上去" class="headerlink" title="16.3 如何把你的组件库发布到 npm 上去"></a>16.3 如何把你的组件库发布到 npm 上去</h3><p>有朋友问过一个问题，他觉得 npm 很神奇，比如当我们在终端里面输入以下命令的时候：</p>
<pre><code>npm install -g @angular/cli
</code></pre><p>npm 就会自动去找到@angular/cli 并安装，看起来很神奇的样子。</p>
<p>其实，背后的处理过程很简单，npm 官方有一个固定的 registry url，你可以把它的作用想象成一个 App Store，全球所有开发者编写的 node 模块都需要发布上去，然后其他人才能安装使用。</p>
<p>如果你开发了一个很强大的 Angular 组件库，希望发布到 node 上面让其他人也能使用，应该怎么做呢？简略的处理步骤如下：</p>
<ul>
<li>第 1 步：用 npm init 初始化项目（只要你的项目里面按照 npm 的规范编写一份 package.json 文件就可以了，不一定用 npm init 初始化）。</li>
<li>第 2 步：编写你自己的代码。</li>
<li>第 3 步：到 <a href="https://www.npmjs.com/" target="_blank" rel="noopener">https://www.npmjs.com/</a> 去注册一个账号。</li>
<li>第 4 步：用 npm publish 把项目 push 上去。</li>
</ul>
<p>publish 之后，全球开发者都可以通过名字查找并安装你这个模块了。</p>
<h3 id="16-4一些小小的经验"><a href="#16-4一些小小的经验" class="headerlink" title="16.4一些小小的经验"></a>16.4一些小小的经验</h3><p>两个常见的误区：</p>
<ul>
<li>第一个误区是：开源组件可以满足你的所有需求。我可以负责任地告诉你，这是不可能的！开源组件库都是通用型的组件，并不会针对任何特定的行业或者领域进行设计。无论选择哪一款开源组件库，组件的外观 CSS 你总要重新写一套的吧？组件里面缺的那些功能你总得自己去写吧？组件里面的那些 Bug 你总得自己去改掉吧？所以，千万不要幻想开源组件能帮你解决所有问题，二次开发是必然的。</li>
<li>第二个误区是：开发组件库很简单，分分钟可以搞定。在 jQuery 时代，有一款功能极其强大树组件叫 <a href="http://www.treejs.cn/v3/main.php#_zTreeInfo" target="_blank" rel="noopener">zTree</a>。你能想到的那些功能 zTree 都实现了，而且运行效率特别高。但是你要知道，zTree 的作者已经花了超过 5 年的时间来维护这个组件。维护一个组件尚且如此，何况要长期维护一个庞大的库？所以，做好一个组件库并不像有些人想象的那么轻松，这件事是需要花钱、花时间的。做开源，最让使用者蛋疼的不是功能够不够强大，而是开发者突然弃坑，这也是很多企业宁愿花钱自己开发组件库的原因。所以，如果你只是单兵作战，最好选一款现有的开源库，在此基础上继续开发。强烈建议你只做一个组件，就像 zTree 的作者那样，把一个组件做好、做透，并且长期维护下去。这比搞一个庞大的组件库，每个组件做得都像个玩具，然后突然弃坑要好很多。</li>
</ul>
<h2 id="17-指令简介"><a href="#17-指令简介" class="headerlink" title="17.指令简介"></a>17.指令简介</h2><h3 id="17-1-组件与指令之间的关系"><a href="#17-1-组件与指令之间的关系" class="headerlink" title="17.1 组件与指令之间的关系"></a>17.1 组件与指令之间的关系</h3><p><img src="https://cdn.jsdelivr.net/gh/shw2018/cdn@1.0/sakura/img/loader/orange.progress-bar-stripe-loader.svg" data-original="https://images.gitbook.cn/03315710-b8d9-11e9-a88b-c93a5ea3d618" alt=""></p>
<p>再看一下核心源代码里面的内容：</p>
<p><img src="https://cdn.jsdelivr.net/gh/shw2018/cdn@1.0/sakura/img/loader/orange.progress-bar-stripe-loader.svg" data-original="https://images.gitbook.cn/0b879640-b8d9-11e9-a194-19c3d4002b01" alt=""></p>
<p>根据 Angular 官方文档的描述，Angular 里面有 3 种类类型的指令：</p>
<ul>
<li>Component 是 Directive 的子接口，是一种特殊的指令，Component 可以带有 HTML 模板，Directive 不能有模板。</li>
<li>属性型指令：用来修改 DOM 元素的外观和行为，但是不会改变 DOM 结构，Angular 内置指令里面典型的属性型指令有 ngClass、ngStyle。如果你打算封装自己的组件库，属性型指令是必备的内容。</li>
<li>结构型指令：可以修改 DOM 结构，内置的常用结构型指令有 <em>ngFor、</em>ngIf 和 NgSwitch。由于结构型指令会修改 DOM 结构，所以同一个 HTML 标签上面不能同时使用多个结构型指令，否则大家都来改 DOM 结构，到底听谁的呢？如果要在同一个 HTML 元素上面使用多个结构性指令，可以考虑加一层空的元素来嵌套，比如在外面套一层空的 <code>&lt;ng-container&gt;&lt;/ng-container&gt;</code>，或者套一层空的 <code>&lt;div&gt;</code>。</li>
</ul>
<h3 id="17-2-有了组件为什么还要指令？"><a href="#17-2-有了组件为什么还要指令？" class="headerlink" title="17.2 有了组件为什么还要指令？"></a>17.2 有了组件为什么还要指令？</h3><p>请注意：即使你认真、仔细地看完以上内容，你依然会感到非常茫然。因为有一个最根本的问题在所有文档里面都没有给出明确的解释，这个问题也是很多开发者经常会问的，那就是：<strong>既然有了组件（Component），为什么还要指令（Directive）？</strong></p>
<p>我们知道，在很多的 UI 框架里面，并没有指令的概念，它们的基类都是从 Component 开始的。比如：</p>
<ul>
<li>Swing 里面基类名字就叫 Component，没有指令的概念</li>
<li>ExtJS 里面基类是 Ext.Component，没有指令的概念</li>
<li>Flex 里面基类名字叫 UIComponent，没有指令的概念</li>
<li>React 里面的基类名字叫 React.Component，没有指令的概念</li>
</ul>
<p>以下是 Swing 的类结构图：</p>
<p><img src="https://cdn.jsdelivr.net/gh/shw2018/cdn@1.0/sakura/img/loader/orange.progress-bar-stripe-loader.svg" data-original="https://images.gitbook.cn/9c1a8af0-b8d9-11e9-a194-19c3d4002b01" alt=""></p>
<p>以下是 ExtJS 3.2 的 UI 组件继承结构图局部，请注意 Ext.Component 类的位置：</p>
<p><img src="https://cdn.jsdelivr.net/gh/shw2018/cdn@1.0/sakura/img/loader/orange.progress-bar-stripe-loader.svg" data-original="https://images.gitbook.cn/a953db90-b8d9-11e9-8b62-c350e3466c22" alt=""></p>
<p>下面是整体缩略图：</p>
<p><img src="https://cdn.jsdelivr.net/gh/shw2018/cdn@1.0/sakura/img/loader/orange.progress-bar-stripe-loader.svg" data-original="https://images.gitbook.cn/b0ecbe30-b8d9-11e9-8b62-c350e3466c22" alt=""></p>
<p>以下是Adobe Flex 3的类结构图：</p>
<p><img src="https://cdn.jsdelivr.net/gh/shw2018/cdn@1.0/sakura/img/loader/orange.progress-bar-stripe-loader.svg" data-original="https://images.gitbook.cn/b7bb4bf0-b8d9-11e9-a194-19c3d4002b01" alt=""></p>
<p>上面这些框架都走的组件化的路子，Swing 和 ExtJS 完全是“代码流”，所有 UI 都通过代码来创建；而 Flex 和 React 是“标签流”，也就通过标签的方式来创建 UI。</p>
<p>但是，所有这些框架都没有“指令”这个概念，为什么 Angular 里面一定要引入“指令”这个概念呢？</p>
<p><strong>根本原因是：我们需要用指令来增强标签的功能，包括 HTML 原生标签和你自己自定义的标签。</strong></p>
<p>举例来说：<code>&lt;div&gt;</code> 是一个常用的原生 HTML 标签，但是请不要小看它，它上面实际上有非常多的属性，这些属性都是 W3C 规范规定好的。</p>
<p><img src="https://cdn.jsdelivr.net/gh/shw2018/cdn@1.0/sakura/img/loader/orange.progress-bar-stripe-loader.svg" data-original="https://images.gitbook.cn/f63d5760-b8d9-11e9-ba33-51636d56aead" alt=""></p>
<p>还能支持以下事件属性：</p>
<p><img src="https://cdn.jsdelivr.net/gh/shw2018/cdn@1.0/sakura/img/loader/orange.progress-bar-stripe-loader.svg" data-original="https://images.gitbook.cn/fffc0030-b8d9-11e9-a194-19c3d4002b01" alt=""></p>
<p>完整的列表请查看 W3C 规范：</p>
<blockquote>
<p><a href="https://www.w3schools.com/tags/ref_standardattributes.asp" target="_blank" rel="noopener">https://www.w3schools.com/tags/ref_standardattributes.asp</a></p>
</blockquote>
<p><strong>但是，这些内置属性还不够用，你想给原生的 HTML 标签再扩展一些属性。比方说：你想给 <code>&lt;div&gt;</code> 标签增加一个自定义的属性叫做 my-high-light，当鼠标进入 div 内部时，div 的背景就会高亮显示，可以这样使用 <code>&lt;div my-high-light&gt;</code>。这时候，没有指令机制就无法实现了。</strong></p>
<h2 id="18-自定义指令"><a href="#18-自定义指令" class="headerlink" title="18.自定义指令"></a>18.自定义指令</h2><p>这是官方文档里面的一个例子，运行效果如下：</p>
<p><img src="https://cdn.jsdelivr.net/gh/shw2018/cdn@1.0/sakura/img/loader/orange.progress-bar-stripe-loader.svg" data-original="https://images.gitbook.cn/66e6e4e0-b8da-11e9-a194-19c3d4002b01" alt=""></p>
<p>核心代码如下：</p>
<pre class="line-numbers language-typescript"><code class="language-typescript"><span class="token keyword">import</span> <span class="token punctuation">{</span> Directive<span class="token punctuation">,</span> ElementRef<span class="token punctuation">,</span>HostListener<span class="token punctuation">,</span>HostBinding<span class="token punctuation">,</span>Input <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@angular/core'</span><span class="token punctuation">;</span>

@<span class="token function">Directive</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  selector<span class="token punctuation">:</span> <span class="token string">'[my-high-light]'</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">MyHighLightDirective</span> <span class="token punctuation">{</span>
  @<span class="token function">Input</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
  highlightColor<span class="token punctuation">:</span> <span class="token keyword">string</span><span class="token punctuation">;</span>

  <span class="token keyword">constructor</span><span class="token punctuation">(</span><span class="token keyword">private</span> el<span class="token punctuation">:</span> ElementRef<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token punctuation">}</span>

  @<span class="token function">HostListener</span><span class="token punctuation">(</span><span class="token string">'mouseenter'</span><span class="token punctuation">)</span> <span class="token function">onMouseEnter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">highlight</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>highlightColor<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  @<span class="token function">HostListener</span><span class="token punctuation">(</span><span class="token string">'mouseleave'</span><span class="token punctuation">)</span> <span class="token function">onMouseLeave</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">highlight</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">private</span> <span class="token function">highlight</span><span class="token punctuation">(</span>color<span class="token punctuation">:</span> <span class="token keyword">string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>el<span class="token punctuation">.</span>nativeElement<span class="token punctuation">.</span>style<span class="token punctuation">.</span>backgroundColor <span class="token operator">=</span> color<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>以上指令的用法如下：</p>
<pre class="line-numbers language-html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span> <span class="token attr-name">my-high-light</span> <span class="token attr-name">highlightColor</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>#ff3300<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>内容高亮显示！<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">></span></span>
<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h3 id="18-1-自定义结构型指令"><a href="#18-1-自定义结构型指令" class="headerlink" title="18.1 自定义结构型指令"></a>18.1 自定义结构型指令</h3><p>这个例子会动态创建 3 个组件，每个延迟 500 毫秒，运行效果如下：</p>
<p><img src="https://cdn.jsdelivr.net/gh/shw2018/cdn@1.0/sakura/img/loader/orange.progress-bar-stripe-loader.svg" data-original="https://images.gitbook.cn/8cc76590-b8da-11e9-ba33-51636d56aead" alt=""></p>
<p>指令代码如下：</p>
<pre class="line-numbers language-typescript"><code class="language-typescript"><span class="token keyword">import</span> <span class="token punctuation">{</span> Directive<span class="token punctuation">,</span> Input<span class="token punctuation">,</span> TemplateRef<span class="token punctuation">,</span> ViewContainerRef <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@angular/core'</span><span class="token punctuation">;</span>

@<span class="token function">Directive</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    selector<span class="token punctuation">:</span> <span class="token string">'[appDelay]'</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">DelayDirective</span> <span class="token punctuation">{</span>
    <span class="token keyword">constructor</span><span class="token punctuation">(</span>
        <span class="token keyword">private</span> templateRef<span class="token punctuation">:</span> TemplateRef<span class="token operator">&lt;</span><span class="token keyword">any</span><span class="token operator">></span><span class="token punctuation">,</span>
        <span class="token keyword">private</span> viewContainerRef<span class="token punctuation">:</span> ViewContainerRef
    <span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span>

    @<span class="token function">Input</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">set</span> <span class="token function">appDelay</span><span class="token punctuation">(</span>time<span class="token punctuation">:</span> <span class="token keyword">number</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>viewContainerRef<span class="token punctuation">.</span><span class="token function">createEmbeddedView</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>templateRef<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span> time<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>指令的用法核心代码：</p>
<pre class="line-numbers language-html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">*ngFor</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>let item of [1,2,3]<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>card</span> <span class="token attr-name">*appDelay</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>500 * item<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
        第 {{item}} 张卡片
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>card</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><strong>你应该注意到了，结构性指令在使用的时候前面都会带上星号，即使是你自定义的结构性指令，也是一样的。</strong></p>
<h3 id="18-2-小结"><a href="#18-2-小结" class="headerlink" title="18.2 小结"></a>18.2 小结</h3><p>强烈建议仔细阅读官方文档里面的关于 Directive 的细节描述：</p>
<blockquote>
<p><a href="https://angular.io/guide/attribute-directives" target="_blank" rel="noopener">https://angular.io/guide/attribute-directives</a></p>
</blockquote>
<h2 id="19-直接在组件里面操作-DOM"><a href="#19-直接在组件里面操作-DOM" class="headerlink" title="19.直接在组件里面操作 DOM"></a>19.直接在组件里面操作 DOM</h2><p>有一个常见的问题：既然组件是指令的子类，那么指令里面能干的事儿组件应该都能干，我可以在指令里面直接操作 DOM 吗？</p>
<p>答案是肯定的。</p>
<p>我们来修改一下上一节里面的例子，直接在组件里面来实现背景高亮效果，关键代码如下：</p>
<pre class="line-numbers language-typescript"><code class="language-typescript">@<span class="token function">Component</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  selector<span class="token punctuation">:</span> <span class="token string">'test'</span><span class="token punctuation">,</span>
  templateUrl<span class="token punctuation">:</span> <span class="token string">'./test.component.html'</span><span class="token punctuation">,</span>
  styleUrls<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'./test.component.scss'</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">TestComponent</span> <span class="token keyword">implements</span> <span class="token class-name">OnInit</span> <span class="token punctuation">{</span>
  @<span class="token function">Input</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
  highlightColor<span class="token punctuation">:</span> <span class="token keyword">string</span><span class="token punctuation">;</span>

  <span class="token keyword">private</span> containerEl<span class="token punctuation">:</span><span class="token keyword">any</span><span class="token punctuation">;</span>

  <span class="token keyword">constructor</span><span class="token punctuation">(</span><span class="token keyword">private</span> el<span class="token punctuation">:</span> ElementRef<span class="token punctuation">)</span> <span class="token punctuation">{</span>

  <span class="token punctuation">}</span>

  <span class="token function">ngOnInit</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token punctuation">}</span>

  <span class="token function">ngAfterContentInit</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>el<span class="token punctuation">.</span>nativeElement<span class="token punctuation">)</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>el<span class="token punctuation">.</span>nativeElement<span class="token punctuation">.</span>childNodes<span class="token punctuation">)</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>el<span class="token punctuation">.</span>nativeElement<span class="token punctuation">.</span>childNodes<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>el<span class="token punctuation">.</span>nativeElement<span class="token punctuation">.</span>innerHTML<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">this</span><span class="token punctuation">.</span>containerEl<span class="token operator">=</span><span class="token keyword">this</span><span class="token punctuation">.</span>el<span class="token punctuation">.</span>nativeElement<span class="token punctuation">.</span>childNodes<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  @<span class="token function">HostListener</span><span class="token punctuation">(</span><span class="token string">'mouseenter'</span><span class="token punctuation">)</span> <span class="token function">onMouseEnter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">highlight</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>highlightColor<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  @<span class="token function">HostListener</span><span class="token punctuation">(</span><span class="token string">'mouseleave'</span><span class="token punctuation">)</span> <span class="token function">onMouseLeave</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">highlight</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">private</span> <span class="token function">highlight</span><span class="token punctuation">(</span>color<span class="token punctuation">:</span> <span class="token keyword">string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>containerEl<span class="token punctuation">.</span>style<span class="token punctuation">.</span>backgroundColor <span class="token operator">=</span> color<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>组件的标签结构如下：</p>
<pre class="line-numbers language-html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>my-container<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
  鼠标移进来就会改变背景
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>这个组件的使用方式如下：</p>
<pre class="line-numbers language-html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>container<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>test</span> <span class="token attr-name">highlightColor</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>#F2DEDE<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>test</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>可以看到，直接在组件里面操作 DOM 是可以的，但是一旦把操作 DOM 的这部分逻辑放在组件里面，就没法再在其它标签上面使用了。</p>
<h2 id="20-模块-NgModule"><a href="#20-模块-NgModule" class="headerlink" title="20.模块@NgModule"></a>20.模块@NgModule</h2><p>这里不想把 NgModule 的所有 API 都列在这里，那样的话，这一部分就没什么存在的意义了。关于 NgModule 的十万个为什么，官方编写了一份很长的文档来做说明：</p>
<blockquote>
<p><a href="https://angular.io/guide/ngmodule-faq" target="_blank" rel="noopener">https://angular.io/guide/ngmodule-faq</a></p>
</blockquote>
<p>但是请特别注意，如果你看完这篇简短的文章之后再去阅读官方的文档，那样你会站在一个高层级的视角去面对那些琐碎的细节，保证不会迷失方向。</p>
<h3 id="20-1-NgModule-的定义方式"><a href="#20-1-NgModule-的定义方式" class="headerlink" title="20.1 @NgModule 的定义方式"></a>20.1 @NgModule 的定义方式</h3><p>看一个最简单的@ NgModule 的定义：</p>
<pre class="line-numbers language-typescript"><code class="language-typescript"><span class="token keyword">import</span> <span class="token punctuation">{</span> BrowserModule <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@angular/platform-browser'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> NgModule <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@angular/core'</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token punctuation">{</span> AppComponent <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./app.component'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> TestViewChildComponent <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./test-view-child/test-view-child.component'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> ChildOneComponent <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./test-view-child/child-one/child-one.component'</span><span class="token punctuation">;</span>

@<span class="token function">NgModule</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  declarations<span class="token punctuation">:</span> <span class="token punctuation">[</span>
    AppComponent<span class="token punctuation">,</span>
    TestViewChildComponent<span class="token punctuation">,</span>
    ChildOneComponent
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  imports<span class="token punctuation">:</span> <span class="token punctuation">[</span>
    BrowserModule
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  providers<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  bootstrap<span class="token punctuation">:</span> <span class="token punctuation">[</span>AppComponent<span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">AppModule</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>declarations：用来放组件、指令、管道的声明。</li>
<li>imports：用来导入外部模块。</li>
<li>providers：需要使用的 Service 都放在这里。</li>
<li>bootstrap：定义启动组件。你可能注意到了这个配置项是一个数组，也就是说可以指定做个组件作为启动点，但是这种用法是很罕见的。</li>
</ul>
<h3 id="20-2-NgModule-的重要作用"><a href="#20-2-NgModule-的重要作用" class="headerlink" title="20.2 @NgModule 的重要作用"></a>20.2 @NgModule 的重要作用</h3><p>在 Angular 中，NgModule 有以下几个重要的作用：</p>
<ul>
<li><strong>NgModule 最根本的意义是帮助开发者组织业务代码</strong>，开发者可以利用 NgModule 把关系比较紧密的组件组织到一起，这是首要的。</li>
<li>NgModule 用来控制组件、指令、管道等的可见性，处于同一个 NgModule 里面的组件默认互相可见，而对于外部的组件来说，只能看到 NgModule 导出（exports）的内容，这一特性非常类似 Java 里面 package 的概念。也就是说，如果你定义的 NgModule 不 exports 任何内容，那么外部使用者即使 import 了你这个模块，也没法使用里面定义的任何内容。</li>
<li><strong>NgModule 是@angular/cli 打包的最小单位</strong>。打包的时候，@angular/cli 会检查所有@NgModule 和路由配置，如果你配置了异步模块，cli 会自动把模块切分成独立的 chunk（块）。这一点是和其它框架不同的，其它框架基本上都需要你自己去配置 webpack，自己定义切分 chunck 的规则；而在 Angular 里面，打包和切分的动作是@angular/cli 自动处理的，不需要你干预。当然，如果你感到不爽，也可以自己从头用 webpack 配一个环境出来，因为@angular/cli 底层也是用的 webpack。</li>
<li><strong>NgModule 是 Router 进行异步加载的最小单位，Router 能加载的最小单位是模块，而不是组件</strong>。当然，模块里面只放一个组件是允许的，很多组件库都是这样做的。</li>
</ul>
<h3 id="20-3-NgModule-的注意点"><a href="#20-3-NgModule-的注意点" class="headerlink" title="20.3 @NgModule 的注意点"></a>20.3 @NgModule 的注意点</h3><ul>
<li>每个应用至少有一个根模块，按照惯例，根模块的名字一般都叫 AppModule，如果你没有非常特别的理由，就不要随意改这个名字了，这相当于一个国际惯例。</li>
<li>组件、指令、管道都必须属于一个模块，而且只能属于一个模块。</li>
<li>NgModule 和 ES6 里面的 Module 是完全不同的两个概念。ES6 里面的模块是通过 export 和 import 来进行声明的，它们是语法层面的内容；而 NgModule 完全不是这个概念，从上面的作用列表你也能看出来。最重要的一点，目前，ES6 里面的 import 只能静态引入模块，并不能异步动态加载模块，而 NgModule 可以配合 Router 来进行异步模块加载，在后面的 介绍Router 时会有实例代码。</li>
<li>模块的定义方式会影响依赖注入机制：对于直接 import 的同步模块，无论你把 @Injectable 类型的组件定义在哪个模块里面，它都是全局可见的。比如：在子模块 post.module.ts 的 providers 数组里面定义了一个 PostListService，你可能会觉得这个 PostListService 只有在 post.module.ts 里面可见。而事实并非如此，PostListService 是全局可见的，就相当于一个全局单例。与此对应，如果你把 PostListService 定义到一个异步加载的模块里面，它就不是全局可见的了，因为对于异步加载进来的模块，Angular 会为它创建独立的 DI（依赖注入）上下文。所以，如果你想让 PostListService 全局可见，应该把它定义在根模块 app.module 里面。同时要特别注意，如果你希望 PostListService 是全局单例的，只能在 app.module 里面的 providers 数组里面定义一次，而不能在其它模块里面再次定义，否则就会出现多个不同的实例。关于 DI 机制更详细的描述请参见这里：<a href="https://angular.io/guide/dependency-injection" target="_blank" rel="noopener">https://angular.io/guide/dependency-injection</a>。</li>
</ul>
<h3 id="20-4-Angular-内核自身的模块结构"><a href="#20-4-Angular-内核自身的模块结构" class="headerlink" title="20.4 Angular 内核自身的模块结构"></a>20.4 Angular 内核自身的模块结构</h3><p>Angular 本身也是用模块化的方式开发的，当你用 cnpm install 装好了开发环境之后，可以打开 node_modules 目录查看整体结构。左侧第一列 6 个目录比较常用，这个顺序是按照我自己的理解排列的，按照常用程度从上到下。</p>
<p><img src="https://cdn.jsdelivr.net/gh/shw2018/cdn@1.0/sakura/img/loader/orange.progress-bar-stripe-loader.svg" data-original="https://images.gitbook.cn/86de6060-b8db-11e9-a194-19c3d4002b01" alt=""></p>
<p><strong>请注意，一个目录里面可能会放多个模块，比如 forms 目录里面就有 FormsModule 和 ReactiveFormsModule 两个模块。</strong></p>
<p>Form 模块的关键类结构图如下：</p>
<p><img src="https://cdn.jsdelivr.net/gh/shw2018/cdn@1.0/sakura/img/loader/orange.progress-bar-stripe-loader.svg" data-original="https://images.gitbook.cn/900472b0-b8db-11e9-8b62-c350e3466c22" alt=""></p>
<p>这份结构图的源文件在 <a href="https://gitee.com/learn-angular-series/learn-form" target="_blank" rel="noopener">https://gitee.com/learn-angular-series/learn-form</a> 这个项目的 master 分支上，docs 目录下。</p>
<h2 id="21-路由概述"><a href="#21-路由概述" class="headerlink" title="21.路由概述"></a>21.路由概述</h2><p>我尽量把 Router 叫做“路由”或者“路由机制”，而不叫“路由器”。因为我总感觉“路由器”是一种网络设备，在前端开发领域叫“路由器”怪怪的。</p>
<p><strong>请特别注意：Angular 中的 Router 模块会负责模块的加载、组件的初始化、销毁等操作，它是整个乐队的总指挥。</strong></p>
<h3 id="21-1-前端为什么要路由"><a href="#21-1-前端为什么要路由" class="headerlink" title="21.1 前端为什么要路由"></a>21.1 前端为什么要路由</h3><p>很多开发者代码写得很溜，但是并不理解为什么要 Router 这个机制。</p>
<p>在目前的前端开发领域，无论你使用哪一种框架，“路由”都是一个绕不开的机制。那么，前端为什么一定要路由机制？举两个简单的例子来帮助理解：</p>
<ul>
<li>如果没有 Router，浏览器的前进后退按钮没法用。做过后台管理系统的开发者应该遇到过这种场景，整个系统只有一个 login.jsp 和 index.jsp，用户从 login.jsp 登录完成之后，跳转到 index.jsp 上面，然后浏览器地址栏里面的 URL 就一直停留在 index.jsp 上面，页面内部的所有内容全部通过 Ajax 进行刷新。这种处理方式实际上把浏览器的 URL 机制给废掉了，整个系统只有一个 URL，用户完全无法通过浏览器的前进、后退按钮进行导航。</li>
<li>如果没有 Router，你将无法把 URL 拷贝并分享给你的朋友。比如：你在某段子网站上看到了一个很搞笑的内容，你把 URL 拷贝下来分享给了你的朋友。如果这个段子网站没有做好路由机制，你的朋友将无法顺利打开这个链接。</li>
</ul>
<p>Router 的本质是记录当前页面的状态，它和当前页面上展示的内容一一对应。</p>
<p>在 Angular 里面，Router 是一个独立的模块，定义在 @angular/router 模块里面，它有以下重要的作用：</p>
<ul>
<li>Router 可以配合 NgModule 进行模块的懒加载、预加载操作；</li>
<li>Router 会管理组件的生命周期，它会负责创建、销毁组件。</li>
</ul>
<h3 id="21-2-服务端的配置"><a href="#21-2-服务端的配置" class="headerlink" title="21.2 服务端的配置"></a>21.2 服务端的配置</h3><p>很多开发者会遇到这个问题：代码在开发状态运行得好好的，但是部署到真实的环境上之后所有路由都 404。</p>
<p>这是一个非常典型的问题，你需要配置一下 Server 才能很好地支持前端路由。</p>
<p>你想啊，既然你启用了前端路由，也就意味着浏览器地址栏里面的那些 URL 在 Server 端并没有真正的资源和它对应，你直接访问过去当然 404 了。</p>
<p>以 Tomcat 为例，你需要在 web.xml 里面加一段配置：</p>
<pre class="line-numbers language-html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>error-page</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>error-code</span><span class="token punctuation">></span></span>404<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>error-code</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>location</span><span class="token punctuation">></span></span>/<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>location</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>error-page</span><span class="token punctuation">></span></span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>这意思就是告诉 Tomcat，对于 404 这种事你别管了，直接扔回前端去。由于 Angular 已经在浏览器里面接管了路由机制，所以接下来就由 Angular 来负责了。</p>
<p>如果你正在使用其它的 WEB 容器，请从以下链接里面查找对应的配置方式：</p>
<blockquote>
<p><a href="https://github.com/angular-ui/ui-router/wiki/Frequently-Asked-Questions" target="_blank" rel="noopener">https://github.com/angular-ui/ui-router/wiki/Frequently-Asked-Questions</a></p>
</blockquote>
<p>在 How to: Configure your server to work with html5Mode 这个小节里面把常见的 Web 容器的配置方式都列举出来了，包括：IIS、Apache、nginx、NodeJS、Tomcat 全部都有，你过去抄过来就行。</p>
<h3 id="21-3-小结"><a href="#21-3-小结" class="headerlink" title="21.3 小结"></a>21.3 小结</h3><p>Angular 新版本的路由机制极其强大，除了能支持无限嵌套之外，还能支持模块懒加载、预加载、路由守卫、辅助路由等高级功能，在接下来的几个小节里面就来写例子一一演示。</p>
<p>Angular Router 模块的作者是 Victor Savkin，这是他的个人 Blog：<a href="https://vsavkin.com/" target="_blank" rel="noopener">https://vsavkin.com/</a>，他专门编写了一本小薄书来完整描述 Angular 路由模块的设计思路和运行原理，这本书只有 151 页，如果你有兴趣请点这里：<a href="https://leanpub.com/router" target="_blank" rel="noopener">https://leanpub.com/router</a>。</p>
<h2 id="22-路由基本用法"><a href="#22-路由基本用法" class="headerlink" title="22.路由基本用法"></a>22.路由基本用法</h2><h3 id="22-1-路由的基本用法"><a href="#22-1-路由的基本用法" class="headerlink" title="22.1 路由的基本用法"></a>22.1 路由的基本用法</h3><p>我们从最简单的例子开始，第一个例子的运行效果如下：</p>
<p><img src="https://cdn.jsdelivr.net/gh/shw2018/cdn@1.0/sakura/img/loader/orange.progress-bar-stripe-loader.svg" data-original="https://images.gitbook.cn/668f8b30-b8dc-11e9-a88b-c93a5ea3d618" alt=""></p>
<p>代码结构：</p>
<p><img src="https://cdn.jsdelivr.net/gh/shw2018/cdn@1.0/sakura/img/loader/orange.progress-bar-stripe-loader.svg" data-original="https://images.gitbook.cn/6fb50140-b8dc-11e9-a194-19c3d4002b01" alt=""></p>
<p>app.routing.module.ts 里面就是路由规则配置，内容如下：</p>
<pre class="line-numbers language-typescript"><code class="language-typescript"><span class="token keyword">import</span> <span class="token punctuation">{</span> NgModule <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@angular/core'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Routes<span class="token punctuation">,</span> RouterModule <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@angular/router'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> HomeComponent <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./home/home.component'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> JokesComponent <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./jokes/jokes.component'</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">const</span> appRoutes<span class="token punctuation">:</span> Routes <span class="token operator">=</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
        path<span class="token punctuation">:</span> <span class="token string">''</span><span class="token punctuation">,</span>
        redirectTo<span class="token punctuation">:</span> <span class="token string">'home'</span><span class="token punctuation">,</span>
        pathMatch<span class="token punctuation">:</span> <span class="token string">'full'</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
        path<span class="token punctuation">:</span> <span class="token string">'home'</span><span class="token punctuation">,</span>
        component<span class="token punctuation">:</span> HomeComponent
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
        path<span class="token punctuation">:</span> <span class="token string">'jokes'</span><span class="token punctuation">,</span>
        component<span class="token punctuation">:</span> JokesComponent
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
        path<span class="token punctuation">:</span> <span class="token string">'**'</span><span class="token punctuation">,</span>
        component<span class="token punctuation">:</span> HomeComponent
    <span class="token punctuation">}</span>
<span class="token punctuation">]</span><span class="token punctuation">;</span>

@<span class="token function">NgModule</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    imports<span class="token punctuation">:</span> <span class="token punctuation">[</span>RouterModule<span class="token punctuation">.</span><span class="token function">forRoot</span><span class="token punctuation">(</span>appRoutes<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    exports<span class="token punctuation">:</span> <span class="token punctuation">[</span>RouterModule<span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">AppRoutingModule</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>app.module.ts 里面首先需要 import 这份路由配置文件：</p>
<pre class="line-numbers language-typescript"><code class="language-typescript"><span class="token keyword">import</span> <span class="token punctuation">{</span> AppRoutingModule <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./app.routing.module'</span><span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>然后 @NgModule 里面的 imports 配置项内容如下：</p>
<pre class="line-numbers language-typescript"><code class="language-typescript">imports<span class="token punctuation">:</span> <span class="token punctuation">[</span>
    BrowserModule<span class="token punctuation">,</span>
    AppRoutingModule
<span class="token punctuation">]</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>HTML 模板里面的写法：</p>
<p><img src="https://cdn.jsdelivr.net/gh/shw2018/cdn@1.0/sakura/img/loader/orange.progress-bar-stripe-loader.svg" data-original="https://images.gitbook.cn/89043120-b8dc-11e9-ba33-51636d56aead" alt=""></p>
<p>这个例子的看点：</p>
<ul>
<li>整个导航过程是通过 RouterModule、app.routing.module.ts、routerLink、router-outlet 这几个东西一起配合完成的。</li>
<li>请点击顶部导航条，观察浏览器地址栏里面URL的变化，这里体现的是Router模块最重要的作用，就是对 URL 和对应界面状态的管理。</li>
<li>请注意路由配置文件 app.routing.module.ts 里面的写法，里面全部用的 component 配置项，这种方式叫“同步路由”。也就是说，@angular/cli 在编译的时候不会把组件切分到独立的 module 文件里面去，当然也不会异步加载，所有的组件都会被打包到一份 JS 文件里面去，请看下图：</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/shw2018/cdn@1.0/sakura/img/loader/orange.progress-bar-stripe-loader.svg" data-original="https://images.gitbook.cn/a7e57720-b8dc-11e9-8b62-c350e3466c22" alt=""></p>
<p>你可能会问，如果想要做成异步模块应该怎么做呢？不要着急，下一段里面就会给例子。</p>
<ul>
<li>注意文件的切分，我看到很多朋友会把路由配置直接写在 app.module.ts 里面，这样做不太好。因为随着项目功能越加越多，路由配置也会变得越来越多，全部写在一起未来不好维护。配置归配置，代码归代码，文件尽量切清晰一些，坑谁也别坑自己对吧？</li>
<li>通配符配置必须写在最后一项，否则会导致路由无效。</li>
</ul>
<p><strong>特别注意：内容和代码都已经升级到了 8.0 的写法，在 8.0 里面，路由配置已经定义成了独立的模块，代码整体看起来更加合理了。</strong></p>
<p>完整可运行的代码在这里：<a href="https://gitee.com/learn-angular-series/learn-router" target="_blank" rel="noopener">https://gitee.com/learn-angular-series/learn-router</a>，这个例子对应的代码在 basic分 支上。</p>
<h3 id="22-2-路由与懒加载模块"><a href="#22-2-路由与懒加载模块" class="headerlink" title="22.2 路由与懒加载模块"></a>22.2 路由与懒加载模块</h3><p><img src="https://cdn.jsdelivr.net/gh/shw2018/cdn@1.0/sakura/img/loader/orange.progress-bar-stripe-loader.svg" data-original="https://images.gitbook.cn/d0f90f50-b8dc-11e9-a88b-c93a5ea3d618" alt=""></p>
<p>为什么要做模块的懒加载？</p>
<p>目的很简单：提升 JS 文件的加载速度，提升 JS 文件的执行效率。</p>
<p>对于一些大型的后台管理系统来说，里面可能会有上千份 JS 文件，如果你把所有 JS 全部都压缩到一份文件里面，那么这份文件的体积可能会超过 5M，这是不能接受的，尤其对于移动端应用。</p>
<p>所以，一个很自然的想法就是：我们能不能按照业务功能，把这些 JS 打包成多份 JS 文件，当用户导航到某个路径的时候，再去异步加载对应的 JS 文件。对于大型的系统来说，用户在使用的过程中不太可能会用到所有功能，所以这种方式可以非常有效地提升系统的加载和运行效率。</p>
<p>我们来把上面这个简单的例子改成异步模式，我们把“主页”和“段子”切分成两个独立的模块，并且做成异步加载的模式。</p>
<p>整体代码结构改成这样：</p>
<p><img src="https://cdn.jsdelivr.net/gh/shw2018/cdn@1.0/sakura/img/loader/orange.progress-bar-stripe-loader.svg" data-original="https://images.gitbook.cn/fed68ba0-b8dc-11e9-a88b-c93a5ea3d618" alt=""></p>
<p>我们给 home 和 jokes 分别加了一个 module 文件和一个 routing.module 文件。</p>
<p>home.routing.module.ts 里面的内容如下：</p>
<pre class="line-numbers language-typescript"><code class="language-typescript"><span class="token keyword">import</span> <span class="token punctuation">{</span> NgModule <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@angular/core'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Routes<span class="token punctuation">,</span> RouterModule <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@angular/router'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> HomeComponent <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./home.component'</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">const</span> homeRoutes<span class="token punctuation">:</span>Routes<span class="token operator">=</span><span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
        path<span class="token punctuation">:</span><span class="token string">''</span><span class="token punctuation">,</span>
        component<span class="token punctuation">:</span>HomeComponent
    <span class="token punctuation">}</span>
<span class="token punctuation">]</span><span class="token punctuation">;</span>

@<span class="token function">NgModule</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    imports<span class="token punctuation">:</span> <span class="token punctuation">[</span>RouterModule<span class="token punctuation">.</span><span class="token function">forChild</span><span class="token punctuation">(</span>homeRoutes<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    exports<span class="token punctuation">:</span> <span class="token punctuation">[</span>RouterModule<span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">HomeRoutingModule</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>home.module.ts 里面的内容如下：</p>
<pre class="line-numbers language-typescript"><code class="language-typescript"><span class="token keyword">import</span> <span class="token punctuation">{</span> NgModule <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@angular/core'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> RouterModule <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@angular/router'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> HomeComponent <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./home.component'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> HomeRoutingModule <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./home.routing.module'</span><span class="token punctuation">;</span>

@<span class="token function">NgModule</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  declarations<span class="token punctuation">:</span> <span class="token punctuation">[</span>
    HomeComponent
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  imports<span class="token punctuation">:</span> <span class="token punctuation">[</span>
    HomeRoutingModule
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  providers<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  bootstrap<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">HomeModule</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>jokes 模块相关的代码类似。</p>
<p>最重要的修改在 app.routing.module.ts 里面，路由的配置变成了这样：</p>
<pre class="line-numbers language-typescript"><code class="language-typescript"><span class="token keyword">import</span> <span class="token punctuation">{</span> NgModule <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@angular/core'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Routes<span class="token punctuation">,</span> RouterModule <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@angular/router'</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">const</span> appRoutes<span class="token punctuation">:</span>Routes<span class="token operator">=</span><span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
        path<span class="token punctuation">:</span><span class="token string">''</span><span class="token punctuation">,</span>
        redirectTo<span class="token punctuation">:</span><span class="token string">'home'</span><span class="token punctuation">,</span>
        pathMatch<span class="token punctuation">:</span><span class="token string">'full'</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
        path<span class="token punctuation">:</span><span class="token string">'home'</span><span class="token punctuation">,</span>
        loadChildren<span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token keyword">import</span><span class="token punctuation">(</span><span class="token string">"./home/home.module"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>m <span class="token operator">=</span><span class="token operator">></span> m<span class="token punctuation">.</span>HomeModule<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
        path<span class="token punctuation">:</span><span class="token string">'jokes'</span><span class="token punctuation">,</span>
        loadChildren<span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token keyword">import</span><span class="token punctuation">(</span><span class="token string">"./jokes/jokes.module"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>m <span class="token operator">=</span><span class="token operator">></span> m<span class="token punctuation">.</span>JokesModule<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
        path<span class="token punctuation">:</span><span class="token string">'**'</span><span class="token punctuation">,</span>
        loadChildren<span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token keyword">import</span><span class="token punctuation">(</span><span class="token string">"./home/home.module"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>m <span class="token operator">=</span><span class="token operator">></span> m<span class="token punctuation">.</span>HomeModule<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">]</span><span class="token punctuation">;</span>

@<span class="token function">NgModule</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    imports<span class="token punctuation">:</span> <span class="token punctuation">[</span>RouterModule<span class="token punctuation">.</span><span class="token function">forRoot</span><span class="token punctuation">(</span>appRoutes<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    exports<span class="token punctuation">:</span> <span class="token punctuation">[</span>RouterModule<span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">AppRoutingModule</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>我们把原来的 component 配置项改成了 loadChildren。</p>
<p>来看运行效果：</p>
<p><img src="https://cdn.jsdelivr.net/gh/shw2018/cdn@1.0/sakura/img/loader/orange.progress-bar-stripe-loader.svg" data-original="https://images.gitbook.cn/22e02970-b8dd-11e9-a88b-c93a5ea3d618" alt=""></p>
<p>请按 F12 打开浏览器里面的开发者工具，查看网络面板，然后点击顶部的导航条，你会看到 0.e7bf37b9868f1788a067.chunk.js 是异步加载进来的。</p>
<p>完整可运行的代码在这里：<a href="https://gitee.com/learn-angular-series/learn-router" target="_blank" rel="noopener">https://gitee.com/learn-angular-series/learn-router</a>，这个例子对应的代码在 async-module 分支上。</p>
<p><strong>注意：从 Angular 8.0 开始，为了遵守最新的 import() 标准，官方建议采用新的方式来写 loadChildren：</strong></p>
<pre class="line-numbers language-typescript"><code class="language-typescript"><span class="token comment" spellcheck="true">//8.0 之前是这样的：</span>
loadChildren<span class="token punctuation">:</span><span class="token string">'./home/home.module#HomeModule'</span>

<span class="token comment" spellcheck="true">//从 8.0 开始这样写：</span>
loadChildren<span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token keyword">import</span><span class="token punctuation">(</span><span class="token string">"./blog/home/home.module"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>m <span class="token operator">=</span><span class="token operator">></span> m<span class="token punctuation">.</span>HomeModule<span class="token punctuation">)</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>8.0 的路由定义的方式也发生了一些变化，路由定义在自己独立的模块里面，就像这样：</p>
<p><img src="https://cdn.jsdelivr.net/gh/shw2018/cdn@1.0/sakura/img/loader/orange.progress-bar-stripe-loader.svg" data-original="https://images.gitbook.cn/495dfb90-b8dd-11e9-a88b-c93a5ea3d618" alt=""></p>
<h3 id="22-3-N层嵌套路由"><a href="#22-3-N层嵌套路由" class="headerlink" title="22.3 N层嵌套路由"></a>22.3 N层嵌套路由</h3><p>在真实的系统中，菜单肯定不止一层，我们继续修改上面的例子，给它加一个二级菜单，就像这样：</p>
<p><img src="https://cdn.jsdelivr.net/gh/shw2018/cdn@1.0/sakura/img/loader/orange.progress-bar-stripe-loader.svg" data-original="https://images.gitbook.cn/54cb17b0-b8dd-11e9-8b62-c350e3466c22" alt=""></p>
<p>于是 home 模块的代码结构变成了这样：</p>
<p><img src="https://cdn.jsdelivr.net/gh/shw2018/cdn@1.0/sakura/img/loader/orange.progress-bar-stripe-loader.svg" data-original="https://images.gitbook.cn/602c25e0-b8dd-11e9-ba33-51636d56aead" alt=""></p>
<p>重点的变化在 home.routing.module.ts 里面：</p>
<pre class="line-numbers language-typescript"><code class="language-typescript"><span class="token keyword">import</span> <span class="token punctuation">{</span> NgModule <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@angular/core'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Routes<span class="token punctuation">,</span> RouterModule <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@angular/router'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> HomeComponent <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./home.component'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> PictureComponent <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./picture/picture.component'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> TextComponent <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./text/text.component'</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">const</span> homeRoutes<span class="token punctuation">:</span>Routes <span class="token operator">=</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
        path<span class="token punctuation">:</span> <span class="token string">''</span><span class="token punctuation">,</span>
        component<span class="token punctuation">:</span> HomeComponent<span class="token punctuation">,</span>
        children<span class="token punctuation">:</span> <span class="token punctuation">[</span>
            <span class="token punctuation">{</span>
                path<span class="token punctuation">:</span> <span class="token string">''</span><span class="token punctuation">,</span>
                redirectTo<span class="token punctuation">:</span> <span class="token string">'pictures'</span><span class="token punctuation">,</span>
                pathMatch<span class="token punctuation">:</span> <span class="token string">'full'</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token punctuation">{</span>
                path<span class="token punctuation">:</span> <span class="token string">'pictures'</span><span class="token punctuation">,</span>
                component<span class="token punctuation">:</span> PictureComponent
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token punctuation">{</span>
                path<span class="token punctuation">:</span> <span class="token string">'text'</span><span class="token punctuation">,</span>
                component<span class="token punctuation">:</span> TextComponent
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token punctuation">{</span>
                path<span class="token punctuation">:</span> <span class="token string">'**'</span><span class="token punctuation">,</span>
                component<span class="token punctuation">:</span> PictureComponent
            <span class="token punctuation">}</span>
        <span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">]</span><span class="token punctuation">;</span>

@<span class="token function">NgModule</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    imports<span class="token punctuation">:</span> <span class="token punctuation">[</span>RouterModule<span class="token punctuation">.</span><span class="token function">forChild</span><span class="token punctuation">(</span>homeRoutes<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    exports<span class="token punctuation">:</span> <span class="token punctuation">[</span>RouterModule<span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">HomeRoutingModule</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>理论上，路由可以无限嵌套，而实际上不可能嵌套得特别深。系统里面有一级、二级、三级菜单很正常，如果你的系统做出了十几级菜单，用户还怎么使用呢？</p>
<p>以上例子完整可运行的代码在这里：<a href="https://gitee.com/learn-angular-series/learn-router" target="_blank" rel="noopener">https://gitee.com/learn-angular-series/learn-router</a>，代码在 nested-router 分支上。</p>
<h3 id="22-4-共享模块"><a href="#22-4-共享模块" class="headerlink" title="22.4 共享模块"></a>22.4 共享模块</h3><p>你刚把嵌套路由的问题搞定，本来以为万事大吉了，这时候产品经理又妖娆地走了过来，他跟你说客户需求改了，需要在页面的侧边栏上面加一个展示用户资料的 Panel（面板），就像这样：</p>
<p><img src="https://cdn.jsdelivr.net/gh/shw2018/cdn@1.0/sakura/img/loader/orange.progress-bar-stripe-loader.svg" data-original="https://images.gitbook.cn/7ce582d0-b8dd-11e9-a88b-c93a5ea3d618" alt=""></p>
<p>同时还提了另一个要求，这个展示用户资料的 Panel 在“段子”这个模块里面也要用，而且未来还可能在其它地方也要使用。</p>
<p>这时候，该轮到“共享模块”机制出场了。因为根据 Angular 的规定：组件必须定义在某个模块里面，但是不能同时属于多个模块。</p>
<p>如果你把这个 UserInfo 面板定义在 home.module 里面，jokes.module 就不能使用了，反之亦然。</p>
<p>当然，你可能说，这还不简单，把 UserInfo 定义在根模块 app.module 里面不就好了嘛。</p>
<p>不错，确实可以这样做。但是这样会造成一个问题：如果系统的功能不断增多，你总不能把所有共用的组件都放到 app.module 里面吧？如果真的这样搞，app.module 最终打包出来会变得非常胖。</p>
<p>所以，更优雅的做法是切分一个“共享模块”出来，就像这样：</p>
<p><img src="https://cdn.jsdelivr.net/gh/shw2018/cdn@1.0/sakura/img/loader/orange.progress-bar-stripe-loader.svg" data-original="https://images.gitbook.cn/9309d890-b8dd-11e9-8b62-c350e3466c22" alt=""></p>
<p>对于所有想使用 UserInfo 的模块来说，只要 import 这个 SharedModule 就可以了。</p>
<p>完整可运行的代码在这里：<a href="https://gitee.com/learn-angular-series/learn-router" target="_blank" rel="noopener">https://gitee.com/learn-angular-series/learn-router</a>，这个例子对应的代码在 shared-module 分支上。</p>
<h3 id="22-5-处理路由事件"><a href="#22-5-处理路由事件" class="headerlink" title="22.5 处理路由事件"></a>22.5 处理路由事件</h3><p>Angular 的路由上面暴露了 8 个事件：</p>
<ul>
<li>NavigationStart</li>
<li>RoutesRecognized</li>
<li>RouteConfigLoadStart</li>
<li>RouteConfigLoadEnd</li>
<li>NavigationEnd</li>
<li>NavigationCancel</li>
<li>NavigationError</li>
<li>Scroll</li>
</ul>
<p>从 Angular 5.0 开始，新增了 8 个路由事件：</p>
<ul>
<li>GuardsCheckStart</li>
<li>ChildActivationStart</li>
<li>ActivationStart</li>
<li>GuardsCheckEnd</li>
<li>ResolveStart</li>
<li>ResolveEnd</li>
<li>ActivationEnd</li>
<li>ChildActivationEnd</li>
</ul>
<p>详细的描述参见这里：</p>
<blockquote>
<p><a href="https://angular.io/guide/router#router-events" target="_blank" rel="noopener">https://angular.io/guide/router#router-events</a></p>
</blockquote>
<p>我们可以监听这些事件，来实现一些自己的业务逻辑，示例如下：</p>
<pre class="line-numbers language-typescript"><code class="language-typescript"><span class="token keyword">import</span> <span class="token punctuation">{</span> Component<span class="token punctuation">,</span> OnInit <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@angular/core'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Router<span class="token punctuation">,</span>NavigationStart <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@angular/router'</span><span class="token punctuation">;</span>

@<span class="token function">Component</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  selector<span class="token punctuation">:</span> <span class="token string">'home'</span><span class="token punctuation">,</span>
  templateUrl<span class="token punctuation">:</span> <span class="token string">'./home.component.html'</span><span class="token punctuation">,</span>
  styleUrls<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'./home.component.scss'</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">HomeComponent</span> <span class="token keyword">implements</span> <span class="token class-name">OnInit</span> <span class="token punctuation">{</span>

  <span class="token keyword">constructor</span><span class="token punctuation">(</span><span class="token keyword">private</span> router<span class="token punctuation">:</span> Router<span class="token punctuation">)</span> <span class="token punctuation">{</span>

  <span class="token punctuation">}</span>

  <span class="token function">ngOnInit</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>router<span class="token punctuation">.</span>events<span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment" spellcheck="true">//可以用instanceof来判断事件的类型，然后去做你想要做的事情</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>event <span class="token keyword">instanceof</span> <span class="token class-name">NavigationStart</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>完整可运行的代码在这里：<a href="https://gitee.com/learn-angular-series/learn-router" target="_blank" rel="noopener">https://gitee.com/learn-angular-series/learn-router</a>，这个例子对应的代码在 router-events 分支上。</p>
<h3 id="22-6-如何传递和获取路由参数"><a href="#22-6-如何传递和获取路由参数" class="headerlink" title="22.6 如何传递和获取路由参数"></a>22.6 如何传递和获取路由参数</h3><p>在路由上面传递参数是必备的功能，Angular 的 Router 可以传递两种类型的参数：简单类型的参数、“矩阵式”参数。</p>
<p>请注意以下 routerLink 的写法：</p>
<pre class="line-numbers language-html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ul</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>nav navbar-nav<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span> <span class="token attr-name">routerLinkActive</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>active<span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>dropdown<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">[routerLink]</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>[<span class="token punctuation">'</span>home<span class="token punctuation">'</span>,<span class="token punctuation">'</span>1<span class="token punctuation">'</span>]<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>主页<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span> <span class="token attr-name">routerLinkActive</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>active<span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>dropdown<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">[routerLink]</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>[<span class="token punctuation">'</span>jokes<span class="token punctuation">'</span>,{id:111,name:<span class="token punctuation">'</span>damo<span class="token punctuation">'</span>}]<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>段子<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ul</span><span class="token punctuation">></span></span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>在 HomeComponent 里面，我们是这样来获取简单参数的：</p>
<pre class="line-numbers language-typescript"><code class="language-typescript"><span class="token keyword">constructor</span><span class="token punctuation">(</span>
    <span class="token keyword">public</span> router<span class="token punctuation">:</span>Router<span class="token punctuation">,</span>
    <span class="token keyword">public</span> activeRoute<span class="token punctuation">:</span> ActivatedRoute<span class="token punctuation">)</span> <span class="token punctuation">{</span> 

<span class="token punctuation">}</span>

<span class="token function">ngOnInit</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>activeRoute<span class="token punctuation">.</span>params<span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span>
        <span class="token punctuation">(</span>params<span class="token punctuation">)</span><span class="token operator">=</span><span class="token operator">></span><span class="token punctuation">{</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>params<span class="token punctuation">)</span><span class="token punctuation">}</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>在 JokesComponent 里面，我们是这样来接受“矩阵式”参数的：</p>
<pre class="line-numbers language-typescript"><code class="language-typescript"><span class="token keyword">constructor</span><span class="token punctuation">(</span>
    <span class="token keyword">public</span> router<span class="token punctuation">:</span> Router<span class="token punctuation">,</span>
    <span class="token keyword">public</span> activeRoute<span class="token punctuation">:</span> ActivatedRoute<span class="token punctuation">)</span> <span class="token punctuation">{</span>

<span class="token punctuation">}</span>

<span class="token function">ngOnInit</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>activeRoute<span class="token punctuation">.</span>params<span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span>
        <span class="token punctuation">(</span>params<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>params<span class="token punctuation">)</span> <span class="token punctuation">}</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>“矩阵式”传参 <code>[routerLink]="['jokes',{id:111,name:'damo'}]"</code> 对应的 URL 是这样一种形态：</p>
<pre class="line-numbers language-typescript"><code class="language-typescript">http<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>localhost<span class="token punctuation">:</span><span class="token number">4200</span><span class="token operator">/</span>jokes<span class="token punctuation">;</span>id<span class="token operator">=</span><span class="token number">111</span><span class="token punctuation">;</span>name<span class="token operator">=</span>damo<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>这种 URL 形态不常见，很多朋友应该没有看到过，但是它确实是合法的。它不是 W3C 的规范，但是互联网之父 Tim Berners-Lee 在 1996 年的文档里面有详细的解释，主流浏览器都是支持的：<a href="https://www.w3.org/DesignIssues/MatrixURIs.html" target="_blank" rel="noopener">https://www.w3.org/DesignIssues/MatrixURIs.html</a>。这种方式的好处是，我们可以传递大块的参数，因为第二个参数可以是一个 JSON 格式的对象。</p>
<p>完整可运行的代码在这里：<a href="https://gitee.com/learn-angular-series/learn-router" target="_blank" rel="noopener">https://gitee.com/learn-angular-series/learn-router</a>，这个例子对应的代码在 router-params 分支上。</p>
<h3 id="22-7-用代码触发路由导航"><a href="#22-7-用代码触发路由导航" class="headerlink" title="22.7 用代码触发路由导航"></a>22.7 用代码触发路由导航</h3><p>除了通过 <code>&lt;a routerLink="home"&gt;主页&lt;/a&gt;</code> 这种方式进行导航之外，我们还可以通过代码的方式来手动进行导航：</p>
<pre class="line-numbers language-typescript"><code class="language-typescript"><span class="token keyword">this</span><span class="token punctuation">.</span>router<span class="token punctuation">.</span><span class="token function">navigate</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">"/jokes"</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token punctuation">{</span> queryParams<span class="token punctuation">:</span> <span class="token punctuation">{</span> page<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span>name<span class="token punctuation">:</span><span class="token number">222</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>接受参数的方式如下：</p>
<pre class="line-numbers language-typescript"><code class="language-typescript"><span class="token keyword">this</span><span class="token punctuation">.</span>activeRoute<span class="token punctuation">.</span>queryParams<span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span>
    <span class="token punctuation">(</span>queryParam<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>queryParam<span class="token punctuation">)</span> <span class="token punctuation">}</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>完整可运行的代码在这里：<a href="https://gitee.com/learn-angular-series/learn-router" target="_blank" rel="noopener">https://gitee.com/learn-angular-series/learn-router</a>，这个例子对应的代码在 router-params 分支上。</p>
<h2 id="23-模块预加载"><a href="#23-模块预加载" class="headerlink" title="23.模块预加载"></a>23.模块预加载</h2><p>我们在前面的实例基础上继续修改，为了方便接下来演示“模块预加载”，我们增加了一个一级导航菜单叫做“图片”：</p>
<p><img src="https://cdn.jsdelivr.net/gh/shw2018/cdn@1.0/sakura/img/loader/orange.progress-bar-stripe-loader.svg" data-original="https://images.gitbook.cn/4b42cbb0-b8de-11e9-8b62-c350e3466c22" alt=""></p>
<p>现在我们有 3 个独立的模块：首页、段子、图片。只有当用户点击这些模块的时候，路由才会去异步加载对应的 chunk（块），就像这样：</p>
<p><img src="https://cdn.jsdelivr.net/gh/shw2018/cdn@1.0/sakura/img/loader/orange.progress-bar-stripe-loader.svg" data-original="https://images.gitbook.cn/526bfc90-b8de-11e9-a194-19c3d4002b01" alt=""></p>
<p>一切看起来都那么完美！但是，产品经理又妖娆地走过来了，他对你说：小伙子干得不错！但是我有一个想法，你看能不能实现。虽然这种异步加载的方式确实能提升加载和执行的效率，但是用户体验并没有做到极致。你看啊，咱们是一个段子站，根据我们的统计数据，这 3 个模块用户都是一定会点的。所以，在首页模块加载完成之后，如果能把“段子”和“图片”这两个模块预先加载到客户端就好了。这样当用户点击这两个菜单的时候，看起来就像“秒开”一样，这才叫“极致体验”对吧？怎么样，有没有技术上的困难？下班之前能改好吧？</p>
<p>你一听就来劲了：看你说的，在我这儿从来不存在什么“技术上的困难”，下班之前保证搞定！</p>
<p>在这个场景下，“预加载”就派上用场了，你需要修改一下 app.routing.module.ts，相关的内容要改成这样：</p>
<pre class="line-numbers language-typescript"><code class="language-typescript"><span class="token keyword">import</span> <span class="token punctuation">{</span> RouterModule<span class="token punctuation">,</span> PreloadAllModules <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@angular/router'</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<pre class="line-numbers language-typescript"><code class="language-typescript">RouterModule<span class="token punctuation">.</span><span class="token function">forRoot</span><span class="token punctuation">(</span>appRoutes<span class="token punctuation">,</span><span class="token punctuation">{</span>preloadingStrategy<span class="token punctuation">:</span>PreloadAllModules<span class="token punctuation">}</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>改完之后刷一下浏览器，效果看起来挺不错，所有模块都预加载进来了：</p>
<p><img src="https://cdn.jsdelivr.net/gh/shw2018/cdn@1.0/sakura/img/loader/orange.progress-bar-stripe-loader.svg" data-original="https://images.gitbook.cn/719b6290-b8de-11e9-8b62-c350e3466c22" alt=""></p>
<p>Angular 内置了两种预加载策略：PreloadAllModules 和 NoPreloading，PreloadAllModules 的意思是：预加载所有模块，不管有没有被访问到。也就是说，要么就一次预加载所有异步模块，要么就彻底不做预加载。</p>
<p>本来到这里产品经理的要求已经达成了，但是你是一个有情怀的人，一想到产品经理说的“极致体验”，还有他每次走过来的时候那种妖娆的姿势，你的热情又被点燃了起来。</p>
<p>你仔细看了一下上面的代码，总感觉这种“一次预加载所有模块”的方式太简单粗暴了一点儿。而且根据你自己的预测，将来这个系统还会开发更多的模块，如果总是一次性全部预加载，总感觉怪怪的。于是，你想进一步做一些优化，你希望实现自己的预加载策略，最好能在路由配置里面加入一些自定义的配置项，让某些模块预加载、某些模块不要进行预加载，就像这样：</p>
<pre class="line-numbers language-typescript"><code class="language-typescript"><span class="token punctuation">{</span>
    path<span class="token punctuation">:</span><span class="token string">'jokes'</span><span class="token punctuation">,</span>
    data<span class="token punctuation">:</span><span class="token punctuation">{</span>preload<span class="token punctuation">:</span><span class="token keyword">true</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    loadChildren<span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token keyword">import</span><span class="token punctuation">(</span><span class="token string">"./jokes/jokes.module"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>m <span class="token operator">=</span><span class="token operator">></span> m<span class="token punctuation">.</span>JokesModule<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">{</span>
    path<span class="token punctuation">:</span><span class="token string">'picture'</span><span class="token punctuation">,</span>
    data<span class="token punctuation">:</span><span class="token punctuation">{</span>preload<span class="token punctuation">:</span><span class="token keyword">false</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    loadChildren<span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token keyword">import</span><span class="token punctuation">(</span><span class="token string">"./picture/picture.module"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>m <span class="token operator">=</span><span class="token operator">></span> m<span class="token punctuation">.</span>PictureModule<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>当 preload 这个配置项为 true 的时候，就去预加载对应的模块，否则什么也不做。于是你实现了一个自己的预加载策略：</p>
<p><img src="https://cdn.jsdelivr.net/gh/shw2018/cdn@1.0/sakura/img/loader/orange.progress-bar-stripe-loader.svg" data-original="https://images.gitbook.cn/86201210-b8de-11e9-a194-19c3d4002b01" alt=""></p>
<p>my-preloading-strategy.ts 里面的内容如下：</p>
<pre class="line-numbers language-typescript"><code class="language-typescript"><span class="token keyword">import</span> <span class="token punctuation">{</span> Route<span class="token punctuation">,</span>PreloadingStrategy <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@angular/router'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Observable <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"rxjs"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token string">"rxjs/add/observable/of"</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">MyPreloadingStrategy</span> <span class="token keyword">implements</span> <span class="token class-name">PreloadingStrategy</span> <span class="token punctuation">{</span>
    <span class="token function">preload</span><span class="token punctuation">(</span>route<span class="token punctuation">:</span> Route<span class="token punctuation">,</span> fn<span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> Observable<span class="token operator">&lt;</span><span class="token keyword">any</span><span class="token operator">></span><span class="token punctuation">)</span><span class="token punctuation">:</span> Observable<span class="token operator">&lt;</span><span class="token keyword">any</span><span class="token operator">></span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> route<span class="token punctuation">.</span>data<span class="token operator">&amp;&amp;</span>route<span class="token punctuation">.</span>data<span class="token punctuation">.</span>preload<span class="token operator">?</span><span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>Observable<span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>当然，别忘记修改一下 app.routing.module.ts 里面的配置，换成你自己的预加载策略：</p>
<pre class="line-numbers language-typescript"><code class="language-typescript">RouterModule<span class="token punctuation">.</span><span class="token function">forRoot</span><span class="token punctuation">(</span>appRoutes<span class="token punctuation">,</span><span class="token punctuation">{</span>preloadingStrategy<span class="token punctuation">:</span>MyPreloadingStrategy<span class="token punctuation">}</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>OK，这样一来，模块预加载的控制权就完全交到你自己的手里了。你可以继续修改这个预加载策略，比如用加个延时，或者根据其它某个业务条件来决定是不是要执行预加载，如此等等。</p>
<p>产品经理笑嘻嘻地跟你说：你看，我就知道你是我们这里最流弊的，一出手分分钟搞定。</p>
<p>你乐呵呵地说：那必须啊，老将出马，一个顶俩。</p>
<p>而你心里的实际想法是：mmp 站着说话不腰疼，反正不用你写代码，你知不知道为了搞这个破东西害得我改了一大堆东西！幸亏小爷我比较机智，这次还超前做了一些灵活的配置项，就等你小子下回再来改需求了。</p>
<h2 id="24-路由守卫"><a href="#24-路由守卫" class="headerlink" title="24.路由守卫"></a>24.路由守卫</h2><p>在实际的业务开发过程中，我们经常需要限制某些 URL 的可访问性。比如：对于系统管理界面，只有那些拥有管理员权限的用户才能打开。</p>
<p>有一些简化的处理方案，比如把菜单隐藏起来。但是这样做是不够的，因为用户还可以自己手动在地址栏里面尝试输入，或者更暴力一点，可以通过工具来强行遍历 URL。</p>
<p>请特别注意：前端代码应该默认被看成是不安全的，安全的重头戏应该放在 Server 端，而前端只是做一些基本的防护。</p>
<p>在 Angular 里面，权限控制的任务由“路由守卫”来负责，路由守卫的典型用法：</p>
<ul>
<li>控制路由能否激活</li>
<li>控制路由的能否退出</li>
<li>控制异步模块能否被加载</li>
</ul>
<h3 id="24-1-控制路由能否激活"><a href="#24-1-控制路由能否激活" class="headerlink" title="24.1 控制路由能否激活"></a>24.1 控制路由能否激活</h3><p>代码结构：</p>
<p><img src="https://cdn.jsdelivr.net/gh/shw2018/cdn@1.0/sakura/img/loader/orange.progress-bar-stripe-loader.svg" data-original="https://images.gitbook.cn/c5eb3f50-b8de-11e9-a88b-c93a5ea3d618" alt=""></p>
<p>auth.guard.ts 里面这样写：</p>
<pre class="line-numbers language-typescript"><code class="language-typescript"><span class="token keyword">import</span> <span class="token punctuation">{</span> Injectable <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@angular/core'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> CanLoad<span class="token punctuation">,</span> CanActivate<span class="token punctuation">,</span> CanActivateChild <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@angular/router'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> AuthService <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./auth.service'</span><span class="token punctuation">;</span>

@<span class="token function">Injectable</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">AuthGuard</span> <span class="token keyword">implements</span> <span class="token class-name">CanLoad</span><span class="token punctuation">,</span>CanActivate<span class="token punctuation">,</span>CanActivateChild<span class="token punctuation">{</span>

    <span class="token keyword">constructor</span><span class="token punctuation">(</span><span class="token keyword">private</span> authService<span class="token punctuation">:</span>AuthService<span class="token punctuation">)</span><span class="token punctuation">{</span>

    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">/**
     * 验证路由是否可以激活
     */</span>
    <span class="token function">canActivate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">//在真实的应用里面需要写一个 Service 到后端去验证权限</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>authService<span class="token punctuation">.</span><span class="token function">canActivate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">/**
     * 验证子路由是否可以激活
     */</span>
    <span class="token function">canActivateChild</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">//在真实的应用里面需要写一个 Service 到后端去验证权限</span>
        <span class="token keyword">return</span> <span class="token keyword">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>别忘记把相关的服务放到 app.module.ts 里面去：</p>
<pre class="line-numbers language-typescript"><code class="language-typescript">providers<span class="token punctuation">:</span> <span class="token punctuation">[</span>AuthService<span class="token punctuation">,</span>AuthGuard<span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>然后 app.routing.module.ts 里面这样配置：</p>
<pre class="line-numbers language-typescript"><code class="language-typescript"><span class="token punctuation">{</span>
    path<span class="token punctuation">:</span><span class="token string">'jokes'</span><span class="token punctuation">,</span>
    data<span class="token punctuation">:</span><span class="token punctuation">{</span>preload<span class="token punctuation">:</span><span class="token keyword">true</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    canLoad<span class="token punctuation">:</span><span class="token punctuation">[</span>AuthGuard<span class="token punctuation">]</span><span class="token punctuation">,</span>
    canActivate<span class="token punctuation">:</span><span class="token punctuation">[</span>AuthGuard<span class="token punctuation">]</span><span class="token punctuation">,</span>
    loadChildren<span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token keyword">import</span><span class="token punctuation">(</span><span class="token string">'./jokes/jokes.module'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>m <span class="token operator">=</span><span class="token operator">></span> m<span class="token punctuation">.</span>JokesModule<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这里的 canActivate 配置项就是用来控制路由是否能被激活的，如果 AuthGuard 里面对应的 canActivate 方法返回 false，jokes 这个路由就无法激活。</p>
<p>在所有子模块的路由里面也可以做类似的配置。</p>
<h3 id="24-2-控制路由的退出"><a href="#24-2-控制路由的退出" class="headerlink" title="24.2 控制路由的退出"></a>24.2 控制路由的退出</h3><p>有时候，我们还需要控制路由能否退出。</p>
<p>比如：当用户已经在表单里面输入了大量的内容，如果不小心导航到了其它 URL，那么输入的内容就会全部丢失。很显然，这会让用户非常恼火。</p>
<p>所以，我们需要做一定的防护，避免这种意外的情况。</p>
<p>这个例子的运行界面如下：</p>
<p><img src="https://cdn.jsdelivr.net/gh/shw2018/cdn@1.0/sakura/img/loader/orange.progress-bar-stripe-loader.svg" data-original="https://images.gitbook.cn/eba17bb0-b8de-11e9-a194-19c3d4002b01" alt=""></p>
<p>我们给 jokes 模块单独写了以守卫：</p>
<p><img src="https://cdn.jsdelivr.net/gh/shw2018/cdn@1.0/sakura/img/loader/orange.progress-bar-stripe-loader.svg" data-original="https://images.gitbook.cn/f2a34e70-b8de-11e9-a194-19c3d4002b01" alt=""></p>
<p>jokes-guard.ts 里面的内容如下：</p>
<pre class="line-numbers language-typescript"><code class="language-typescript"><span class="token keyword">import</span> <span class="token punctuation">{</span> Injectable <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@angular/core'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> CanDeactivate <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@angular/router'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> JokesComponent <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./jokes.component'</span><span class="token punctuation">;</span>

@<span class="token function">Injectable</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">JokesGuard</span> <span class="token keyword">implements</span> <span class="token class-name">CanDeactivate</span><span class="token operator">&lt;</span><span class="token keyword">any</span><span class="token operator">></span><span class="token punctuation">{</span>
   <span class="token function">canDeactivate</span><span class="token punctuation">(</span>component<span class="token punctuation">:</span>JokesComponent<span class="token punctuation">)</span><span class="token punctuation">{</span>
       console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>component<span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>component<span class="token punctuation">.</span>saved<span class="token punctuation">)</span><span class="token punctuation">{</span>
           <span class="token keyword">return</span> window<span class="token punctuation">.</span><span class="token function">confirm</span><span class="token punctuation">(</span><span class="token string">"确定不保存吗？"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token punctuation">}</span>
       <span class="token keyword">return</span> <span class="token keyword">true</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>注意 jokes.module.ts 和 jokes.routing.module.ts 里面相关的配置。</p>
<h3 id="24-3-控制模块能否被加载"><a href="#24-3-控制模块能否被加载" class="headerlink" title="24.3 控制模块能否被加载"></a>24.3 控制模块能否被加载</h3><p>除了可以控制路由能否被激活之外，还可以控制模块能否被加载，处理方式类似，在 AuthGuard 里面增加一个处理方法：</p>
<pre class="line-numbers language-typescript"><code class="language-typescript"><span class="token comment" spellcheck="true">/**
 * 验证是否有权限加载一个异步模块
 */</span>
<span class="token function">canLoad</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">//在真实的应用里面需要写一个 Service 到后端去验证权限</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>authService<span class="token punctuation">.</span><span class="token function">canLoad</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>如果 canLoad 方法返回 false，模块就根本不会被加载到浏览器里面了。</p>
<h2 id="25-多重出口"><a href="#25-多重出口" class="headerlink" title="25.多重出口"></a>25.多重出口</h2><p>到目前为止，在我们所有例子里面，界面结构都是这样的：</p>
<p><img src="https://cdn.jsdelivr.net/gh/shw2018/cdn@1.0/sakura/img/loader/orange.progress-bar-stripe-loader.svg" data-original="https://images.gitbook.cn/376e15d0-b8df-11e9-8b62-c350e3466c22" alt=""></p>
<p>但是，有时候我们在同一个界面上需要同时出现两块或者多块动态的内容。比如，你想让左侧的导航栏和右侧的主体区域全部变成动态的，就像这样：</p>
<p><img src="https://cdn.jsdelivr.net/gh/shw2018/cdn@1.0/sakura/img/loader/orange.progress-bar-stripe-loader.svg" data-original="https://images.gitbook.cn/3e101550-b8df-11e9-a88b-c93a5ea3d618" alt=""></p>
<p>核心代码如下：</p>
<p>app.component.html 里面的内容：</p>
<pre class="line-numbers language-typescript"><code class="language-typescript"><span class="token operator">&lt;</span>a <span class="token punctuation">[</span>routerLink<span class="token punctuation">]</span><span class="token operator">=</span><span class="token string">"['home', {outlets: {'left-nav': ['leftNav'], 'main-area': ['none']}}]"</span><span class="token operator">></span>主页<span class="token operator">&lt;</span><span class="token operator">/</span>a<span class="token operator">></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>home.component.html 里面的内容：</p>
<pre class="line-numbers language-html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>row<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>col-xs-3<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>router-outlet</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>left-nav<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>router-outlet</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>col-xs-9<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>router-outlet</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>main-area<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>router-outlet</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>left-nav.component.html 里面的核心代码：</p>
<pre class="line-numbers language-html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>list-group-item<span class="token punctuation">"</span></span> <span class="token attr-name">(click)</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>toogle(1)<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>只看图片<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>list-group-item<span class="token punctuation">"</span></span> <span class="token attr-name">(click)</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>toogle(2)<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>只看文字<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">></span></span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>left-nav.component.ts 里面的核心代码：</p>
<pre class="line-numbers language-typescript"><code class="language-typescript"><span class="token function">toogle</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>router<span class="token punctuation">.</span><span class="token function">navigate</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'/home'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>outlets<span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token string">'main-area'</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>id<span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>运行效果：</p>
<p><img src="https://cdn.jsdelivr.net/gh/shw2018/cdn@1.0/sakura/img/loader/orange.progress-bar-stripe-loader.svg" data-original="https://images.gitbook.cn/92c51c80-b8df-11e9-ba33-51636d56aead" alt=""></p>
<p>请注意看浏览器地址栏里面的内容，形式比较复杂，而且代码写起来也比较繁琐，所以，请尽量避开这种用法。</p>
<h2 id="26-表单快速上手"><a href="#26-表单快速上手" class="headerlink" title="26.表单快速上手"></a>26.表单快速上手</h2><p>如果没有表单，我们将没有途径收集用户输入。所以，表单是前端开发里面的重头戏。在日常开发中，处理表单会占据你大块的编码时间。</p>
<p>我们先来做一个最简单的用户注册界面：</p>
<p><img src="https://cdn.jsdelivr.net/gh/shw2018/cdn@1.0/sakura/img/loader/orange.progress-bar-stripe-loader.svg" data-original="https://images.gitbook.cn/b583c3c0-b8df-11e9-a88b-c93a5ea3d618" alt=""></p>
<p>HTML 模版里面的核心代码：</p>
<pre class="line-numbers language-html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>email<span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>form-control<span class="token punctuation">"</span></span> <span class="token attr-name">placeholder</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>Email<span class="token punctuation">"</span></span> <span class="token attr-name">(keyup)</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>userNameChange($event)<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">#pwd</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>password<span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>form-control<span class="token punctuation">"</span></span> <span class="token attr-name">placeholder</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>Password<span class="token punctuation">"</span></span> <span class="token attr-name">(keyup)</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>0<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>组件核心代码：</p>
<pre class="line-numbers language-typescript"><code class="language-typescript"><span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">FormQuickStartComponent</span> <span class="token keyword">implements</span> <span class="token class-name">OnInit</span> <span class="token punctuation">{</span>
  <span class="token keyword">public</span> userName<span class="token punctuation">:</span><span class="token keyword">string</span><span class="token punctuation">;</span>

  <span class="token keyword">public</span> <span class="token function">userNameChange</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span><span class="token punctuation">:</span><span class="token keyword">void</span><span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>userName<span class="token operator">=</span>event<span class="token punctuation">.</span>target<span class="token punctuation">.</span>value<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这个例子非常简单，里面有两个 input，分别演示两种传递参数的方式：</p>
<ul>
<li>第一个 input：用事件绑定的方式，把 input 的值传递给组件内部定义的 userName 属性，然后页面上再用  获取数据。</li>
<li>第二个 input：我们定义了一个模板局部变量 #pwd，然后底部直接用这个名字来获取 input 的值 。这里有一个小小的注意点，标签里面必须写 (keyup)=”0”，要不然 Angular 不会启动变更检测机制， 取不到值。</li>
</ul>
<h2 id="27-双向数据绑定"><a href="#27-双向数据绑定" class="headerlink" title="27.双向数据绑定"></a>27.双向数据绑定</h2><p>Angular 是第一个把“双向数据绑定”机制引入到前端开发领域来的框架，这也是当年 AngularJS 最受开发者欢迎的特性。</p>
<p>我们接着上一个例子继续改，先看运行效果：</p>
<p><img src="https://cdn.jsdelivr.net/gh/shw2018/cdn@1.0/sakura/img/loader/orange.progress-bar-stripe-loader.svg" data-original="https://images.gitbook.cn/0e441a00-b8e0-11e9-8b62-c350e3466c22" alt=""></p>
<p>HTML 模版里面的核心代码：</p>
<pre class="line-numbers language-html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>email<span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>form-control<span class="token punctuation">"</span></span> <span class="token attr-name">placeholder</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>Email<span class="token punctuation">"</span></span> <span class="token attr-name">[(ngModel)]</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>regModel.userName<span class="token punctuation">"</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>userName<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>password<span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>form-control<span class="token punctuation">"</span></span> <span class="token attr-name">placeholder</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>Password<span class="token punctuation">"</span></span> <span class="token attr-name">[(ngModel)]</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>regModel.password<span class="token punctuation">"</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>password<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>checkbox<span class="token punctuation">"</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>rememberMe<span class="token punctuation">"</span></span> <span class="token attr-name">[(ngModel)]</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>regModel.rememberMe<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>记住我
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>数据模型和组件核心代码：</p>
<pre class="line-numbers language-typescript"><code class="language-typescript"><span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">RegisterModel</span> <span class="token punctuation">{</span>
    userName<span class="token punctuation">:</span> <span class="token keyword">string</span><span class="token punctuation">;</span>
    password<span class="token punctuation">:</span> <span class="token keyword">string</span><span class="token punctuation">;</span>
    rememberMe<span class="token punctuation">:</span><span class="token keyword">boolean</span><span class="token operator">=</span><span class="token keyword">false</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>组件里面的核心代码：</p>
<pre class="line-numbers language-typescript"><code class="language-typescript"><span class="token keyword">import</span> <span class="token punctuation">{</span> RegisterModel <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./model/register-model'</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">FormQuickStartComponent</span> <span class="token keyword">implements</span> <span class="token class-name">OnInit</span> <span class="token punctuation">{</span>
  <span class="token keyword">public</span> regModel<span class="token punctuation">:</span>RegisterModel<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">RegisterModel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>一些常见的坑：</p>
<ul>
<li>要想使用 [(ngModel)] 进行双向绑定，必须在你的 @NgModule 定义里面 import FormsModule 模块。</li>
<li>用双向绑定的时候，必须给 <code>&lt;input&gt;</code> 标签设置 name 或者 id，否则会报错。（这个行为挺奇怪的，吐槽一下！）</li>
<li>表单上面展现的字段和你处理业务用的数据模型不一定完全一致，推荐设计两个 Model，一个用来给表单进行绑定操作，一个用来处理你的业务。</li>
</ul>
<h2 id="28-表单校验"><a href="#28-表单校验" class="headerlink" title="28.表单校验"></a>28.表单校验</h2><p>表单校验一定会牵扯到一个大家都比较头疼的技术点：正则表达式。正则表达式学起来有难度，但是又不可或缺。</p>
<p>强制所有开发者都能精通正则表达式是不太现实的事情，但是有一点是必须要做到的，那就是至少要能读懂别人编写正则。</p>
<h3 id="28-1-先来一个例子"><a href="#28-1-先来一个例子" class="headerlink" title="28.1 先来一个例子"></a>28.1 先来一个例子</h3><p><img src="https://cdn.jsdelivr.net/gh/shw2018/cdn@1.0/sakura/img/loader/orange.progress-bar-stripe-loader.svg" data-original="https://images.gitbook.cn/59f05ae0-b8e0-11e9-a194-19c3d4002b01" alt=""></p>
<p>关键 HTML 模板代码如下：</p>
<pre class="line-numbers language-html"><code class="language-html">    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>form</span> <span class="token attr-name">#registerForm</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>ngForm<span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>form-horizontal<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>form-group<span class="token punctuation">"</span></span> <span class="token attr-name">[ngClass]</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>{<span class="token punctuation">'</span>has-error<span class="token punctuation">'</span>: userName.invalid &amp;&amp; (userName.dirty || userName.touched) }<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>label</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>col-xs-2 control-label<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>用户名：<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>label</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>col-xs-10<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">#userName</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>ngModel<span class="token punctuation">"</span></span> <span class="token attr-name">[(ngModel)]</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>regModel.userName<span class="token punctuation">"</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>userName<span class="token punctuation">"</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>email<span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>form-control<span class="token punctuation">"</span></span> <span class="token attr-name">placeholder</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>Email<span class="token punctuation">"</span></span> <span class="token attr-name">required</span> <span class="token attr-name">minlength</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>12<span class="token punctuation">"</span></span> <span class="token attr-name">maxlength</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>32<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">*ngIf</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>userName.invalid &amp;&amp; (userName.dirty || userName.touched)<span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>text-danger<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">*ngIf</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>userName.errors.required<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
              用户名不能为空
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">*ngIf</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>userName.errors.minlength<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
              最小长度不能小于12个字符
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">*ngIf</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>userName.errors.maxlength<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
              最大长度不能大于32个字符
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>
          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>form</span><span class="token punctuation">></span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>panel-footer<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">></span></span>用户名：{{userName.value}}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">></span></span>密码：{{pwd.value}}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">></span></span>表单状态： {{registerForm.valid}} 
                    {{registerForm.invalid}} 
                    {{registerForm.pending}} 
                    {{registerForm.pristine}} 
                    {{registerForm.dirty}}
                    {{registerForm.untouched}} 
                    {{registerForm.touched}}
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>模板和组件里面的关键代码：</p>
<pre class="line-numbers language-typescript"><code class="language-typescript"><span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">RegisterModel</span> <span class="token punctuation">{</span>
    userName<span class="token punctuation">:</span> <span class="token keyword">string</span><span class="token punctuation">;</span>
    password<span class="token punctuation">:</span> <span class="token keyword">string</span><span class="token punctuation">;</span>
    rememberMe<span class="token punctuation">:</span><span class="token keyword">boolean</span><span class="token operator">=</span><span class="token keyword">false</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-typescript"><code class="language-typescript"><span class="token keyword">import</span> <span class="token punctuation">{</span> RegisterModel <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./model/register-model'</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">FormQuickStartComponent</span> <span class="token keyword">implements</span> <span class="token class-name">OnInit</span> <span class="token punctuation">{</span>
  <span class="token keyword">public</span> regModel<span class="token punctuation">:</span>RegisterModel<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">RegisterModel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="28-2-状态标志位"><a href="#28-2-状态标志位" class="headerlink" title="28.2 状态标志位"></a>28.2 状态标志位</h3><p>Form、FormGroup、FormControl（输入项）都有一些标志位可以使用，这些标志位是 Angular 提供的，一共有 9 个（官方的文档里面没有明确列出来，或者列得不全）：</p>
<ul>
<li>valid：校验成功</li>
<li>invalid：校验失败</li>
<li>pending：表单正在提交过程中</li>
<li>pristine：数据依然处于原始状态，用户没有修改过</li>
<li>dirty：数据已经变脏了，被用户改过了</li>
<li>touched：被触摸或者点击过</li>
<li>untouched：未被触摸或者点击</li>
<li>enabled：启用状态</li>
<li>disabled：禁用状态</li>
</ul>
<p>Form 上面多一个状态标志位 submitted，可以用来判断表单是否已经被提交。</p>
<p>我们可以利用这些标志位来判断表单和输入项的状态。</p>
<h3 id="28-3-内置校验规则"><a href="#28-3-内置校验规则" class="headerlink" title="28.3 内置校验规则"></a>28.3 内置校验规则</h3><p>Angular 一共内置了 8 种校验规则：</p>
<ol>
<li>required</li>
<li>requiredTrue</li>
<li>minLength</li>
<li>maxLength</li>
<li>pattern</li>
<li>nullValidator</li>
<li>compose</li>
<li>composeAsync</li>
</ol>
<p>详细的 API 描述参见这里：</p>
<blockquote>
<p><a href="https://angular.io/api/forms/Validators" target="_blank" rel="noopener">https://angular.io/api/forms/Validators</a></p>
</blockquote>
<h3 id="28-4-自定义校验规则"><a href="#28-4-自定义校验规则" class="headerlink" title="28.4 自定义校验规则"></a>28.4 自定义校验规则</h3><p>内置的校验规则经常不够用，尤其在需要多条件联合校验的时候，所以我们需要自己定义校验规则。</p>
<p>请看这个例子：</p>
<p><img src="https://cdn.jsdelivr.net/gh/shw2018/cdn@1.0/sakura/img/loader/orange.progress-bar-stripe-loader.svg" data-original="https://images.gitbook.cn/941d15f0-b8e0-11e9-a194-19c3d4002b01" alt=""></p>
<p>关键 HTML 模板代码：</p>
<pre class="line-numbers language-html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>form-group<span class="token punctuation">"</span></span>  <span class="token attr-name">[ngClass]</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>{<span class="token punctuation">'</span>has-error<span class="token punctuation">'</span>: mobile.invalid &amp;&amp; (mobile.dirty || mobile.touched) }<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>label</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>col-xs-2 control-label<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>手机号：<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>label</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>col-xs-10<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">#mobile</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>ngModel<span class="token punctuation">"</span></span> <span class="token attr-name">[(ngModel)]</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>regModel.mobile<span class="token punctuation">"</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>mobile<span class="token punctuation">"</span></span> <span class="token attr-name">ChineseMobileValidator</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>form-control<span class="token punctuation">"</span></span> <span class="token attr-name">placeholder</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>Mobile<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">*ngIf</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>mobile.invalid &amp;&amp; (mobile.dirty || mobile.touched)<span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>text-danger<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">*ngIf</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>!mobile.errors.ChineseMobileValidator<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
          请输入合法的手机号
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>自定义的校验规则代码：</p>
<pre class="line-numbers language-typescript"><code class="language-typescript"><span class="token keyword">import</span> <span class="token punctuation">{</span> Directive<span class="token punctuation">,</span> Input <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@angular/core'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Validator<span class="token punctuation">,</span> AbstractControl<span class="token punctuation">,</span> NG_VALIDATORS <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@angular/forms'</span><span class="token punctuation">;</span>

@<span class="token function">Directive</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    selector<span class="token punctuation">:</span> <span class="token string">'[ChineseMobileValidator]'</span><span class="token punctuation">,</span>
    providers<span class="token punctuation">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{</span>
            provide<span class="token punctuation">:</span> NG_VALIDATORS<span class="token punctuation">,</span>
            useExisting<span class="token punctuation">:</span> ChineseMobileValidator<span class="token punctuation">,</span>
            multi<span class="token punctuation">:</span> <span class="token keyword">true</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">ChineseMobileValidator</span> <span class="token keyword">implements</span> <span class="token class-name">Validator</span> <span class="token punctuation">{</span>
    @<span class="token function">Input</span><span class="token punctuation">(</span><span class="token punctuation">)</span> ChineseMobileValidator<span class="token punctuation">:</span> <span class="token keyword">string</span><span class="token punctuation">;</span>

    <span class="token keyword">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span>

    <span class="token function">validate</span><span class="token punctuation">(</span>control<span class="token punctuation">:</span> AbstractControl<span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token punctuation">{</span> <span class="token punctuation">[</span>error<span class="token punctuation">:</span> <span class="token keyword">string</span><span class="token punctuation">]</span><span class="token punctuation">:</span> <span class="token keyword">any</span> <span class="token punctuation">}</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> val <span class="token operator">=</span> control<span class="token punctuation">.</span>value<span class="token punctuation">;</span>        
        <span class="token keyword">let</span> flag<span class="token operator">=</span><span class="token regex">/^1(3|4|5|7|8)\d{9}$/</span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span><span class="token punctuation">;</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>flag<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>flag<span class="token punctuation">)</span><span class="token punctuation">{</span>
            control<span class="token punctuation">.</span><span class="token function">setErrors</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token keyword">null</span>
        <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
            control<span class="token punctuation">.</span><span class="token function">setErrors</span><span class="token punctuation">(</span><span class="token punctuation">{</span>ChineseMobileValidator<span class="token punctuation">:</span><span class="token keyword">false</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token punctuation">{</span>ChineseMobileValidator<span class="token punctuation">:</span><span class="token keyword">false</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>可以看到，自定义校验规则的使用方式和内置校验规则并没有什么区别。</p>
<p>当然，也可以把正则表达式传给内置的 pattern 校验器来实现这个效果，但是每次都拷贝正则比较麻烦，对于你的业务系统常见的校验规则，还是把它沉淀成你们自己的校验规则库可复用性更高。</p>
<p>关于校验器更详细的 API 描述参见这里：</p>
<blockquote>
<p><a href="https://angular.io/api/forms/Validators" target="_blank" rel="noopener">https://angular.io/api/forms/Validators</a></p>
</blockquote>
<h2 id="29-模型驱动型表单"><a href="#29-模型驱动型表单" class="headerlink" title="29.模型驱动型表单"></a>29.模型驱动型表单</h2><p>前面的例子都是“模板驱动型表单”，我们把表单相关的逻辑，包括校验逻辑全部写在模板里面，组件内部几乎没写什么代码。</p>
<p>表单的另一种写法是“模型驱动型表单”，又叫做“响应式表单”。特点是：把表单的创建、校验等逻辑全部用代码写到组件里面，让 HTML 模板变得很简单。</p>
<p><strong>特别注意：如果想使用响应式表单，必须在你的 @NgModule 定义里面 import ReactiveFormsModule。</strong></p>
<p>这里我们来一个复杂一些的表单，运行起来的效果如下：</p>
<p><img src="https://cdn.jsdelivr.net/gh/shw2018/cdn@1.0/sakura/img/loader/orange.progress-bar-stripe-loader.svg" data-original="https://images.gitbook.cn/e8d885c0-b8e0-11e9-a88b-c93a5ea3d618" alt=""></p>
<p>如果你想查阅“响应式表单”的详细文档，请参考这里：</p>
<blockquote>
<p><a href="https://angular.io/guide/reactive-forms" target="_blank" rel="noopener">https://angular.io/guide/reactive-forms</a></p>
</blockquote>
<h2 id="30-动态表单"><a href="#30-动态表单" class="headerlink" title="30.动态表单"></a>30.动态表单</h2><p>有这样一种业务场景：表单里面的输入项不是固定的，需要根据服务端返回的数据动态进行创建。</p>
<p>这时候我们压根没法把表单的 HTML 模板写死，我们需要根据配置项用代码动态构建表单，而这些配置项甚至可能是在服务端动态生成的。</p>
<p>在 NiceFish 里面有一个实际的例子，运行效果如下：</p>
<p><img src="https://cdn.jsdelivr.net/gh/shw2018/cdn@1.0/sakura/img/loader/orange.progress-bar-stripe-loader.svg" data-original="https://images.gitbook.cn/18dadde0-b8e1-11e9-a194-19c3d4002b01" alt=""></p>
<p>我们把创建表单相关的逻辑全部移到了组件里面：</p>
<p><img src="https://cdn.jsdelivr.net/gh/shw2018/cdn@1.0/sakura/img/loader/orange.progress-bar-stripe-loader.svg" data-original="https://images.gitbook.cn/1ff96060-b8e1-11e9-a194-19c3d4002b01" alt=""></p>
<p>HTML 模板变得非常简单：</p>
<p><img src="https://cdn.jsdelivr.net/gh/shw2018/cdn@1.0/sakura/img/loader/orange.progress-bar-stripe-loader.svg" data-original="https://images.gitbook.cn/269852a0-b8e1-11e9-8b62-c350e3466c22" alt=""></p>
<h2 id="31-服务"><a href="#31-服务" class="headerlink" title="31.服务"></a>31.服务</h2><p>在组件的构造函数里面声明，Angular 会在运行时自动把 Service 实例创建出来并注射给组件：</p>
<p><img src="https://cdn.jsdelivr.net/gh/shw2018/cdn@1.0/sakura/img/loader/orange.progress-bar-stripe-loader.svg" data-original="https://images.gitbook.cn/873cebf0-cce3-11e9-8d89-4fa271cb1633" alt=""></p>
<h3 id="31-1-单例模式"><a href="#31-1-单例模式" class="headerlink" title="31.1 单例模式"></a>31.1 单例模式</h3><p>如果你希望 Service 是全局单例的，需要把它定义到根模块里面。</p>
<p><img src="https://cdn.jsdelivr.net/gh/shw2018/cdn@1.0/sakura/img/loader/orange.progress-bar-stripe-loader.svg" data-original="https://images.gitbook.cn/991910b0-cce3-11e9-9a11-bbb3551196dc" alt=""></p>
<h3 id="31-2-多实例模式"><a href="#31-2-多实例模式" class="headerlink" title="31.2 多实例模式"></a>31.2 多实例模式</h3><p>下面这个例子用来测试 UserListService 是否是单例，第一个组件会向 UserListService 里面塞数据，第二个组件会尝试去读取数据：</p>
<p><img src="https://cdn.jsdelivr.net/gh/shw2018/cdn@1.0/sakura/img/loader/orange.progress-bar-stripe-loader.svg" data-original="https://images.gitbook.cn/bf4196e0-cce3-11e9-8d89-4fa271cb1633" alt=""></p>
<p>核心代码如下：</p>
<pre class="line-numbers language-typescript"><code class="language-typescript"><span class="token operator">&lt;</span>pre<span class="token operator">></span>
@<span class="token function">Component</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  selector<span class="token punctuation">:</span> <span class="token string">'order-list'</span><span class="token punctuation">,</span>
  templateUrl<span class="token punctuation">:</span> <span class="token string">'./order-list.component.html'</span><span class="token punctuation">,</span>
  styleUrls<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'./order-list.component.scss'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  providers<span class="token punctuation">:</span> <span class="token punctuation">[</span>UserListService<span class="token punctuation">]</span> <span class="token comment" spellcheck="true">//如果你在这里提供了 providers 配置，UserListService 就不是全局单例了</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>pre<span class="token operator">></span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>从运行结果可以看出来，因为我们在组件内部的 providers 里面也配置了一个 UserListService，很明显就不是同一个实例了。</p>
<h3 id="31-3-简单解释一下原理"><a href="#31-3-简单解释一下原理" class="headerlink" title="31.3 简单解释一下原理"></a>31.3 简单解释一下原理</h3><p>在新版本的 Angular 里面，每个组件上都有自己的注射器（Injector）实例，所以很明显，注射器也构成了一个树形的结构。</p>
<p><img src="https://cdn.jsdelivr.net/gh/shw2018/cdn@1.0/sakura/img/loader/orange.progress-bar-stripe-loader.svg" data-original="https://images.gitbook.cn/e4e49960-cce3-11e9-8d89-4fa271cb1633" alt=""></p>
<p>我们的 UserListService 是通过依赖注入机制注射给组件的，DI 机制会根据以下顺序查找服务实例：</p>
<ul>
<li>如果组件内部的 providers 上面配置了服务，优先使用组件上的配置。</li>
<li>否则继续向父层组件继续查找。</li>
<li>直到查询到模块里面的 providers 配置。</li>
<li>如果没有找到指定的服务，抛异常。</li>
</ul>
<p>所以请特别注意：</p>
<ul>
<li>在 Component 里面直接引入 Service，就不是单例了，而是会为每个组件实例都创建一个单独的 Service 单例。</li>
<li>如果你在多个模块（@NgModule）里面同时定义 providers，那也不是单例。</li>
<li>如果你在异步加载的模块里面定义 Service，那也不是全局单例的，因为 Angular 会为异步模块创建独立的 Injector 空间。</li>
</ul>
<h3 id="31-4-关于Service的基本注意点"><a href="#31-4-关于Service的基本注意点" class="headerlink" title="31.4 关于Service的基本注意点"></a>31.4 关于Service的基本注意点</h3><p>有很多朋友说：OK，我会写 Service 了，也知道怎么玩注入了，但还有一个最基本的问题没有解决，那就是应该把什么样的东西做成服务？</p>
<p>整体上说，Angular 里面的 Service 与后端框架里面的 Service 设计思想是一致的：</p>
<ul>
<li>Service 应该是无状态的。</li>
<li>Service 应该可以被很多组件复用，不应该和任何组件紧密相关。</li>
<li>多个 Service 可以组合起来，实现更复杂的服务。</li>
</ul>
<p>在 Angular 核心包里面，最典型的一个服务就是 Htpp 服务。</p>
<blockquote>
<p><a href="https://en.wikipedia.org/wiki/Service-oriented_architecture" target="_blank" rel="noopener">https://en.wikipedia.org/wiki/Service-oriented_architecture</a></p>
</blockquote>
<h2 id="32-RxJS-快速上手"><a href="#32-RxJS-快速上手" class="headerlink" title="32.RxJS 快速上手"></a>32.RxJS 快速上手</h2><h3 id="32-1-ReactiveX与RxJS"><a href="#32-1-ReactiveX与RxJS" class="headerlink" title="32.1 ReactiveX与RxJS"></a>32.1 ReactiveX与RxJS</h3><p>ReactiveX 本身是一种编程范式，或者叫一种设计思想，目前有Java/C++/Python 等 18 种语言实现了 ReactiveX，RxJS 是其中的 JavaScript 版本。</p>
<p>ReactiveX 的官方网站在这里：<a href="http://reactivex.io/" target="_blank" rel="noopener">http://reactivex.io/</a>，上面有详细介绍、入门文档、技术特性等。</p>
<p>这篇文章不会重复文档上已经有的内容，而是从另外一个视角，带你领略 RxJS 的核心用法。</p>
<h3 id="32-2-回调地狱与-Promise"><a href="#32-2-回调地狱与-Promise" class="headerlink" title="32.2 回调地狱与 Promise"></a>32.2 回调地狱与 Promise</h3><p>在使用 Ajax 的过程中，经常会遇到这种情况：我们需要在一个 Ajax 里面嵌套另一个 Ajax 调用，有时候甚至需要嵌套好几层 Ajax 调用，于是就形成了所谓的“回调地狱”：</p>
<p><img src="https://cdn.jsdelivr.net/gh/shw2018/cdn@1.0/sakura/img/loader/orange.progress-bar-stripe-loader.svg" data-original="https://images.gitbook.cn/0113c240-cce5-11e9-9f23-07a3e2a236db" alt=""></p>
<p>这种代码最大的问题是可读性非常差，时间长了之后根本无法维护。</p>
<p>Promise 的出现主要就是为了解决这个问题，在 Promise 的场景下，我们可以这样写代码：</p>
<pre class="line-numbers language-typescript"><code class="language-typescript"><span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span>reject<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">//异步操作之后用 resolve 返回 data</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">//依赖于 Promise 的第一个异步操作</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">//依赖于 Promise 的第二个异步操作</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">//依赖于 Promise 的第三个异步操作</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token keyword">catch</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span>reason<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">//处理异常</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>很明显，这样的代码可读性就强太多了，而且未来维护起来也很方便。</p>
<p>当然，Promise 的作用不止于此，如果你想更细致地研究 Promise，请看 MDN 上的这篇资料：</p>
<blockquote>
<p><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Promise" target="_blank" rel="noopener">https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Promise</a></p>
</blockquote>
<h3 id="32-3-RxJS-与-Promise-的共同点"><a href="#32-3-RxJS-与-Promise-的共同点" class="headerlink" title="32.3 RxJS 与 Promise 的共同点"></a>32.3 RxJS 与 Promise 的共同点</h3><p>RxJS 与 Promise 具有相似的地方，请看以下两个代码片段：</p>
<pre class="line-numbers language-typescript"><code class="language-typescript"><span class="token keyword">let</span> promise <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span>resolve <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
        <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'---promise timeout---'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">2000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
promise<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>value <span class="token operator">=</span><span class="token operator">></span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-typescript"><code class="language-typescript"><span class="token keyword">let</span> stream1$ <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Observable</span><span class="token punctuation">(</span>observer <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> timeout <span class="token operator">=</span> <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
        observer<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token string">'observable timeout'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">2000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
        <span class="token function">clearTimeout</span><span class="token punctuation">(</span>timeout<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> disposable <span class="token operator">=</span> stream1$<span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span>value <span class="token operator">=</span><span class="token operator">></span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>可以看到，RxJS 和 Promise 的基本用法非常类似，除了一些关键词不同。Promise 里面用的是 then() 和 resolve()，而 RxJS 里面用的是 next() 和 subscribe()。</p>
<h3 id="32-4-RxJS-与-Promise-的-3-大重要不同点"><a href="#32-4-RxJS-与-Promise-的-3-大重要不同点" class="headerlink" title="32.4 RxJS 与 Promise 的 3 大重要不同点"></a>32.4 RxJS 与 Promise 的 3 大重要不同点</h3><p>任何一种技术或者框架，一定要有自己的特色，如果跟别人完全一样，解决的问题也和别人一样，那存在的意义和价值就会遭到质疑。</p>
<p>所以，RxJS 一定有和 Promise 不一样的地方，最重要的不同点有 3 个，请看下图：</p>
<p><img src="https://cdn.jsdelivr.net/gh/shw2018/cdn@1.0/sakura/img/loader/orange.progress-bar-stripe-loader.svg" data-original="https://images.gitbook.cn/366bead0-cce5-11e9-beb5-a53251e30de8" alt=""></p>
<p>依次给 3 块代码来示范一下：</p>
<pre class="line-numbers language-typescript"><code class="language-typescript"><span class="token keyword">let</span> promise <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span>resolve <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
        <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'---promise timeout---'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">2000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
promise<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>value <span class="token operator">=</span><span class="token operator">></span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-typescript"><code class="language-typescript"><span class="token keyword">let</span> stream1$ <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Observable</span><span class="token punctuation">(</span>observer <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> timeout <span class="token operator">=</span> <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
        observer<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token string">'observable timeout'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">2000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
        <span class="token function">clearTimeout</span><span class="token punctuation">(</span>timeout<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> disposable <span class="token operator">=</span> stream1$<span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span>value <span class="token operator">=</span><span class="token operator">></span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
    disposable<span class="token punctuation">.</span><span class="token function">unsubscribe</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>从以上代码可以看到，Promise 的创建之后，动作是无法撤回的。Observable 不一样，动作可以通过 unsbscribe() 方法中途撤回，而且 Observable 在内部做了智能的处理，如果某个主题的订阅者为 0，RxJS 将不会触发动作。</p>
<pre class="line-numbers language-typescript"><code class="language-typescript"><span class="token keyword">let</span> stream2$ <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Observable</span><span class="token operator">&lt;</span><span class="token keyword">number</span><span class="token operator">></span><span class="token punctuation">(</span>observer <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> count <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> interval <span class="token operator">=</span> <span class="token function">setInterval</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
        observer<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span>count<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
        <span class="token function">clearInterval</span><span class="token punctuation">(</span>interval<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
stream2$<span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span>value <span class="token operator">=</span><span class="token operator">></span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"Observable>"</span><span class="token operator">+</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>以上代码里面我们用 setInterval 每隔一秒钟触发一个新的值，源源不断，就像流水一样。</p>
<p>这一点 Promise 是做不到的，对于 Promise 来说，最终结果要么 resole（兑现）、要么 reject（拒绝），而且都只能触发一次。如果在同一个 Promise 对象上多次调用 resolve 方法，则会抛异常。而 Observable 不一样，它可以不断地触发下一个值，就像 next() 这个方法的名字所暗示的那样。</p>
<pre class="line-numbers language-typescript"><code class="language-typescript"><span class="token keyword">let</span> stream2$ <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Observable</span><span class="token operator">&lt;</span><span class="token keyword">number</span><span class="token operator">></span><span class="token punctuation">(</span>observer <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> count <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> interval <span class="token operator">=</span> <span class="token function">setInterval</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
        observer<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span>count<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
        <span class="token function">clearInterval</span><span class="token punctuation">(</span>interval<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
stream2$
<span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>
    <span class="token function">filter</span><span class="token punctuation">(</span>val <span class="token operator">=</span><span class="token operator">></span> val <span class="token operator">%</span> <span class="token number">2</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span>value <span class="token operator">=</span><span class="token operator">></span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"filter>"</span> <span class="token operator">+</span> value<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

stream2$
<span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>
    <span class="token function">map</span><span class="token punctuation">(</span>value <span class="token operator">=</span><span class="token operator">></span> value <span class="token operator">*</span> value<span class="token punctuation">)</span>
<span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span>value <span class="token operator">=</span><span class="token operator">></span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"map>"</span> <span class="token operator">+</span> value<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>在上述代码里面，我们用到了两个工具函数：filter 和 map。</p>
<ul>
<li>filter 的作用就如它的名字所示，可以对结果进行过滤，在以上代码里面，我们只对偶数值有兴趣，所以给 filter 传递了一个箭头函数，当这个函数的返回值为 true 的时候，结果就会留下来，其它值都会被过滤掉。</li>
<li>map 的作用是用来对集合进行遍历，比如例子里面的代码，我们把 Observable 返回的每个值都做了一次平方，然后再传递给监听函数。</li>
</ul>
<p>类似这样的工具方法在 Observable 里面叫做 operator（操作符），所以有人说 Observable 就相当于异步领域的 Underscore 或者 lodash，这样的比喻是非常贴切的。这也是 Observable 比较强的地方，Promise 里面就没有提供这些工具函数。</p>
<p>Observable 里面提供了数百个这样的“操作符”，完整的列表和 API 文档请参考这里：</p>
<blockquote>
<p><a href="http://reactivex.io/documentation/operators.html" target="_blank" rel="noopener">http://reactivex.io/documentation/operators.html</a></p>
</blockquote>
<p>RxJS 官方的 GitHub 仓库在这里：</p>
<blockquote>
<p><a href="https://github.com/ReactiveX/rxjs.git" target="_blank" rel="noopener">https://github.com/ReactiveX/rxjs.git</a></p>
</blockquote>
<p><strong>特别注意</strong>：Angular 5.0之后，修改了 RxJS 的 import 方式，与其它模块的引入格式进行了统一。</p>
<pre class="line-numbers language-typescript"><code class="language-typescript"><span class="token keyword">import</span> <span class="token punctuation">{</span> Observable<span class="token punctuation">,</span> Subject <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'rxjs'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> debounceTime<span class="token punctuation">,</span> distinctUntilChanged<span class="token punctuation">,</span> map<span class="token punctuation">,</span> filter <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'rxjs/operators'</span><span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>我也看到有一些朋友在抱怨，说 RxJS 太过复杂，操作符（operator）的数量又特别多，不知道在什么场景下面应该用什么操作符。</p>
<p>实际上这种担心是多余的，因为在 RxJS 里面最常用的操作符不超过 10 个，不常用的操作符都可以在使用的时候再去查阅文档。</p>
<p>RxJS 和你自己开发的系统一样，常用的功能只有其中的 20%，而剩余 80% 的功能可能永远不会被用到。所以，RxJS 并不像很多人说的那么玄乎，你一定能学会，我相信你。</p>
<h3 id="32-5-RxJS-在-Angular-的典型应用场景-1：HTTP-服务"><a href="#32-5-RxJS-在-Angular-的典型应用场景-1：HTTP-服务" class="headerlink" title="32.5 RxJS 在 Angular 的典型应用场景 1：HTTP 服务"></a>32.5 RxJS 在 Angular 的典型应用场景 1：HTTP 服务</h3><pre class="line-numbers language-typescript"><code class="language-typescript"><span class="token keyword">this</span><span class="token punctuation">.</span>http
<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> <span class="token punctuation">{</span> search<span class="token punctuation">:</span> params <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>
    <span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span>res<span class="token punctuation">:</span> Response<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> result <span class="token operator">=</span> res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> result<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">catchError</span><span class="token punctuation">(</span><span class="token punctuation">(</span>error<span class="token punctuation">:</span> <span class="token keyword">any</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> Observable<span class="token punctuation">.</span><span class="token keyword">throw</span><span class="token punctuation">(</span>error <span class="token operator">||</span> <span class="token string">'Server error'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>在新版本的 Angular 里面，HTTP 服务的返回值都是 Observable 类型的对象，所以我们可以 subscribe（订阅）这个对象。当然，Observable 所提供的各种“操作符”都可以用在这个对象上面，比如上面这个例子就用到了 map 操作符。</p>
<h3 id="32-6-RxJS-在-Angular-的典型应用场景-2：事件处理"><a href="#32-6-RxJS-在-Angular-的典型应用场景-2：事件处理" class="headerlink" title="32.6 RxJS 在 Angular 的典型应用场景 2：事件处理"></a>32.6 RxJS 在 Angular 的典型应用场景 2：事件处理</h3><pre class="line-numbers language-typescript"><code class="language-typescript"><span class="token keyword">this</span><span class="token punctuation">.</span>searchTextStream
<span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>
    <span class="token function">debounceTime</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">distinctUntilChanged</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span>searchText <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>searchText<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">loadData</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>searchText<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这个例子里面最有意思的部分是 debounceTime 方法和 distinctUntilChanged 方法，这是一种“去抖动”效果。“去抖动”这个场景非常能体现 Observable 的优势所在，有一些朋友可能没遇到过这种场景，我来解释一下，以防万一。</p>
<p>在搜索引擎里面，我们经常会看到这样的效果：</p>
<p><img src="https://cdn.jsdelivr.net/gh/shw2018/cdn@1.0/sakura/img/loader/orange.progress-bar-stripe-loader.svg" data-original="https://images.gitbook.cn/c6b83990-cce5-11e9-8d89-4fa271cb1633" alt=""></p>
<p>这种东西叫做“动态搜索建议”，在用户敲击键盘的过程中，浏览器已经向后台发起了请求，返回了一些结果，目的是给用户提供一些建议。</p>
<p>效果看起来很简单，但是如果没有这个 debounceTime 工具函数，我们自己实现起来是非常麻烦的。这里的难点在于：用户敲击键盘的过程是源源不断的，我们并不知道用户什么时候才算输入完成。所以，如果让你自己来从零开始实现这种效果，你将会不得不使用定时器，不停地注册、取消，自己实现延时，还要对各种按键码做处理。</p>
<p>在 Observable 里面，处理这种情况非常简单，只要一个简单的 debounceTime 加 distinctUntilChanged 调用就可以了。</p>
<h3 id="32-7-小结"><a href="#32-7-小结" class="headerlink" title="32.7 小结"></a>32.7 小结</h3><ul>
<li>ReactiveX 本身是一种编程范式，或者叫一种设计思想，RxJS 是其中的一种实现，其它还有 Java/C++/Python 等15种语言的实现版本。ReactiveX 本身涉及到的内容比较多，特别是一些设计思想层面的内容，如果你对它特别有兴趣，请参考官方的站点：<a href="http://reactivex.io/" target="_blank" rel="noopener">http://reactivex.io</a>。</li>
<li>关于 RxJS 目前已经有专门的书籍来做介绍，但是还没有中文版。在网络上有各种翻译和文章，如果你想深入研究，请自行搜索。</li>
<li>RxJS 是 Angular 内核的重要组成部分，它和 Zone.js 一起配合实现了“变更检测”机制，所以在编写 Angular 应用的过程中应该优先使用 RxJS 相关的 API。</li>
<li>RxJS 可以独立使用，它并不一定要和 Angular 一起使用。</li>
</ul>
<h2 id="33-Reactive-Programming与RxJS深入解析"><a href="#33-Reactive-Programming与RxJS深入解析" class="headerlink" title="33.Reactive Programming与RxJS深入解析"></a>33.Reactive Programming与RxJS深入解析</h2><blockquote>
<p>这部分内容有深度，如果你暂时不想了解这么多，可以先跳过去，有需要的时候再来看。</p>
</blockquote>
<h3 id="33-1-Reactive-Programming—反应式编程"><a href="#33-1-Reactive-Programming—反应式编程" class="headerlink" title="33.1 Reactive Programming—反应式编程"></a>33.1 Reactive Programming—反应式编程</h3><p><img src="https://cdn.jsdelivr.net/gh/shw2018/cdn@1.0/sakura/img/loader/orange.progress-bar-stripe-loader.svg" data-original="https://images.gitbook.cn/33cae4b0-cce6-11e9-beb5-a53251e30de8" alt=""></p>
<p>从本质上来说，计算机编程语言分成两大种大的范式：命令式和声明式。</p>
<ul>
<li>典型的命令式编程语言有：C、C++、Java 等。</li>
<li>典型的声明式编程语言有：SQL、XML、HTML、SVG 等。</li>
</ul>
<p>为了帮助你更好地理解这两种编程范式的不同点，我用自己的语言来解释一下。比如 SQL 是一种典型的声明式语言，你会写出这样的语句：</p>
<pre><code>select u.* from user u where u.age &gt; 15;</code></pre><p>但是，数据库在底层是如何解释并执行这条语句，是由数据库自己决定的，不需要程序员来控制，程序员只是在“描述”自己想要什么，而并不需要告诉计算机具体怎么做。</p>
<p>命令式编程语言刚好相反，程序员必须想好需要什么结果，同时需要提供完整的执行过程。</p>
<p>Reactive Programming 属于声明式编程语言的一种，有很多中文资料把它翻译成“响应式编程”，我认为这不够准确，而且容易和UI设计领域的“响应式编程”发生混淆，翻译成“反应式编程”更加贴切，请参考题图。</p>
<h3 id="33-2-发展历程"><a href="#33-2-发展历程" class="headerlink" title="33.2 发展历程"></a>33.2 发展历程</h3><p><img src="https://cdn.jsdelivr.net/gh/shw2018/cdn@1.0/sakura/img/loader/orange.progress-bar-stripe-loader.svg" data-original="https://images.gitbook.cn/539a0d20-cce6-11e9-beb5-a53251e30de8" alt=""></p>
<p>Reactive Programming 在 1970 年代就开始发展了，后来微软在 .NET 上面做了第一个实现，后面 2013 年的时候有了 Java 版的实现，然后才有了 ReactiveX 宣言。</p>
<p>目前有 18 种语言实现了 ReactiveX，而 RxJS 是其中的 JS 版本。所以，你可以看到，ReactiveX 本身是和语言无关的，你可以把它看成一种编程思想、一种协议、一种规范。</p>
<h3 id="33-3-典型的业务场景"><a href="#33-3-典型的业务场景" class="headerlink" title="33.3 典型的业务场景"></a>33.3 典型的业务场景</h3><p>有人会说，OK，我懂了，这是一种编程思想，但是我为什么要用它呢？它能带来什么好处呢？</p>
<p>我举几个典型的业务场景帮助你理解。</p>
<ul>
<li>场景一：事件流与“防抖动”</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/shw2018/cdn@1.0/sakura/img/loader/orange.progress-bar-stripe-loader.svg" data-original="https://images.gitbook.cn/808d2970-cce6-11e9-8d89-4fa271cb1633" alt=""></p>
<p><img src="https://cdn.jsdelivr.net/gh/shw2018/cdn@1.0/sakura/img/loader/orange.progress-bar-stripe-loader.svg" data-original="https://images.gitbook.cn/8847c4e0-cce6-11e9-beb5-a53251e30de8" alt=""></p>
<p>用户连续不断地敲击键盘，如果用户每次按下一个键就发起一个网络请求进行查询，很明显就会产生大量无效的查询。那么，如何才能在用户真正输入完成之后再发起查询请求呢？这个场景用 RxJS 实现起来就非常简单。</p>
<ul>
<li>场景二：数据流</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/shw2018/cdn@1.0/sakura/img/loader/orange.progress-bar-stripe-loader.svg" data-original="https://images.gitbook.cn/abae6bf0-cce6-11e9-9a11-bbb3551196dc" alt=""></p>
<p>我有 3 个 Ajax 请求，业务需要 3 个请求全部都成功之后才能继续后面的业务操作。这个场景可以用 Promise 来实现，也可以用 RxJS 来实现。</p>
<ul>
<li>场景三：数据与 UI 的同步</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/shw2018/cdn@1.0/sakura/img/loader/orange.progress-bar-stripe-loader.svg" data-original="https://images.gitbook.cn/c3b76030-cce6-11e9-beb5-a53251e30de8" alt=""></p>
<ul>
<li>场景四：Android 中 UI 线程与其它线程的同步问题</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/shw2018/cdn@1.0/sakura/img/loader/orange.progress-bar-stripe-loader.svg" data-original="https://images.gitbook.cn/d0b83bb0-cce6-11e9-beb5-a53251e30de8" alt=""></p>
<p>对于以上 4 种典型的业务场景，如果完全靠程序员从零自己实现，会非常繁琐，而用 ReactiveX 的思路来做就会非常简单。</p>
<h3 id="33-4-RX中的难点：Operator（操作符）"><a href="#33-4-RX中的难点：Operator（操作符）" class="headerlink" title="33.4 RX中的难点：Operator（操作符）"></a>33.4 RX中的难点：Operator（操作符）</h3><p>ReactiveX 所描述的设计思想是非常清晰的，理解起来也不困难。</p>
<p>但是，在工程实践中，有很多人在抱怨 ReactiveX 过于繁琐，这里面最大的一个难点就是所谓的“操作符”（Operator）的用法。</p>
<p>ReactiveX 官方移动定义了 70 个 Operator，分成 11 个大类（各种语言实现 Operator 的数量不一样）：</p>
<p><img src="https://cdn.jsdelivr.net/gh/shw2018/cdn@1.0/sakura/img/loader/orange.progress-bar-stripe-loader.svg" data-original="https://images.gitbook.cn/16024530-cce7-11e9-9a11-bbb3551196dc" alt=""></p>
<h3 id="33-5-RxJS"><a href="#33-5-RxJS" class="headerlink" title="33.5 RxJS"></a>33.5 RxJS</h3><p>RxJS 是 ReactiveX 的 JavaScript 版实现，它本身是独立的，只是 Angular 选用了它来构建自己的内核。</p>
<p>RxJS 一共实现了 105 个 Operator，分成 10 个大类，完整的分类和列表参见这里：</p>
<blockquote>
<p><a href="https://rxjs.dev/guide/operators" target="_blank" rel="noopener">https://rxjs.dev/guide/operators</a></p>
</blockquote>
<p>请不用担忧，这里面很多 Operator 在日常业务开发里面永远都不会用到。所以你不需要一次性全部掌握，刚开始的时候只要能熟练使用其中的 15 个就可以了。</p>
<p>创建型：</p>
<ul>
<li>ajax</li>
<li>empty</li>
<li>from</li>
<li>of</li>
<li>range</li>
</ul>
<p>join 创建型：</p>
<ul>
<li>concat</li>
<li>merge</li>
<li>zip</li>
</ul>
<p>变换型：</p>
<ul>
<li>map</li>
<li>scan</li>
</ul>
<p>过滤型：</p>
<ul>
<li>filter</li>
<li>first</li>
<li>last</li>
<li>throttle</li>
</ul>
<p>异常处理型：</p>
<ul>
<li>catchError</li>
</ul>
<p>对于其他 Operator，你可以在用到的时候再查文档，也可以通过类比的方式进行理解和记忆。比如：对于数学运算类的 Operator，当你看到有 max 的时候，就能想到一定有 min。这是非常自然的事情，并不需要额外的努力。</p>
<p>在官方的文档中 <a href="https://rxjs.dev/guide/operators" target="_blank" rel="noopener">https://rxjs.dev/guide/operators</a>，为每一个 Operator 都提供了实例代码，总共有一千多个例子，你可以对照这些例子进行理解。在例子页面上，还提供了弹珠图。我看到有一些初学者还不会看弹珠图，附一张中文版的弹珠图说明如下：</p>
<p><img src="https://cdn.jsdelivr.net/gh/shw2018/cdn@1.0/sakura/img/loader/orange.progress-bar-stripe-loader.svg" data-original="https://images.gitbook.cn/769be270-cce7-11e9-9f23-07a3e2a236db" alt=""></p>
<p><strong>弹珠图是从上向下看的：上方的时间线是输入，中间的方框是 Operator，下方的时间线是输出。由于输入输出都是 Observable，所以可以无限链式调用。</strong></p>
<p>比如下面这张弹珠图：</p>
<p><img src="https://cdn.jsdelivr.net/gh/shw2018/cdn@1.0/sakura/img/loader/orange.progress-bar-stripe-loader.svg" data-original="https://images.gitbook.cn/82c040a0-cce7-11e9-8d89-4fa271cb1633" alt=""></p>
<p>输入是上方的两条时间线，中间的 merge 是 Operator，下方的时间线是输出，所以 merge 操作的效果就是把两条时间线上的值“合并”成了下方的一条时间线。</p>
<h3 id="33-6-参考资料"><a href="#33-6-参考资料" class="headerlink" title="33.6 参考资料"></a>33.6 参考资料</h3><ul>
<li><a href="https://en.wikipedia.org/wiki/" target="_blank" rel="noopener">https://en.wikipedia.org/wiki/Declarative_programming</a></li>
<li>ReactiveX 宣言：<a href="http://reactivex.io/" target="_blank" rel="noopener">http://reactivex.io/</a></li>
<li>RxJS：<a href="https://github.com/ReactiveX/rxjs" target="_blank" rel="noopener">https://github.com/ReactiveX/rxjs</a></li>
<li>RxJava：<a href="https://github.com/ReactiveX/RxJava" target="_blank" rel="noopener">https://github.com/ReactiveX/RxJava</a></li>
</ul>
<h2 id="34-国际化的用法"><a href="#34-国际化的用法" class="headerlink" title="34.国际化的用法"></a>34.国际化的用法</h2><h3 id="34-1-先看运行效果"><a href="#34-1-先看运行效果" class="headerlink" title="34.1 先看运行效果"></a>34.1 先看运行效果</h3><p>这里用 NiceFish 这个开源项目来演示国际化的用法，代码在这里：</p>
<blockquote>
<p><a href="https://gitee.com/mumu-osc/NiceFish" target="_blank" rel="noopener">https://gitee.com/mumu-osc/NiceFish</a></p>
</blockquote>
<p>这是默认中文情况下，用户注册界面：</p>
<p><img src="https://cdn.jsdelivr.net/gh/shw2018/cdn@1.0/sakura/img/loader/orange.progress-bar-stripe-loader.svg" data-original="https://images.gitbook.cn/13b6b210-cce8-11e9-9f23-07a3e2a236db" alt=""></p>
<p>打开 Chrome 的设置界面，把默认语言设置成“英语”：</p>
<p><img src="https://cdn.jsdelivr.net/gh/shw2018/cdn@1.0/sakura/img/loader/orange.progress-bar-stripe-loader.svg" data-original="https://images.gitbook.cn/1cd411d0-cce8-11e9-9f23-07a3e2a236db" alt=""></p>
<p>刷新一下，可以看到界面变成了英文状态：</p>
<p><img src="https://cdn.jsdelivr.net/gh/shw2018/cdn@1.0/sakura/img/loader/orange.progress-bar-stripe-loader.svg" data-original="https://images.gitbook.cn/240cfa20-cce8-11e9-9a11-bbb3551196dc" alt=""></p>
<h3 id="34-2-解释具体做法"><a href="#34-2-解释具体做法" class="headerlink" title="34.2 解释具体做法"></a>34.2 解释具体做法</h3><p>第一步：在项目的 package.json 里面的 dependencies 配置项中加上 “ng2-translate”: “5.0.0”。</p>
<p>第二步：在 app.module.ts 里面导入需要使用的模块：</p>
<pre class="line-numbers language-typescript"><code class="language-typescript"><span class="token keyword">import</span> <span class="token punctuation">{</span> TranslateModule<span class="token punctuation">,</span> TranslateLoader<span class="token punctuation">,</span> TranslateStaticLoader <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'ng2-translate'</span><span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>在 imports 配置项里面加上以下内容：</p>
<pre class="line-numbers language-typescript"><code class="language-typescript">TranslateModule<span class="token punctuation">.</span><span class="token function">forRoot</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    provide<span class="token punctuation">:</span> TranslateLoader<span class="token punctuation">,</span>
    useFactory<span class="token punctuation">:</span> <span class="token punctuation">(</span>http<span class="token punctuation">:</span> Http<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token keyword">new</span> <span class="token class-name">TranslateStaticLoader</span><span class="token punctuation">(</span>http<span class="token punctuation">,</span><span class="token string">'./assets/i18n'</span><span class="token punctuation">,</span> <span class="token string">'.json'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    deps<span class="token punctuation">:</span> <span class="token punctuation">[</span>Http<span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>第三步：在 app.component.ts 中的 ngOnInit 钩子里面加上以下内容：</p>
<pre class="line-numbers language-typescript"><code class="language-typescript"><span class="token keyword">this</span><span class="token punctuation">.</span>translate<span class="token punctuation">.</span><span class="token function">addLangs</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">"zh"</span><span class="token punctuation">,</span> <span class="token string">"en"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">this</span><span class="token punctuation">.</span>translate<span class="token punctuation">.</span><span class="token function">setDefaultLang</span><span class="token punctuation">(</span><span class="token string">'zh'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> browserLang <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>translate<span class="token punctuation">.</span><span class="token function">getBrowserLang</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">this</span><span class="token punctuation">.</span>translate<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>browserLang<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span><span class="token regex">/zh|en/</span><span class="token punctuation">)</span> <span class="token operator">?</span> browserLang <span class="token punctuation">:</span> <span class="token string">'zh'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>第四步：在 HTML 模板里面通过管道的方式来编写需要进行国际化的Key：</p>
<p><img src="https://cdn.jsdelivr.net/gh/shw2018/cdn@1.0/sakura/img/loader/orange.progress-bar-stripe-loader.svg" data-original="https://images.gitbook.cn/6107c950-cce8-11e9-beb5-a53251e30de8" alt=""></p>
<p>可以看到，国际化插件本质上是利用了 Angular 的“管道”机制。</p>
<p>第五步：用来编写国际化字符串的 JSON 文件是这样的：</p>
<p><img src="https://cdn.jsdelivr.net/gh/shw2018/cdn@1.0/sakura/img/loader/orange.progress-bar-stripe-loader.svg" data-original="https://images.gitbook.cn/6e1c05c0-cce8-11e9-8d89-4fa271cb1633" alt=""></p>
<h3 id="34-3-小结"><a href="#34-3-小结" class="headerlink" title="34.3 小结"></a>34.3 小结</h3><p>ng2-translate 的主页在这里：</p>
<blockquote>
<p><a href="https://github.com/ngx-translate/core" target="_blank" rel="noopener">https://github.com/ngx-translate/core</a></p>
</blockquote>
<p>它是一个第三方提供的 i18n 库，和 Angular 结合得比较好，ngx-translate 是后来改的名字。</p>
<h2 id="35-自动化测试"><a href="#35-自动化测试" class="headerlink" title="35.自动化测试"></a>35.自动化测试</h2><p>自动化测试一直是前端开发中的一个巨大痛点，由于前端在运行时严重依赖浏览器环境，导致我们一直没法像测试后端代码那样可以自动跑用例。</p>
<p>在有了 NodeJS 之后，我们终于有了 Karma+Jasmine 这样的单元测试组合，也有了基于 WebDriverJS 这样的可以和浏览器进行通讯的集成测试神器。</p>
<p>目前，无论你使用什么样的前端框架，做单元测试一定会用到 Karma+Jasmine，这个组合已经成为了事实标准。Karma 是一个运行时平台，Jasmine 是用来编写测试用例的一种语法。</p>
<p>集成测试（场景测试）稍微复杂一些，但是一般都会用 WebDriverJS 来实现，它也是事实标准。对于 Angular 来说，集成测试所用的工具叫做 Protractor（量角器），底层也是 WebDriverJS。</p>
<p>如果你使用 @angular/cli 作为开发环境，在前端自动化测试方面会非常简单，因为它已经在内部集成了这些工具。</p>
<p>但是有一件事非常遗憾，在@angular/cli 目前发布的所有版本里面，默认生成的项目和配置文件都无法直接运行单元测试，因为@angular/cli 默认引用的一些 Node.js 模块在 Windows 平台上面有 Bug。</p>
<p>所以，这里不会列举 Jasmine 和 Protractor 的那些语法特性，而是帮你填平这些小坑，让你能把这个机制跑起来。至于 Jasmine 和 Protractor 详细 API 调用方式，需要你自己去研究并熟悉，请参见：</p>
<ul>
<li><a href="https://jasmine.github.io/" target="_blank" rel="noopener">https://jasmine.github.io/</a></li>
<li><a href="http://www.protractortest.org/" target="_blank" rel="noopener">http://www.protractortest.org</a></li>
</ul>
<p>注意，Karma、Jasmine、WebDriverJS 是通用技术，与具体的框架无关；Protractor 是专门针对 Angular 设计的，不能用在其它框架里面。</p>
<h3 id="35-1-单元测试"><a href="#35-1-单元测试" class="headerlink" title="35.1 单元测试"></a>35.1 单元测试</h3><p>在 @angular/cli 自动生成的项目结构里面，karma.conf.js 里面有这样一些配置项：</p>
<p><img src="https://cdn.jsdelivr.net/gh/shw2018/cdn@1.0/sakura/img/loader/orange.progress-bar-stripe-loader.svg" data-original="https://images.gitbook.cn/2058fd60-cce9-11e9-beb5-a53251e30de8" alt=""></p>
<p>很可惜，这里引用的 karma-jasmine-html-reporter 这个 Node 模块在 Windows 下面有 Bug。</p>
<p>所以我们需要进行一些修改，把报告生成器改成 karma-htmlfile-reporter 和 karma-mocha-reporter。</p>
<p>我们需要修改两份配置文件：package.json 和 karma.conf.js。</p>
<p>第一步，把 package.json 里面的 <code>"karma-jasmine-html-reporter"</code> 这一行删掉，换成以下内容：</p>
<pre class="line-numbers language-typescript"><code class="language-typescript"><span class="token string">"karma-mocha-reporter"</span><span class="token punctuation">:</span><span class="token string">"^2.2.3"</span><span class="token punctuation">,</span>
<span class="token string">"karma-htmlfile-reporter"</span><span class="token punctuation">:</span> <span class="token string">"~0.3"</span><span class="token punctuation">,</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>第二步，把 karma.conf.js 里面的 <code>require('karma-jasmine-html-reporter')</code> 这一行配置换成以下内容：</p>
<pre class="line-numbers language-typescript"><code class="language-typescript"><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'karma-htmlfile-reporter'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'karma-mocha-reporter'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>同时把原来 <code>reporters: ['progress', 'kjhtml']</code> 这一行替换成下面的一段内容：</p>
<pre class="line-numbers language-typescript"><code class="language-typescript">reporters<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'progress'</span><span class="token punctuation">,</span><span class="token string">'mocha'</span><span class="token punctuation">,</span><span class="token string">'html'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
htmlReporter<span class="token punctuation">:</span> <span class="token punctuation">{</span>
    outputFile<span class="token punctuation">:</span> <span class="token string">'unit-test-report/report.html'</span><span class="token punctuation">,</span>

    <span class="token comment" spellcheck="true">// Optional </span>
    pageTitle<span class="token punctuation">:</span> <span class="token string">'单元测试结果'</span><span class="token punctuation">,</span>
    subPageTitle<span class="token punctuation">:</span> <span class="token string">'learn-test'</span><span class="token punctuation">,</span>
    groupSuites<span class="token punctuation">:</span> <span class="token keyword">true</span><span class="token punctuation">,</span>
    useCompactStyle<span class="token punctuation">:</span> <span class="token keyword">true</span><span class="token punctuation">,</span>
    useLegacyStyle<span class="token punctuation">:</span> <span class="token keyword">true</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>如果你想直接拷贝 karma.conf.js 完整的内容，请参考这个空壳示例项目：</p>
<blockquote>
<p><a href="https://gitee.com/learn-angular-series/learn-test" target="_blank" rel="noopener">https://gitee.com/learn-angular-series/learn-test</a></p>
</blockquote>
<p>改完这些配置之后，使用 <code>cnpm install</code> 重新安装一下所依赖的 Node 模块，然后在终端里面执行：</p>
<pre class="line-numbers language-typescript"><code class="language-typescript">ng test
<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>Karma 将会自动把你本地的 Chrome 浏览器拉起来，并且自动运行所有测试用例。</p>
<p><img src="https://cdn.jsdelivr.net/gh/shw2018/cdn@1.0/sakura/img/loader/orange.progress-bar-stripe-loader.svg" data-original="https://images.gitbook.cn/8780c400-cce9-11e9-9a11-bbb3551196dc" alt=""></p>
<p><img src="https://cdn.jsdelivr.net/gh/shw2018/cdn@1.0/sakura/img/loader/orange.progress-bar-stripe-loader.svg" data-original="https://images.gitbook.cn/8e9dbfe0-cce9-11e9-8d89-4fa271cb1633" alt=""></p>
<p>同时，在 unit-test-report 这个目录里面会生成一个 report.html，我本地跑完之后生成的内容如下：</p>
<p><img src="https://cdn.jsdelivr.net/gh/shw2018/cdn@1.0/sakura/img/loader/orange.progress-bar-stripe-loader.svg" data-original="https://images.gitbook.cn/97762760-cce9-11e9-beb5-a53251e30de8" alt=""></p>
<p>接下来就看你自己的了，你需要去 Jasmine 的主页上面熟悉一下基本语法，然后编写更多的单元测试用例。</p>
<h3 id="35-2-集成测试"><a href="#35-2-集成测试" class="headerlink" title="35.2 集成测试"></a>35.2 集成测试</h3><p>在 @angular/cli 自动生成的项目结构里面，有一个 e2e 目录，里面有 3 个文件：</p>
<p><img src="https://cdn.jsdelivr.net/gh/shw2018/cdn@1.0/sakura/img/loader/orange.progress-bar-stripe-loader.svg" data-original="https://images.gitbook.cn/a3a497b0-cce9-11e9-9f23-07a3e2a236db" alt=""></p>
<p>打开 app.po.ts，可以看到下面的内容：</p>
<pre class="line-numbers language-typescript"><code class="language-typescript"><span class="token keyword">import</span> <span class="token punctuation">{</span> browser<span class="token punctuation">,</span> by<span class="token punctuation">,</span> element <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'protractor'</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">AppPage</span> <span class="token punctuation">{</span>
  <span class="token function">navigateTo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> browser<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">getParagraphText</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">element</span><span class="token punctuation">(</span>by<span class="token punctuation">.</span><span class="token function">css</span><span class="token punctuation">(</span><span class="token string">'app-root h1'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getText</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>我不打算在这篇文章里面列举 Protractor 的技术特性和 API 列表，借着上面的这段代码，我大概给你介绍一下 Protractor 的整体设计思路和使用方式。</p>
<p>如前所述，Protractor 的底层是 WebDriverJS，从 WebDriverJS 这个名字你可以猜出来，这是一个 Driver（驱动），它是用来和浏览器进程通讯的。</p>
<p>Protractor 在 WebDriverJS 的基础上封装了一层，暴露出了几个非常核心的接口：</p>
<ul>
<li>browser 对象：我们可以利用这个对象来操纵浏览器，比如打开和关闭浏览器窗口、让浏览器窗口最大（小）化、控制浏览器导航到某个 URL 路径。</li>
<li>element 和 by 对象：我们可以利用这两个对象来控制浏览器内部的 HTML 元素，而其基本的语法和 CSS 选择器非常类似，并没有太多的学习成本。</li>
</ul>
<h3 id="35-3-小结"><a href="#35-3-小结" class="headerlink" title="35.3 小结"></a>35.3 小结</h3><p>推荐阿里发布的前端自动化测试 f2etest 框架，这是目前较强大的一款前端自动化框架，而且是开源免费的。f2etest 的底层也是用的 Karma+Jasmine 和 WebDriverJS 这套东西，它在此基础上进行了自己的封装，可以利用多台虚拟机实现浏览器云的效果。关于 f2etest 的更多详情请参考这个链接：<a href="https://github.com/alibaba/f2etest" target="_blank" rel="noopener">https://github.com/alibaba/f2etest</a>，里面有详细的文档和上手教程。</p>
<p><img src="https://cdn.jsdelivr.net/gh/shw2018/cdn@1.0/sakura/img/loader/orange.progress-bar-stripe-loader.svg" data-original="https://images.gitbook.cn/d2868bb0-cce9-11e9-9a11-bbb3551196dc" alt=""></p>
<p>虽然已经有了这么多强大的工具，但是国内大多数企业并没有真正去编写测试用例。因为测试用例本身也是代码，而国内大多数企业都会不停地改需求，这就会导致测试用例的代码也需要不停地改。不写测试用例我们已经 996 了，根本没有任何动力去把工作量增加一倍。</p>
<p>所以，如你所知，像TDD 这种东西，还是让它停留在美丽的幻想里面吧。</p>
<p>对于自动化测试这件事，也许只能量力而行，能做就做一些，实在不想做的话，最起码要知道怎么做。</p>
<p>当然，也有少量的企业自己搭建了完善的持续集成平台，如果有这样的技术基础，自动化测试做起来会轻松很多。</p>
<h2 id="36-注射器树基础知识"><a href="#36-注射器树基础知识" class="headerlink" title="36.注射器树基础知识"></a>36.注射器树基础知识</h2><p>为了能更方便地理解后面的内容，你需要预先理解以下两个概念：</p>
<ul>
<li>组件树</li>
<li>注射器树</li>
</ul>
<p>同时还要介绍一个调试神器 Augury，注意，这货读 [‘ɔ:ɡjuri]，是“占卜”、“预言”的意思，不是 angry，不是愤怒！</p>
<h3 id="36-1-组件树"><a href="#36-1-组件树" class="headerlink" title="36.1 组件树"></a>36.1 组件树</h3><p>目前，几乎所有前端框架都在玩“组件化”，而且最近都不约而同地选择了“标签化”这种思路，Angular 也不例外。“标签化”会导致一个很自然的结果，组件之间会形成树形结构。例如，对于下面这样一个界面：</p>
<p><img src="https://cdn.jsdelivr.net/gh/shw2018/cdn@1.0/sakura/img/loader/orange.progress-bar-stripe-loader.svg" data-original="https://images.gitbook.cn/d818c9a0-d25f-11e9-84ba-0bd4ba7d7fb3" alt=""></p>
<p>用 Angular 实现出来的组件树结构是这样的：</p>
<p><img src="https://cdn.jsdelivr.net/gh/shw2018/cdn@1.0/sakura/img/loader/orange.progress-bar-stripe-loader.svg" data-original="https://images.gitbook.cn/e8783970-d25f-11e9-8d0f-6b56ebcd1907" alt=""></p>
<p>在线查看运行效果：</p>
<blockquote>
<p><a href="http://47.104.13.149:4200/" target="_blank" rel="noopener">http://47.104.13.149:4200/</a></p>
</blockquote>
<p>repo 地址：</p>
<blockquote>
<p><a href="http://git.oschina.net/mumu-osc/NiceFish" target="_blank" rel="noopener">http://git.oschina.net/mumu-osc/NiceFish</a></p>
</blockquote>
<h3 id="36-2-Injector-Tree"><a href="#36-2-Injector-Tree" class="headerlink" title="36.2 Injector Tree"></a>36.2 Injector Tree</h3><p>如你所知，AngularJS 是第一个把“依赖注入”（Dependency Injection）思想带到前端开发领域的框架。</p>
<p>关于“注射器树”这事儿这里要说得更精确一点：<strong>如果一个 DOM 元素上面被创建了 Component 或者 Directive，Angular 就会创建一个对应的注射器实例。</strong></p>
<p>对于上面的组件结构，形成的注射器结构是这样的：</p>
<p><img src="https://cdn.jsdelivr.net/gh/shw2018/cdn@1.0/sakura/img/loader/orange.progress-bar-stripe-loader.svg" data-original="https://images.gitbook.cn/0292cfa0-d260-11e9-bcae-b7c2737c8da6" alt=""></p>
<p>很明显，这些 Injector 实例也构成了树形结构：</p>
<p><img src="https://cdn.jsdelivr.net/gh/shw2018/cdn@1.0/sakura/img/loader/orange.progress-bar-stripe-loader.svg" data-original="https://images.gitbook.cn/092ae410-d260-11e9-8d0f-6b56ebcd1907" alt=""></p>
<p><strong>请记住这个树形结构，后续的所有内容都是以此为基础展开的。</strong></p>
<h3 id="36-2-利用Augury可视化查看注射器树"><a href="#36-2-利用Augury可视化查看注射器树" class="headerlink" title="36.2 利用Augury可视化查看注射器树"></a>36.2 利用Augury可视化查看注射器树</h3><p>Augury 是一款 Chrome 插件，它是调试 Angular 应用的利器，利用它可以可视化展示组件树、路由树，以及服务依赖关系。</p>
<p>比如，对于 NiceFish 首页：</p>
<p><img src="https://cdn.jsdelivr.net/gh/shw2018/cdn@1.0/sakura/img/loader/orange.progress-bar-stripe-loader.svg" data-original="https://images.gitbook.cn/3280b560-d260-11e9-b943-9d5bb2abdc80" alt=""></p>
<p>它的服务依赖关系是这样的：</p>
<p><img src="https://cdn.jsdelivr.net/gh/shw2018/cdn@1.0/sakura/img/loader/orange.progress-bar-stripe-loader.svg" data-original="https://images.gitbook.cn/386c0f10-d260-11e9-84ba-0bd4ba7d7fb3" alt=""></p>
<p>组件依赖关系是这样的：</p>
<p><img src="https://cdn.jsdelivr.net/gh/shw2018/cdn@1.0/sakura/img/loader/orange.progress-bar-stripe-loader.svg" data-original="https://images.gitbook.cn/3e258350-d260-11e9-b943-9d5bb2abdc80" alt=""></p>
<p>整体路由树是这样的：</p>
<p><img src="https://cdn.jsdelivr.net/gh/shw2018/cdn@1.0/sakura/img/loader/orange.progress-bar-stripe-loader.svg" data-original="https://images.gitbook.cn/44e2fa10-d260-11e9-b943-9d5bb2abdc80" alt=""></p>
<h3 id="36-3-小结"><a href="#36-3-小结" class="headerlink" title="36.3 小结"></a>36.3 小结</h3><p>到这里为止，你知道了：<strong>在 Angular 应用运行时，组件之间会构成树形结构，Injector（注射器）的实例也会构成树形结构。</strong></p>
<p>接下来，我们从易到难，就可以把注射器玩儿出花来。</p>
<h3 id="36-4-参考资源"><a href="#36-4-参考资源" class="headerlink" title="36.4 参考资源"></a>36.4 参考资源</h3><ul>
<li><a href="https://angular.io/guide/dependency-injection" target="_blank" rel="noopener">https://angular.io/guide/dependency-injection</a></li>
<li><a href="http://git.oschina.net/mumu-osc/NiceFish" target="_blank" rel="noopener">http://git.oschina.net/mumu-osc/NiceFish</a></li>
</ul>
<h2 id="37-Angular依赖注入的基本玩法（1）"><a href="#37-Angular依赖注入的基本玩法（1）" class="headerlink" title="37.Angular依赖注入的基本玩法（1）"></a>37.Angular依赖注入的基本玩法（1）</h2><p>Angular 的依赖注入机制很强大，这一节我们玩儿三种最典型的场景：</p>
<ul>
<li>全局单例模式的 Service</li>
<li>多实例模式的 Service</li>
<li>异步模块上的 Service</li>
</ul>
<h3 id="37-1-全局单例模式"><a href="#37-1-全局单例模式" class="headerlink" title="37.1 全局单例模式"></a>37.1 全局单例模式</h3><p>我们有一个 UserListComponent，它会利用 UserListService 来加载数据，写法如下。</p>
<p>在 UserListComponent 的构造函数里声明 UserListService：</p>
<p><img src="https://cdn.jsdelivr.net/gh/shw2018/cdn@1.0/sakura/img/loader/orange.progress-bar-stripe-loader.svg" data-original="https://images.gitbook.cn/94de49c0-d260-11e9-84ba-0bd4ba7d7fb3" alt=""></p>
<p>编写 UserListService 的具体实现：</p>
<p><img src="https://cdn.jsdelivr.net/gh/shw2018/cdn@1.0/sakura/img/loader/orange.progress-bar-stripe-loader.svg" data-original="https://images.gitbook.cn/9bd239d0-d260-11e9-b943-9d5bb2abdc80" alt=""></p>
<p>在根模块 AppModule 的 providers 里面配置 UserListService：</p>
<p><img src="https://cdn.jsdelivr.net/gh/shw2018/cdn@1.0/sakura/img/loader/orange.progress-bar-stripe-loader.svg" data-original="https://images.gitbook.cn/a454e030-d260-11e9-bcae-b7c2737c8da6" alt=""></p>
<p>运行起来的效果是这样的：</p>
<p><img src="https://cdn.jsdelivr.net/gh/shw2018/cdn@1.0/sakura/img/loader/orange.progress-bar-stripe-loader.svg" data-original="https://images.gitbook.cn/ab05acc0-d260-11e9-84ba-0bd4ba7d7fb3" alt=""></p>
<p>再看一下以上代码，你没有直接 new UserListService 对不对？很明显，Angular 在运行时自动帮你创建了 Service 的实例。</p>
<p>OK，看起来不错，但是如何证明这个 Service 是全局单例呢？</p>
<p>我们在界面上再放一个 UserListComponent 的实例，然后把 UserListService 的 id 打印出来看是否相同，就像这样：</p>
<p><img src="https://cdn.jsdelivr.net/gh/shw2018/cdn@1.0/sakura/img/loader/orange.progress-bar-stripe-loader.svg" data-original="https://images.gitbook.cn/b5fbc420-d260-11e9-84ba-0bd4ba7d7fb3" alt=""></p>
<p>运行起来的效果是这样的：</p>
<p><img src="https://cdn.jsdelivr.net/gh/shw2018/cdn@1.0/sakura/img/loader/orange.progress-bar-stripe-loader.svg" data-original="https://images.gitbook.cn/bd823030-d260-11e9-b943-9d5bb2abdc80" alt=""></p>
<p>可以看到，在两个 UserListComponent 实例中，使用的都是同一个 UserListService 实例。</p>
<p>这种全局单例模式很有用，你可以利用它来实现整个 App 范围内的数据共享。</p>
<p><strong>注意：在同步 NgModule 里面配置的 provider 在整个 App 范围内都是可见的，也就是说，即使你在某个子模块里面配置的 provider，它们依然是全局可见的，可以被注射到任意类里面。</strong></p>
<h3 id="37-2-多实例模式"><a href="#37-2-多实例模式" class="headerlink" title="37.2 多实例模式"></a>37.2 多实例模式</h3><p>有人会说，如果我想创建多个 UserListService 实例，怎么办？</p>
<p>我们把 UserListComponent 改成这样：</p>
<p><img src="https://cdn.jsdelivr.net/gh/shw2018/cdn@1.0/sakura/img/loader/orange.progress-bar-stripe-loader.svg" data-original="https://images.gitbook.cn/cfba57a0-d260-11e9-b943-9d5bb2abdc80" alt=""></p>
<p>然后在界面上放两个实例：</p>
<p><img src="https://cdn.jsdelivr.net/gh/shw2018/cdn@1.0/sakura/img/loader/orange.progress-bar-stripe-loader.svg" data-original="https://images.gitbook.cn/d69ae6c0-d260-11e9-bcae-b7c2737c8da6" alt=""></p>
<p>运行起来的效果是这样的：</p>
<p><img src="https://cdn.jsdelivr.net/gh/shw2018/cdn@1.0/sakura/img/loader/orange.progress-bar-stripe-loader.svg" data-original="https://images.gitbook.cn/de0b0bb0-d260-11e9-b943-9d5bb2abdc80" alt=""></p>
<p>可以看到，如果把 UserListService 配置在 UserListComponent 内部的 providers 中，就不再是单例模式了，每个 UserListComponent 都拥有自己独立的 UserListService 实例。</p>
<p>组件内部的 provider 生命周期与组件自身保持一致，当组件被销毁的时候，它内部的 provider 也会被销毁掉。</p>
<h3 id="37-3-异步模块上的注射器"><a href="#37-3-异步模块上的注射器" class="headerlink" title="37.3 异步模块上的注射器"></a>37.3 异步模块上的注射器</h3><p>以上都是同步模块，对于懒加载进来的异步模块，注射器是一种什么样的结构呢？</p>
<p>我们来做一个复杂一点的例子，默认展示首页：</p>
<p><img src="https://cdn.jsdelivr.net/gh/shw2018/cdn@1.0/sakura/img/loader/orange.progress-bar-stripe-loader.svg" data-original="https://images.gitbook.cn/ee57dde0-d260-11e9-bcae-b7c2737c8da6" alt=""></p>
<p>点击“用户列表”之后导航到 <a href="http://localhost:4200/userlist" target="_blank" rel="noopener">http://localhost:4200/userlist</a> 展示用户列表：</p>
<p><img src="https://cdn.jsdelivr.net/gh/shw2018/cdn@1.0/sakura/img/loader/orange.progress-bar-stripe-loader.svg" data-original="https://images.gitbook.cn/f5144330-d260-11e9-8d0f-6b56ebcd1907" alt=""></p>
<p>“用户列表”是一个异步模块，从 Chrome 的网络面板上可以看到这个模块是点击之后才加载进来的：</p>
<p><img src="https://cdn.jsdelivr.net/gh/shw2018/cdn@1.0/sakura/img/loader/orange.progress-bar-stripe-loader.svg" data-original="https://images.gitbook.cn/fcafe4f0-d260-11e9-bcae-b7c2737c8da6" alt=""></p>
<p>用 Augury 展示 UserListService 实例的依赖关系：</p>
<p><img src="https://cdn.jsdelivr.net/gh/shw2018/cdn@1.0/sakura/img/loader/orange.progress-bar-stripe-loader.svg" data-original="https://images.gitbook.cn/03b4c4f0-d261-11e9-b943-9d5bb2abdc80" alt=""></p>
<p><strong>注意：异步模块里面配置的 providers 只对本模块中的成员可见。如果你在其它模块里面引用异步模块里面配置的 provider，会产生异常。这里的本质原因是，Angular 会给异步加载的模块创建独立的注射器树。</strong></p>
<p>你可以自己尝试修改以上例子继续测试。</p>
<h3 id="37-4-小结"><a href="#37-4-小结" class="headerlink" title="37.4 小结"></a>37.4 小结</h3><p>来总结一下这个注入机制，它的运行规则是这样的：</p>
<ul>
<li>如果组件内部配置了 providers，优先使用组件上的配置来创建注入对象。</li>
<li>否则向父层组件继续查找，父组件上找不到继续向所属的模块查找。</li>
<li>一直到查询到根模块 AppModule 里面的 providers 配置。</li>
<li>如果没有找到指定的服务，抛异常。</li>
<li>同步模块里面配置的 providers 是全局可见的，即使是很深的子模块里面配置的 providers，依然是全局可见的。</li>
<li><strong>异步模块里面配置的 providers 只对本模块中的成员可见。这里的本质是，Angular 会给异步加载的模块创建独立的注射器树。</strong></li>
<li>组件里面配置的 providers 对组件自身和所有子层组件可见。</li>
<li>注射器的生命周期与组件自身保持一致，当组件被销毁的时候，对应的注射器实例也会被销毁。</li>
</ul>
<p>简而言之，Angular 的 Injector Tree 机制与 JavaScript 的原型查找类似。对于日常的开发来说，知道这些已经足够，可以覆盖 90% 以上的业务场景了。</p>
<p>但是，既然这是在说 DI，我们可以玩儿一些复杂的花样，请继续下一个小节。</p>
<h3 id="37-5-参考资源"><a href="#37-5-参考资源" class="headerlink" title="37.5 参考资源"></a>37.5 参考资源</h3><ul>
<li><a href="http://es6.ruanyifeng.com/#docs/decorator" target="_blank" rel="noopener">http://es6.ruanyifeng.com/#docs/decorator</a></li>
<li><a href="https://www.typescriptlang.org/docs/handbook/decorators.html" target="_blank" rel="noopener">https://www.typescriptlang.org/docs/handbook/decorators.html</a></li>
</ul>
<h2 id="38-Injectable-amp-Inject（2）"><a href="#38-Injectable-amp-Inject（2）" class="headerlink" title="38.@Injectable &amp; @Inject（2）"></a>38.@Injectable &amp; @Inject（2）</h2><h3 id="38-1-自动档-Injectable"><a href="#38-1-自动档-Injectable" class="headerlink" title="38.1 自动档 @Injectable"></a>38.1 自动档 @Injectable</h3><p>在上一小节里面，UserListService 服务直接返回了一个数组字面值。在真实的应用中，我们需要到服务端去加载数据。这就需要用到 Angular 提供的 HttpClient 服务了，这里我们需要把 HttpClient 服务注射到 UserListService 服务里面去，做法如下：</p>
<p><img src="https://cdn.jsdelivr.net/gh/shw2018/cdn@1.0/sakura/img/loader/orange.progress-bar-stripe-loader.svg" data-original="https://images.gitbook.cn/6a965ad0-d261-11e9-84ba-0bd4ba7d7fb3" alt=""></p>
<p>别忘记在 app.module 里面 import 一下 HttpClientModule：</p>
<p><img src="https://cdn.jsdelivr.net/gh/shw2018/cdn@1.0/sakura/img/loader/orange.progress-bar-stripe-loader.svg" data-original="https://images.gitbook.cn/5ad1f280-d261-11e9-84ba-0bd4ba7d7fb3" alt=""></p>
<p>我们注意到，在以上第一段代码里面，UserListService 顶部有一个 @Injectable 装饰器。那么 @Injectable 到底对 UserListService 做了什么猥琐的事情呢？</p>
<p>我们来看 ng build 之后生成的代码：</p>
<p><img src="https://cdn.jsdelivr.net/gh/shw2018/cdn@1.0/sakura/img/loader/orange.progress-bar-stripe-loader.svg" data-original="https://images.gitbook.cn/792688e0-d261-11e9-84ba-0bd4ba7d7fb3" alt=""></p>
<p>可以看到，编辑器生成了一些奇怪的东西，看起来像是保留了一些类型信息。</p>
<p>如果我们把 @Injectable 删掉会怎么样呢？来看最终编译出来的代码：</p>
<p><img src="https://cdn.jsdelivr.net/gh/shw2018/cdn@1.0/sakura/img/loader/orange.progress-bar-stripe-loader.svg" data-original="https://images.gitbook.cn/7f81e270-d261-11e9-8d0f-6b56ebcd1907" alt=""></p>
<p>可以看到，去掉 @Injectable 装饰器之后，生成出来的代码发生了很大的变化，而且运行会报错：</p>
<p><img src="https://cdn.jsdelivr.net/gh/shw2018/cdn@1.0/sakura/img/loader/orange.progress-bar-stripe-loader.svg" data-original="https://images.gitbook.cn/85907b90-d261-11e9-84ba-0bd4ba7d7fb3" alt=""></p>
<p>OK，我们大概可以猜到 @Injectable 装饰器的作用了：如果存在 @Injectable 装饰器，TS 编译器就会在最终生成的代码里面保留类型元数据（实际上是内核里面定义的 decorator 函数），然后 Angular 在运行时就可以根据这些信息来注射指定的对象。否则，运行时就无法解析参数类型了。</p>
<p><strong>简而言之：如果一个 Service 里面需要依赖其它 Service，需要使用 @Injectable 装饰器进行装饰。</strong></p>
<p><strong>为了不给自己找麻烦，最好所有 Service 都加上 @Injectable 装饰器，这是一种良好的编码风格。用 @angular/cli 生成的 Service 会自动在头部加上 @Injectable 装饰器，不需要你操心。</strong></p>
<h3 id="38-2-手动档-利用-Inject指定类型信息"><a href="#38-2-手动档-利用-Inject指定类型信息" class="headerlink" title="38.2 手动档:利用@Inject指定类型信息"></a>38.2 手动档:利用@Inject指定类型信息</h3><p>除了在 UserListService 顶部添加 @Injectable 装饰器之外，还有一种非常不常用的方法，利用 @Inject 装饰器手动指定类型信息，代码如下：</p>
<p><img src="https://cdn.jsdelivr.net/gh/shw2018/cdn@1.0/sakura/img/loader/orange.progress-bar-stripe-loader.svg" data-original="https://images.gitbook.cn/9d1ec190-d261-11e9-84ba-0bd4ba7d7fb3" alt=""></p>
<p>编译之后生成的代码如下：</p>
<p><img src="https://cdn.jsdelivr.net/gh/shw2018/cdn@1.0/sakura/img/loader/orange.progress-bar-stripe-loader.svg" data-original="https://images.gitbook.cn/a2ba9bb0-d261-11e9-8d0f-6b56ebcd1907" alt=""></p>
<p>可以看到，我们自己使用 @Inject 装饰器编译之后也生成了对应的类型元数据，并且运行起来也不会报错。</p>
<p><strong>仔细观察你就会发现，用 @Inject 和用 @Injectable 最终编译出来的代码是不一样的。用 @Inject 生成的代码多了很多东西，如果出现大量这种代码，最终编译出来的文件体积会变大。</strong></p>
<h3 id="38-3-Inject-的其它用法"><a href="#38-3-Inject-的其它用法" class="headerlink" title="38.3 @Inject 的其它用法"></a>38.3 @Inject 的其它用法</h3><p>在以上例子里面，我们注入的都是强类型的对象。</p>
<p>有人就会问了：如果我想注入弱类型的对象字面值可不可以呢？</p>
<p>当然可以，但是稍微麻烦一点。</p>
<p>比如你想把这样一个配置对象注入给 LiteralService 服务：</p>
<p><img src="https://cdn.jsdelivr.net/gh/shw2018/cdn@1.0/sakura/img/loader/orange.progress-bar-stripe-loader.svg" data-original="https://images.gitbook.cn/aec35b90-d261-11e9-84ba-0bd4ba7d7fb3" alt=""></p>
<p>app.module 里面是这样配置的：</p>
<p><img src="https://cdn.jsdelivr.net/gh/shw2018/cdn@1.0/sakura/img/loader/orange.progress-bar-stripe-loader.svg" data-original="https://images.gitbook.cn/b4b62f50-d261-11e9-b943-9d5bb2abdc80" alt=""></p>
<p>在 LiteralService 里面使用 @Inject 来注入：</p>
<p><img src="https://cdn.jsdelivr.net/gh/shw2018/cdn@1.0/sakura/img/loader/orange.progress-bar-stripe-loader.svg" data-original="https://images.gitbook.cn/bb249bb0-d261-11e9-bcae-b7c2737c8da6" alt=""></p>
<p>运行起来的结果：</p>
<p><img src="https://cdn.jsdelivr.net/gh/shw2018/cdn@1.0/sakura/img/loader/orange.progress-bar-stripe-loader.svg" data-original="https://images.gitbook.cn/c05d9550-d261-11e9-8d0f-6b56ebcd1907" alt=""></p>
<p><strong>特别注意：这种玩法非常罕见，除非你想自己实现一些特别猥琐的功能才用得到。比如上面这个例子，你可以直接利用 TypeScript 的 import 机制，直接把配置文件 import 进来完事。</strong></p>
<h3 id="38-4-总结"><a href="#38-4-总结" class="headerlink" title="38.4 总结"></a>38.4 总结</h3><p>简而言之，@Injectable 与 @Inject 之间的关系，就像自动档和手动档的区别。如果不是有奇怪的癖好，当然是自动档开起来舒服，老司机都懂的。</p>
<ul>
<li>我们可以自己手动用 @Inject 装饰器来让 TypeScript 编译器保留类型元数据，但是一般来说不需要这么干。（也就是说，@Inject 装饰器一般是用不到的，除非你想做一些猥琐的事情。）</li>
<li>保留类型元数据的另一个简便方法是使用 @Injectable 装饰器，@Injectable 并没有什么神奇的作用，它只是告诉 TS 编译器：请生成类型元数据。然后 Angular 在运行时就知道应该注射什么类型的对象了。</li>
<li>这是 TypeScript 强加的一个规则，如果不加 @Injectable 装饰器，TS 编译器会把参数类型元数据丢弃。</li>
<li><strong>对于 Angular 中的 Service 来说，最好都加上@Injectable 装饰器，这是一种良好的编码风格。</strong></li>
</ul>
<h2 id="39-Self-的用法"><a href="#39-Self-的用法" class="headerlink" title="39.@Self 的用法"></a>39.@Self 的用法</h2><h3 id="39-1-使用父层组件上的-UserListService-实例"><a href="#39-1-使用父层组件上的-UserListService-实例" class="headerlink" title="39.1 使用父层组件上的 UserListService 实例"></a>39.1 使用父层组件上的 UserListService 实例</h3><p>前面说到Injector 会构成树形结构，就像这样：</p>
<p><img src="https://cdn.jsdelivr.net/gh/shw2018/cdn@1.0/sakura/img/loader/orange.progress-bar-stripe-loader.svg" data-original="https://images.gitbook.cn/f6fd3200-d261-11e9-8d0f-6b56ebcd1907" alt=""></p>
<p>这就意味着，如果我们在父层组件里面定义了 UserListService，子层组件可以直接使用同一个实例。</p>
<p>继续前面的例子进行改造，给 UserListComponent 加一层子组件，组件名字就叫 ChildComponent，运行起来的界面效果是这样的：</p>
<p><img src="https://cdn.jsdelivr.net/gh/shw2018/cdn@1.0/sakura/img/loader/orange.progress-bar-stripe-loader.svg" data-original="https://images.gitbook.cn/031f1f30-d262-11e9-b943-9d5bb2abdc80" alt=""></p>
<p>ChildComponent 里面没有配置 providers，代码如下：</p>
<p><img src="https://cdn.jsdelivr.net/gh/shw2018/cdn@1.0/sakura/img/loader/orange.progress-bar-stripe-loader.svg" data-original="https://images.gitbook.cn/09ea0370-d262-11e9-84ba-0bd4ba7d7fb3" alt=""></p>
<p>父层的 UserListComponent 配置了 providers，代码如下：</p>
<p><img src="https://cdn.jsdelivr.net/gh/shw2018/cdn@1.0/sakura/img/loader/orange.progress-bar-stripe-loader.svg" data-original="https://images.gitbook.cn/11356250-d262-11e9-84ba-0bd4ba7d7fb3" alt=""></p>
<p>Augury 图形化展示出来的依赖关系是这样的：</p>
<p><img src="https://cdn.jsdelivr.net/gh/shw2018/cdn@1.0/sakura/img/loader/orange.progress-bar-stripe-loader.svg" data-original="https://images.gitbook.cn/172290c0-d262-11e9-bcae-b7c2737c8da6" alt=""></p>
<p>从运行效果可以看到：由于 ChildComponent 嵌套在 UserListComponent 内部，而且它自己没有配置 providers，所以它共享了父层的 UserListService 实例。</p>
<p>那么问题就来了，如果 ChildComponent 想要自己独立的 UserListService 实例，应该怎么做呢？</p>
<h3 id="39-2-Self-装饰器"><a href="#39-2-Self-装饰器" class="headerlink" title="39.2 @Self 装饰器"></a>39.2 @Self 装饰器</h3><p>我们可以利用 @Self 装饰器来提示注射器，不要向上查找，只在组件自身内部查找依赖。</p>
<p>我们给 ChildComponent 内部的 UserListService 声明加上@Self 装饰器：</p>
<p><img src="https://cdn.jsdelivr.net/gh/shw2018/cdn@1.0/sakura/img/loader/orange.progress-bar-stripe-loader.svg" data-original="https://images.gitbook.cn/22b647b0-d262-11e9-b943-9d5bb2abdc80" alt=""></p>
<p>然后当然就报错啦：</p>
<p><img src="https://cdn.jsdelivr.net/gh/shw2018/cdn@1.0/sakura/img/loader/orange.progress-bar-stripe-loader.svg" data-original="https://images.gitbook.cn/28f6ed50-d262-11e9-84ba-0bd4ba7d7fb3" alt=""></p>
<p>很好理解对吧，我们用 @Self 装饰器把查找依赖的范围限定在 ChildComponent 组件自身内部，但是 ChildComponent 自己并没有配置 UserListService，当然就找不到了。</p>
<p>所以，我们要在 ChildComponent 组件内部补上 providers 配置项：</p>
<p><img src="https://cdn.jsdelivr.net/gh/shw2018/cdn@1.0/sakura/img/loader/orange.progress-bar-stripe-loader.svg" data-original="https://images.gitbook.cn/32c107d0-d262-11e9-8d0f-6b56ebcd1907" alt=""></p>
<p>然后从运行结果可以看到，父层和子层已经是不同的 UserListService 实例了：</p>
<p><img src="https://cdn.jsdelivr.net/gh/shw2018/cdn@1.0/sakura/img/loader/orange.progress-bar-stripe-loader.svg" data-original="https://images.gitbook.cn/391890d0-d262-11e9-bcae-b7c2737c8da6" alt=""></p>
<p>Augury 图形化展示出来的依赖关系是这样的：</p>
<p><img src="https://cdn.jsdelivr.net/gh/shw2018/cdn@1.0/sakura/img/loader/orange.progress-bar-stripe-loader.svg" data-original="https://images.gitbook.cn/3ec3fb50-d262-11e9-84ba-0bd4ba7d7fb3" alt=""></p>
<p>顺便说一句：很多初学者遇到异常的时候不仔细看堆栈，碰到问题就在群里叫，然后被人鄙视。</p>
<p><strong>像这种“No provider for…”基本上都是因为缺了 providers 配置项导致的，老司机扫一眼就懂，并不需要 Debug，也不需要查文档，知道为什么别人打代码速度辣么快了吧？</strong></p>
<p><img src="https://cdn.jsdelivr.net/gh/shw2018/cdn@1.0/sakura/img/loader/orange.progress-bar-stripe-loader.svg" data-original="https://images.gitbook.cn/584c3c90-d262-11e9-8d0f-6b56ebcd1907" alt=""></p>
<h2 id="40-Optional-的用法"><a href="#40-Optional-的用法" class="headerlink" title="40.@Optional 的用法"></a>40.@Optional 的用法</h2><h3 id="40-1-Optional基本用法"><a href="#40-1-Optional基本用法" class="headerlink" title="40.1 @Optional基本用法"></a>40.1 @Optional基本用法</h3><p>我们在 ChildComponent 的构造函数里面加上 @Optional 装饰器进行装饰：</p>
<p><img src="https://cdn.jsdelivr.net/gh/shw2018/cdn@1.0/sakura/img/loader/orange.progress-bar-stripe-loader.svg" data-original="https://images.gitbook.cn/bd0218d0-d262-11e9-84ba-0bd4ba7d7fb3" alt=""></p>
<p>然后父组件 UserListComponent 里面清空，啥也没有：</p>
<p><img src="https://cdn.jsdelivr.net/gh/shw2018/cdn@1.0/sakura/img/loader/orange.progress-bar-stripe-loader.svg" data-original="https://images.gitbook.cn/c3449330-d262-11e9-bcae-b7c2737c8da6" alt=""></p>
<p>当然，NgModule 里面也不声明 UserListService。</p>
<p>注射器看到 @Optional 装饰器之后就知道这个服务是可选的，处理逻辑如下：</p>
<ul>
<li>沿着 Injector Tree 向上找一遍，如果找到了需要注入的类型，就创建实例。</li>
<li>如果啥都没找到，直接赋值为 null，<strong>不抛异常</strong>。</li>
</ul>
<h3 id="40-2-Self与-Optional组合使用"><a href="#40-2-Self与-Optional组合使用" class="headerlink" title="40.2 @Self与@Optional组合使用"></a>40.2 @Self与@Optional组合使用</h3><p><strong>注意：组合使用的方式在官方文档里面没有详细说明，请对照例子仔细理解一下。</strong></p>
<p>装饰器是可以组合使用的，所以 ChildComponent 的构造函数里面可以写成这样：</p>
<pre class="line-numbers language-typescript"><code class="language-typescript"><span class="token keyword">constructor</span><span class="token punctuation">(</span>
    @<span class="token function">Self</span><span class="token punctuation">(</span><span class="token punctuation">)</span> @<span class="token function">Optional</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">public</span> userListService<span class="token punctuation">:</span>UserListService
<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>这种用法的含义是：</p>
<ul>
<li>因为 @Self 装饰器限定了查找范围，所以只在 ChildComponent 自身内部进行查找。父层组件有没有定义对应的服务，不会产生任何影响。</li>
<li>因为有 @Optional 装饰器，所以如果 ChildComponent 自身内部提供了对应的服务，就创建实例，否则就直接赋值为 null，不抛异常。</li>
</ul>
<p>怎么样，挺清晰的对吧？</p>
<p>你还可以自己测试一下更复杂的玩法，组合使用 3 个以上的装饰器看看。</p>
<h2 id="41-SkipSelf的用法"><a href="#41-SkipSelf的用法" class="headerlink" title="41.@SkipSelf的用法"></a>41.@SkipSelf的用法</h2><h3 id="41-1-SkipSelf基本用法"><a href="#41-1-SkipSelf基本用法" class="headerlink" title="41.1 @SkipSelf基本用法"></a>41.1 @SkipSelf基本用法</h3><p>从名字可以猜出来它的含义：跳过组件自身，然后沿着 Injector Tree 向上查找。</p>
<p>继续在前面的例子上改造 ChildComponent，改成这样：</p>
<p><img src="https://cdn.jsdelivr.net/gh/shw2018/cdn@1.0/sakura/img/loader/orange.progress-bar-stripe-loader.svg" data-original="https://images.gitbook.cn/e60caee0-d7c9-11e9-9143-0bdf45914741" alt=""></p>
<p>父组件是这样的：</p>
<p><img src="https://cdn.jsdelivr.net/gh/shw2018/cdn@1.0/sakura/img/loader/orange.progress-bar-stripe-loader.svg" data-original="https://images.gitbook.cn/ec53e430-d7c9-11e9-8797-4924c0d7c082" alt=""></p>
<p>可以看到，我们在 ChildComponent 和它的父层组件 UserListComponent 上都配置了 UserListService。但是， ChildComponent 上有 @SkipSelf 装饰器，所以 ChildComponent 上的配置并没有起作用，使用的还是 UserListComponent 上的实例：</p>
<p><img src="https://cdn.jsdelivr.net/gh/shw2018/cdn@1.0/sakura/img/loader/orange.progress-bar-stripe-loader.svg" data-original="https://images.gitbook.cn/f67f3180-d7c9-11e9-8fae-816b29059b0c" alt=""></p>
<h3 id="41-2-SkipSelf与-Optional组合使用"><a href="#41-2-SkipSelf与-Optional组合使用" class="headerlink" title="41.2 @SkipSelf与@Optional组合使用"></a>41.2 @SkipSelf与@Optional组合使用</h3><p>同样，我们可以组合使用 @SkipSelf 与 @Optional：</p>
<pre class="line-numbers language-typescript"><code class="language-typescript">@<span class="token function">SkipSelf</span><span class="token punctuation">(</span><span class="token punctuation">)</span> @<span class="token function">Optional</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">public</span> userListService<span class="token punctuation">:</span> UserListService
<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>这样写的含义是：</p>
<ul>
<li>因为使用了 @SkipSelf 装饰器，所以直接跳过 ChildComponent 组件自身，从 Injector Tree 的父层节点向上进行查找。也就是说，不管 ChildComponent 组件自己有没有配置 UserListService 都不起作用，因为跳过去了。</li>
<li>因为使用了 @Optional 装饰器，如果在父层上面找到了指定的类型，那就创建实例；否则，直接设置为 null，不抛异常。</li>
</ul>
<h2 id="42-Host-的使用"><a href="#42-Host-的使用" class="headerlink" title="42.@Host 的使用"></a>42.@Host 的使用</h2><p>Host 这个单词有“宿主”的意思，就像病毒和 OS 之间的关系。</p>
<p>你可以意会一下 @Host 这个装饰器的特性。</p>
<h3 id="42-1-Host的基本用法"><a href="#42-1-Host的基本用法" class="headerlink" title="42.1 @Host的基本用法"></a>42.1 @Host的基本用法</h3><p>默认情况下，@Host 装饰器会指示注射器在组件自己内部去查找所依赖的类型，就像这样：</p>
<p><img src="https://cdn.jsdelivr.net/gh/shw2018/cdn@1.0/sakura/img/loader/orange.progress-bar-stripe-loader.svg" data-original="https://images.gitbook.cn/29ed6460-d7ca-11e9-9143-0bdf45914741" alt=""></p>
<p>如果 @Host 只有这一个特性的话，它就没什么存在的必要了，实际上它更核心的功能与所谓的 Content Projection（内容投影）机制有关。</p>
<h3 id="42-2-Content-Projection（内容投影）"><a href="#42-2-Content-Projection（内容投影）" class="headerlink" title="42.2 Content Projection（内容投影）"></a>42.2 Content Projection（内容投影）</h3><p>有时候，组件内部放什么内容并不固定，而是需要调用方在使用组件的时候去指定，这是 Content Projection 最核心的一个作用。</p>
<p>我们继续修改 ChildComponent 这个组件，在上面使用 @Host 装饰器，但是不配置 UserListService，就像这样：</p>
<p><img src="https://cdn.jsdelivr.net/gh/shw2018/cdn@1.0/sakura/img/loader/orange.progress-bar-stripe-loader.svg" data-original="https://images.gitbook.cn/354c28a0-d7ca-11e9-8fae-816b29059b0c" alt=""></p>
<p>父层组件 UserListComponent 的改动幅度比较大，首先我们还是给它配置了 UserListService，就像这样：</p>
<p><img src="https://cdn.jsdelivr.net/gh/shw2018/cdn@1.0/sakura/img/loader/orange.progress-bar-stripe-loader.svg" data-original="https://images.gitbook.cn/3d0b09d0-d7ca-11e9-8797-4924c0d7c082" alt=""></p>
<p>然后我们还修改了 UserListComponent 的 HTML 模板代码，这里跟前面的例子都不一样，我们不再把 <child> 写死在模板内部，而是在模板里面使用了一个 <ng-content> 标签。ng-content 的本质是一个占位符，这个占位符会被真正投影进来的内容替换掉。</ng-content></child></p>
<p>现在 UserListComponent 的模板代码如下：</p>
<p><img src="https://cdn.jsdelivr.net/gh/shw2018/cdn@1.0/sakura/img/loader/orange.progress-bar-stripe-loader.svg" data-original="https://images.gitbook.cn/4b477290-d7ca-11e9-8797-4924c0d7c082" alt=""></p>
<p>在 AppComponent 的 HTML 模板里面，使用 UserListComponent 的方式也发生了改变，<user-list> 标签的内部嵌套了一个子层标签，这在之前的例子里面是没有出现过的，就像这样：</user-list></p>
<p><img src="https://cdn.jsdelivr.net/gh/shw2018/cdn@1.0/sakura/img/loader/orange.progress-bar-stripe-loader.svg" data-original="https://images.gitbook.cn/5558a830-d7ca-11e9-9143-0bdf45914741" alt=""></p>
<p>运行起来的效果是这样的：</p>
<p><img src="https://cdn.jsdelivr.net/gh/shw2018/cdn@1.0/sakura/img/loader/orange.progress-bar-stripe-loader.svg" data-original="https://images.gitbook.cn/5befd240-d7ca-11e9-a536-c512dee3d564" alt=""></p>
<p>可以看到，投影进来的子组件和父层的宿主组件共用了同一个 UserListService 实例。</p>
<p>用 Augury 图形化展示出来是这样的：</p>
<p><img src="https://cdn.jsdelivr.net/gh/shw2018/cdn@1.0/sakura/img/loader/orange.progress-bar-stripe-loader.svg" data-original="https://images.gitbook.cn/63897830-d7ca-11e9-9143-0bdf45914741" alt=""></p>
<p>“内容投影”的优点在于：UserListComponent 的 HTML 模板没有和 ChildComponent 紧密耦合在一起，因为 ChildComponent 是被“投影”进来的，未来如果你觉得不爽，可以投影一个另外的组件实例进来（当然这里的代码还得小改一番才能实现）。于是，两个组件都变得比较灵活了，而不会出现谁也离不开谁的情况。</p>
<p>@Host 装饰器会提示注射器：要么在组件自己内部查找需要的依赖，要么到 Host（宿主）上去查找。</p>
<p>怎么样，能理解这里 Host 一词的意味了吧？</p>
<p><strong>简而言之：@Host 装饰器是用来在被投影的组件和它的宿主之间构建联系的。</strong></p>
<p>“内容投影”机制还有很多非常重要的作用，在 <a href="http://gitbook.cn/gitchat/column/59dae2081e6d652a5a9c3603" target="_blank" rel="noopener">《Angular 初学者快速上手指南》</a>里面有非常琐碎的描述，如果你还没有深入理解它，请移步过去阅读。</p>
<h3 id="42-3-Host-和-Optional-组合使用"><a href="#42-3-Host-和-Optional-组合使用" class="headerlink" title="42.3 @Host 和 @Optional 组合使用"></a>42.3 @Host 和 @Optional 组合使用</h3><p>如上所述，@Host 会尝试到宿主组件上去查找依赖，那么问题就来了，如果宿主上面并没有所需要的东西，怎么办呢？</p>
<p>借着上面的例子，我们把 UserListComponent 里面配置的 UserListService 注释掉：</p>
<p><img src="https://cdn.jsdelivr.net/gh/shw2018/cdn@1.0/sakura/img/loader/orange.progress-bar-stripe-loader.svg" data-original="https://images.gitbook.cn/8efbe7f0-d7ca-11e9-a536-c512dee3d564" alt=""></p>
<p>然后理所当然就报错了，因为现在宿主上并没有所需要对象：</p>
<p><img src="https://cdn.jsdelivr.net/gh/shw2018/cdn@1.0/sakura/img/loader/orange.progress-bar-stripe-loader.svg" data-original="https://images.gitbook.cn/95b714c0-d7ca-11e9-9143-0bdf45914741" alt=""></p>
<p>如果不想出现这种报错，而且你认为对于 ChildComponent 来说， UserListService 并不是在构造的时候就必须的，@Optional 装饰器就可以派上用场了：</p>
<pre class="line-numbers language-typescript"><code class="language-typescript">@<span class="token function">Host</span><span class="token punctuation">(</span><span class="token punctuation">)</span> @<span class="token function">Optional</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">public</span> userListService<span class="token punctuation">:</span> UserListService
<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h2 id="43-手动操作注射器实例"><a href="#43-手动操作注射器实例" class="headerlink" title="43.手动操作注射器实例"></a>43.手动操作注射器实例</h2><p><strong>官方文档特别强调：开发者可以手动操作 Injector 的实例，但是这种情况非常罕见。</strong></p>
<p>所以那部分文档隐藏了一些黑魔法，这里我们自己揭开盖子来玩儿。</p>
<h3 id="43-1-注入Injector实例"><a href="#43-1-注入Injector实例" class="headerlink" title="43.1 注入Injector实例"></a>43.1 注入Injector实例</h3><p>我们继续在前面的例子上改进，来尝试手动操作 Injector 的实例：</p>
<p><img src="https://cdn.jsdelivr.net/gh/shw2018/cdn@1.0/sakura/img/loader/orange.progress-bar-stripe-loader.svg" data-original="https://images.gitbook.cn/cdc041a0-d7cc-11e9-a536-c512dee3d564" alt=""></p>
<p>你可以自己用 Chrome 打开开发者工具看看 Injector 实例上面都有些什么属性：</p>
<p><img src="https://cdn.jsdelivr.net/gh/shw2018/cdn@1.0/sakura/img/loader/orange.progress-bar-stripe-loader.svg" data-original="https://images.gitbook.cn/df6aa800-d7cc-11e9-a536-c512dee3d564" alt=""></p>
<p><strong>很明显，Injector 本身也是一个服务。</strong></p>
<h3 id="43-2-手动创建注射器实例"><a href="#43-2-手动创建注射器实例" class="headerlink" title="43.2 手动创建注射器实例"></a>43.2 手动创建注射器实例</h3><p>在上面的例子里面，Injector 实例是 Angular 帮我们自动创建的。如果我们自己创建注射器，可不可以呢？</p>
<p>当然是 OK 的，Angular 内核默认提供了 3 种 Injector 的实现，：</p>
<p><img src="https://cdn.jsdelivr.net/gh/shw2018/cdn@1.0/sakura/img/loader/orange.progress-bar-stripe-loader.svg" data-original="https://images.gitbook.cn/f02704e0-d7cc-11e9-8fae-816b29059b0c" alt=""></p>
<ul>
<li>_NullInjector 是内部使用的私有类，外部无法引用。</li>
<li>StaticInjector 可以在外部使用，但是文档里面没有描述。</li>
<li>ReflectiveInjector，反射型注射器。如果你学过 Java 里面的反射机制，从 ReflectiveInjector 这个名字你可以猜测到它内部是怎么运行的。</li>
</ul>
<p>测试 Demo 的核心代码如下：</p>
<pre class="line-numbers language-typescript"><code class="language-typescript"><span class="token keyword">import</span> <span class="token punctuation">{</span> Component<span class="token punctuation">,</span> OnInit<span class="token punctuation">,</span> Injector<span class="token punctuation">,</span> ReflectiveInjector <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@angular/core'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> TestService <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./service/test.service'</span><span class="token punctuation">;</span>

<span class="token function">ngOnInit</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">//尝试自己手动创建 userListService 实例</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>userListService<span class="token operator">=</span><span class="token keyword">this</span><span class="token punctuation">.</span>injector<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span>UserListService<span class="token punctuation">)</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>userListService<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">this</span><span class="token punctuation">.</span>userListService<span class="token punctuation">.</span><span class="token function">getUserList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token punctuation">(</span>userList<span class="token punctuation">:</span><span class="token keyword">Array</span><span class="token operator">&lt;</span><span class="token keyword">any</span><span class="token operator">></span><span class="token punctuation">)</span><span class="token operator">=</span><span class="token operator">></span><span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>userList<span class="token operator">=</span>userList<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">//尝试自己创建注射器，然后利用注射器自己注射 TestService 服务实例</span>
    <span class="token keyword">let</span> myInjector <span class="token operator">=</span> ReflectiveInjector<span class="token punctuation">.</span><span class="token function">resolveAndCreate</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
        <span class="token punctuation">{</span> provide<span class="token punctuation">:</span> <span class="token string">"TestService"</span><span class="token punctuation">,</span> useClass<span class="token punctuation">:</span> TestService <span class="token punctuation">}</span>
    <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>myInjector<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">this</span><span class="token punctuation">.</span>testService <span class="token operator">=</span> myInjector<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">"TestService"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>testService<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>运行效果如下：</p>
<p><img src="https://cdn.jsdelivr.net/gh/shw2018/cdn@1.0/sakura/img/loader/orange.progress-bar-stripe-loader.svg" data-original="https://images.gitbook.cn/034c9990-d7cd-11e9-8fae-816b29059b0c" alt=""></p>
<p>尝试自己创建注射器，然后利用注射器自己创建了 TestService 服务实例。</p>
<p><strong>注意：从 Angular 5.x 开始，ReflectiveInjector 被标记成了过时的，官方建议使用静态方法 Injector.create。</strong></p>
<h2 id="44-综合案例OpenWMS介绍"><a href="#44-综合案例OpenWMS介绍" class="headerlink" title="44.综合案例OpenWMS介绍"></a>44.综合案例OpenWMS介绍</h2><p>通过前面的小节，我们已经熟悉了 Angular 的方方面面，最后，我们来一个综合的大例子。</p>
<p>OpenWMS 也是一个开源项目，同时提交在 GithuHb 和 Gitee 上：</p>
<ul>
<li><a href="https://github.com/damoqiongqiu/OpenWMS-Frontend" target="_blank" rel="noopener">https://github.com/damoqiongqiu/OpenWMS-Frontend</a></li>
<li><a href="https://gitee.com/mumu-osc/OpenWMS-Frontend" target="_blank" rel="noopener">https://gitee.com/mumu-osc/OpenWMS-Frontend</a></li>
</ul>
<p>这个项目的技术特性如下：</p>
<ul>
<li>Angular 核心包：7.0.0</li>
<li>组件库：PrimeNG 6.1.5</li>
<li>图表：ngx-echarts</li>
<li>国际化：ngx-translate</li>
<li>字体图标：font-awesome</li>
</ul>
<p>OpenWMS 为你提供了一个可以借鉴的项目模板，把真实业务开发过程中的模块都配置好了。</p>
<h3 id="44-1-模块分析"><a href="#44-1-模块分析" class="headerlink" title="44.1 模块分析"></a>44.1 模块分析</h3><p>以下是项目 build 出来的体积：</p>
<p><img src="https://cdn.jsdelivr.net/gh/shw2018/cdn@1.0/sakura/img/loader/orange.progress-bar-stripe-loader.svg" data-original="https://images.gitbook.cn/449fed70-d7cd-11e9-a536-c512dee3d564" alt=""></p>
<p>用 webpack-bundle-analyzer 分析之后可以看到各个模块在编译之后所占的体积：</p>
<p><img src="https://cdn.jsdelivr.net/gh/shw2018/cdn@1.0/sakura/img/loader/orange.progress-bar-stripe-loader.svg" data-original="https://images.gitbook.cn/4bd134a0-d7cd-11e9-8797-4924c0d7c082" alt=""></p>
<p>可以看到，主要是因为 ECharts 和 PrimeNG 占的体积比较大，建议您在使用的时候做一下异步，用不到的组件不要一股脑全部导入进来。</p>
<h3 id="44-2-效果截图"><a href="#44-2-效果截图" class="headerlink" title="44.2 效果截图"></a>44.2 效果截图</h3><p><img src="https://cdn.jsdelivr.net/gh/shw2018/cdn@1.0/sakura/img/loader/orange.progress-bar-stripe-loader.svg" data-original="https://images.gitbook.cn/54fb8cb0-d7cd-11e9-8797-4924c0d7c082" alt=""></p>
<p><img src="https://cdn.jsdelivr.net/gh/shw2018/cdn@1.0/sakura/img/loader/orange.progress-bar-stripe-loader.svg" data-original="https://images.gitbook.cn/5a8f7790-d7cd-11e9-8fae-816b29059b0c" alt=""></p>
<p><img src="https://cdn.jsdelivr.net/gh/shw2018/cdn@1.0/sakura/img/loader/orange.progress-bar-stripe-loader.svg" data-original="https://images.gitbook.cn/64978570-d7cd-11e9-a536-c512dee3d564" alt=""></p>
<h2 id="45-快速上手-PWA"><a href="#45-快速上手-PWA" class="headerlink" title="45.快速上手 PWA"></a>45.快速上手 PWA</h2><h3 id="45-1-PWA-是什么？"><a href="#45-1-PWA-是什么？" class="headerlink" title="45.1 PWA 是什么？"></a>45.1 PWA 是什么？</h3><p>PWA 是 Google 在 2015 年提出的一种全新的 Web 应用开发规范。</p>
<p>PWA 这个缩写是由 Google Chrome 团队的 Alex Russell 提出来的。</p>
<p>PWA 的全称是 Progressive Web Apps，翻译成中文是“渐进式WEB应用”。</p>
<p>PWA 不针对特定的语言，也不针对特定的框架，它本身只是一种规范，只要你的应用能满足 PWA 提出的规范，那么它就是一款 PWA 应用。</p>
<p>PWA 需要具备的关键特性有：</p>
<ul>
<li>应用无需安装，无需发布到应用市场</li>
<li>可以在主屏幕上创建图标</li>
<li>可以离线运行，利用后台线程与服务端通讯（由 ServiceWorker 特性来支持）</li>
<li>对搜索引擎友好</li>
<li>支持消息推送</li>
<li>支持响应式设计，支持各种类型的终端和屏幕</li>
<li>方便分享，用户可以方便地把应用内部的 URL 地址分享出去</li>
</ul>
<p>如果你想知道自己的应用是否是 PWA，官方提供了一份清单可供核对：</p>
<blockquote>
<p><a href="https://developers.google.com/web/progressive-web-apps/checklist" target="_blank" rel="noopener">https://developers.google.com/web/progressive-web-apps/checklist</a></p>
</blockquote>
<p>Google 官方对 PWA 的描述是这样的：</p>
<blockquote>
<p>Progressive Web Apps are just great web sites that can behave like native apps—or, perhaps, Progressive Web Apps are just great apps, powered by Web technologies and delivered with Web infrastructure.</p>
</blockquote>
<h3 id="45-2-三大厂商已经全部支持-PWA"><a href="#45-2-三大厂商已经全部支持-PWA" class="headerlink" title="45.2 三大厂商已经全部支持 PWA"></a>45.2 三大厂商已经全部支持 PWA</h3><p>目前，Apple、Microsoft、Google 已经全部支持 PWA 技术。</p>
<p>Google 的 Android 平台、Chrome 平台、Chrome Book 平台已经能全部支持 PWA：</p>
<p><img src="https://cdn.jsdelivr.net/gh/shw2018/cdn@1.0/sakura/img/loader/orange.progress-bar-stripe-loader.svg" data-original="https://images.gitbook.cn/261db620-dd59-11e9-9cc8-a572519b0723" alt=""></p>
<p><img src="https://cdn.jsdelivr.net/gh/shw2018/cdn@1.0/sakura/img/loader/orange.progress-bar-stripe-loader.svg" data-original="https://images.gitbook.cn/2ccd2320-dd59-11e9-a584-59c5758c1abc" alt=""></p>
<p>iOS 11.3 开始内置支持 PWA：</p>
<p><img src="https://cdn.jsdelivr.net/gh/shw2018/cdn@1.0/sakura/img/loader/orange.progress-bar-stripe-loader.svg" data-original="https://images.gitbook.cn/3454c7b0-dd59-11e9-a584-59c5758c1abc" alt=""></p>
<p>Windows 10 已经全面支持 PWA，目前 Windows 10 的应用商店里面已经有非常多的 PWA 应用了：</p>
<p><img src="https://cdn.jsdelivr.net/gh/shw2018/cdn@1.0/sakura/img/loader/orange.progress-bar-stripe-loader.svg" data-original="https://images.gitbook.cn/3c857d80-dd59-11e9-a584-59c5758c1abc" alt=""></p>
<p><img src="https://cdn.jsdelivr.net/gh/shw2018/cdn@1.0/sakura/img/loader/orange.progress-bar-stripe-loader.svg" data-original="https://images.gitbook.cn/43e798b0-dd59-11e9-a584-59c5758c1abc" alt=""></p>
<p>三大厂商齐心合力支持同一种技术规范是非常罕见的现象，从目前的情况看，PWA 将会成为一个比较大的热点。</p>
<blockquote>
<p>注意：国内外的互联网生态完全不同，国内移动互联网基本上被微信、今日头条所把持，目前微信小程序的影响力比 PWA 更大，微信小程序的数量已经超过 100 万个。另外，很多消息推送服务在国内用不了。</p>
</blockquote>
<h3 id="45-3-中国厂商的“快应用”与PWA的区别"><a href="#45-3-中国厂商的“快应用”与PWA的区别" class="headerlink" title="45.3 中国厂商的“快应用”与PWA的区别"></a>45.3 中国厂商的“快应用”与PWA的区别</h3><p><img src="https://cdn.jsdelivr.net/gh/shw2018/cdn@1.0/sakura/img/loader/orange.progress-bar-stripe-loader.svg" data-original="https://images.gitbook.cn/50645010-dd59-11e9-9cc8-a572519b0723" alt=""></p>
<p>2018 年 3 月 20 日，国内 10 大手机厂商共同参会，支持“快应用”标准，这些厂商包括：华为、中兴、小米、Oppo、Vivo、魅族、联想等。</p>
<p>从技术层面看，“快应用”与 ReactNative 类似，它和 PWA 完全不同。PWA 是完全的 Web 技术，借助于浏览器渲染，是“页面”。而“快应用”是类似于 RN 的“原生渲染”模式，JS 相关的代码运行在 JSCore 里面，然后通过 Bridge 驱动原生代码渲染 UI 界面，整体思路如下图：</p>
<p><img src="https://cdn.jsdelivr.net/gh/shw2018/cdn@1.0/sakura/img/loader/orange.progress-bar-stripe-loader.svg" data-original="https://images.gitbook.cn/6bd7bf80-dd59-11e9-a584-59c5758c1abc" alt=""></p>
<p>从目前的发展情况来看，小米 8 已经对“快应用”做了很好的支持。</p>
<h3 id="45-4-参考资源"><a href="#45-4-参考资源" class="headerlink" title="45.4 参考资源"></a>45.4 参考资源</h3><ul>
<li>2015 年 11 月，Alex Russell 关于 PWA 的<a href="https://medium.com/@slightlylate/progressive-apps-escaping-tabs-without-losing-our-soul-3b93a8561955" target="_blank" rel="noopener">原始文章</a></li>
<li>Google 官方提供的<a href="https://developers.google.com/web/progressive-web-apps/" target="_blank" rel="noopener">文档</a></li>
<li><a href="https://www.quickapp.cn/" target="_blank" rel="noopener">快应用官方网站</a></li>
</ul>
<script>
        document.querySelectorAll('.github-emoji')
          .forEach(el => {
            if (!el.dataset.src) { return; }
            const img = document.createElement('img');
            img.style = 'display:none !important;';
            img.src = el.dataset.src;
            img.addEventListener('error', () => {
              img.remove();
              el.style.color = 'inherit';
              el.style.backgroundImage = 'none';
              el.style.background = 'none';
            });
            img.addEventListener('load', () => {
              img.remove();
            });
            document.body.appendChild(img);
          });
      </script>
            </div>
            <hr/>

            

    <div class="reprint" id="reprint-statement">
        
            <div class="reprint__author">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-user">
                        文章作者:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="https://www.zhengchaoqiang.com" rel="external nofollow noreferrer">Chaoqiang</a>
                </span>
            </div>
            <div class="reprint__type">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-link">
                        文章链接:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="https://www.zhengchaoqiang.com/2020/03/12/angular-crash-tutorial/">https://www.zhengchaoqiang.com/2020/03/12/angular-crash-tutorial/</a>
                </span>
            </div>
            <div class="reprint__notice">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-copyright">
                        版权声明:
                    </i>
                </span>
                <span class="reprint-info">
                    本博客所有文章除特別声明外，均采用
                    <a href="https://creativecommons.org/licenses/by/4.0/deed.zh" rel="external nofollow noreferrer" target="_blank">CC BY 4.0</a>
                    许可协议。转载请注明来源
                    <a href="https://www.zhengchaoqiang.com" target="_blank">Chaoqiang</a>
                    !
                </span>
            </div>
        
    </div>

    <script async defer>
      document.addEventListener("copy", function (e) {
        let toastHTML = '<span>复制成功，请遵循本文的转载规则</span><button class="btn-flat toast-action" onclick="navToReprintStatement()" style="font-size: smaller">查看</a>';
        M.toast({html: toastHTML})
      });

      function navToReprintStatement() {
        $("html, body").animate({scrollTop: $("#reprint-statement").offset().top - 80}, 800);
      }
    </script>



            <div class="tag_share" style="display: block;">
                <div class="post-meta__tag-list" style="display: inline-block;">
                    
                        <div class="article-tag">
                            
                                <a href="/tags/Angular/">
                                    <span class="chip bg-color">Angular</span>
                                </a>
                            
                        </div>
                    
                </div>
                <div class="post_share" style="zoom: 80%; width: fit-content; display: inline-block; float: right; margin: -0.15rem 0;">
                    <link rel="stylesheet" type="text/css" href="/libs/share/css/share.min.css">

<div id="article-share">
    
    
    <div class="social-share" data-sites="twitter,facebook,google,qq,qzone,wechat,weibo,douban,linkedin" data-wechat-qrcode-helper="<p>微信扫一扫即可分享！</p>"></div>
    <script src="/libs/share/js/social-share.min.js"></script>
    

    

</div>

                </div>
            </div>
            
                <style>
    #reward {
        margin: 40px 0;
        text-align: center;
    }

    #reward .reward-link {
        font-size: 1.4rem;
        line-height: 38px;
    }

    #reward .btn-floating:hover {
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.2), 0 5px 15px rgba(0, 0, 0, 0.2);
    }

    #rewardModal {
        width: 320px;
        height: 350px;
    }

    #rewardModal .reward-title {
        margin: 15px auto;
        padding-bottom: 5px;
    }

    #rewardModal .modal-content {
        padding: 10px;
    }

    #rewardModal .close {
        position: absolute;
        right: 15px;
        top: 15px;
        color: rgba(0, 0, 0, 0.5);
        font-size: 1.3rem;
        line-height: 20px;
        cursor: pointer;
    }

    #rewardModal .close:hover {
        color: #ef5350;
        transform: scale(1.3);
        -moz-transform:scale(1.3);
        -webkit-transform:scale(1.3);
        -o-transform:scale(1.3);
    }

    #rewardModal .reward-tabs {
        margin: 0 auto;
        width: 210px;
    }

    .reward-tabs .tabs {
        height: 38px;
        margin: 10px auto;
        padding-left: 0;
    }

    .reward-content ul {
        padding-left: 0 !important;
    }

    .reward-tabs .tabs .tab {
        height: 38px;
        line-height: 38px;
    }

    .reward-tabs .tab a {
        color: #fff;
        background-color: #ccc;
    }

    .reward-tabs .tab a:hover {
        background-color: #ccc;
        color: #fff;
    }

    .reward-tabs .wechat-tab .active {
        color: #fff !important;
        background-color: #22AB38 !important;
    }

    .reward-tabs .alipay-tab .active {
        color: #fff !important;
        background-color: #019FE8 !important;
    }

    .reward-tabs .reward-img {
        width: 210px;
        height: 210px;
    }
</style>

<div id="reward">
    <a href="#rewardModal" class="reward-link modal-trigger btn-floating btn-medium waves-effect waves-light red">赏</a>

    <!-- Modal Structure -->
    <div id="rewardModal" class="modal">
        <div class="modal-content">
            <a class="close modal-close"><i class="fas fa-times"></i></a>
            <h4 class="reward-title">你要请我吃糖嘛!</h4>
            <div class="reward-content">
                <div class="reward-tabs">
                    <ul class="tabs row">
                        <li class="tab col s6 alipay-tab waves-effect waves-light"><a href="#alipay">支付宝</a></li>
                        <li class="tab col s6 wechat-tab waves-effect waves-light"><a href="#wechat">微 信</a></li>
                    </ul>
                    <div id="alipay">
                        <img src="" class="reward-img" alt="支付宝打赏二维码">
                    </div>
                    <div id="wechat">
                        <img src="/medias/reward/wechatpay.png" class="reward-img" alt="微信打赏二维码">
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    $(function () {
        $('.tabs').tabs();
    });
</script>
            
        </div>
    </div>

    

    

    

    

    
        <style>
    .valine-card {
        margin: 1.5rem auto;
    }

    .valine-card .card-content {
        padding: 20px 20px 5px 20px;
    }

    #vcomments textarea {
        box-sizing: border-box;
        background: url("/medias/comment_bg.png") 100% 100% no-repeat;
    }

    #vcomments p {
        margin: 2px 2px 10px;
        font-size: 1.05rem;
        line-height: 1.78rem;
    }

    #vcomments blockquote p {
        text-indent: 0.2rem;
    }

    #vcomments a {
        padding: 0 2px;
        color: #4cbf30;
        font-weight: 500;
        text-decoration: none;
    }

    #vcomments img {
        max-width: 100%;
        height: auto;
        cursor: pointer;
    }

    #vcomments ol li {
        list-style-type: decimal;
    }

    #vcomments ol,
    ul {
        display: block;
        padding-left: 2em;
        word-spacing: 0.05rem;
    }

    #vcomments ul li,
    ol li {
        display: list-item;
        line-height: 1.8rem;
        font-size: 1rem;
    }

    #vcomments ul li {
        list-style-type: disc;
    }

    #vcomments ul ul li {
        list-style-type: circle;
    }

    #vcomments table, th, td {
        padding: 12px 13px;
        border: 1px solid #dfe2e5;
    }

    #vcomments table, th, td {
        border: 0;
    }

    table tr:nth-child(2n), thead {
        background-color: #fafafa;
    }

    #vcomments table th {
        background-color: #f2f2f2;
        min-width: 80px;
    }

    #vcomments table td {
        min-width: 80px;
    }

    #vcomments h1 {
        font-size: 1.85rem;
        font-weight: bold;
        line-height: 2.2rem;
    }

    #vcomments h2 {
        font-size: 1.65rem;
        font-weight: bold;
        line-height: 1.9rem;
    }

    #vcomments h3 {
        font-size: 1.45rem;
        font-weight: bold;
        line-height: 1.7rem;
    }

    #vcomments h4 {
        font-size: 1.25rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    #vcomments h5 {
        font-size: 1.1rem;
        font-weight: bold;
        line-height: 1.4rem;
    }

    #vcomments h6 {
        font-size: 1rem;
        line-height: 1.3rem;
    }

    #vcomments p {
        font-size: 1rem;
        line-height: 1.5rem;
    }

    #vcomments hr {
        margin: 12px 0;
        border: 0;
        border-top: 1px solid #ccc;
    }

    #vcomments blockquote {
        margin: 15px 0;
        border-left: 5px solid #42b983;
        padding: 1rem 0.8rem 0.3rem 0.8rem;
        color: #666;
        background-color: rgba(66, 185, 131, .1);
    }

    #vcomments pre {
        font-family: monospace, monospace;
        padding: 1.2em;
        margin: .5em 0;
        background: #272822;
        overflow: auto;
        border-radius: 0.3em;
        tab-size: 4;
    }

    #vcomments code {
        font-family: monospace, monospace;
        padding: 1px 3px;
        font-size: 0.92rem;
        color: #e96900;
        background-color: #f8f8f8;
        border-radius: 2px;
    }

    #vcomments pre code {
        font-family: monospace, monospace;
        padding: 0;
        color: #e8eaf6;
        background-color: #272822;
    }

    #vcomments pre[class*="language-"] {
        padding: 1.2em;
        margin: .5em 0;
    }

    #vcomments code[class*="language-"],
    pre[class*="language-"] {
        color: #e8eaf6;
    }

    #vcomments [type="checkbox"]:not(:checked), [type="checkbox"]:checked {
        position: inherit;
        margin-left: -1.3rem;
        margin-right: 0.4rem;
        margin-top: -1px;
        vertical-align: middle;
        left: unset;
        visibility: visible;
    }

    #vcomments b,
    strong {
        font-weight: bold;
    }

    #vcomments dfn {
        font-style: italic;
    }

    #vcomments small {
        font-size: 85%;
    }

    #vcomments cite {
        font-style: normal;
    }

    #vcomments mark {
        background-color: #fcf8e3;
        padding: .2em;
    }

    #vcomments table, th, td {
        padding: 12px 13px;
        border: 1px solid #dfe2e5;
    }

    table tr:nth-child(2n), thead {
        background-color: #fafafa;
    }

    #vcomments table th {
        background-color: #f2f2f2;
        min-width: 80px;
    }

    #vcomments table td {
        min-width: 80px;
    }

    #vcomments [type="checkbox"]:not(:checked), [type="checkbox"]:checked {
        position: inherit;
        margin-left: -1.3rem;
        margin-right: 0.4rem;
        margin-top: -1px;
        vertical-align: middle;
        left: unset;
        visibility: visible;
    }
</style>

<div class="card valine-card" data-aos="fade-up">
    <div class="comment_headling" style="font-size: 20px; font-weight: 700; position: relative; left: 20px; top: 15px; padding-bottom: 5px;">
        <i class="fas fa-comments fa-fw" aria-hidden="true"></i>
        <span>评论</span>
    </div>
    <div id="vcomments" class="card-content" style="display: grid">
    </div>
</div>

<script src="/libs/valine/av-min.js"></script>
<script src="/libs/valine/Valine.min.js"></script>
<script>
    new Valine({
        el: '#vcomments',
        appId: 'n7QWLgVufdyFqbDlUDEznVhx-gzGzoHsz',
        appKey: 'YGPdAIijkOPzqgi0LlHI52ex',
        notify: 'true' === 'true',
        verify: 'true' === 'true',
        visitor: 'true' === 'true',
        avatar: 'mm',
        pageSize: '10',
        lang: 'zh-cn',
        placeholder: 'just go go'
    });
</script>

    

    

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge left-badge text-color">
                <i class="fas fa-chevron-left"></i>&nbsp;上一篇</div>
            <div class="card">
                <a href="/2020/03/14/typescript-learning-series-09/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/21.jpg" class="responsive-img" alt="TypeScript Basic Tutorial (9)">
                        
                        <span class="card-title">TypeScript Basic Tutorial (9)</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            模块模块的的概念（官方）:

关于术语的一点说明: 请务必注意一点，TypeScript 1.5里术语名已经发生了变化。 “内部模块”现在称做“命名空间”。
“外部模块”现在则简称为“模块” 模块在其自身的作用域里执行，而不是在全局作用域里
                        
                    </div>
                    <div class="publish-info">
                        <span class="publish-date">
                            <i class="far fa-clock fa-fw icon-date"></i>2020-03-14
                        </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/TypeScript-Basic-Tutorial/" class="post-category">
                                    TypeScript Basic Tutorial
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/TypeScript/">
                        <span class="chip bg-color">TypeScript</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge right-badge text-color">
                下一篇&nbsp;<i class="fas fa-chevron-right"></i>
            </div>
            <div class="card">
                <a href="/2020/03/07/dotnet-advanced-series-5-1-netcore31start/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/0.jpg" class="responsive-img" alt="DotNet-Advanced-Series-5-1-NetCore31Start">
                        
                        <span class="card-title">DotNet-Advanced-Series-5-1-NetCore31Start</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            介绍基本的Net Core跨平台知识 搭建一个小的Net Core项目 入门Net Core
                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="far fa-clock fa-fw icon-date"></i>2020-03-07
                            </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/Net-Core-Learning-Series/" class="post-category">
                                    .Net Core Learning Series
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/Net-Core/">
                        <span class="chip bg-color">Net Core</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
    </div>
</article>

</div>


<script>
    $('#articleContent').on('copy', function (e) {
        // IE8 or earlier browser is 'undefined'
        if (typeof window.getSelection === 'undefined') return;

        var selection = window.getSelection();
        // if the selection is short let's not annoy our users.
        if (('' + selection).length < Number.parseInt('120')) {
            return;
        }

        // create a div outside of the visible area and fill it with the selected text.
        var bodyElement = document.getElementsByTagName('body')[0];
        var newdiv = document.createElement('div');
        newdiv.style.position = 'absolute';
        newdiv.style.left = '-99999px';
        bodyElement.appendChild(newdiv);
        newdiv.appendChild(selection.getRangeAt(0).cloneContents());

        // we need a <pre> tag workaround.
        // otherwise the text inside "pre" loses all the line breaks!
        if (selection.getRangeAt(0).commonAncestorContainer.nodeName === 'PRE') {
            newdiv.innerHTML = "<pre>" + newdiv.innerHTML + "</pre>";
        }

        var url = document.location.href;
        newdiv.innerHTML += '<br />'
            + '来源: chaoqiang&#39;s Blog<br />'
            + '文章作者: chaoqiang<br />'
            + '文章链接: <a href="' + url + '">' + url + '</a><br />'
            + '本文章著作权归作者所有，任何形式的转载都请注明出处。';

        selection.selectAllChildren(newdiv);
        window.setTimeout(function () {bodyElement.removeChild(newdiv);}, 200);
    });
</script>


<!-- 代码块功能依赖 -->
<script type="text/javascript" src="/libs/codeBlock/codeBlockFuction.js"></script>

<!-- 代码语言 -->

<script type="text/javascript" src="/libs/codeBlock/codeLang.js"></script>


<!-- 代码块复制 -->

<script type="text/javascript" src="/libs/codeBlock/codeCopy.js"></script>


<!-- 代码块收缩 -->

<script type="text/javascript" src="/libs/codeBlock/codeShrink.js"></script>


<!-- 代码块折行 -->

<style type="text/css">
code[class*="language-"], pre[class*="language-"] { white-space: pre !important; }
</style>


    </div>
    <div id="toc-aside" class="expanded col l3 hide-on-med-and-down">
        <div class="toc-widget">
            <div class="toc-title"><i class="far fa-list-alt"></i>&nbsp;&nbsp;目录</div>
            <div id="toc-content"></div>
        </div>
    </div>
</div>

<!-- TOC 悬浮按钮. -->

<div id="floating-toc-btn" class="hide-on-med-and-down">
    <a class="btn-floating btn-large bg-color">
        <i class="fas fa-list-ul"></i>
    </a>
</div>


<script src="/libs/tocbot/tocbot.min.js"></script>
<script>
    $(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            collapseDepth: Number('0'),
            headingSelector: 'h2, h3, h4'
        });

        // modify the toc link href to support Chinese.
        let i = 0;
        let tocHeading = 'toc-heading-';
        $('#toc-content a').each(function () {
            $(this).attr('href', '#' + tocHeading + (++i));
        });

        // modify the heading title id to support Chinese.
        i = 0;
        $('#articleContent').children('h2, h3, h4').each(function () {
            $(this).attr('id', tocHeading + (++i));
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });

        
        /* 修复文章卡片 div 的宽度. */
        let fixPostCardWidth = function (srcId, targetId) {
            let srcDiv = $('#' + srcId);
            if (srcDiv.length === 0) {
                return;
            }

            let w = srcDiv.width();
            if (w >= 450) {
                w = w + 21;
            } else if (w >= 350 && w < 450) {
                w = w + 18;
            } else if (w >= 300 && w < 350) {
                w = w + 16;
            } else {
                w = w + 14;
            }
            $('#' + targetId).width(w);
        };

        // 切换TOC目录展开收缩的相关操作.
        const expandedClass = 'expanded';
        let $tocAside = $('#toc-aside');
        let $mainContent = $('#main-content');
        $('#floating-toc-btn .btn-floating').click(function () {
            if ($tocAside.hasClass(expandedClass)) {
                $tocAside.removeClass(expandedClass).hide();
                $mainContent.removeClass('l9');
            } else {
                $tocAside.addClass(expandedClass).show();
                $mainContent.addClass('l9');
            }
            fixPostCardWidth('artDetail', 'prenext-posts');
        });
        
    });
</script>

    

</main>



    <footer class="page-footer bg-color">
    <div class="container row center-align">
        <div class="col s12 m8 l8 copy-right">
            <span>
                <div>
                    <span style="color:#ffffff;">Copyright&copy; 2020 chaoqiang. All Rights Reserved</span>
                </div>
                
                <div style="width:500px;margin:0 auto; padding:0px 0;">
                    <a target="_blank" href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=32050702010849" style="display:inline-block;text-decoration:none;height:20px;line-height:20px;">
                        <img src="https://blog-icp-1257411902.cos.ap-shanghai.myqcloud.com/icp.png" style="float:left;"/>
                        <span style="float:left;height:20px;line-height:20px;margin: 0px 0px 0px 5px; color:#ffffff;">苏公网安备 32050702010849号 苏ICP备20017637号</span>
                    </a>
                    <!-- <span style="height:20px;line-height:20px;margin: 0px 0px 0px 5px; color:#ffffff;"> 苏ICP备20017637号</span> -->
                </div>
            </span>
            <span id="sitetime"></span>
        </div>

    
    </div>
</footer>

<div class="progress-bar"></div>

<script language=javascript>
    function siteTime() {
        window.setTimeout("siteTime()", 1000);
        var seconds = 1000;
        var minutes = seconds * 60;
        var hours = minutes * 60;
        var days = hours * 24;
        var years = days * 365;
        var today = new Date();
        var todayYear = today.getFullYear();
        var todayMonth = today.getMonth() + 1;
        var todayDate = today.getDate();
        var todayHour = today.getHours();
        var todayMinute = today.getMinutes();
        var todaySecond = today.getSeconds();

        /* Date.UTC() -- 返回date对象距世界标准时间(UTC)1970年1月1日午夜之间的毫秒数(时间戳)
        year - 作为date对象的年份，为4位年份值
        month - 0-11之间的整数，做为date对象的月份
        day - 1-31之间的整数，做为date对象的天数
        hours - 0(午夜24点)-23之间的整数，做为date对象的小时数
        minutes - 0-59之间的整数，做为date对象的分钟数
        seconds - 0-59之间的整数，做为date对象的秒数
        microseconds - 0-999之间的整数，做为date对象的毫秒数 */

        var t1 = Date.UTC(2019, 08, 10, 00, 00, 00); //北京时间2019-8-1 00:00:00
        var t2 = Date.UTC(todayYear, todayMonth, todayDate, todayHour, todayMinute, todaySecond);
        var diff = t2 - t1;
        var diffYears = Math.floor(diff / years);
        var diffDays = Math.floor((diff / days) - diffYears * 365);
        var diffHours = Math.floor((diff - (diffYears * 365 + diffDays) * days) / hours);
        var diffMinutes = Math.floor((diff - (diffYears * 365 + diffDays) * days - diffHours * hours) / minutes);
        var diffSeconds = Math.floor((diff - (diffYears * 365 + diffDays) * days - diffHours * hours - diffMinutes *
            minutes) / seconds);
        document.getElementById("sitetime").innerHTML = "本站已勉强运行 " + diffYears + " 年 " + diffDays + " 天 " + diffHours +
            " 小时 " + diffMinutes + " 分钟 " + diffSeconds + " 秒" ;
    } /*因为建站时间还没有一年，就将之注释掉了。需要的可以取消*/
    siteTime();
</script>






    <!-- 搜索遮罩框 -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fas fa-search"></i>&nbsp;&nbsp;搜索</span>
            <input type="search" id="searchInput" name="s" placeholder="请输入搜索的关键字"
                   class="search-input">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script src="/js/search.js"></script>
<script type="text/javascript">
$(function () {
    searchFunc("/" + "search.xml", 'searchInput', 'searchResult');
});
</script>
    <!-- 回到顶部按钮 -->
<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fas fa-arrow-up"></i>
    </a>
</div>


    <script src="/libs/materialize/materialize.min.js"></script>
    <script src="/libs/masonry/masonry.pkgd.min.js"></script>
    <script src="/libs/aos/aos.js"></script>
    <script src="/libs/scrollprogress/scrollProgress.min.js"></script>
    <script src="/libs/lightGallery/js/lightgallery-all.min.js"></script>
    <script src="/js/matery.js"></script>

    <!-- Global site tag (gtag.js) - Google Analytics -->


    <!-- Baidu Analytics -->

    <!-- Baidu Push -->

<script>
    (function () {
        var bp = document.createElement('script');
        var curProtocol = window.location.protocol.split(':')[0];
        if (curProtocol === 'https') {
            bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
        } else {
            bp.src = 'http://push.zhanzhang.baidu.com/push.js';
        }
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(bp, s);
    })();
</script>

    
    <script src="/libs/others/clicklove.js" async="async"></script>
    
    
    <script async src="/libs/others/busuanzi.pure.mini.js"></script>
    

    

    

    
    <script type="text/javascript" color="0,0,255"
        pointColor="0,0,255" opacity='0.7'
        zIndex="-1" count="99"
        src="/libs/background/canvas-nest.js"></script>
    

    

    
    
    
    <script src="/libs/instantpage/instantpage.js" type="module"></script>
    

     <!-- Chaoqiang shw2018 add 2019.08.28 -->
     <script type="text/javascript">
        var OriginTitile = document.title,
            st;
        document.addEventListener("visibilitychange", function () {
            document.hidden ? (document.title = "看不见我🙈~看不见我🙈~", clearTimeout(st)) : (document.title =
                "(๑•̀ㅂ•́) ✧被发现了～", st = setTimeout(function () {
                    document.title = OriginTitile
                }, 3e3))
        })
    </script>

    <!-- 鼠标点击烟花爆炸效果  Chaoqiang shw2018 add 2019.09.09 -->
    
        <canvas class="fireworks" style="position: fixed; left: 0; top: 0; z-index: 1; pointer-events: none;"></canvas>
        <script type="text/javascript" src="//cdn.bootcss.com/animejs/2.2.0/anime.min.js"></script>
        <script type="text/javascript" src="/js/fireworks.js"></script>
    

    <!-- 背景雪花飘落特效Chaoqiang shw2018 add 2019.09.10 -->
    

    <!-- 鼠标点击文字特效 Chaoqiang shw2018 add 2019.09.10-->
    
        <script src="/js/wenzi.js" type="text/javascript"></script>
    

    <!-- 背景雪花飘落特效 Chaoqiang shw2018 add 2019.09.10 -->
    

    <!-- 在线聊天工具  Chaoqiang shw2018 add 2019.09.11 -->
    

<script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"log":false,"model":{"jsonPath":"/live2dw/assets/wanko.model.json"},"display":{"position":"left","width":150,"height":200},"mobile":{"show":false},"react":{"opacity":0.7}});</script><script>
            window.imageLazyLoadSetting = {
                isSPA: false,
                preloadRatio: 1,
                processImages: null,
            };
        </script><script>window.addEventListener("load",function(){var t=/\.(gif|jpg|jpeg|tiff|png)$/i,r=/^data:image\/[a-z]+;base64,/;Array.prototype.slice.call(document.querySelectorAll("img[data-original]")).forEach(function(a){var e=a.parentNode;"A"===e.tagName&&(e.href.match(t)||e.href.match(r))&&(e.href=a.dataset.original)})});</script><script>!function(n){n.imageLazyLoadSetting.processImages=o;var e=n.imageLazyLoadSetting.isSPA,i=n.imageLazyLoadSetting.preloadRatio||1,r=Array.prototype.slice.call(document.querySelectorAll("img[data-original]"));function o(){e&&(r=Array.prototype.slice.call(document.querySelectorAll("img[data-original]")));for(var t,a=0;a<r.length;a++)0<=(t=(t=r[a]).getBoundingClientRect()).bottom&&0<=t.left&&t.top<=(n.innerHeight*i||document.documentElement.clientHeight*i)&&function(){var t,e,n,i,o=r[a];t=o,e=function(){r=r.filter(function(t){return o!==t})},n=new Image,i=t.getAttribute("data-original"),n.onload=function(){t.src=i,e&&e()},t.src!==i&&(n.src=i)}()}o(),n.addEventListener("scroll",function(){var t,e;t=o,e=n,clearTimeout(t.tId),t.tId=setTimeout(function(){t.call(e)},500)})}(this);</script></body>

</html>
