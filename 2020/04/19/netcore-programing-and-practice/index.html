<!DOCTYPE HTML>
<html lang="zh-CN">


<head><meta name="generator" content="Hexo 3.9.0">
    <meta charset="utf-8">
    <meta name="keywords" content="NetCore 开发实战（1）——必备知识, Bosch SEU chaoqiang Mechanics Eletronics 超强 micro-service Intelligent-Manufacturing MES">
    <meta name="description" content="01 | 简介为什么要学习 .NET Core
微软大力支持推动 .Net 技术生态发展
跨平台：更多的开发环境和部署环境选择，尤其是对 Docker 和 Kubernetes 的良好支持，快速构建微服务并部署到云基础设施中，实现高可用，可">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>NetCore 开发实战（1）——必备知识 | chaoqiang&#39;s Blog</title>
    <link rel="icon" type="image/png" href="/favicon.png">

    <link rel="stylesheet" type="text/css" href="/libs/awesome/css/all.css">
    <link rel="stylesheet" type="text/css" href="/libs/materialize/materialize.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/aos/aos.css">
    <link rel="stylesheet" type="text/css" href="/libs/animate/animate.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/lightGallery/css/lightgallery.min.css">
    <link rel="stylesheet" type="text/css" href="/css/matery.css">
    <link rel="stylesheet" type="text/css" href="/css/my.css">
    
    <script src="/libs/jquery/jquery.min.js"></script>
    
<link rel="stylesheet" href="/css/prism-tomorrow.css" type="text/css">
<link rel="stylesheet" href="/css/prism-line-numbers.css" type="text/css"></head>


<body>
    <header class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="nav-wrapper head-container">
            <div class="brand-logo">
                <a href="/" class="waves-effect waves-light">
                    
                    <span class="logo-span">chaoqiang's Blog</span>
                </a>
            </div>
            

<a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fas fa-bars"></i></a>
<ul class="right nav-menu">
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/" class="waves-effect waves-light">
      
      <i class="fas fa-home" style="zoom: 0.6;"></i>
      
      <span>首页</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/tags" class="waves-effect waves-light">
      
      <i class="fas fa-tags" style="zoom: 0.6;"></i>
      
      <span>标签</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/categories" class="waves-effect waves-light">
      
      <i class="fas fa-bookmark" style="zoom: 0.6;"></i>
      
      <span>分类</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/archives" class="waves-effect waves-light">
      
      <i class="fas fa-archive" style="zoom: 0.6;"></i>
      
      <span>归档</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/about" class="waves-effect waves-light">
      
      <i class="fas fa-user-circle" style="zoom: 0.6;"></i>
      
      <span>关于</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/contact" class="waves-effect waves-light">
      
      <i class="fas fa-comments" style="zoom: 0.6;"></i>
      
      <span>留言板</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/friends" class="waves-effect waves-light">
      
      <i class="fas fa-address-book" style="zoom: 0.6;"></i>
      
      <span>友情链接</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/AV" class="waves-effect waves-light">

      
      <i class="fas fa-list" style="zoom: 0.6;"></i>
      
      <span>Medias</span>
      <i class="fas fa-chevron-down" aria-hidden="true" style="zoom: 0.6;"></i>
    </a>
    <ul class="sub-nav menus_item_child ">
      
      <li>
        <a href="/Music">
          
          <i class="fas fa-music" style="margin-top: -20px; zoom: 0.6;"></i>
          
          <span>Musics</span>
        </a>
      </li>
      
      <li>
        <a href="/Movie">
          
          <i class="fas fa-film" style="margin-top: -20px; zoom: 0.6;"></i>
          
          <span>Movies</span>
        </a>
      </li>
      
      <li>
        <a href="/Book">
          
          <i class="fas fa-book" style="margin-top: -20px; zoom: 0.6;"></i>
          
          <span>Books</span>
        </a>
      </li>
      
      <li>
        <a href="/AV">
          
          <i class="fas fa-image" style="margin-top: -20px; zoom: 0.6;"></i>
          
          <span>Galleries</span>
        </a>
      </li>
      
    </ul>
    
  </li>
  
  <li>
    <a href="#searchModal" class="modal-trigger waves-effect waves-light">
      <i id="searchIcon" class="fas fa-search" title="搜索" style="zoom: 0.85;"></i>
    </a>
  </li>
</ul>

<div id="mobile-nav" class="side-nav sidenav">

    <div class="mobile-head bg-color">
        
        <div class="logo-name">chaoqiang's Blog</div>
        <div class="logo-desc">
            
            博世互联工业 | 智能制造 | 微服务架构 | 东南大学 | 机械电子工程
            
        </div>
    </div>

    

    <ul class="menu-list mobile-menu-list">
        
        <li class="m-nav-item">
	  
		<a href="/" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-home"></i>
			
			首页
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/tags" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-tags"></i>
			
			标签
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/categories" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-bookmark"></i>
			
			分类
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/archives" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-archive"></i>
			
			归档
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/about" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-user-circle"></i>
			
			关于
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/contact" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-comments"></i>
			
			留言板
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/friends" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-address-book"></i>
			
			友情链接
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="javascript:;">
			
				<i class="fa-fw fas fa-list"></i>
			
			Medias
			<span class="m-icon"><i class="fas fa-chevron-right"></i></span>
		</a>
            <ul  style="background:  ;" >
              
                <li>   
				
                  <a href="/Music " style="margin-left:75px";>
				  
				   <i class="fa fas fa-music" style="position: absolute;left:50px" ></i>
			      
		          <span>Musics</span>
                  </a>
                </li>
              
                <li>   
				
                  <a href="/Movie " style="margin-left:75px";>
				  
				   <i class="fa fas fa-film" style="position: absolute;left:50px" ></i>
			      
		          <span>Movies</span>
                  </a>
                </li>
              
                <li>   
				
                  <a href="/Book " style="margin-left:75px";>
				  
				   <i class="fa fas fa-book" style="position: absolute;left:50px" ></i>
			      
		          <span>Books</span>
                  </a>
                </li>
              
                <li>   
				
                  <a href="/AV " style="margin-left:75px";>
				  
				   <i class="fa fas fa-image" style="position: absolute;left:50px" ></i>
			      
		          <span>Galleries</span>
                  </a>
                </li>
               
            </ul>
          
        </li>
        
        
        <li><div class="divider"></div></li>
        <li>
            <a href="https://github.com/Zhengchaoqiang" class="waves-effect waves-light" target="_blank">
                <i class="fab fa-github-square fa-fw"></i>Fork Me
            </a>
        </li>
        
    </ul>
</div>

        </div>

        
            <style>
    .nav-transparent .github-corner {
        display: none !important;
    }

    .github-corner {
        position: absolute;
        z-index: 10;
        top: 0;
        right: 0;
        border: 0;
        transform: scale(1.1);
    }

    .github-corner svg {
        color: #0f9d58;
        fill: #fff;
        height: 64px;
        width: 64px;
    }

    .github-corner:hover .octo-arm {
        animation: a 0.56s ease-in-out;
    }

    .github-corner .octo-arm {
        animation: none;
    }

    @keyframes a {
        0%,
        to {
            transform: rotate(0);
        }
        20%,
        60% {
            transform: rotate(-25deg);
        }
        40%,
        80% {
            transform: rotate(10deg);
        }
    }
</style>

<a href="https://github.com/Zhengchaoqiang" class="github-corner tooltipped hide-on-med-and-down" target="_blank"
   data-tooltip="Fork Me" data-position="left" data-delay="50">
    <svg viewBox="0 0 250 250" aria-hidden="true">
        <path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path>
        <path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2"
              fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path>
        <path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z"
              fill="currentColor" class="octo-body"></path>
    </svg>
</a>
        
    </nav>

</header>

    
<script src="/libs/cryptojs/crypto-js.min.js"></script>
<script>
    (function() {
        let pwd = '';
        if (pwd && pwd.length > 0) {
            if (pwd !== CryptoJS.SHA256(prompt('请输入访问本文章的密码')).toString(CryptoJS.enc.Hex)) {
                alert('密码错误，将返回主页！');
                location.href = '/';
            }
        }
    })();
</script>




<div class="bg-cover pd-header post-cover" style="background-image: url('/medias/featureimages/20.jpg')">
    <div class="container" style="right: 0px;left: 0px;">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <h1 class="description center-align post-title">NetCore 开发实战（1）——必备知识</h1>
                </div>
            </div>
        </div>
    </div>
</div>




<main class="post-container content">

    
    <link rel="stylesheet" href="/libs/tocbot/tocbot.css">
<style>
    #articleContent h1::before,
    #articleContent h2::before,
    #articleContent h3::before,
    #articleContent h4::before,
    #articleContent h5::before,
    #articleContent h6::before {
        display: block;
        content: " ";
        height: 100px;
        margin-top: -100px;
        visibility: hidden;
    }

    #articleContent :focus {
        outline: none;
    }

    .toc-fixed {
        position: fixed;
        top: 64px;
    }

    .toc-widget {
        width: 345px;
        padding-left: 20px;
    }

    .toc-widget .toc-title {
        margin: 35px 0 15px 0;
        padding-left: 17px;
        font-size: 1.5rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    .toc-widget ol {
        padding: 0;
        list-style: none;
    }

    #toc-content {
        height: calc(100vh - 250px);
        overflow: auto;
    }

    #toc-content ol {
        padding-left: 10px;
    }

    #toc-content ol li {
        padding-left: 10px;
    }

    #toc-content .toc-link:hover {
        color: #42b983;
        font-weight: 700;
        text-decoration: underline;
    }

    #toc-content .toc-link::before {
        background-color: transparent;
        max-height: 25px;
    }

    #toc-content .is-active-link {
        color: #42b983;
    }

    #toc-content .is-active-link::before {
        background-color: #42b983;
    }

    #floating-toc-btn {
        position: fixed;
        right: 15px;
        bottom: 76px;
        padding-top: 15px;
        margin-bottom: 0;
        z-index: 998;
    }

    #floating-toc-btn .btn-floating {
        width: 48px;
        height: 48px;
    }

    #floating-toc-btn .btn-floating i {
        line-height: 48px;
        font-size: 1.4rem;
    }
</style>
<div class="row">
    <div id="main-content" class="col s12 m12 l9">
        <!-- 文章内容详情 -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            <div class="row tag-cate">
                <div class="col s7">
                    
                    <div class="article-tag">
                        
                            <a href="/tags/Net-Core/">
                                <span class="chip bg-color">Net Core</span>
                            </a>
                        
                    </div>
                    
                </div>
                <div class="col s5 right-align">
                    
                    <div class="post-cate">
                        <i class="fas fa-bookmark fa-fw icon-category"></i>
                        
                            <a href="/categories/NetCore-开发实战/" class="post-category">
                                NetCore 开发实战
                            </a>
                        
                    </div>
                    
                </div>
            </div>

            <div class="post-info">
                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-minus fa-fw"></i>发布日期:&nbsp;&nbsp;
                    2020-04-19
                </div>
                

                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-check fa-fw"></i>更新日期:&nbsp;&nbsp;
                    2020-06-14
                </div>
                

                
                <div class="info-break-policy">
                    <i class="far fa-file-word fa-fw"></i>文章字数:&nbsp;&nbsp;
                    27k
                </div>
                

                
                <div class="info-break-policy">
                    <i class="far fa-clock fa-fw"></i>阅读时长:&nbsp;&nbsp;
                    109 分
                </div>
                

                
                    <div id="busuanzi_container_page_pv" class="info-break-policy">
                        <i class="far fa-eye fa-fw"></i>阅读次数:&nbsp;&nbsp;
                        <span id="busuanzi_value_page_pv"></span>
                    </div>
				
            </div>

        </div>
        <hr class="clearfix">
        <div class="card-content article-card-content">
            <div id="articleContent">
                <h2 id="01-简介"><a href="#01-简介" class="headerlink" title="01 | 简介"></a>01 | 简介</h2><h3 id="为什么要学习-NET-Core"><a href="#为什么要学习-NET-Core" class="headerlink" title="为什么要学习 .NET Core"></a>为什么要学习 .NET Core</h3><ul>
<li>微软大力支持推动 .Net 技术生态发展</li>
<li>跨平台：更多的开发环境和部署环境选择，尤其是对 Docker 和 Kubernetes 的良好支持，快速构建微服务并部署到云基础设施中，实现高可用，可伸缩的系统架构搭建，提高代码重用程度</li>
<li>开源：.NET 技术栈的开放性和包容性，同时也意味着自主性，可以自由使用，再分发 .NET Core 源码</li>
<li>在桌面开发、移动客户端开发、物联网、AI等领域都有非常好的支持，所以可以快速构建适应不同场景的系统</li>
</ul>
<h3 id="学习-NET-Core-的难点有哪些"><a href="#学习-NET-Core-的难点有哪些" class="headerlink" title="学习 .NET Core 的难点有哪些"></a>学习 .NET Core 的难点有哪些</h3><p>.NET Core 的类库、框架、组件使用起来非常自然简单，因此入门非常容易</p>
<p>但是如何用最好的方式使用它来解决工作中的各类问题</p>
<p>如何确保我们设计的系统具备健壮性、可扩展性</p>
<p>如何让团队借助 .NET Core 高效的协作，则是需要大量的实战和经验积累的</p>
<p>比如，如何确保我们的应用适应不同的部署环境</p>
<p>如何设计业务代码，确保其不会随着系统的复杂度的提升而丧失可维护性</p>
<p>服务化又是如何在多团队中保障支付效率的</p>
<p>如何使用 .NET Core 技术解决服务化带来的事务一致性问题</p>
<p>要回答上述问题，就需要你对 .NET Core 的深层原理</p>
<p>以及在实际生产中的最佳实践有进一步的学习和了解</p>
<p>这样你才能认清技术架构和团队协作的关系</p>
<p>并具备保障系统架构的可持续演进的能力</p>
<h3 id="主要预期"><a href="#主要预期" class="headerlink" title="主要预期"></a>主要预期</h3><ul>
<li>掌握 .NET Core 重要组件的设计原理和最佳实践</li>
<li>掌握 Kubernetes 下 .NET Core 微服务应用的设计和实现方案</li>
<li>掌握工程设计原则在 .NET Core 技术栈中的实践</li>
</ul>
<h2 id="02-内容综述"><a href="#02-内容综述" class="headerlink" title="02 | 内容综述"></a>02 | 内容综述</h2><h3 id="主要目标"><a href="#主要目标" class="headerlink" title="主要目标"></a>主要目标</h3><ul>
<li>掌握 .NET Core 微服务架构的最佳实践</li>
<li>成长为一个具备良好架构设计能力的架构师</li>
</ul>
<h3 id="主要内容"><a href="#主要内容" class="headerlink" title="主要内容"></a>主要内容</h3><ul>
<li>第一部分 .NET Core 的必备知识</li>
<li>第二部分 .NET Core 微服务实战</li>
<li>第三部分 将微服务应用部署到 Kubernetes 中</li>
</ul>
<h4 id="第一部分-NET-Core-的必备知识"><a href="#第一部分-NET-Core-的必备知识" class="headerlink" title="第一部分 .NET Core 的必备知识"></a>第一部分 .NET Core 的必备知识</h4><ul>
<li>依赖注入</li>
<li>配置管理</li>
<li>日志框架</li>
<li>关键中间件</li>
</ul>
<p>这些都是构建良好架构的必要知识</p>
<h4 id="第二部分-NET-Core-微服务实战"><a href="#第二部分-NET-Core-微服务实战" class="headerlink" title="第二部分 .NET Core 微服务实战"></a>第二部分 .NET Core 微服务实战</h4><p>面向期望掌握复杂系统架构设计能力的开发者</p>
<p>通过一步步构建一个微服务架构展开</p>
<p>涉及领域驱动设计、远程调用、熔断限流、网关、身份认证、安全等微服务架构的各个方面</p>
<h4 id="第三部分-将微服务应用部署到-Kubernetes-中"><a href="#第三部分-将微服务应用部署到-Kubernetes-中" class="headerlink" title="第三部分 将微服务应用部署到 Kubernetes 中"></a>第三部分 将微服务应用部署到 Kubernetes 中</h4><p>偏向运维侧的需求，现在 DevOps 协作模式非常流行，部署和维护不再是单个运维单个角色的职责，开发和架构师都需要掌握这部分技能</p>
<p>通过一个在 Kubernetes 中部署和维护的案例，了解技术机构对团队 DevOps 能力的影响</p>
<p>通过这部分内容，理解如何保障系统的可用性、可检测性、故障隔离能力和可维护性</p>
<h2 id="03-NET-Core的现状、未来以及环境搭建"><a href="#03-NET-Core的现状、未来以及环境搭建" class="headerlink" title="03 | .NET Core的现状、未来以及环境搭建"></a>03 | .NET Core的现状、未来以及环境搭建</h2><h3 id="NET-Core的现状"><a href="#NET-Core的现状" class="headerlink" title=".NET Core的现状"></a>.NET Core的现状</h3><p><img src="https://cdn.jsdelivr.net/gh/shw2018/cdn@1.0/sakura/img/loader/orange.progress-bar-stripe-loader.svg" data-original="03-01-Net-Core-Function-Map.png" alt=""><br>.NET Core 的应用场景：桌面端、Web端、云端、移动端、游戏、IOT 和 AI</p>
<p>云端指的是 .NET Core 与云原生 Kubernetes 的完美融合</p>
<p>游戏，比如最流行的王者荣耀，就是用 Unity 3D 做的，基于 .NET 的 C# 语言和 Mono</p>
<p>AI 指的是 ML.NET 和 Azure .NET</p>
<h3 id="NET-Core的未来"><a href="#NET-Core的未来" class="headerlink" title=".NET Core的未来"></a>.NET Core的未来</h3><p>.NET Core 的版本历史主要版本</p>
<ul>
<li>2018年5月 .NET Core 2.1 (LTS)</li>
<li>2019年12月 .NET Core 3.1 (LTS)</li>
<li>2020年11月 .NET 5.0</li>
<li>2021年11月 .NET 6.0 (LTS)</li>
<li>2022年11月 .NTE 7.0</li>
<li>2023年11月 .NET 8.0 (LTS)</li>
</ul>
<p>LTS：3年官方支持期</p>
<h3 id="NET-Core-开发工具介绍"><a href="#NET-Core-开发工具介绍" class="headerlink" title=".NET Core 开发工具介绍"></a>.NET Core 开发工具介绍</h3><ul>
<li>Visual Studio (Community, Professional, Enterprise)</li>
<li>Visual Studio for Mac</li>
<li>Visual Studio Code</li>
</ul>
<h3 id="环境搭建"><a href="#环境搭建" class="headerlink" title="环境搭建"></a>环境搭建</h3><p>开发工具下载链接：<a href="https://visualstudio.microsoft.com/zh-hans/" target="_blank" rel="noopener">https://visualstudio.microsoft.com/zh-hans/</a><br>社区版是针对个人开发者授权免费下载使用</p>
<p>工作负载：勾选 ASP.NET 和 Web 开发</p>
<p>单个组件：可以选择一些自定义选项</p>
<h2 id="04-Startup：掌握ASP-NET-Core的启动过程"><a href="#04-Startup：掌握ASP-NET-Core的启动过程" class="headerlink" title="04 | Startup：掌握ASP.NET Core的启动过程"></a>04 | Startup：掌握ASP.NET Core的启动过程</h2><p>新建一个 ASP.NET Core Web 应用程序</p>
<p>选择 API</p>
<pre class="line-numbers language-csharp"><code class="language-csharp"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Program</span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">Main</span><span class="token punctuation">(</span><span class="token keyword">string</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token function">CreateHostBuilder</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> IHostBuilder <span class="token function">CreateHostBuilder</span><span class="token punctuation">(</span><span class="token keyword">string</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span>
        Host<span class="token punctuation">.</span><span class="token function">CreateDefaultBuilder</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">ConfigureWebHostDefaults</span><span class="token punctuation">(</span>webBuilder <span class="token operator">=</span><span class="token operator">></span>
            <span class="token punctuation">{</span>
                webBuilder<span class="token punctuation">.</span><span class="token generic-method function">UseStartup<span class="token punctuation">&lt;</span>Startup<span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>在 Program.cs 的 Main 函数中</p>
<p>CreateHostBuilder 方法返回了一个 <strong>IHostBuilder</strong></p>
<p>它是应用程序启动的<strong>核心接口</strong></p>
<p>IHostBuilder 接口有六个方法：</p>
<p><img src="https://cdn.jsdelivr.net/gh/shw2018/cdn@1.0/sakura/img/loader/orange.progress-bar-stripe-loader.svg" data-original="https://img2018.cnblogs.com/blog/1412316/202002/1412316-20200216235246031-976888981.jpg" alt=""></p>
<p>主要关注以下三个：</p>
<ul>
<li>ConfigureAppConfiguration</li>
<li>ConfigureHostConfiguration</li>
<li>ConfigureServices</li>
</ul>
<p>接下来，我们添加一些代码演示整个应用程序的启动过程：</p>
<pre class="line-numbers language-csharp"><code class="language-csharp"><span class="token keyword">public</span> <span class="token keyword">static</span> IHostBuilder <span class="token function">CreateHostBuilder</span><span class="token punctuation">(</span><span class="token keyword">string</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span>
    Host<span class="token punctuation">.</span><span class="token function">CreateDefaultBuilder</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">ConfigureAppConfiguration</span><span class="token punctuation">(</span>builder <span class="token operator">=</span><span class="token operator">></span>
        <span class="token punctuation">{</span>
            Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">"ConfigureAppConfiguration"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">ConfigureServices</span><span class="token punctuation">(</span>service <span class="token operator">=</span><span class="token operator">></span>
        <span class="token punctuation">{</span>
            Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">"ConfigureServices"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">ConfigureHostConfiguration</span><span class="token punctuation">(</span>builder <span class="token operator">=</span><span class="token operator">></span>
        <span class="token punctuation">{</span>
            Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">"ConfigureHostConfiguration"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">ConfigureWebHostDefaults</span><span class="token punctuation">(</span>webBuilder <span class="token operator">=</span><span class="token operator">></span>
        <span class="token punctuation">{</span>
            Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">"ConfigureWebHostDefaults"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            webBuilder<span class="token punctuation">.</span><span class="token generic-method function">UseStartup<span class="token punctuation">&lt;</span>Startup<span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>接着，在 Startup 的三个方法中添加一些代码</p>
<pre class="line-numbers language-csharp"><code class="language-csharp"><span class="token keyword">public</span> <span class="token function">Startup</span><span class="token punctuation">(</span>IConfiguration configuration<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">"Startup"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">ConfigureServices</span><span class="token punctuation">(</span>IServiceCollection services<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">"ConfigureServices"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">Configure</span><span class="token punctuation">(</span>IApplicationBuilder app<span class="token punctuation">,</span> IWebHostEnvironment env<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">"Configure"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>启动程序查看输出：</p>
<pre><code>ConfigureWebHostDefaults
ConfigureHostConfiguration
ConfigureAppConfiguration
ConfigureServices
Startup
Startup.ConfigureServices
Startup.Configure
</code></pre><p>调整一下委托的注册顺序</p>
<pre class="line-numbers language-csharp"><code class="language-csharp"><span class="token keyword">public</span> <span class="token keyword">static</span> IHostBuilder <span class="token function">CreateHostBuilder</span><span class="token punctuation">(</span><span class="token keyword">string</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span>
    Host<span class="token punctuation">.</span><span class="token function">CreateDefaultBuilder</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">ConfigureWebHostDefaults</span><span class="token punctuation">(</span>webBuilder <span class="token operator">=</span><span class="token operator">></span>
        <span class="token punctuation">{</span>
            Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">"ConfigureWebHostDefaults"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            webBuilder<span class="token punctuation">.</span><span class="token generic-method function">UseStartup<span class="token punctuation">&lt;</span>Startup<span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">ConfigureServices</span><span class="token punctuation">(</span>service <span class="token operator">=</span><span class="token operator">></span>
        <span class="token punctuation">{</span>
            Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">"ConfigureServices"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">ConfigureAppConfiguration</span><span class="token punctuation">(</span>builder <span class="token operator">=</span><span class="token operator">></span>
        <span class="token punctuation">{</span>
            Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">"ConfigureAppConfiguration"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">ConfigureHostConfiguration</span><span class="token punctuation">(</span>builder <span class="token operator">=</span><span class="token operator">></span>
        <span class="token punctuation">{</span>
            Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">"ConfigureHostConfiguration"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>会得到不同的结果</p>
<pre><code>ConfigureWebHostDefaults
ConfigureHostConfiguration
ConfigureAppConfiguration
Startup
Startup.ConfigureServices
ConfigureServices
Startup.Configure
</code></pre><p>本质上，如果查看源码会发现，委托注册进去之后，实际上是按照一定的顺序来执行的：<br><img src="https://cdn.jsdelivr.net/gh/shw2018/cdn@1.0/sakura/img/loader/orange.progress-bar-stripe-loader.svg" data-original="04-01-StartOrder.png" alt=""></p>
<ol>
<li>ConfigureWebHostDefaults</li>
</ol>
<p>这个阶段注册了应用程序必要的几个组件，比如配置的组件、容器组件</p>
<ol start="2">
<li>ConfigureHostConfiguration</li>
</ol>
<p>用于配置应用程序启动时必要的配置，比如应用程序启动时所需要监听的端口，URL 地址</p>
<p>在这个过程可以嵌入一些自己配置的内容，注入到配置的框架中</p>
<ol start="3">
<li>ConfigureAppConfiguration</li>
</ol>
<p>用于嵌入自己的配置文件，供应用程序读取，这些配置将会在后续的应用程序执行过程中间每个组件读取</p>
<ol start="4">
<li>ConfigureServices, ConfigureLogging, Startup, Startup.ConfigureServices</li>
</ol>
<p>用于往容器里注入应用的组件</p>
<ol start="5">
<li>Startup.Configure</li>
</ol>
<p>用于注入中间件，处理 HttpContext 整个请求过程</p>
<pre class="line-numbers language-csharp"><code class="language-csharp"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">Configure</span><span class="token punctuation">(</span>IApplicationBuilder app<span class="token punctuation">,</span> IWebHostEnvironment env<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">"Startup.Configure"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>env<span class="token punctuation">.</span><span class="token function">IsDevelopment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        app<span class="token punctuation">.</span><span class="token function">UseDeveloperExceptionPage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    app<span class="token punctuation">.</span><span class="token function">UseHttpsRedirection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    app<span class="token punctuation">.</span><span class="token function">UseRouting</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    app<span class="token punctuation">.</span><span class="token function">UseAuthorization</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    app<span class="token punctuation">.</span><span class="token function">UseFileServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    app<span class="token punctuation">.</span><span class="token function">UseWebSockets</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    app<span class="token punctuation">.</span><span class="token function">UseEndpoints</span><span class="token punctuation">(</span>endpoints <span class="token operator">=</span><span class="token operator">></span>
    <span class="token punctuation">{</span>
        endpoints<span class="token punctuation">.</span><span class="token function">MapControllers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>在整个启动的过程中，Startup 这个类不是必要的，只是让代码结构更加合理</p>
<pre class="line-numbers language-csharp"><code class="language-csharp"><span class="token keyword">public</span> <span class="token keyword">static</span> IHostBuilder <span class="token function">CreateHostBuilder</span><span class="token punctuation">(</span><span class="token keyword">string</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span>
    Host<span class="token punctuation">.</span><span class="token function">CreateDefaultBuilder</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">ConfigureWebHostDefaults</span><span class="token punctuation">(</span>webBuilder <span class="token operator">=</span><span class="token operator">></span>
        <span class="token punctuation">{</span>
            Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">"ConfigureWebHostDefaults"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">//webBuilder.UseStartup&lt;Startup>();</span>

            webBuilder<span class="token punctuation">.</span><span class="token function">ConfigureServices</span><span class="token punctuation">(</span>services <span class="token operator">=</span><span class="token operator">></span>
            <span class="token punctuation">{</span>
                Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">"webBuilder.ConfigureServices"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                services<span class="token punctuation">.</span><span class="token function">AddControllers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            webBuilder<span class="token punctuation">.</span><span class="token function">Configure</span><span class="token punctuation">(</span>app <span class="token operator">=</span><span class="token operator">></span>
            <span class="token punctuation">{</span>
                Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">"webBuilder.Configure"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                app<span class="token punctuation">.</span><span class="token function">UseHttpsRedirection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                app<span class="token punctuation">.</span><span class="token function">UseRouting</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                app<span class="token punctuation">.</span><span class="token function">UseAuthorization</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                app<span class="token punctuation">.</span><span class="token function">UseFileServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                app<span class="token punctuation">.</span><span class="token function">UseWebSockets</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                app<span class="token punctuation">.</span><span class="token function">UseEndpoints</span><span class="token punctuation">(</span>endpoints <span class="token operator">=</span><span class="token operator">></span>
                <span class="token punctuation">{</span>
                    endpoints<span class="token punctuation">.</span><span class="token function">MapControllers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">ConfigureServices</span><span class="token punctuation">(</span>service <span class="token operator">=</span><span class="token operator">></span>
        <span class="token punctuation">{</span>
            Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">"ConfigureServices"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">ConfigureAppConfiguration</span><span class="token punctuation">(</span>builder <span class="token operator">=</span><span class="token operator">></span>
        <span class="token punctuation">{</span>
            Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">"ConfigureAppConfiguration"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">ConfigureHostConfiguration</span><span class="token punctuation">(</span>builder <span class="token operator">=</span><span class="token operator">></span>
        <span class="token punctuation">{</span>
            Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">"ConfigureHostConfiguration"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>启动程序查看输出：</p>
<pre><code>ConfigureWebHostDefaults
ConfigureHostConfiguration
ConfigureAppConfiguration
webBuilder.ConfigureServices
ConfigureServices
webBuilder.Configure
</code></pre><p>服务注册一般放在 Startup 的 ConfigureServices，一般是services.AddXXX</p>
<pre class="line-numbers language-csharp"><code class="language-csharp"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">ConfigureServices</span><span class="token punctuation">(</span>IServiceCollection services<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    services<span class="token punctuation">.</span><span class="token function">AddMvc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    services<span class="token punctuation">.</span><span class="token function">AddAuthentication</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    services<span class="token punctuation">.</span><span class="token function">AddAuthorization</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">"Startup.ConfigureServices"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    services<span class="token punctuation">.</span><span class="token function">AddControllers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>中间件的注册一般放在 Startup 的 Configure</p>
<pre class="line-numbers language-csharp"><code class="language-csharp"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">Configure</span><span class="token punctuation">(</span>IApplicationBuilder app<span class="token punctuation">,</span> IWebHostEnvironment env<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">"Startup.Configure"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>env<span class="token punctuation">.</span><span class="token function">IsDevelopment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        app<span class="token punctuation">.</span><span class="token function">UseDeveloperExceptionPage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    app<span class="token punctuation">.</span><span class="token function">UseHttpsRedirection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    app<span class="token punctuation">.</span><span class="token function">UseRouting</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    app<span class="token punctuation">.</span><span class="token function">UseAuthorization</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    app<span class="token punctuation">.</span><span class="token function">UseFileServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    app<span class="token punctuation">.</span><span class="token function">UseWebSockets</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    app<span class="token punctuation">.</span><span class="token function">UseEndpoints</span><span class="token punctuation">(</span>endpoints <span class="token operator">=</span><span class="token operator">></span>
    <span class="token punctuation">{</span>
        endpoints<span class="token punctuation">.</span><span class="token function">MapControllers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="05-依赖注入：良好架构的起点"><a href="#05-依赖注入：良好架构的起点" class="headerlink" title="05 | 依赖注入：良好架构的起点"></a>05 | 依赖注入：良好架构的起点</h2><h3 id="为什么要使用依赖注入框架"><a href="#为什么要使用依赖注入框架" class="headerlink" title="为什么要使用依赖注入框架"></a>为什么要使用依赖注入框架</h3><ul>
<li>借助依赖注入框架，我们可以轻松管理类之间的依赖，帮助我们在构建应用时遵循设计原则，确保代码的可维护性和可扩展性</li>
<li>ASP.NET Core 的整个架构中，依赖注入框架提供了对象创建和生命周期管理的核心能力，各个组件相互协作，也是由依赖注入框架的能力来实现的</li>
</ul>
<h3 id="组件包"><a href="#组件包" class="headerlink" title="组件包"></a>组件包</h3><ul>
<li>Microsoft.Extensions.DependencyInjection.Abstractions</li>
<li>Microsoft.Extensions.DependencyInjection</li>
</ul>
<p>依赖注入的核心是以上两个组件包，一个是抽象包，一个是具体的实现</p>
<p>这里用到了一个经典的设计模式，接口实现分离模式</p>
<p>组件只需要依赖抽象接口，而不需要依赖具体实现，当使用的时候注入它的具体实现即可</p>
<p>这样做的好处是可以在使用时决定具体的实现，也就意味着未来可以做任意的扩展，替换依赖注入框架的具体实现</p>
<p>默认情况下，使用 .NET Core 提供的内置依赖注入框架，也可以使用第三方的依赖注入框架来替换默认实现</p>
<h3 id="核心类型"><a href="#核心类型" class="headerlink" title="核心类型"></a>核心类型</h3><ul>
<li>IServiceCollection：服务的注册</li>
<li>ServiceDescriptor：每一个服务注册时的信息</li>
<li>IServiceProvider：具体的容器，由 ServiceCollection Build 产生</li>
<li>IServiceScope：一个容器的子容器的生命周期</li>
</ul>
<h3 id="生命周期"><a href="#生命周期" class="headerlink" title="生命周期"></a>生命周期</h3><ul>
<li>单例 Singleton：在整个根容器的生命周期内，都是单例，不管是子容器还是根容器，与作用域的区别是：一个是全局的，一个是范围的单例</li>
<li>作用域 Scoped：在 Scope 的生存周期内，也就是容器的生存周期内，或者子容器的生存周期内，如果我的容器释放掉，我的对象也会释放掉</li>
<li>瞬时（暂时）Transient：每一次从容器里面获取对象时，都可以得到一个全新的对象</li>
</ul>
<p>新建一个 ASP.NET Core Web 应用程序 DependencyInjectionDemo，选择API</p>
<p>添加一个 Services 文件夹，新建三个服务代表三个生命周期的服务</p>
<pre class="line-numbers language-csharp"><code class="language-csharp"><span class="token keyword">namespace</span> DependencyInjectionDemo<span class="token punctuation">.</span>Services
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">IMyScopedService</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyScopedService</span> <span class="token punctuation">:</span> IMyScopedService
    <span class="token punctuation">{</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-csharp"><code class="language-csharp"><span class="token keyword">namespace</span> DependencyInjectionDemo<span class="token punctuation">.</span>Services
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">IMySingletonService</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MySingletonService</span> <span class="token punctuation">:</span> IMySingletonService
    <span class="token punctuation">{</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-csharp"><code class="language-csharp"><span class="token keyword">namespace</span> DependencyInjectionDemo<span class="token punctuation">.</span>Services
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">IMyTransientService</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyTransientService</span> <span class="token punctuation">:</span> IMyTransientService
    <span class="token punctuation">{</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>在 Startup 中注册服务</p>
<pre class="line-numbers language-csharp"><code class="language-csharp"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">ConfigureServices</span><span class="token punctuation">(</span>IServiceCollection services<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token preprocessor property">#<span class="token directive keyword">region</span> 注册服务不同生命周期的服务</span>

    <span class="token comment" spellcheck="true">// 将单例的服务注册为单例的模式</span>
    services<span class="token punctuation">.</span><span class="token generic-method function">AddSingleton<span class="token punctuation">&lt;</span>IMySingletonService<span class="token punctuation">,</span> MySingletonService<span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// Scoped 的服务注册为 Scoped 的生命周期</span>
    services<span class="token punctuation">.</span><span class="token generic-method function">AddScoped<span class="token punctuation">&lt;</span>IMyScopedService<span class="token punctuation">,</span> MyScopedService<span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// 瞬时的服务注册为瞬时的生命周期</span>
    services<span class="token punctuation">.</span><span class="token generic-method function">AddTransient<span class="token punctuation">&lt;</span>IMyTransientService<span class="token punctuation">,</span> MyTransientService<span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token preprocessor property">#<span class="token directive keyword">endregion</span></span>

    services<span class="token punctuation">.</span><span class="token function">AddControllers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>在 Controller 里面获取我们的服务</p>
<pre class="line-numbers language-csharp"><code class="language-csharp"><span class="token comment" spellcheck="true">// FromServices 标注的作用是从容器里面获取我们的对象</span>
<span class="token comment" spellcheck="true">// 每个对象获取两遍，用于对比每个生命周期获取的对象是什么样子的</span>
<span class="token comment" spellcheck="true">// HashCode 代表对象的唯一性</span>
<span class="token punctuation">[</span>HttpGet<span class="token punctuation">]</span>
<span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">GetService</span><span class="token punctuation">(</span>
    <span class="token punctuation">[</span>FromServices<span class="token punctuation">]</span>IMySingletonService singleton1<span class="token punctuation">,</span>
    <span class="token punctuation">[</span>FromServices<span class="token punctuation">]</span>IMySingletonService singleton2<span class="token punctuation">,</span>
    <span class="token punctuation">[</span>FromServices<span class="token punctuation">]</span>IMyTransientService transient1<span class="token punctuation">,</span>
    <span class="token punctuation">[</span>FromServices<span class="token punctuation">]</span>IMyTransientService transient2<span class="token punctuation">,</span>
    <span class="token punctuation">[</span>FromServices<span class="token punctuation">]</span>IMyScopedService scoped1<span class="token punctuation">,</span>
    <span class="token punctuation">[</span>FromServices<span class="token punctuation">]</span>IMyScopedService scoped2<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span>$<span class="token string">"singleton1:{singleton1.GetHashCode()}"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span>$<span class="token string">"singleton2:{singleton2.GetHashCode()}"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span>$<span class="token string">"transient1:{transient1.GetHashCode()}"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span>$<span class="token string">"transient2:{transient2.GetHashCode()}"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span>$<span class="token string">"scoped1:{scoped1.GetHashCode()}"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span>$<span class="token string">"scoped2:{scoped2.GetHashCode()}"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span>$<span class="token string">"========请求结束========"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>启动程序，刷新浏览器再次访问接口，输出如下：</p>
<p><img src="https://cdn.jsdelivr.net/gh/shw2018/cdn@1.0/sakura/img/loader/orange.progress-bar-stripe-loader.svg" data-original="https://img2018.cnblogs.com/blog/1412316/202002/1412316-20200218003943791-347841228.png" alt=""></p>
<p>单例模式两次的 HashCode 没有变化</p>
<p>两个瞬时服务两次的 HashCode 完全不同，意味着瞬时服务每次请求都会得到一个新对象</p>
<p>范围服务每个请求内是相同的，不同的请求之间得到的对象实例是不同的</p>
<h3 id="其他服务注册方式"><a href="#其他服务注册方式" class="headerlink" title="其他服务注册方式"></a>其他服务注册方式</h3><p>除了使用泛型的方式注册服务之外，还有其他的方式</p>
<p>添加一个 OrderService</p>
<pre class="line-numbers language-csharp"><code class="language-csharp"><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">IOrderService</span>
<span class="token punctuation">{</span>

<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OrderService</span> <span class="token punctuation">:</span> IOrderService
<span class="token punctuation">{</span>

<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OrderServiceEx</span> <span class="token punctuation">:</span> IOrderService
<span class="token punctuation">{</span>

<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>在 Startup 中注册服务</p>
<pre class="line-numbers language-csharp"><code class="language-csharp"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">ConfigureServices</span><span class="token punctuation">(</span>IServiceCollection services<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token preprocessor property">#<span class="token directive keyword">region</span> 注册服务不同生命周期的服务</span>

    <span class="token comment" spellcheck="true">// 将单例的服务注册为单例的模式</span>
    services<span class="token punctuation">.</span><span class="token generic-method function">AddSingleton<span class="token punctuation">&lt;</span>IMySingletonService<span class="token punctuation">,</span> MySingletonService<span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// Scoped 的服务注册为 Scoped 的生命周期</span>
    services<span class="token punctuation">.</span><span class="token generic-method function">AddScoped<span class="token punctuation">&lt;</span>IMyScopedService<span class="token punctuation">,</span> MyScopedService<span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// 瞬时的服务注册为瞬时的生命周期</span>
    services<span class="token punctuation">.</span><span class="token generic-method function">AddTransient<span class="token punctuation">&lt;</span>IMyTransientService<span class="token punctuation">,</span> MyTransientService<span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token preprocessor property">#<span class="token directive keyword">endregion</span></span>

    <span class="token preprocessor property">#<span class="token directive keyword">region</span> 花式注册</span>

    services<span class="token punctuation">.</span><span class="token generic-method function">AddSingleton<span class="token punctuation">&lt;</span>IOrderService<span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">OrderService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">//直接注入实例</span>

    <span class="token comment" spellcheck="true">//// 通过工厂模式</span>
    <span class="token comment" spellcheck="true">//services.AddSingleton&lt;IOrderService>(serviceProvider =></span>
    <span class="token comment" spellcheck="true">//{</span>
    <span class="token comment" spellcheck="true">//    return new OrderServiceEx();</span>
    <span class="token comment" spellcheck="true">//});</span>

    <span class="token comment" spellcheck="true">//services.AddScoped&lt;IOrderService>(serviceProvider =></span>
    <span class="token comment" spellcheck="true">//{</span>
    <span class="token comment" spellcheck="true">//    // 可以使用 IServiceProvider 入参，也就意味着可以从容器里面获取多个对象，进行组装，得到最终的实现实例</span>
    <span class="token comment" spellcheck="true">//    // 也就是可以把工厂类设计的比较复杂，比如说实现类依赖了容器里面的另外一个类，或者用另一个类来包装原有的实现</span>
    <span class="token comment" spellcheck="true">//    //serviceProvider.GetService&lt;>()</span>

    <span class="token comment" spellcheck="true">//    return new OrderServiceEx();</span>
    <span class="token comment" spellcheck="true">//});</span>

    <span class="token preprocessor property">#<span class="token directive keyword">endregion</span></span>

    <span class="token preprocessor property">#<span class="token directive keyword">region</span> 尝试注册（如果服务已经注册过，则不再注册）</span>

    services<span class="token punctuation">.</span><span class="token generic-method function">TryAddSingleton<span class="token punctuation">&lt;</span>IOrderService<span class="token punctuation">,</span> OrderServiceEx<span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token preprocessor property">#<span class="token directive keyword">endregion</span></span>

    services<span class="token punctuation">.</span><span class="token function">AddControllers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>在服务端 WeatherForecastController 定义另外一个接口</p>
<pre class="line-numbers language-csharp"><code class="language-csharp"><span class="token comment" spellcheck="true">// IEnumerable&lt;IOrderService>：获取曾经注册过的所有 IOrderService</span>
<span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">GetServiceList</span><span class="token punctuation">(</span><span class="token punctuation">[</span>FromServices<span class="token punctuation">]</span>IEnumerable<span class="token operator">&lt;</span>IOrderService<span class="token operator">></span> services<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token keyword">var</span> item <span class="token keyword">in</span> services<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span>$<span class="token string">"获取到服务实例：{item.ToString()}:{item.GetHashCode()}"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>调整一下程序的启动页面，Properties 下的 launchSetting.json 的这一行代码</p>
<pre><code>"launchUrl": "weatherforecast/getservicelist",</code></pre><p>启动程序，输出如下：</p>
<pre><code>获取到服务实例：DependencyInjectionDemo.Services.OrderService:25560520</code></pre><p>只有一个实例，说明 TryAddSingleton 没有生效</p>
<p>接着，注册两个服务</p>
<pre class="line-numbers language-csharp"><code class="language-csharp">services<span class="token punctuation">.</span><span class="token generic-method function">AddSingleton<span class="token punctuation">&lt;</span>IOrderService<span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">OrderService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
services<span class="token punctuation">.</span><span class="token generic-method function">AddSingleton<span class="token punctuation">&lt;</span>IOrderService<span class="token punctuation">,</span> OrderServiceEx<span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>启动程序，输出如下：</p>
<pre><code>获取到服务实例：DependencyInjectionDemo.Services.OrderService:16991442
获取到服务实例：DependencyInjectionDemo.Services.OrderServiceEx:25560520</code></pre><p>结果获取到了两个实例</p>
<p>接下来，了解一下 TryAddEnumerable 与 TryAddSingleton 的区别</p>
<pre class="line-numbers language-csharp"><code class="language-csharp"><span class="token preprocessor property">#<span class="token directive keyword">region</span> 尝试注册（如果服务已经注册过，则不再注册）</span>

services<span class="token punctuation">.</span><span class="token generic-method function">TryAddSingleton<span class="token punctuation">&lt;</span>IOrderService<span class="token punctuation">,</span> OrderServiceEx<span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// 接口类型重复，则不注册</span>

services<span class="token punctuation">.</span><span class="token function">TryAddEnumerable</span><span class="token punctuation">(</span>ServiceDescriptor<span class="token punctuation">.</span><span class="token generic-method function">Singleton<span class="token punctuation">&lt;</span>IOrderService<span class="token punctuation">,</span> OrderService<span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// 相同类型的接口，实现类相同，则不注册</span>

<span class="token preprocessor property">#<span class="token directive keyword">endregion</span></span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>注册服务</p>
<pre class="line-numbers language-csharp"><code class="language-csharp">services<span class="token punctuation">.</span><span class="token generic-method function">AddSingleton<span class="token punctuation">&lt;</span>IOrderService<span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">OrderService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
services<span class="token punctuation">.</span><span class="token function">TryAddEnumerable</span><span class="token punctuation">(</span>ServiceDescriptor<span class="token punctuation">.</span><span class="token generic-method function">Singleton<span class="token punctuation">&lt;</span>IOrderService<span class="token punctuation">,</span> OrderService<span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>启动程序，输出如下：</p>
<pre><code>获取到服务实例：DependencyInjectionDemo.Services.OrderService:53046438</code></pre><p>因为已经注册过 OrderService，所以第二句代码不生效</p>
<p>以不同的实现注册服务</p>
<pre class="line-numbers language-csharp"><code class="language-csharp">services<span class="token punctuation">.</span><span class="token generic-method function">AddSingleton<span class="token punctuation">&lt;</span>IOrderService<span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">OrderService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
services<span class="token punctuation">.</span><span class="token function">TryAddEnumerable</span><span class="token punctuation">(</span>ServiceDescriptor<span class="token punctuation">.</span><span class="token generic-method function">Singleton<span class="token punctuation">&lt;</span>IOrderService<span class="token punctuation">,</span> OrderServiceEx<span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>启动程序，输出如下：</p>
<pre><code>获取到服务实例：DependencyInjectionDemo.Services.OrderService:24219861
获取到服务实例：DependencyInjectionDemo.Services.OrderServiceEx:38855053</code></pre><p>这样就可以获取到两个服务实例</p>
<p>刷新浏览器，再执行一遍</p>
<pre><code>获取到服务实例：DependencyInjectionDemo.Services.OrderService:24219861
获取到服务实例：DependencyInjectionDemo.Services.OrderServiceEx:38855053
获取到服务实例：DependencyInjectionDemo.Services.OrderService:24219861
获取到服务实例：DependencyInjectionDemo.Services.OrderServiceEx:38855053</code></pre><p>因为注册的是单例，所以两次请求获取到的实例都是相同的</p>
<h3 id="服务的替换和删除"><a href="#服务的替换和删除" class="headerlink" title="服务的替换和删除"></a>服务的替换和删除</h3><p>注册完毕之后，想替换某些组件的某些部分时，可以使用 <strong>Replace</strong> 和 <strong>RemoveAll</strong></p>
<pre class="line-numbers language-csharp"><code class="language-csharp">services<span class="token punctuation">.</span><span class="token generic-method function">AddSingleton<span class="token punctuation">&lt;</span>IOrderService<span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">OrderService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
services<span class="token punctuation">.</span><span class="token function">Replace</span><span class="token punctuation">(</span>ServiceDescriptor<span class="token punctuation">.</span><span class="token generic-method function">Singleton<span class="token punctuation">&lt;</span>IOrderService<span class="token punctuation">,</span> OrderServiceEx<span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// 替换掉注册的第一个实现</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>启动程序，输出如下：</p>
<pre><code>获取到服务实例：DependencyInjectionDemo.Services.OrderServiceEx:25560520</code></pre><p>从结果看出，注册的 OrderService 被替换为 OrderServiceEx</p>
<p>下面介绍 RemoveAll</p>
<pre><code>services.AddSingleton&lt;IOrderService&gt;(new OrderService());
services.AddSingleton&lt;IOrderService, OrderServiceEx&gt;();
services.RemoveAll&lt;IOrderService&gt;();// 移除所有 IOrderService 的注册
</code></pre><p>这种情况下程序会报错，因为所有 IOrderService 的注册被移除</p>
<pre><code>Unable to resolve service for type 'DependencyInjectionDemo.Services.IOrderService'</code></pre><h3 id="注册泛型模板"><a href="#注册泛型模板" class="headerlink" title="注册泛型模板"></a>注册泛型模板</h3><p>当需要注册一组泛型实现的时候</p>
<p>实际上注册的时候并不知道泛型类的具体类型入参</p>
<p>依赖注入框架为我们提供了泛型模板的注册方式</p>
<p>通过一行代码来注册所有此泛型的具体实现</p>
<p>定义一个泛型接口</p>
<pre class="line-numbers language-csharp"><code class="language-csharp"><span class="token keyword">namespace</span> DependencyInjectionDemo<span class="token punctuation">.</span>Services
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">IGenericService</span><span class="token operator">&lt;</span>T<span class="token operator">></span>
    <span class="token punctuation">{</span>

    <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">GenericService</span><span class="token operator">&lt;</span>T<span class="token operator">></span> <span class="token punctuation">:</span> IGenericService<span class="token operator">&lt;</span>T<span class="token operator">></span>
    <span class="token punctuation">{</span>
        <span class="token keyword">public</span> T Data <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">private</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
        <span class="token keyword">public</span> <span class="token function">GenericService</span><span class="token punctuation">(</span>T data<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>Data <span class="token operator">=</span> data<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>泛型模板注册方法</p>
<pre class="line-numbers language-csharp"><code class="language-csharp">services<span class="token punctuation">.</span><span class="token function">AddSingleton</span><span class="token punctuation">(</span><span class="token keyword">typeof</span><span class="token punctuation">(</span>IGenericService<span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">typeof</span><span class="token punctuation">(</span>GenericService<span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>它的生命周期与之前的注册方式是一致的</p>
<p>不过它无法通过泛型 API 注册</p>
<p>需要注册两个 service 的 type</p>
<p>第一个入参是服务的类型</p>
<p>第二个入参是服务实现的类型</p>
<p>接下来，看看如何在 controller 中使用</p>
<pre class="line-numbers language-csharp"><code class="language-csharp"><span class="token comment" spellcheck="true">// 在构造函数中添加两个入参，IOrderService 和 IGenericService</span>
<span class="token comment" spellcheck="true">// 通过断点调试查看 genericService 的类型可得知，泛型的具体实现可以用容器里面的任意类型来替代</span>
<span class="token keyword">public</span> <span class="token function">WeatherForecastController</span><span class="token punctuation">(</span>ILogger<span class="token operator">&lt;</span>WeatherForecastController<span class="token operator">></span> logger<span class="token punctuation">,</span> IOrderService orderService<span class="token punctuation">,</span> IGenericService<span class="token operator">&lt;</span>IOrderService<span class="token operator">></span> genericService<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    _orderService <span class="token operator">=</span> orderService<span class="token punctuation">;</span>
    _logger <span class="token operator">=</span> logger<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>在 controller 中有两种依赖注入的实例的获取方式：</p>
<ul>
<li>通过 controller 构造函数注入</li>
<li>通过 [FromServices] 注入</li>
</ul>
<p>当定义一个 controller 的时候</p>
<p>它的服务是大部分接口都需要使用的情况下</p>
<p>推荐的做法是用构造函数注入的方式</p>
<p>如果这个服务仅仅在某一个接口使用的情况下</p>
<p>推荐使用 [FromServices] 注入</p>
<h2 id="06-作用域与对象释放行为"><a href="#06-作用域与对象释放行为" class="headerlink" title="06 | 作用域与对象释放行为"></a>06 | 作用域与对象释放行为</h2><p>作用域主要由<strong>IServiceScope</strong>这个接口来承载</p>
<p>对于实现 IDisposable 类的实例的对象，容器会负责对其生命周期进行管理，使用完毕之后，他会释放这些对象。</p>
<p>实现 IDisposable 接口类型的释放：</p>
<ul>
<li>1.容器只会负责由其创建的对象，如果这个对象是<strong>自己创建出来并放到容器里的</strong>，容器不负责释放这个对象</li>
<li>2.在容器和子容器释放时，容器才会去释放这些对象，也就是说<strong>容器的生命周期与其创建的对象的生命周期是有对应关系的</strong></li>
</ul>
<p>两点建议：</p>
<ul>
<li>1.在根容器，最好不要创建实现了 IDisposable 瞬时服务</li>
<li>2.避免手动创建实现了 IDisposable 对象，然后塞到容器里面，应该尽可能地使用容器来管理我们对象的创建和释放</li>
</ul>
<p>先看一下服务</p>
<pre class="line-numbers language-csharp"><code class="language-csharp"><span class="token keyword">namespace</span> DependencyInjectionScopeAndDisposableDemo<span class="token punctuation">.</span>Services
<span class="token punctuation">{</span>

    <span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">IOrderService</span>
    <span class="token punctuation">{</span>

    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DisposableOrderService</span> <span class="token punctuation">:</span> IOrderService<span class="token punctuation">,</span> IDisposable
    <span class="token punctuation">{</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">Dispose</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span>$<span class="token string">"DisposableOrderService Disposed:{this.GetHashCode()}"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>首先定义 IOrderService</p>
<p>接着定义 IOrderService 的实现 DisposableOrderService，并*<em>实现了 IDisposable *</em>这个接口</p>
<p>在释放的时候打印释放信息，并输出对象的 HashCode</p>
<p>接着是服务注册（Startup）</p>
<pre class="line-numbers language-csharp"><code class="language-csharp">services<span class="token punctuation">.</span><span class="token generic-method function">AddTransient<span class="token punctuation">&lt;</span>IOrderService<span class="token punctuation">,</span>DisposableOrderService<span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>这里先注册一个<strong>瞬时服务</strong>，将 IOrderService 注册进去</p>
<p>然后看一下控制器（WeatherForecastController）</p>
<pre><code>[HttpGet]
public int Get([FromServices] IOrderService orderService,
    [FromServices] IOrderService orderService2)
{
    return 1;
}
</code></pre><p>这里 FromServices 获取了两次 IOrderService</p>
<p>这里不需要写任何代码对它进行操作，因为整个生命周期是由容器去管理的</p>
<p>启动程序，输出如下：</p>
<pre><code>DisposableOrderService Disposed:10579059
DisposableOrderService Disposed:47945396
</code></pre><p>可以看出，执行完毕之后，DisposableOrderService 会被释放掉，并且两个对象都会被释放掉</p>
<p>两个对象的 HashCode 不同</p>
<p><strong>瞬时服务在每一次获取的时候都会获得一个新的对象</strong></p>
<p>接着，添加一行代码表示服务</p>
<pre><code>[HttpGet]
public int Get([FromServices] IOrderService orderService,
    [FromServices] IOrderService orderService2)
{
    Console.WriteLine("接口请求处理结束");
    return 1;
}
</code></pre><p>输出一下，表示我们的接口已经访问完毕，看一下释放时机在哪里</p>
<p>启动程序，输出如下：</p>
<pre><code>接口请求处理结束
DisposableOrderService Disposed:35023218
DisposableOrderService Disposed:13943705</code></pre><p>由此看出，<strong>接口请求处理结束后，才释放对象</strong></p>
<p>接下来看一下 <strong>Scoped 模式</strong></p>
<p>服务注册</p>
<pre class="line-numbers language-csharp"><code class="language-csharp">services<span class="token punctuation">.</span><span class="token generic-method function">AddScoped<span class="token punctuation">&lt;</span>IOrderService<span class="token punctuation">></span></span><span class="token punctuation">(</span>p <span class="token operator">=</span><span class="token operator">></span> <span class="token keyword">new</span> <span class="token class-name">DisposableOrderService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>控制器</p>
<pre class="line-numbers language-csharp"><code class="language-csharp"><span class="token punctuation">[</span>HttpGet<span class="token punctuation">]</span>
<span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">Get</span><span class="token punctuation">(</span><span class="token punctuation">[</span>FromServices<span class="token punctuation">]</span> IOrderService orderService<span class="token punctuation">,</span>
    <span class="token punctuation">[</span>FromServices<span class="token punctuation">]</span> IOrderService orderService2<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">"=======1=========="</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">// HttpContext.RequestServices</span>
    <span class="token comment" spellcheck="true">// 是当前请求的一个根容器</span>
    <span class="token comment" spellcheck="true">// 应用程序根容器的一个子容器</span>
    <span class="token comment" spellcheck="true">// 每个请求会创建一个容器</span>
    <span class="token keyword">using</span> <span class="token punctuation">(</span>IServiceScope scope <span class="token operator">=</span> HttpContext<span class="token punctuation">.</span>RequestServices<span class="token punctuation">.</span><span class="token function">CreateScope</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// 在这个子容器下面再创建一个子容器来获取服务</span>
        <span class="token keyword">var</span> service <span class="token operator">=</span> scope<span class="token punctuation">.</span>ServiceProvider<span class="token punctuation">.</span><span class="token generic-method function">GetService<span class="token punctuation">&lt;</span>IOrderService<span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">"=======2=========="</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">"接口请求处理结束"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>启动程序，输出如下：</p>
<pre><code>=======1==========
DisposableOrderService Disposed:31307802
=======2==========
接口请求处理结束
DisposableOrderService Disposed:31614998
</code></pre><p>每次请求会获得两个释放，意味着<strong>每创建一个 Scoped 的作用域，每个作用域内可以是单例的</strong></p>
<p>接下来，把服务切换为单例模式，通过工厂的方式</p>
<pre class="line-numbers language-csharp"><code class="language-csharp">services<span class="token punctuation">.</span><span class="token generic-method function">AddSingleton<span class="token punctuation">&lt;</span>IOrderService<span class="token punctuation">></span></span><span class="token punctuation">(</span>p <span class="token operator">=</span><span class="token operator">></span> <span class="token keyword">new</span> <span class="token class-name">DisposableOrderService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>启动程序，输出如下：</p>
<pre><code>=======1==========
=======2==========
接口请求处理结束</code></pre><p>可以看到代码实际上<strong>不会被释放</strong></p>
<p>如果切换为瞬时模式，通过工厂的方式</p>
<pre class="line-numbers language-csharp"><code class="language-csharp">services<span class="token punctuation">.</span><span class="token generic-method function">AddTransient<span class="token punctuation">&lt;</span>IOrderService<span class="token punctuation">></span></span><span class="token punctuation">(</span>p <span class="token operator">=</span><span class="token operator">></span> <span class="token keyword">new</span> <span class="token class-name">DisposableOrderService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>启动程序，输出如下：</p>
<pre><code>=======1==========
DisposableOrderService Disposed:12021664
DisposableOrderService Disposed:32106157
=======2==========
接口请求处理结束
DisposableOrderService Disposed:3165221
DisposableOrderService Disposed:13048313
</code></pre><p>这里可以看到，<strong>获取四个服务并且释放掉</strong></p>
<p>接下来把服务调整为<strong>自己创建，并注册进去</strong></p>
<pre class="line-numbers language-csharp"><code class="language-csharp"><span class="token keyword">var</span> service <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DisposableOrderService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
services<span class="token punctuation">.</span><span class="token generic-method function">AddSingleton<span class="token punctuation">&lt;</span>IOrderService<span class="token punctuation">></span></span><span class="token punctuation">(</span>service<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>同样我们也不会得到释放的输出</p>
<p>也就是说，通过这种方式注册，<strong>容器不会管理对象的生命周期</strong></p>
<p>如何识别这个区别呢？</p>
<p>在控制器中注入 <strong>IHostApplicationLifetime</strong> 接口</p>
<p>这个接口的作用是用来管理整个应用程序的生命周期</p>
<p>它有一个方法 <strong>StopApplication</strong></p>
<p>也就是说它可以把整个应用程序关掉</p>
<p>接着，<strong>通过手工关掉的方式看一下应用程序关闭时会不会把单例对象释放掉</strong></p>
<pre class="line-numbers language-csharp"><code class="language-csharp"><span class="token punctuation">[</span>HttpGet<span class="token punctuation">]</span>
<span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">Get</span><span class="token punctuation">(</span><span class="token punctuation">[</span>FromServices<span class="token punctuation">]</span> IOrderService orderService<span class="token punctuation">,</span>
    <span class="token punctuation">[</span>FromServices<span class="token punctuation">]</span> IOrderService orderService2<span class="token punctuation">,</span>
    <span class="token punctuation">[</span>FromServices<span class="token punctuation">]</span>IHostApplicationLifetime hostApplicationLifetime<span class="token punctuation">,</span>
    <span class="token punctuation">[</span>FromQuery<span class="token punctuation">]</span><span class="token keyword">bool</span> stop <span class="token operator">=</span> <span class="token keyword">false</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">"=======1=========="</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">// HttpContext.RequestServices</span>
    <span class="token comment" spellcheck="true">// 是当前请求的一个根容器</span>
    <span class="token comment" spellcheck="true">// 应用程序根容器的一个子容器</span>
    <span class="token comment" spellcheck="true">// 每个请求会创建一个容器</span>
    <span class="token keyword">using</span> <span class="token punctuation">(</span>IServiceScope scope <span class="token operator">=</span> HttpContext<span class="token punctuation">.</span>RequestServices<span class="token punctuation">.</span><span class="token function">CreateScope</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// 在这个子容器下面再创建一个子容器来获取服务</span>
        <span class="token keyword">var</span> service <span class="token operator">=</span> scope<span class="token punctuation">.</span>ServiceProvider<span class="token punctuation">.</span><span class="token generic-method function">GetService<span class="token punctuation">&lt;</span>IOrderService<span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">var</span> service2 <span class="token operator">=</span> scope<span class="token punctuation">.</span>ServiceProvider<span class="token punctuation">.</span><span class="token generic-method function">GetService<span class="token punctuation">&lt;</span>IOrderService<span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">"=======2=========="</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>stop<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        hostApplicationLifetime<span class="token punctuation">.</span><span class="token function">StopApplication</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">"接口请求处理结束"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>首先用自己创建对象的方式</p>
<pre class="line-numbers language-csharp"><code class="language-csharp"><span class="token keyword">var</span> service <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DisposableOrderService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
services<span class="token punctuation">.</span><span class="token generic-method function">AddSingleton<span class="token punctuation">&lt;</span>IOrderService<span class="token punctuation">></span></span><span class="token punctuation">(</span>service<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>启动程序</p>
<p>输入 ?stop=true</p>
<pre><code>https://localhost:5001/weatherforecast?stop=true</code></pre><p>输出如下：</p>
<pre><code>...
DependencyInjectionScopeAndDisposableDemo.exe (进程 16884)已退出，代码为 0。
要在调试停止时自动关闭控制台，请启用“工具”-&gt;“选项”-&gt;“调试”-&gt;“调试停止时自动关闭控制台”。
按任意键关闭此窗口. . .</code></pre><p>如果单例由容器来管理，切换回普通注册方式</p>
<pre class="line-numbers language-csharp"><code class="language-csharp">services<span class="token punctuation">.</span><span class="token generic-method function">AddSingleton<span class="token punctuation">&lt;</span>IOrderService<span class="token punctuation">,</span> DisposableOrderService<span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>启动程序</p>
<p>输入 ?stop=true</p>
<pre><code>https://localhost:5001/weatherforecast?stop=true</code></pre><p>输出如下：</p>
<pre><code>Application is shutting down...
接口请求处理结束
DisposableOrderService Disposed:23399238</code></pre><p>对象释放，应用程序退出</p>
<p>这里说明<strong>单例的服务都是注册在根容器里面</strong></p>
<p><strong>根容器的释放意味着需要在整个应用程序退出时释放</strong></p>
<p>这个时候它会释放自己所管理的所有的 IDisposable 的对象</p>
<p>这里面有一个非常需要注意的坑：</p>
<p>假如把服务注册成<strong>瞬时</strong>的</p>
<pre class="line-numbers language-csharp"><code class="language-csharp">services<span class="token punctuation">.</span><span class="token generic-method function">AddTransient<span class="token punctuation">&lt;</span>IOrderService<span class="token punctuation">,</span> DisposableOrderService<span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>然后又<strong>在根容器里面去获取这个对象</strong></p>
<pre class="line-numbers language-csharp"><code class="language-csharp"><span class="token keyword">var</span> s <span class="token operator">=</span> app<span class="token punctuation">.</span>ApplicationServices<span class="token punctuation">.</span><span class="token generic-method function">GetService<span class="token punctuation">&lt;</span>IOrderService<span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>这意味着在根容器去持续的创建 IOrderService，但是<strong>由于根容器只会在应用程序整个退出时回收</strong>，也就意味着<strong>这些对象会一直积累在应用程序内</strong></p>
<p>调整控制器，不获取 IOrderService</p>
<pre class="line-numbers language-csharp"><code class="language-csharp"><span class="token punctuation">[</span>HttpGet<span class="token punctuation">]</span>
<span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">Get</span><span class="token punctuation">(</span>
    <span class="token punctuation">[</span>FromServices<span class="token punctuation">]</span>IHostApplicationLifetime hostApplicationLifetime<span class="token punctuation">,</span>
    <span class="token punctuation">[</span>FromQuery<span class="token punctuation">]</span><span class="token keyword">bool</span> stop <span class="token operator">=</span> <span class="token keyword">false</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>stop<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        hostApplicationLifetime<span class="token punctuation">.</span><span class="token function">StopApplication</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>仅仅在根容器获取一次</p>
<pre class="line-numbers language-csharp"><code class="language-csharp"><span class="token keyword">var</span> s <span class="token operator">=</span> app<span class="token punctuation">.</span>ApplicationServices<span class="token punctuation">.</span><span class="token generic-method function">GetService<span class="token punctuation">&lt;</span>IOrderService<span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>这样运行起来，每次请求（点击刷新）的话，整个输出是不会有内容的，因为我们没有在子容器里面去获取对象</p>
<p>但实际上当我们退出的时候，会发现确实有一个实例被释放掉了</p>
<pre class="line-numbers language-csharp"><code class="language-csharp">DisposableOrderService Disposed<span class="token punctuation">:</span><span class="token number">7511460</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>也就是说，<strong>实现了 IDisposable 接口的服务，如果时注册瞬时的，又在根容器去做操作，它会一直保持到应用程序退出的时候，才能够被回收掉</strong></p>
<h2 id="07-用Autofac增强容器能力：引入面向切面编程（AOP）的能力"><a href="#07-用Autofac增强容器能力：引入面向切面编程（AOP）的能力" class="headerlink" title="07 | 用Autofac增强容器能力：引入面向切面编程（AOP）的能力"></a>07 | 用Autofac增强容器能力：引入面向切面编程（AOP）的能力</h2><p>这一节讲解使用第三方框架来扩展依赖注入容器</p>
<p>什么情况下需要我们引入第三方容器组件？</p>
<p>大部分情况下，默认的容器组件足够使用</p>
<p>当需要一些非常特殊的场景如下：</p>
<ol>
<li><p>基于名称的注入：需要把一个服务按照名称来区分它的不同实现的时候</p>
</li>
<li><p>属性注入：直接把服务注册到某一个类的属性里面去，而不需要定义构造函数，比如之前的 FromService 和 构造函数入参</p>
</li>
<li><p>子容器：可以理解为之前讲过的 Scope，但实际上还可以用第三方的框架实现一些特殊的子容器</p>
</li>
<li><p>基于动态代理的 AOP：需要在服务中注入额外的行为的时候，可以用动态代理的能力</p>
</li>
</ol>
<p>.NET Core 的依赖注入框架，它的核心扩展点是 IserviceProviderFactory</p>
<p>第三方的依赖注入容器都是用了这个类来作为扩展点，把自己注入到整个框架里来</p>
<p>也就是说在使用这些依赖注入框架的时候，不需要关注说谁家的特性，谁家的接口是什么样子，只需要关注官方核心的定义就可以了，不需要直接依赖这些框架</p>
<p>服务</p>
<pre class="line-numbers language-csharp"><code class="language-csharp"><span class="token keyword">namespace</span> DependencyInjectionAutofacDemo<span class="token punctuation">.</span>Services
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">IMyService</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">void</span> <span class="token function">ShowCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyService</span> <span class="token punctuation">:</span> IMyService
    <span class="token punctuation">{</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">ShowCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span>$<span class="token string">"MyService.ShowCode:{GetHashCode()}"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyServiceV2</span> <span class="token punctuation">:</span> IMyService
    <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">/// &lt;summary></span>
        <span class="token comment" spellcheck="true">/// 用于演示属性注入的方式</span>
        <span class="token comment" spellcheck="true">/// &lt;/summary></span>
        <span class="token keyword">public</span> MyNameService NameService <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>

        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">ShowCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// 默认情况下，NameService 为空，如果注入成功，则不为空</span>
            Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span>$<span class="token string">"MyServiceV2.ShowCode:{GetHashCode()},NameService是否为空：{NameService == null}"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyNameService</span>
    <span class="token punctuation">{</span> 

    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>接下来看一下如何集成 Autofac</p>
<p>使用 Autofac 是因为它是 .NET 社区里面最老牌的容器框架之一</p>
<p>它有两个包：</p>
<ul>
<li>Autofac.Extensions.DependencyInjection</li>
<li>Autofac.Extras.DynamicProxy</li>
</ul>
<p>引入这两个包，就可以使用它来达到之前说的四种能力</p>
<p>引入这两个包后，需要在 Program 中添加一行代码</p>
<pre class="line-numbers language-csharp"><code class="language-csharp"><span class="token punctuation">.</span><span class="token function">UseServiceProviderFactory</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">AutofacServiceProviderFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>UseServiceProviderFactory 是用于注册第三方容器的入口</p>
<p>还有一个改动在 Startup 中，我们需要添加一个 ConfigureContainer 方法，它的入参是 Autofac 的 ContainerBuilder</p>
<pre class="line-numbers language-csharp"><code class="language-csharp"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">ConfigureContainer</span><span class="token punctuation">(</span>ContainerBuilder builder<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>现在有两个 ConfigureServices，一个是默认的，一个是 ConfigureContainer</p>
<p>服务注册进默认的容器之后，实际上会被 Autofac 接替，然后执行 ConfigureContainer</p>
<p>Autofac 的注册方式与之前的注册方式不同，先注册具体的实现，然后再告诉它想把它标记为哪个服务的类型，与之前的写法相反</p>
<pre class="line-numbers language-csharp"><code class="language-csharp">builder<span class="token punctuation">.</span><span class="token generic-method function">RegisterType<span class="token punctuation">&lt;</span>MyService<span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token generic-method function">As<span class="token punctuation">&lt;</span>IMyService<span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>接下来是命名注册，当需要把一个服务注册多次，并且用不同命名作为区分的时候，可以用这种方式，入参是一个服务名</p>
<pre class="line-numbers language-csharp"><code class="language-csharp">builder<span class="token punctuation">.</span><span class="token generic-method function">RegisterType<span class="token punctuation">&lt;</span>MyServiceV2<span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token generic-method function">Named<span class="token punctuation">&lt;</span>IMyService<span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token string">"service2"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>如何使用它呢？</p>
<pre class="line-numbers language-csharp"><code class="language-csharp"><span class="token keyword">public</span> ILifetimeScope AutofacContainer <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">private</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">Configure</span><span class="token punctuation">(</span>IApplicationBuilder app<span class="token punctuation">,</span> IWebHostEnvironment env<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// 注册根容器</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>AutofacContainer <span class="token operator">=</span> app<span class="token punctuation">.</span>ApplicationServices<span class="token punctuation">.</span><span class="token function">GetAutofacRoot</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// Autofac 容器获取实例的方式是一组 Resolve 方法</span>
    <span class="token keyword">var</span> service <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>AutofacContainer<span class="token punctuation">.</span><span class="token generic-method function">ResolveNamed<span class="token punctuation">&lt;</span>IMyService<span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token string">"service2"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    service<span class="token punctuation">.</span><span class="token function">ShowCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>启动程序，输出如下：</p>
<pre><code>MyServiceV2.ShowCode:61566768,NameService是否为空：True</code></pre><p>如何获取没有命名的服务呢？</p>
<pre class="line-numbers language-csharp"><code class="language-csharp"><span class="token comment" spellcheck="true">// 获取没有命名的服务，把 namd 去掉即可</span>
<span class="token keyword">var</span> servicenamed <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>AutofacContainer<span class="token punctuation">.</span><span class="token generic-method function">Resolve<span class="token punctuation">&lt;</span>IMyService<span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
servicenamed<span class="token punctuation">.</span><span class="token function">ShowCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">// Autofac 容器获取实例的方式是一组 Resolve 方法</span>
<span class="token keyword">var</span> service <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>AutofacContainer<span class="token punctuation">.</span><span class="token generic-method function">ResolveNamed<span class="token punctuation">&lt;</span>IMyService<span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token string">"service2"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
service<span class="token punctuation">.</span><span class="token function">ShowCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>启动程序，输出如下：</p>
<pre class="line-numbers language-csharp"><code class="language-csharp">MyService<span class="token punctuation">.</span>ShowCode<span class="token punctuation">:</span><span class="token number">61566768</span>
MyServiceV2<span class="token punctuation">.</span>ShowCode<span class="token punctuation">:</span><span class="token number">44407631</span><span class="token punctuation">,</span>NameService是否为空：True<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>接下来，讲解属性注入</p>
<pre class="line-numbers language-csahrp"><code class="language-csahrp">builder.RegisterType<MyNameService>();
// 只需要在注册方法加上 PropertiesAutowired 即可
builder.RegisterType<MyServiceV2>().As<IMyService>().PropertiesAutowired();<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>从服务里面获取它并且 ShowCode</p>
<pre class="line-numbers language-csharp"><code class="language-csharp"><span class="token keyword">var</span> servicenamed <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>AutofacContainer<span class="token punctuation">.</span><span class="token generic-method function">Resolve<span class="token punctuation">&lt;</span>IMyService<span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
servicenamed<span class="token punctuation">.</span><span class="token function">ShowCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>启动程序，输出如下：</p>
<pre class="line-numbers language-csharp"><code class="language-csharp">MyServiceV2<span class="token punctuation">.</span>ShowCode<span class="token punctuation">:</span><span class="token number">11318800</span><span class="token punctuation">,</span>NameService是否为空：False<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>不为空，注册成功</p>
<p>接下来，演示 AOP 场景，它指的是在不期望改变原有类的情况下，在方法执行时嵌入一些逻辑，使得可以在方法执行的切面上任意插入逻辑</p>
<pre class="line-numbers language-cshqrp"><code class="language-cshqrp">namespace DependencyInjectionAutofacDemo.Services
{
    /// <summary>
    /// IInterceptor 是 Autofac 的面向切面的最重要的一个接口，它可以把逻辑注入到方法的切面里面去
    /// </summary>
    public class MyInterceptor : IInterceptor
    {
        public void Intercept(IInvocation invocation)
        {
            // 方法执行前
            Console.WriteLine($"Intercept before,Method:{invocation.Method.Name}");
            // 具体方法的执行，如果这句话不执行，相当于把切面的方法拦截掉，让具体类的方法不执行
            invocation.Proceed();
            // 方法执行后，也就是说可以在任意的方法执行后，插入执行逻辑，并且决定原有的方法是否执行
            Console.WriteLine($"Intercept after,Method:{invocation.Method.Name}");
        }
    }
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>如何启动切面？</p>
<pre class="line-numbers language-csharp"><code class="language-csharp"><span class="token comment" spellcheck="true">// 把拦截器注册到容器里面</span>
builder<span class="token punctuation">.</span><span class="token generic-method function">RegisterType<span class="token punctuation">&lt;</span>MyInterceptor<span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">// 注册 MyServiceV2，并且允许它属性注册 （PropertiesAutowired）</span>
<span class="token comment" spellcheck="true">// 开启拦截器需要使用 InterceptedBy 方法，并且注册类型 MyInterceptor</span>
<span class="token comment" spellcheck="true">// 最后还要执行一个开关 EnableInterfaceInterceptors 允许接口拦截器</span>
builder<span class="token punctuation">.</span><span class="token generic-method function">RegisterType<span class="token punctuation">&lt;</span>MyServiceV2<span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token generic-method function">As<span class="token punctuation">&lt;</span>IMyService<span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">PropertiesAutowired</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">InterceptedBy</span><span class="token punctuation">(</span><span class="token keyword">typeof</span><span class="token punctuation">(</span>MyInterceptor<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">EnableInterfaceInterceptors</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>拦截器分两种类型，一种是接口拦截器，一种是类拦截器</p>
<p>常用的是接口拦截器，当服务类型是接口的时候，就需要使用这种方式</p>
<p>如果没有基于接口设计类，而是实现类的时候，就需要用类拦截器</p>
<p>类拦截器需要把方法设计为虚方法，这样子允许类重载的情况下，才可以拦截到具体的方法</p>
<p>启动程序，输出如下：</p>
<pre class="line-numbers language-csharp"><code class="language-csharp">Intercept before<span class="token punctuation">,</span>Method<span class="token punctuation">:</span>ShowCode
MyServiceV2<span class="token punctuation">.</span>ShowCode<span class="token punctuation">:</span><span class="token number">31780825</span><span class="token punctuation">,</span>NameService是否为空：True
Intercept after<span class="token punctuation">,</span>Method<span class="token punctuation">:</span>ShowCode
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>接下来看一下子容器的用法</p>
<pre class="line-numbers language-csharp"><code class="language-csharp"><span class="token comment" spellcheck="true">// Autofac 具备给子容器进行命名的特性，可以把以服务注入到子容器中，并且是特定命名的子容器，这就意味着在其他的子容器是获取不到这个对象的</span>
builder<span class="token punctuation">.</span><span class="token generic-method function">RegisterType<span class="token punctuation">&lt;</span>MyNameService<span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">InstancePerMatchingLifetimeScope</span><span class="token punctuation">(</span><span class="token string">"myscope"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>创建一个 myscope 的子容器</p>
<pre class="line-numbers language-csharp"><code class="language-csharp"><span class="token keyword">using</span> <span class="token punctuation">(</span><span class="token keyword">var</span> myscope <span class="token operator">=</span> AutofacContainer<span class="token punctuation">.</span><span class="token function">BeginLifetimeScope</span><span class="token punctuation">(</span><span class="token string">"myscope"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">var</span> service0 <span class="token operator">=</span> myscope<span class="token punctuation">.</span><span class="token generic-method function">Resolve<span class="token punctuation">&lt;</span>MyNameService<span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">using</span> <span class="token punctuation">(</span><span class="token keyword">var</span> scope <span class="token operator">=</span> myscope<span class="token punctuation">.</span><span class="token function">BeginLifetimeScope</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">var</span> service1 <span class="token operator">=</span> scope<span class="token punctuation">.</span><span class="token generic-method function">Resolve<span class="token punctuation">&lt;</span>MyNameService<span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">var</span> service2 <span class="token operator">=</span> scope<span class="token punctuation">.</span><span class="token generic-method function">Resolve<span class="token punctuation">&lt;</span>MyNameService<span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span>$<span class="token string">"service1=service2:{service1 == service2}"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span>$<span class="token string">"service1=service0:{service1 == service0}"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>启动程序，输出如下：</p>
<pre><code>service1=service2:True
service1=service0:True</code></pre><p>这意味着在 myscope 子容器下面，不管再创建任何子容器的生命周期，得到的都是同一个对象</p>
<p>这样子的好处是当不期望这个对象在根容器创建时，又希望它在某一定的范围内时单例模式的情况下，可以使用这种方式</p>
<h2 id="08-配置框架：让服务无缝适应各种环境"><a href="#08-配置框架：让服务无缝适应各种环境" class="headerlink" title="08 | 配置框架：让服务无缝适应各种环境"></a>08 | 配置框架：让服务无缝适应各种环境</h2><p>配置是应用程序发布到各种环境的必备能力，这一节开始详细讲解 ASP.NET Core 的配置框架</p>
<p>配置框架的核心包有两个，一个抽象包，一个实现包</p>
<ul>
<li>Microsoft.Extensions.Configuration.Abstractions</li>
<li>Microsoft.Extensions.Configuration</li>
</ul>
<p>这与依赖注入框架一样，也是使用了接口实现分离的设计模式</p>
<p>配置框架以 Key-value 字符串键值对的方式抽象了配置</p>
<p>同时还支持从各种不同的数据源读取配置，比如从命令行读取，从环境变量读取，从文件中读取</p>
<p>配置框架的核心接口有四个</p>
<ul>
<li>IConfiguration</li>
<li>IConfigurationRoot</li>
<li>IConfigurationSection</li>
<li>IConfigurationBuilder</li>
</ul>
<p>配置框架有一个核心的扩展点，就是注入自己的配置源，也就是说可以指定任意的配置的数据来源，注入到配置框架里面</p>
<ul>
<li>IConfigurationSource</li>
<li>IConfigurationProvider</li>
</ul>
<p>接下来通过一个基本的控制台应用程序从头到尾演示一个配置的构建和使用。</p>
<p>首先引入上面提到的两个包</p>
<ul>
<li>Microsoft.Extensions.Configuration.Abstractions</li>
<li>Microsoft.Extensions.Configuration</li>
</ul>
<p>接着是构建和使用</p>
<pre class="line-numbers language-csharp"><code class="language-csharp"><span class="token keyword">namespace</span> ConfigurationDemo
<span class="token punctuation">{</span>
    <span class="token keyword">class</span> <span class="token class-name">Program</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">Main</span><span class="token punctuation">(</span><span class="token keyword">string</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// ConfigurationBuilder 是用来构建配置的核心，所有设置都在 builder 中完成</span>
            IConfigurationBuilder builder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConfigurationBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// 注入一个内存的配置数据源（注入一个字典集合作为配置数据源）</span>
            builder<span class="token punctuation">.</span><span class="token function">AddInMemoryCollection</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Dictionary</span><span class="token operator">&lt;</span><span class="token keyword">string</span><span class="token punctuation">,</span> <span class="token keyword">string</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                <span class="token punctuation">{</span> <span class="token string">"key1"</span><span class="token punctuation">,</span><span class="token string">"value1"</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
                <span class="token punctuation">{</span> <span class="token string">"key2"</span><span class="token punctuation">,</span><span class="token string">"value2"</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// Build 方法用来把所有的配置构建出来，并且获得一个 configurationRoot，表示配置的根</span>
            <span class="token comment" spellcheck="true">// 也就是说读取配置的动作都需要从 IConfigurationRoot 这个对象读取的</span>
            IConfigurationRoot configurationRoot <span class="token operator">=</span> builder<span class="token punctuation">.</span><span class="token function">Build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span>configurationRoot<span class="token punctuation">[</span><span class="token string">"key1"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span>configurationRoot<span class="token punctuation">[</span><span class="token string">"key2"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>启动程序，输出如下：</p>
<pre><code>value1
value2
</code></pre><p>IConfigurationSection</p>
<pre class="line-numbers language-csharp"><code class="language-csharp"><span class="token keyword">namespace</span> ConfigurationDemo
<span class="token punctuation">{</span>
    <span class="token keyword">class</span> <span class="token class-name">Program</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">Main</span><span class="token punctuation">(</span><span class="token keyword">string</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// ConfigurationBuilder 是用来构建配置的核心，所有设置都在 builder 中完成</span>
            IConfigurationBuilder builder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConfigurationBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// 注入一个内存的配置数据源（注入一个字典集合作为配置数据源）</span>
            builder<span class="token punctuation">.</span><span class="token function">AddInMemoryCollection</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Dictionary</span><span class="token operator">&lt;</span><span class="token keyword">string</span><span class="token punctuation">,</span> <span class="token keyword">string</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                <span class="token punctuation">{</span> <span class="token string">"key1"</span><span class="token punctuation">,</span><span class="token string">"value1"</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
                <span class="token punctuation">{</span> <span class="token string">"key2"</span><span class="token punctuation">,</span><span class="token string">"value2"</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
                <span class="token punctuation">{</span> <span class="token string">"section1:key4"</span><span class="token punctuation">,</span><span class="token string">"value4"</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
                <span class="token punctuation">{</span> <span class="token string">"section2:key5"</span><span class="token punctuation">,</span><span class="token string">"value5"</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
                <span class="token punctuation">{</span> <span class="token string">"section2:key6"</span><span class="token punctuation">,</span><span class="token string">"value6"</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// Build 方法用来把所有的配置构建出来，并且获得一个 configurationRoot，表示配置的根</span>
            <span class="token comment" spellcheck="true">// 也就是说读取配置的动作都需要从 IConfigurationRoot 这个对象读取的</span>
            IConfigurationRoot configurationRoot <span class="token operator">=</span> builder<span class="token punctuation">.</span><span class="token function">Build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">//IConfiguration config = configurationRoot;</span>
            Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span>configurationRoot<span class="token punctuation">[</span><span class="token string">"key1"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span>configurationRoot<span class="token punctuation">[</span><span class="token string">"key2"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment" spellcheck="true">// section 的作用是指当配置不仅仅是简单的 Key value 的时候，比如说需要给配置分组，就可以使用 section 来定义</span>
            <span class="token comment" spellcheck="true">// section 每一节是用冒号来作为节的分隔符的</span>
            IConfigurationSection section <span class="token operator">=</span> configurationRoot<span class="token punctuation">.</span><span class="token function">GetSection</span><span class="token punctuation">(</span><span class="token string">"section1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span>$<span class="token string">"key4:{section["</span>key4<span class="token string">"]}"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span>$<span class="token string">"key5:{section["</span>key5<span class="token string">"]}"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>启动程序，输出如下：</p>
<pre><code>value1
value2
key4:value4
key5:</code></pre><p>section1 的 key5 没有值</p>
<p>打印一下 section2 的 key5</p>
<pre class="line-numbers language-csharp"><code class="language-csharp">IConfigurationSection section2 <span class="token operator">=</span> configurationRoot<span class="token punctuation">.</span><span class="token function">GetSection</span><span class="token punctuation">(</span><span class="token string">"section2"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span>$<span class="token string">"key5_v2:{section2["</span>key5<span class="token string">"]}"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>启动程序，输出如下：</p>
<pre><code>key5_v2:value5</code></pre><p>多级嵌套</p>
<pre><code>{ "section2:section3:key7","value7" }</code></pre><p>打印输出</p>
<pre class="line-numbers language-csharp"><code class="language-csharp"><span class="token keyword">var</span> section3 <span class="token operator">=</span> section2<span class="token punctuation">.</span><span class="token function">GetSection</span><span class="token punctuation">(</span><span class="token string">"section3"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span>$<span class="token string">"key7:{section3["</span>key7<span class="token string">"]}"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>启动程序，输出如下：</p>
<pre><code>key7:value7</code></pre><p>这样做的好处是：一方面避免一个服务重复注册，也可以控制一个服务需要注册不同的实现</p>
<h2 id="09-命令行配置提供程序：最简单快捷的配置注入方法"><a href="#09-命令行配置提供程序：最简单快捷的配置注入方法" class="headerlink" title="09 | 命令行配置提供程序：最简单快捷的配置注入方法"></a>09 | 命令行配置提供程序：最简单快捷的配置注入方法</h2><p>这一节讲解如何使用命令行参数来作为配置数据源</p>
<p>命令行配置（提供程序的）支持三种格式的命令</p>
<ol>
<li>无前缀的 key=value 模式</li>
<li>双中横线模式 –key=value 或 –key value</li>
<li>正横杠模式 /key=value 或 /key value</li>
</ol>
<p>备注：等号分隔符和空格分隔符不能混用</p>
<p>命令替换模式：为命令参数提供别名</p>
<ol>
<li>必须以单横杠(-)或双横杠(–)开头</li>
<li>映射字典不能包含重复 Key</li>
</ol>
<p>首先引入三个包</p>
<ul>
<li>Microsoft.Extensions.Configuration.Abstractions</li>
<li>Microsoft.Extensions.Configuration</li>
<li>Microsoft.Extensions.Configuration.CommandLine</li>
</ul>
<p>主程序</p>
<pre class="line-numbers language-csharp"><code class="language-csharp"><span class="token keyword">namespace</span> ConfigurationCommandLineDemo
<span class="token punctuation">{</span>
    <span class="token keyword">class</span> <span class="token class-name">Program</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">Main</span><span class="token punctuation">(</span><span class="token keyword">string</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token keyword">var</span> builder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConfigurationBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment" spellcheck="true">// 把入参传递给命令行参提供程序</span>
            builder<span class="token punctuation">.</span><span class="token function">AddCommandLine</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">var</span> configurationRoot <span class="token operator">=</span> builder<span class="token punctuation">.</span><span class="token function">Build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span>$<span class="token string">"CommandLineKey1:{configurationRoot["</span>CommandLineKey1<span class="token string">"]}"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span>$<span class="token string">"CommandLineKey2:{configurationRoot["</span>CommandLineKey2<span class="token string">"]}"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            Console<span class="token punctuation">.</span><span class="token function">ReadKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>项目右键属性，设置调试模式启动时的命令参数</p>
<pre class="line-numbers language-csharp"><code class="language-csharp">CommandLineKey1<span class="token operator">=</span>value1 <span class="token operator">--</span>CommandLineKey2<span class="token operator">=</span>value2 <span class="token operator">/</span>CommandLineKey3<span class="token operator">=</span>value3 <span class="token operator">--</span>k1<span class="token operator">=</span>k3<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>也可以通过文件编辑，launchSettings.json</p>
<pre class="line-numbers language-csharp"><code class="language-csharp"><span class="token punctuation">{</span>
  <span class="token string">"profiles"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
    <span class="token string">"ConfigurationCommandLineDemo"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
      <span class="token string">"commandName"</span><span class="token punctuation">:</span> <span class="token string">"Project"</span><span class="token punctuation">,</span>
      <span class="token string">"commandLineArgs"</span><span class="token punctuation">:</span> <span class="token string">"CommandLineKey1=value1 --CommandLineKey2=value2 /CommandLineKey3=value3 --k1=k3"</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>启动程序，输出如下：</p>
<pre class="line-numbers language-csharp"><code class="language-csharp">CommandLineKey1<span class="token punctuation">:</span>value1
CommandLineKey2<span class="token punctuation">:</span>value2<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>接着是命令替换</p>
<pre class="line-numbers language-csharp"><code class="language-csharp"><span class="token keyword">namespace</span> ConfigurationCommandLineDemo
<span class="token punctuation">{</span>
    <span class="token keyword">class</span> <span class="token class-name">Program</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">Main</span><span class="token punctuation">(</span><span class="token keyword">string</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token keyword">var</span> builder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConfigurationBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment" spellcheck="true">//// 把入参传递给命令行参提供程序</span>
            <span class="token comment" spellcheck="true">//builder.AddCommandLine(args);</span>

            <span class="token preprocessor property">#<span class="token directive keyword">region</span> 命令替换</span>
            <span class="token keyword">var</span> mapper <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Dictionary</span><span class="token operator">&lt;</span><span class="token keyword">string</span><span class="token punctuation">,</span> <span class="token keyword">string</span><span class="token operator">></span> <span class="token punctuation">{</span> <span class="token punctuation">{</span> <span class="token string">"-k1"</span><span class="token punctuation">,</span> <span class="token string">"CommandLineKey1"</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
            builder<span class="token punctuation">.</span><span class="token function">AddCommandLine</span><span class="token punctuation">(</span>args<span class="token punctuation">,</span> mapper<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token preprocessor property">#<span class="token directive keyword">endregion</span></span>

            <span class="token keyword">var</span> configurationRoot <span class="token operator">=</span> builder<span class="token punctuation">.</span><span class="token function">Build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span>$<span class="token string">"CommandLineKey1:{configurationRoot["</span>CommandLineKey1<span class="token string">"]}"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span>$<span class="token string">"CommandLineKey2:{configurationRoot["</span>CommandLineKey2<span class="token string">"]}"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            Console<span class="token punctuation">.</span><span class="token function">ReadKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>将双横杠 –k1=k3 改为 单横杠 -k1=k3</p>
<pre><code>{
  "profiles": {
    "ConfigurationCommandLineDemo": {
      "commandName": "Project",
      "commandLineArgs": "CommandLineKey1=value1 --CommandLineKey2=value2 /CommandLineKey3=value3 -k1=k3"
    }
  }
}</code></pre><p>启动程序，输出如下：</p>
<pre><code>CommandLineKey1:k3
CommandLineKey2:value2</code></pre><p>可以看出，-k1 替换了 CommandLineKey1 里面的值</p>
<p>这个场景是用来做什么的？</p>
<p>实际上可以看一下 .NET 自己的命令行工具</p>
<p>打开控制台，输入 dotnet –help</p>
<pre><code>sdk-options:
  -d|--diagnostics  启用诊断输出。
  -h|--help         显示命令行帮助。
  --info            显示 .NET Core 信息。
  --list-runtimes   显示安装的运行时。
  --list-sdks       显示安装的 SDK。
  --version         显示使用中的 .NET Core SDK 版本。</code></pre><p>这里可以看到 options 支持双横杠长命名和单横杠的短命名</p>
<p>实际上最典型的场景就是给应用的命令行参数提供了一个短命名快捷命名的方式，比如说 -h 就可以替换 –help</p>
<h2 id="10-环境变量配置提供程序：容器环境下配置注入的最佳途径"><a href="#10-环境变量配置提供程序：容器环境下配置注入的最佳途径" class="headerlink" title="10 | 环境变量配置提供程序：容器环境下配置注入的最佳途径"></a>10 | 环境变量配置提供程序：容器环境下配置注入的最佳途径</h2><p>环境变量的配置提供程序主要适应场景：</p>
<ol>
<li>在 Docker 中运行时</li>
<li>在 Kubernetes 中运行时</li>
<li>需要设置 ASP.NET Core 的一些内置特殊配置时</li>
</ol>
<p>环境变量和命令行这两个提供程序在早期是没有容器化的，当时一个操作系统会跑多个应用程序，应用程序注入配置的方式一般都是通过文件或者是命令行的方式来注入的，环境变量当时用的比较少</p>
<p>现在在容器化的环境下，有了 Docker 的隔离能力，就意味着每一个应用程序都相当于跑在一个小型的操作系统下面一样，所以说这个时候 Docker 提供的环境隔离能力让我们可以使用环境变量来配置应用程序，在 Docker 和 Kubernetes 中，会大量使用环境变量，而不是使用命令行来配置基础配置</p>
<p>环境变量的配置有如下特点：</p>
<ol>
<li>对于配置的分层键，支持使用双下横线 “__” 代替 “:”</li>
<li>支持根据前缀加载</li>
</ol>
<p>在某些操作系统，比如说 Linux 下面，冒号作为环境变量的 Key 值是不行的，所以说这里支持用双下划线来代替冒号，也就是说当遇到双下划线的环境变量时，可以认为这是一个分层键</p>
<p>环境变量提供程序还支持根据环境变量的前缀来加载</p>
<p>接下来是代码演示：</p>
<p>首先引入三个包</p>
<ul>
<li>Microsoft.Extensions.Configuration.Abstractions</li>
<li>Microsoft.Extensions.Configuration</li>
<li>Microsoft.Extensions.Configuration.EnvironmentVariables</li>
</ul>
<p>然后看一下环境变量如何在调试环境下注入</p>
<p>右键项目，属性，调试，环境变量</p>
<p><img src="https://cdn.jsdelivr.net/gh/shw2018/cdn@1.0/sakura/img/loader/orange.progress-bar-stripe-loader.svg" data-original="https://img2018.cnblogs.com/blog/1412316/202002/1412316-20200227005129677-597064997.jpg" alt=""></p>
<p>同样的在 Properties 下的 launchSettings.json 可以看到配置</p>
<pre><code>{
  "profiles": {
    "ConfigurationEnvironmentVariablesDemo": {
      "commandName": "Project",
      "environmentVariables": {
        "KEY1": "value1",
        "KEY2": "value2",
        "SECTION1__KEY3": "value3",
        "SECTION1__SECTION2__KEY4": "value4",
        "XIAO_KEY1": "xiao key1"
      }
    }
  }
}</code></pre><p>主程序</p>
<pre class="line-numbers language-csharp"><code class="language-csharp"><span class="token keyword">namespace</span> ConfigurationEnvironmentVariablesDemo
<span class="token punctuation">{</span>
    <span class="token keyword">class</span> <span class="token class-name">Program</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">Main</span><span class="token punctuation">(</span><span class="token keyword">string</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token keyword">var</span> builder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConfigurationBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            builder<span class="token punctuation">.</span><span class="token function">AddEnvironmentVariables</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">var</span> configurationRoot <span class="token operator">=</span> builder<span class="token punctuation">.</span><span class="token function">Build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span>$<span class="token string">"key1:{configurationRoot["</span>key1<span class="token string">"]}"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>启动程序，输出如下：</p>
<pre><code>key1:value1</code></pre><p>分层键</p>
<pre class="line-numbers language-csharp"><code class="language-csharp"><span class="token comment" spellcheck="true">// "SECTION1__KEY3": "value3"</span>
<span class="token comment" spellcheck="true">// 我们定义了一个分层键 SECTION1，用双下划线隔开，这个 section 下面有一个 KEY3 的 Key</span>
<span class="token keyword">var</span> section <span class="token operator">=</span> configurationRoot<span class="token punctuation">.</span><span class="token function">GetSection</span><span class="token punctuation">(</span><span class="token string">"SECTION1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span>$<span class="token string">"KEY3:{section["</span>KEY3<span class="token string">"]}"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>启动程序，输出如下：</p>
<pre><code>KEY3:value3</code></pre><p>多级分层键</p>
<pre class="line-numbers language-csharp"><code class="language-csharp"><span class="token comment" spellcheck="true">// "SECTION1__SECTION2__KEY4": "value4"</span>
<span class="token keyword">var</span> section2 <span class="token operator">=</span> configurationRoot<span class="token punctuation">.</span><span class="token function">GetSection</span><span class="token punctuation">(</span><span class="token string">"SECTION1:SECTION2"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span>$<span class="token string">"KEY4:{section2["</span>KEY4<span class="token string">"]}"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>启动程序，输出如下：</p>
<pre><code>KEY4:value4</code></pre><p>前缀过滤：是指在注入环境变量的时候，指定一个前缀，意味着只注入指定前缀的环境变量，而不是把整个操作系统的所有环境变量注入进去</p>
<pre class="line-numbers language-csharp"><code class="language-csharp"><span class="token comment" spellcheck="true">// "XIAO_KEY1": "xiao key1"</span>
<span class="token comment" spellcheck="true">// build 之后把读取到的环境变量的前缀去掉</span>
builder<span class="token punctuation">.</span><span class="token function">AddEnvironmentVariables</span><span class="token punctuation">(</span><span class="token string">"XIAO_"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> configurationRoot <span class="token operator">=</span> builder<span class="token punctuation">.</span><span class="token function">Build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span>$<span class="token string">"KEY1:{configurationRoot["</span>KEY1<span class="token string">"]}"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">// "KEY2": "value2"</span>
<span class="token comment" spellcheck="true">// 在注入的时候，凡是没有 XIAO_ 开头的 Key 都没有注入进来，仅注册进来需要的一个环境变量值</span>
<span class="token comment" spellcheck="true">// 适合当需要加载特定的值，去掉系统其他值的干扰项的场景使用</span>
Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span>$<span class="token string">"KEY2:{configurationRoot["</span>KEY2<span class="token string">"]}"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>启动程序，输出如下：</p>
<pre><code>KEY1:xiao key1
KEY2:value2</code></pre><h2 id="11-文件配置提供程序：自由选择配置的格式"><a href="#11-文件配置提供程序：自由选择配置的格式" class="headerlink" title="11 | 文件配置提供程序：自由选择配置的格式"></a>11 | 文件配置提供程序：自由选择配置的格式</h2><p>文件配置提供程序</p>
<ul>
<li>Microsoft.Extensions.Configuration.Ini</li>
<li>Microsoft.Extensions.Configuration.Json</li>
<li>Microsoft.Extensions.Configuration.NewtonsoftJson</li>
<li>Microsoft.Extensions.Configuration.Xml</li>
<li>Microsoft.Extensions.Configuration.UserSecrets</li>
</ul>
<p>这些都是读取不同文件的格式，或者从不同的位置来读取文件</p>
<p>文件提供程序支持</p>
<ul>
<li>文件是否可选</li>
<li>监视文件的变更</li>
</ul>
<p>下面通过代码来了解这些特性</p>
<p>引用以下四个包：</p>
<ul>
<li>Microsoft.Extensions.Configuration</li>
<li>Microsoft.Extensions.Configuration.Abstractions</li>
<li>Microsoft.Extensions.Configuration.Ini</li>
<li>Microsoft.Extensions.Configuration.Json</li>
</ul>
<p>读取 appsettings.json</p>
<pre><code>{
  "Key1": "Value1",
  "Key2": "Value2"
}</code></pre><p>主程序</p>
<pre class="line-numbers language-csharp"><code class="language-csharp"><span class="token keyword">var</span> builder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConfigurationBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
builder<span class="token punctuation">.</span><span class="token function">AddJsonFile</span><span class="token punctuation">(</span><span class="token string">"appsettings.json"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> configurationRoot <span class="token operator">=</span> builder<span class="token punctuation">.</span><span class="token function">Build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span>$<span class="token string">"Key1:{configurationRoot["</span>Key1<span class="token string">"]}"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span>$<span class="token string">"Key2:{configurationRoot["</span>Key2<span class="token string">"]}"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span>$<span class="token string">"Key3:{configurationRoot["</span>Key3<span class="token string">"]}"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
Console<span class="token punctuation">.</span><span class="token function">ReadKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>启动程序，输出如下：</p>
<pre><code>Key1:Value1
Key2:Value2
Key3:</code></pre><p>Key3 不存在，所以他的值是空的</p>
<p>文件是否可选是它的第二个参数 optional，默认情况下是 false</p>
<pre class="line-numbers language-csharp"><code class="language-csharp">builder<span class="token punctuation">.</span><span class="token function">AddJsonFile</span><span class="token punctuation">(</span><span class="token string">"appsettings.json"</span><span class="token punctuation">,</span> optional<span class="token punctuation">:</span><span class="token keyword">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>这意味当文件不存在的时候它会报错</p>
<p>它的另一个参数是 reloadOnChange， 默认情况下是 true</p>
<pre class="line-numbers language-sharp"><code class="language-sharp">builder.AddJsonFile("appsettings.json", optional:false, reloadOnChange:true);<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>这意味着每次文件变更，它会去读取新文件</p>
<p>接下来看一下 appsettings.ini</p>
<pre><code>Key3=Value3 in ini</code></pre><p>主程序</p>
<pre class="line-numbers language-csharp"><code class="language-csharp"><span class="token keyword">var</span> builder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConfigurationBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
builder<span class="token punctuation">.</span><span class="token function">AddJsonFile</span><span class="token punctuation">(</span><span class="token string">"appsettings.json"</span><span class="token punctuation">,</span> optional<span class="token punctuation">:</span><span class="token keyword">false</span><span class="token punctuation">,</span> reloadOnChange<span class="token punctuation">:</span><span class="token keyword">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
builder<span class="token punctuation">.</span><span class="token function">AddIniFile</span><span class="token punctuation">(</span><span class="token string">"appsettings.ini"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> configurationRoot <span class="token operator">=</span> builder<span class="token punctuation">.</span><span class="token function">Build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span>$<span class="token string">"Key1:{configurationRoot["</span>Key1<span class="token string">"]}"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span>$<span class="token string">"Key2:{configurationRoot["</span>Key2<span class="token string">"]}"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span>$<span class="token string">"Key3:{configurationRoot["</span>Key3<span class="token string">"]}"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
Console<span class="token punctuation">.</span><span class="token function">ReadKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>启动程序，输出如下：</p>
<pre class="line-numbers language-csharp"><code class="language-csharp">Key1<span class="token punctuation">:</span>Value1
Key2<span class="token punctuation">:</span>Value2
Key3<span class="token punctuation">:</span>Value3 <span class="token keyword">in</span> ini<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>这里可以看到新添加的配置已经生效</p>
<p>builder 中添加配置源是有顺序关系的，后添加的配置会覆盖先添加的配置</p>
<h2 id="12-配置变更监听：配置热更新能力的核心"><a href="#12-配置变更监听：配置热更新能力的核心" class="headerlink" title="12 | 配置变更监听：配置热更新能力的核心"></a>12 | 配置变更监听：配置热更新能力的核心</h2><p>这一节讲解如何使用代码来监视配置变化并做出一些动作</p>
<p>当我们需要追踪配置发生的变化，可以在变化发生时执行一些特定的操作</p>
<p>配置主要提供了一个 GetReloadToken 方法，这就是跟踪配置的关键方法</p>
<p>接着使用上一节的代码</p>
<pre class="line-numbers language-csharp"><code class="language-csharp"><span class="token keyword">var</span> builder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConfigurationBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
builder<span class="token punctuation">.</span><span class="token function">AddJsonFile</span><span class="token punctuation">(</span><span class="token string">"appsettings.json"</span><span class="token punctuation">,</span> optional<span class="token punctuation">:</span><span class="token keyword">true</span><span class="token punctuation">,</span> reloadOnChange<span class="token punctuation">:</span><span class="token keyword">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> configurationRoot <span class="token operator">=</span> builder<span class="token punctuation">.</span><span class="token function">Build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

IChangeToken token <span class="token operator">=</span> configurationRoot<span class="token punctuation">.</span><span class="token function">GetReloadToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>IChangeToken 有两个属性和一个方法</p>
<pre class="line-numbers language-csharp"><code class="language-csharp"><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">IChangeToken</span>
<span class="token punctuation">{</span>
    <span class="token keyword">bool</span> HasChanged <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>

    <span class="token keyword">bool</span> ActiveChangeCallbacks <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>

    IDisposable <span class="token function">RegisterChangeCallback</span><span class="token punctuation">(</span>Action<span class="token operator">&lt;</span><span class="token keyword">object</span><span class="token operator">></span> callback<span class="token punctuation">,</span> <span class="token keyword">object</span> state<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>接着注册 Callback</p>
<pre class="line-numbers language-csharp"><code class="language-csharp">token<span class="token punctuation">.</span><span class="token function">RegisterChangeCallback</span><span class="token punctuation">(</span>state <span class="token operator">=</span><span class="token operator">></span>
<span class="token punctuation">{</span>
    Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span>$<span class="token string">"Key1:{configurationRoot["</span>Key1<span class="token string">"]}"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span>$<span class="token string">"Key2:{configurationRoot["</span>Key2<span class="token string">"]}"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span>$<span class="token string">"Key3:{configurationRoot["</span>Key3<span class="token string">"]}"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> configurationRoot<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>启动程序，修改配置文件，触发 Callback</p>
<p>多次修改配置文件没有效果？</p>
<p>因为 IChangeToken 这个对象只能使用一次，也就是说捕获到变更并且执行代码之后，需要再重新获取一个新的 IChangeToken，再次注册</p>
<pre class="line-numbers language-csharp"><code class="language-csharp">token<span class="token punctuation">.</span><span class="token function">RegisterChangeCallback</span><span class="token punctuation">(</span>state <span class="token operator">=</span><span class="token operator">></span>
<span class="token punctuation">{</span>
    Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span>$<span class="token string">"Key1:{configurationRoot["</span>Key1<span class="token string">"]}"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span>$<span class="token string">"Key2:{configurationRoot["</span>Key2<span class="token string">"]}"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span>$<span class="token string">"Key3:{configurationRoot["</span>Key3<span class="token string">"]}"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    token <span class="token operator">=</span> configurationRoot<span class="token punctuation">.</span><span class="token function">GetReloadToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    token<span class="token punctuation">.</span><span class="token function">RegisterChangeCallback</span><span class="token punctuation">(</span>state2 <span class="token operator">=</span><span class="token operator">></span>
    <span class="token punctuation">{</span>
        Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> configurationRoot<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> configurationRoot<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这将变成一个无限循环的过程，微软实际上提供了一个比较方便使用的快捷的扩展方法，这个方法可以帮助我们轻松地处理这件事，也就意味着每次触发完成以后可以重新绑定</p>
<pre><code>ChangeToken.OnChange(() =&gt; configurationRoot.GetReloadToken(), () =&gt;
{
    Console.WriteLine($"Key1:{configurationRoot["Key1"]}");
    Console.WriteLine($"Key2:{configurationRoot["Key2"]}");
    Console.WriteLine($"Key3:{configurationRoot["Key3"]}");
});
</code></pre><p>第一个参数是获取 IChangeToken 的方法</p>
<p>第二个参数是处理变更的注入方法</p>
<p>启动程序，修改配置文件，多次触发 Callback</p>
<h2 id="13-配置绑定：使用强类型对象承载配置数据"><a href="#13-配置绑定：使用强类型对象承载配置数据" class="headerlink" title="13 | 配置绑定：使用强类型对象承载配置数据"></a>13 | 配置绑定：使用强类型对象承载配置数据</h2><p>要点：</p>
<ol>
<li><p>支持将配置值绑定到已有对象</p>
</li>
<li><p>支持将配置值绑定到私有属性上</p>
</li>
</ol>
<p>继续使用上一节代码</p>
<p>首先定义一个类作为接收配置的实例</p>
<pre class="line-numbers language-csharp"><code class="language-csharp"><span class="token keyword">class</span> <span class="token class-name">Config</span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">string</span> Key1 <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">bool</span> Key5 <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">int</span> Key6 <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span>  <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>接着看一下配置文件，appsettings.json</p>
<pre><code>{
  "Key1": "Value1",
  "Key2": "Value2",
  "Key5": true,
  "Key6": 0
}</code></pre><p>新增一个引用包</p>
<ul>
<li>Microsoft.Extensions.Configuration.Binder</li>
</ul>
<p>这个包的作用就是让我们能够很方便的把配置绑定到强类型上面去</p>
<p>主程序</p>
<pre class="line-numbers language-csharp"><code class="language-csharp"><span class="token keyword">var</span> builder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConfigurationBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
builder<span class="token punctuation">.</span><span class="token function">AddJsonFile</span><span class="token punctuation">(</span><span class="token string">"appsettings.json"</span><span class="token punctuation">,</span> optional<span class="token punctuation">:</span><span class="token keyword">true</span><span class="token punctuation">,</span> reloadOnChange<span class="token punctuation">:</span><span class="token keyword">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> configurationRoot <span class="token operator">=</span> builder<span class="token punctuation">.</span><span class="token function">Build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> config <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Config</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    Key1 <span class="token operator">=</span> <span class="token string">"config key1"</span><span class="token punctuation">,</span>
    Key5 <span class="token operator">=</span> <span class="token keyword">false</span><span class="token punctuation">,</span>
    Key6 <span class="token operator">=</span> <span class="token number">100</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

configurationRoot<span class="token punctuation">.</span><span class="token function">Bind</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span><span class="token punctuation">;</span>

Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span>$<span class="token string">"Key1:{config.Key1}"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span>$<span class="token string">"Key5:{config.Key5}"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span>$<span class="token string">"Key6:{config.Key6}"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>启动程序，输出如下：</p>
<pre><code>Key1:Value1
Key5:True
Key6:0</code></pre><p>可以看出，绑定的字段都是从配置中读出来的</p>
<p>实际上通常意义来讲，配置文件不会这么简单，一般都是有嵌套格式</p>
<pre><code>{
  "Key2": "Value2",
  "Key6": 0,
  "OrderService": {
    "Key1": "order key1",
    "Key5": true,
    "Key6": 200
  }
}</code></pre><p>在这种情形下，需要把 section 绑定给 config 对象</p>
<pre class="line-numbers language-csharp"><code class="language-csharp">configurationRoot<span class="token punctuation">.</span><span class="token function">GetSection</span><span class="token punctuation">(</span><span class="token string">"OrderService"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Bind</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>这样就可以对不同的配置进行分组，并且分别绑定，避免配置混在一起</p>
<p>启动程序，输出如下：</p>
<pre><code>Key1:order key1
Key5:True
Key6:200</code></pre><p>也就是说可以从任意的节来读取配置，并且绑定到类型上面</p>
<p>这里定义的所有类型，所有的字段都是 public，但有一些场景下面可能是 private，对于私有的字段，默认情况下，是不会去绑定的，也不允许赋默认值，可以在定义时设置</p>
<pre class="line-numbers language-csharp"><code class="language-csharp"><span class="token keyword">class</span> <span class="token class-name">Config</span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">string</span> Key1 <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">bool</span> Key5 <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">int</span> Key6 <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">private</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token number">100</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>主程序</p>
<pre class="line-numbers language-csharp"><code class="language-csharp"><span class="token keyword">var</span> config <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Config</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    Key1 <span class="token operator">=</span> <span class="token string">"config key1"</span><span class="token punctuation">,</span>
    Key5 <span class="token operator">=</span> <span class="token keyword">false</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

configurationRoot<span class="token punctuation">.</span><span class="token function">GetSection</span><span class="token punctuation">(</span><span class="token string">"OrderService"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Bind</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>启动程序，输出如下：</p>
<pre><code>Key1:order key1
Key5:True
Key6:100</code></pre><p>可以看到 Key6 的值是100，没有发生变化，而配置中的值是200</p>
<p>要让私有变量生效，实际上 Bind 还有另外一个参数</p>
<pre class="line-numbers language-csharp"><code class="language-csharp">configurationRoot<span class="token punctuation">.</span><span class="token function">GetSection</span><span class="token punctuation">(</span><span class="token string">"OrderService"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Bind</span><span class="token punctuation">(</span>config<span class="token punctuation">,</span>
                binderOptions <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span> binderOptions<span class="token punctuation">.</span>BindNonPublicProperties <span class="token operator">=</span> <span class="token keyword">true</span><span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>启动程序，输出如下：</p>
<pre><code>Key1:order key1
Key5:True
Key6:200</code></pre><p>这样一来，私有字段也都可以从配置里面赋值了</p>
<h2 id="14-自定义配置数据源：低成本实现定制化配置方案"><a href="#14-自定义配置数据源：低成本实现定制化配置方案" class="headerlink" title="14 | 自定义配置数据源：低成本实现定制化配置方案"></a>14 | 自定义配置数据源：低成本实现定制化配置方案</h2><p>这一节讲解如何定义自己的数据源，来扩展配置框架</p>
<p>扩展步骤</p>
<ol>
<li>实现 IConfigurationSource</li>
<li>实现 IConfigurationProvider</li>
<li>实现 AddXXX 扩展方法，用来作为注入的快捷方式</li>
</ol>
<p>首先定义一个 MyConfigurationSource</p>
<pre class="line-numbers language-csharp"><code class="language-csharp"><span class="token keyword">namespace</span> ConfigurationCustom
<span class="token punctuation">{</span>
    <span class="token keyword">class</span> <span class="token class-name">MyConfigurationSource</span> <span class="token punctuation">:</span> IConfigurationSource
    <span class="token punctuation">{</span>
        <span class="token keyword">public</span> IConfigurationProvider <span class="token function">Build</span><span class="token punctuation">(</span>IConfigurationBuilder builder<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">MyConfigurationProvider</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>接着是 MyConfigurationProvider</p>
<pre class="line-numbers language-csharp"><code class="language-csharp"><span class="token keyword">namespace</span> ConfigurationCustom
<span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// ConfigurationProvider 集成自 IConfigurationProvider</span>
    <span class="token keyword">class</span> <span class="token class-name">MyConfigurationProvider</span> <span class="token punctuation">:</span> ConfigurationProvider
    <span class="token punctuation">{</span>

        Timer timer<span class="token punctuation">;</span>

        <span class="token keyword">public</span> <span class="token function">MyConfigurationProvider</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token keyword">base</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// 用一个线程模拟配置发生变化，每三秒钟执行一次，告诉我们要重新加载配置</span>
            timer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Timer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            timer<span class="token punctuation">.</span>Elapsed <span class="token operator">+</span><span class="token operator">=</span> Timer_Elapsed<span class="token punctuation">;</span>
            timer<span class="token punctuation">.</span>Interval <span class="token operator">=</span> <span class="token number">3000</span><span class="token punctuation">;</span>
            timer<span class="token punctuation">.</span><span class="token function">Start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">Timer_Elapsed</span><span class="token punctuation">(</span><span class="token keyword">object</span> sender<span class="token punctuation">,</span> ElapsedEventArgs e<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token function">Load</span><span class="token punctuation">(</span><span class="token keyword">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">public</span> <span class="token keyword">override</span> <span class="token keyword">void</span> <span class="token function">Load</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token function">Load</span><span class="token punctuation">(</span><span class="token keyword">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">/// &lt;summary></span>
        <span class="token comment" spellcheck="true">/// 加载数据</span>
        <span class="token comment" spellcheck="true">/// &lt;/summary></span>
        <span class="token comment" spellcheck="true">/// &lt;param name="reload">是否重新加载数据&lt;/param></span>
        <span class="token keyword">void</span> <span class="token function">Load</span><span class="token punctuation">(</span><span class="token keyword">bool</span> reload<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// Data 表示 Key-value 数据，这是由 ConfigurationProvider 提供的一个数据承载的集合</span>
            <span class="token comment" spellcheck="true">// 我们把最新的时间填充进去</span>
            Data<span class="token punctuation">[</span><span class="token string">"lastTime"</span><span class="token punctuation">]</span> <span class="token operator">=</span> DateTime<span class="token punctuation">.</span>Now<span class="token punctuation">.</span><span class="token function">ToString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>reload<span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                <span class="token keyword">base</span><span class="token punctuation">.</span><span class="token function">OnReload</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>实际上到此扩展就已经完成了，可以通过 builder.AddXXX 这个方法来把 source 注入进来</p>
<pre class="line-numbers language-csharp"><code class="language-csharp"><span class="token keyword">namespace</span> ConfigurationCustom
<span class="token punctuation">{</span>
    <span class="token keyword">class</span> <span class="token class-name">Program</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">Main</span><span class="token punctuation">(</span><span class="token keyword">string</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token keyword">var</span> builder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConfigurationBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            builder<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">MyConfigurationSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">var</span> configRoot <span class="token operator">=</span> builder<span class="token punctuation">.</span><span class="token function">Build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span>$<span class="token string">"lastTime:{configRoot["</span>lastTime<span class="token string">"]}"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            Console<span class="token punctuation">.</span><span class="token function">ReadKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>启动程序，输出如下：</p>
<pre><code>lastTime:2020/3/1 22:39:36</code></pre><p>这里可以看到，输出最新的时间</p>
<p>但是如果这样去分发配置源的包的话，需要把 MyConfigurationSource<br>定义为 public，否则使用方式没办法引用到这个类</p>
<p>那么就可以通过扩展方法的方式来保障不需要暴露 ConfigSource</p>
<p>定义一个扩展方法 AddMyConfiguration</p>
<pre class="line-numbers language-csharp"><code class="language-csharp"><span class="token keyword">namespace</span> Microsoft<span class="token punctuation">.</span>Extensions<span class="token punctuation">.</span>Configuration
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">MyConfigurationBuilderExtensions</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">public</span> <span class="token keyword">static</span> IConfigurationBuilder <span class="token function">AddMyConfiguration</span><span class="token punctuation">(</span><span class="token keyword">this</span> IConfigurationBuilder builder<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            builder<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">MyConfigurationSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> builder<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>首先把扩展方法的命名空间放在 config 的命名空间，而不是自己的命名空间，这样方便在引用的时候直接使用而无需加载具体的命名空间</p>
<p>另外一个可以把 Provider 定义为 internal 的，默认是 internal，如果说分发到第三方的话，internal 的类是不能被引用的，这样就意味着只需要暴露一个扩展方法，而不需要暴露具体的配置源的实现</p>
<pre class="line-numbers language-csharp"><code class="language-csharp"><span class="token keyword">class</span> <span class="token class-name">MyConfigurationProvider</span> <span class="token punctuation">:</span> ConfigurationProvider<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>如何使用呢，其实很简单</p>
<p>只需要在 builder.Add 的时候使用 builder.AddMyConfiguration 就可以了，这样达到的效果是一样的</p>
<pre class="line-numbers language-csharp"><code class="language-csharp"><span class="token keyword">namespace</span> ConfigurationCustom
<span class="token punctuation">{</span>
    <span class="token keyword">class</span> <span class="token class-name">Program</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">Main</span><span class="token punctuation">(</span><span class="token keyword">string</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token keyword">var</span> builder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConfigurationBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">//builder.Add(new MyConfigurationSource());</span>
            builder<span class="token punctuation">.</span><span class="token function">AddMyConfiguration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">var</span> configRoot <span class="token operator">=</span> builder<span class="token punctuation">.</span><span class="token function">Build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span>$<span class="token string">"lastTime:{configRoot["</span>lastTime<span class="token string">"]}"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            Console<span class="token punctuation">.</span><span class="token function">ReadKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>启动程序，输出如下：</p>
<pre><code>lastTime:2020/3/1 22:55:11</code></pre><p>在定义扩展的时候，都推荐这样去做，把具体实现都定义为私有的，然后通过扩展方法的方式暴露出去</p>
<p>刚才实际上还定义了一个 timer 来模拟配置的变更，这里可以监听一下它的变更，看是否生效</p>
<p>上一节讲到 ChangeToken 的方式，这里还是用 ChangeToken 的 OnChange 方法</p>
<pre class="line-numbers language-csharp"><code class="language-csharp"><span class="token keyword">namespace</span> ConfigurationCustom
<span class="token punctuation">{</span>
    <span class="token keyword">class</span> <span class="token class-name">Program</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">Main</span><span class="token punctuation">(</span><span class="token keyword">string</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token keyword">var</span> builder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConfigurationBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            builder<span class="token punctuation">.</span><span class="token function">AddMyConfiguration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">var</span> configRoot <span class="token operator">=</span> builder<span class="token punctuation">.</span><span class="token function">Build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            ChangeToken<span class="token punctuation">.</span><span class="token function">OnChange</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> configRoot<span class="token punctuation">.</span><span class="token function">GetReloadToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span>
            <span class="token punctuation">{</span>
                Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span>$<span class="token string">"lastTime:{configRoot["</span>lastTime<span class="token string">"]}"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">"开始了"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            Console<span class="token punctuation">.</span><span class="token function">ReadKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>启动程序，输出如下：</p>
<pre class="line-numbers language-csharp"><code class="language-csharp">开始了
lastTime<span class="token punctuation">:</span><span class="token number">2020</span><span class="token operator">/</span><span class="token number">3</span><span class="token operator">/</span><span class="token number">1</span> <span class="token number">22</span><span class="token punctuation">:</span><span class="token number">59</span><span class="token punctuation">:</span><span class="token number">25</span>
lastTime<span class="token punctuation">:</span><span class="token number">2020</span><span class="token operator">/</span><span class="token number">3</span><span class="token operator">/</span><span class="token number">1</span> <span class="token number">22</span><span class="token punctuation">:</span><span class="token number">59</span><span class="token punctuation">:</span><span class="token number">28</span>
lastTime<span class="token punctuation">:</span><span class="token number">2020</span><span class="token operator">/</span><span class="token number">3</span><span class="token operator">/</span><span class="token number">1</span> <span class="token number">22</span><span class="token punctuation">:</span><span class="token number">59</span><span class="token punctuation">:</span><span class="token number">31</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>每个三秒钟输出一次，这说明我们定义的配置变更的通知已经生效了</p>
<p>MyConfigurationProvider 中我们只是通过赋值一个 DateTime 来模拟配置源</p>
<p>实际上可以从远程来说，比如阿波罗的配置中心，Kazoo，这些地方远程的读取配置，结合着命令行和环境变量配置，就可以完成配置中心的远程方案，意味着可以版本化的管理配置</p>
<p>这样子在 Docker 容器环境下面，Kubernetes 环境下面，就可以有完善的配置管理解决方案</p>
<h2 id="15-选项框架：服务组件集成配置的最佳实践"><a href="#15-选项框架：服务组件集成配置的最佳实践" class="headerlink" title="15 | 选项框架：服务组件集成配置的最佳实践"></a>15 | 选项框架：服务组件集成配置的最佳实践</h2><p>这一节讲解如何使用选项框架来处理服务和配置的关系</p>
<p>选项框架的特性：</p>
<ol>
<li>支持单例模式读取配置</li>
<li>支持快照</li>
<li>支持配置变更通知</li>
<li>支持运行时动态修改选项值</li>
</ol>
<p>在设计系统的时候需要遵循两个原则：</p>
<ol>
<li>接口分离原则（ISP），我们的类不应该依赖它不使用的配置</li>
<li>关注点分离（SoC），不同组件、服务、类之间的配置不应相互依赖或耦合</li>
</ol>
<p>建议：</p>
<ol>
<li>为我们的服务设计 XXXOptions</li>
<li>使用 IOptions、IOptionsSnapshot、IOptionsMonitor作为服务构造函数的参数</li>
</ol>
<p>这样会让我们更快的实现服务配置的各种能力</p>
<p>在定义服务的时候，一般先定义服务接口</p>
<pre class="line-numbers language-csharp"><code class="language-csharp"><span class="token keyword">namespace</span> OptionsDemo<span class="token punctuation">.</span>Services
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">IOrderService</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">int</span> <span class="token function">ShowMaxOrderCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OrderService</span> <span class="token punctuation">:</span> IOrderService
    <span class="token punctuation">{</span>
        OrderServiceOptions _options<span class="token punctuation">;</span>

        <span class="token keyword">public</span> <span class="token function">OrderService</span><span class="token punctuation">(</span>OrderServiceOptions options<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            _options <span class="token operator">=</span> options<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">ShowMaxOrderCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token keyword">return</span> _options<span class="token punctuation">.</span>MaxOrderCount<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">// 代表从配置中读取的值</span>
    <span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OrderServiceOptions</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">public</span> <span class="token keyword">int</span> MaxOrderCount <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token number">100</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>接着是服务注册</p>
<pre class="line-numbers language-csharp"><code class="language-csharp"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">ConfigureServices</span><span class="token punctuation">(</span>IServiceCollection services<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    services<span class="token punctuation">.</span><span class="token generic-method function">AddSingleton<span class="token punctuation">&lt;</span>OrderServiceOptions<span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    services<span class="token punctuation">.</span><span class="token generic-method function">AddSingleton<span class="token punctuation">&lt;</span>IOrderService<span class="token punctuation">,</span> OrderService<span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>接着是控制器的定义</p>
<pre class="line-numbers language-csharp"><code class="language-csharp"><span class="token punctuation">[</span>HttpGet<span class="token punctuation">]</span>
<span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">Get</span><span class="token punctuation">(</span><span class="token punctuation">[</span>FromServices<span class="token punctuation">]</span>IOrderService orderService<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span>$<span class="token string">"orderService.ShowMaxOrderCount:{orderService.ShowMaxOrderCount()}"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>启动程序，输出如下：</p>
<pre><code>orderService.ShowMaxOrderCount:100</code></pre><p>如果说我们需要把这个值跟配置绑定，怎么做呢？</p>
<p>首先需要引入 Options 框架</p>
<p>ASP.NET Core 实际上已经默认帮我们把框架引入进来了</p>
<p>命名空间是：Microsoft.Extensions.Options</p>
<p>我们需要修改一下服务的入参</p>
<pre class="line-numbers language-csharp"><code class="language-csharp"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OrderService</span> <span class="token punctuation">:</span> IOrderService
<span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">//OrderServiceOptions _options;</span>
    IOptions<span class="token operator">&lt;</span>OrderServiceOptions<span class="token operator">></span> _options<span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">//public OrderService(OrderServiceOptions options)</span>
    <span class="token keyword">public</span> <span class="token function">OrderService</span><span class="token punctuation">(</span>IOptions<span class="token operator">&lt;</span>OrderServiceOptions<span class="token operator">></span> options<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        _options <span class="token operator">=</span> options<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">ShowMaxOrderCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">//return _options.MaxOrderCount;</span>
        <span class="token keyword">return</span> _options<span class="token punctuation">.</span>Value<span class="token punctuation">.</span>MaxOrderCount<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>注册的时候使用 config 方法，从配置文件读取</p>
<pre class="line-numbers language-csharp"><code class="language-csharp"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">ConfigureServices</span><span class="token punctuation">(</span>IServiceCollection services<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">//services.AddSingleton&lt;OrderServiceOptions>();</span>
    services<span class="token punctuation">.</span><span class="token generic-method function">Configure<span class="token punctuation">&lt;</span>OrderServiceOptions<span class="token punctuation">></span></span><span class="token punctuation">(</span>Configuration<span class="token punctuation">.</span><span class="token function">GetSection</span><span class="token punctuation">(</span><span class="token string">"OrderService"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    services<span class="token punctuation">.</span><span class="token generic-method function">AddSingleton<span class="token punctuation">&lt;</span>IOrderService<span class="token punctuation">,</span> OrderService<span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>配置文件</p>
<pre><code>{
  "OrderService": {
    "MaxOrderCount": 200
  }
}
</code></pre><p>启动程序，输出如下：</p>
<pre><code>orderService.ShowMaxOrderCount:200</code></pre><p>可以看到，输出的值为200，说明配置与选项已经完成绑定</p>
<p>服务只依赖了 OrderServiceOptions，并没有依赖配置框架，也就是说服务只关心配置的值是什么，它并不关心配置的值从哪里来，解除了配置与服务之间的依赖</p>
<p>另外可以为所有的服务分别设计它们的 Options，这样服务之间的选项配置也都不会互相依赖</p>
<h2 id="16-选项数据热更新：让服务感知配置的变化"><a href="#16-选项数据热更新：让服务感知配置的变化" class="headerlink" title="16 | 选项数据热更新：让服务感知配置的变化"></a>16 | 选项数据热更新：让服务感知配置的变化</h2><p>选项框架还有两个关键类型：</p>
<ol>
<li>IOptionsMonitor</li>
<li>IOptionsSnapshot</li>
</ol>
<p>场景：</p>
<ol>
<li>范围作用域类型使用 IOptinsSnapshot</li>
<li>单例服务使用 IOptionsMonitor</li>
</ol>
<p>通过代码更新选项：</p>
<p><strong>IPostConfigureOptions</strong></p>
<p>延续上一节的代码，但是做一些特殊处理，之前注册 Order 服务用的是单例模式，这里改为 Scoped 模式</p>
<pre class="line-numbers language-csharp"><code class="language-csharp"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">ConfigureServices</span><span class="token punctuation">(</span>IServiceCollection services<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    services<span class="token punctuation">.</span><span class="token generic-method function">Configure<span class="token punctuation">&lt;</span>OrderServiceOptions<span class="token punctuation">></span></span><span class="token punctuation">(</span>Configuration<span class="token punctuation">.</span><span class="token function">GetSection</span><span class="token punctuation">(</span><span class="token string">"OrderService"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">//services.AddSingleton&lt;IOrderService, OrderService>();</span>
    services<span class="token punctuation">.</span><span class="token generic-method function">AddScoped<span class="token punctuation">&lt;</span>IOrderService<span class="token punctuation">,</span> OrderService<span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    services<span class="token punctuation">.</span><span class="token function">AddControllers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>service 还是使用 IOptions</p>
<pre class="line-numbers language-csharp"><code class="language-csharp"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OrderService</span> <span class="token punctuation">:</span> IOrderService
<span class="token punctuation">{</span>
    IOptions<span class="token operator">&lt;</span>OrderServiceOptions<span class="token operator">></span> _options<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token function">OrderService</span><span class="token punctuation">(</span>IOptions<span class="token operator">&lt;</span>OrderServiceOptions<span class="token operator">></span> options<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        _options <span class="token operator">=</span> options<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">ShowMaxOrderCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">return</span> _options<span class="token punctuation">.</span>Value<span class="token punctuation">.</span>MaxOrderCount<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>启动程序，输出如下：</p>
<pre><code>orderService.ShowMaxOrderCount:200</code></pre><p>修改配置</p>
<pre><code>{
    "OrderService": {
    "MaxOrderCount": 2000
  }
}</code></pre><p>启动程序，输出如下：</p>
<pre><code>orderService.ShowMaxOrderCount:200</code></pre><p>输出值还是200</p>
<p>那么如何能够读到新的配置呢？</p>
<p>只需要把 IOptions 换成 IOptionsSnapshot 即可</p>
<pre class="line-numbers language-csharp"><code class="language-csharp">IOptionsSnapshot<span class="token operator">&lt;</span>OrderServiceOptions<span class="token operator">></span> _options<span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token function">OrderService</span><span class="token punctuation">(</span>IOptionsSnapshot<span class="token operator">&lt;</span>OrderServiceOptions<span class="token operator">></span> options<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这是因为我们的服务注册的是 Scoped 模式，并且使用 Snapshot 来读取配置，每次请求都会重新计算并读取配置</p>
<p>那如果我们的服务是单例的时候怎么办呢？</p>
<p>把服务注册改为单例模式</p>
<pre class="line-numbers language-csharp"><code class="language-csharp">services<span class="token punctuation">.</span><span class="token generic-method function">AddSingleton<span class="token punctuation">&lt;</span>IOrderService<span class="token punctuation">,</span> OrderService<span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>这里需要使用另一个接口，把 Snapshot 改为 Monitor</p>
<pre class="line-numbers language-csharp"><code class="language-csharp">IOptionsMonitor<span class="token operator">&lt;</span>OrderServiceOptions<span class="token operator">></span> _options<span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token function">OrderService</span><span class="token punctuation">(</span>IOptionsMonitor<span class="token operator">&lt;</span>OrderServiceOptions<span class="token operator">></span> options<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>Monitor 与 Snapshot 的定义略微有些不同，它获取值是需要用 CurrentValue 字段</p>
<pre class="line-numbers language-csharp"><code class="language-csharp"><span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">ShowMaxOrderCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">return</span> _options<span class="token punctuation">.</span>CurrentValue<span class="token punctuation">.</span>MaxOrderCount<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>启动程序，修改配置文件，刷新浏览器，可以看到输出了修改后的数据，也就是说单例对象同时也能读取到最新的配置</p>
<p>如果说我想知道配置的值发生变化并且通知到我的 Options 怎么做呢？</p>
<p>首先看一下 Monitor 的定义</p>
<pre class="line-numbers language-csharp"><code class="language-csharp"><span class="token keyword">namespace</span> Microsoft<span class="token punctuation">.</span>Extensions<span class="token punctuation">.</span>Options
<span class="token punctuation">{</span>
  <span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">IOptionsMonitor</span><span class="token operator">&lt;</span><span class="token keyword">out</span> TOptions<span class="token operator">></span>
  <span class="token punctuation">{</span>

    TOptions CurrentValue <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>

    TOptions <span class="token function">Get</span><span class="token punctuation">(</span><span class="token keyword">string</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>

    IDisposable <span class="token function">OnChange</span><span class="token punctuation">(</span>Action<span class="token operator">&lt;</span>TOptions<span class="token punctuation">,</span> <span class="token keyword">string</span><span class="token operator">></span> listener<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>它有一个 OnChange 方法，也就是说可以监听它的变更</p>
<pre class="line-numbers language-csharp"><code class="language-csharp"><span class="token keyword">public</span> <span class="token function">OrderService</span><span class="token punctuation">(</span>IOptionsMonitor<span class="token operator">&lt;</span>OrderServiceOptions<span class="token operator">></span> options<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    _options <span class="token operator">=</span> options<span class="token punctuation">;</span>

    _options<span class="token punctuation">.</span><span class="token function">OnChange</span><span class="token punctuation">(</span>option <span class="token operator">=</span><span class="token operator">></span>
    <span class="token punctuation">{</span>
        Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span>$<span class="token string">"配置更新了，最新的值是:{_options.CurrentValue.MaxOrderCount}"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>启动程序，修改配置，可以看到输出配置变化，也就是说可以在单例模式下监听到 Options 的变化</p>
<p>通常情况下，在设计服务的时候，会在 ConfigureServices 添加配置注入、服务注入，但是当配置多起来的时候，注入代码就会非常多</p>
<p>那么如何使代码结构更加良好？</p>
<p>实际上可以<strong>把服务注册的代码放在静态扩展方法里</strong>，使得 ConfigureServices 更加简洁</p>
<pre class="line-numbers language-csharp"><code class="language-csharp"><span class="token keyword">namespace</span> Microsoft<span class="token punctuation">.</span>Extensions<span class="token punctuation">.</span>DependencyInjection
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">OrderServiceExtensions</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">public</span> <span class="token keyword">static</span> IServiceCollection <span class="token function">AddOrderService</span><span class="token punctuation">(</span><span class="token keyword">this</span> IServiceCollection services<span class="token punctuation">,</span>IConfiguration configuration<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>

            services<span class="token punctuation">.</span><span class="token generic-method function">Configure<span class="token punctuation">&lt;</span>OrderServiceOptions<span class="token punctuation">></span></span><span class="token punctuation">(</span>configuration<span class="token punctuation">)</span><span class="token punctuation">;</span>
            services<span class="token punctuation">.</span><span class="token generic-method function">AddSingleton<span class="token punctuation">&lt;</span>IOrderService<span class="token punctuation">,</span> OrderService<span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> services<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这样在 Startup 的注册就变得更为简单了</p>
<pre class="line-numbers language-csharp"><code class="language-csharp">services<span class="token punctuation">.</span><span class="token function">AddOrderService</span><span class="token punctuation">(</span>Configuration<span class="token punctuation">.</span><span class="token function">GetSection</span><span class="token punctuation">(</span><span class="token string">"OrderService"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>我们在设计系统的时候会涉及大量的 service，所以我们可以把 service 的注册提炼在扩展方法里，不同的模块用不同的扩展方法隔开，使模块之间更加清晰，代码的结构也更加的清晰</p>
<p>那么实际上我们在设计服务的时候，还有一些特殊的述求，比如说把配置读取出来之后，还需要在内存里面进行一些特殊的处理，我们就可以使用动态配置的方式</p>
<p>动态配置的方式是在我们的 Configure 的代码之后，调用 PostConfigure 的方法，这里需要配置 OrderServiceOptions</p>
<pre class="line-numbers language-csharp"><code class="language-csharp"><span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">OrderServiceExtensions</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">public</span> <span class="token keyword">static</span> IServiceCollection <span class="token function">AddOrderService</span><span class="token punctuation">(</span><span class="token keyword">this</span> IServiceCollection services<span class="token punctuation">,</span>IConfiguration configuration<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>

            services<span class="token punctuation">.</span><span class="token generic-method function">Configure<span class="token punctuation">&lt;</span>OrderServiceOptions<span class="token punctuation">></span></span><span class="token punctuation">(</span>configuration<span class="token punctuation">)</span><span class="token punctuation">;</span>

            services<span class="token punctuation">.</span><span class="token generic-method function">PostConfigure<span class="token punctuation">&lt;</span>OrderServiceOptions<span class="token punctuation">></span></span><span class="token punctuation">(</span>options <span class="token operator">=</span><span class="token operator">></span>
            <span class="token punctuation">{</span>
                options<span class="token punctuation">.</span>MaxOrderCount <span class="token operator">+</span><span class="token operator">=</span> <span class="token number">20</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            services<span class="token punctuation">.</span><span class="token generic-method function">AddSingleton<span class="token punctuation">&lt;</span>IOrderService<span class="token punctuation">,</span> OrderService<span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> services<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>启动程序，可以看到输出动态增加了20</p>
<h2 id="17-为选项数据添加验证：避免错误配置的应用接收用户流量"><a href="#17-为选项数据添加验证：避免错误配置的应用接收用户流量" class="headerlink" title="17 | 为选项数据添加验证：避免错误配置的应用接收用户流量"></a>17 | 为选项数据添加验证：避免错误配置的应用接收用户流量</h2><p>三种验证方法</p>
<ol>
<li>直接注册验证函数</li>
<li>实现 IValidateOptions</li>
<li>使用 Microsoft.Extensions.Options.DataAnnotations</li>
</ol>
<p>延用上一节代码</p>
<p>需要添加验证的时候不能用 Configure，而用 AddOptions 方法</p>
<pre class="line-numbers language-csharp"><code class="language-csharp"><span class="token comment" spellcheck="true">//services.Configure&lt;OrderServiceOptions>(configuration);</span>

services<span class="token punctuation">.</span><span class="token generic-method function">AddOptions<span class="token punctuation">&lt;</span>OrderServiceOptions<span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Configure</span><span class="token punctuation">(</span>options <span class="token operator">=</span><span class="token operator">></span>
<span class="token punctuation">{</span>
    configuration<span class="token punctuation">.</span><span class="token function">Bind</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Validate</span><span class="token punctuation">(</span>options <span class="token operator">=</span><span class="token operator">></span>
<span class="token punctuation">{</span>
    <span class="token keyword">return</span> options<span class="token punctuation">.</span>MaxOrderCount <span class="token operator">&lt;=</span> <span class="token number">100</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">"MaxOrderCount 不能大于100"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>配置中的值是200，所以运行之后报错，提示 “MaxOrderCount 不能大于100”</p>
<p>接着使用属性的方式，切换成属性注入</p>
<pre class="line-numbers language-csharp"><code class="language-csharp">services<span class="token punctuation">.</span><span class="token generic-method function">AddOptions<span class="token punctuation">&lt;</span>OrderServiceOptions<span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Configure</span><span class="token punctuation">(</span>options <span class="token operator">=</span><span class="token operator">></span>
<span class="token punctuation">{</span>
    configuration<span class="token punctuation">.</span><span class="token function">Bind</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ValidateDataAnnotations</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>还需要修改 OrderServiceOptions，定义它的验证属性</p>
<pre class="line-numbers language-csharp"><code class="language-csharp"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OrderServiceOptions</span>
<span class="token punctuation">{</span>
  <span class="token punctuation">[</span><span class="token function">Range</span><span class="token punctuation">(</span><span class="token number">30</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
  <span class="token keyword">public</span> <span class="token keyword">int</span> MaxOrderCount <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token number">100</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>配置中的值是200，所以运行之后报错，提示 “MaxOrderCount 的值必须在30到100之间”</p>
<p>接着是第三种方式，实现接口的方式</p>
<p>首先是定义验证类</p>
<pre class="line-numbers language-cshar"><code class="language-cshar">public class OrderServiceValidateOptions : IValidateOptions<OrderServiceOptions>
{
    public ValidateOptionsResult Validate(string name, OrderServiceOptions options)
    {
        if (options.MaxOrderCount > 100)
        {
            return ValidateOptionsResult.Fail("MaxOrderCount 不能大于100");
        }
        else
        {
            return ValidateOptionsResult.Success;
        }
    }
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>要使用这个类，需要注入进去</p>
<pre class="line-numbers language-csharp"><code class="language-csharp">services<span class="token punctuation">.</span><span class="token generic-method function">AddOptions<span class="token punctuation">&lt;</span>OrderServiceOptions<span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Configure</span><span class="token punctuation">(</span>options <span class="token operator">=</span><span class="token operator">></span>
<span class="token punctuation">{</span>
    configuration<span class="token punctuation">.</span><span class="token function">Bind</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span>Services<span class="token punctuation">.</span>AddSingleton<span class="token operator">&lt;</span>IValidateOptions<span class="token operator">&lt;</span>OrderServiceOptions<span class="token operator">></span><span class="token operator">></span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">OrderServiceValidateOptions</span><span class="token punctuation">(</span> <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>配置中的值是200，所以运行之后报错，提示 “MaxOrderCount 不能大于100”</p>
<p>总结一下，通过添加选项的验证，可以在配置错误的情况下阻止应用程序启动，这样就可以避免用户流量达到错误的节点上。</p>
<h2 id="18-日志框架：聊聊记日志的最佳姿势"><a href="#18-日志框架：聊聊记日志的最佳姿势" class="headerlink" title="18 | 日志框架：聊聊记日志的最佳姿势"></a>18 | 日志框架：聊聊记日志的最佳姿势</h2><p>日志框架必要的包：</p>
<ol>
<li>Microsoft.Extensions.Logging</li>
<li>Microsoft.Extensions.Logging.Console</li>
<li>Microsoft.Extensions.Logging.Debug</li>
<li>Microsoft.Extensions.Logging.TraceSource</li>
</ol>
<p>代码通过一个控制台程序，展示从读取配置到整个日志的记录器的构造和日志记录的过程<br>首先从文件读取配置</p>
<pre class="line-numbers language-csharp"><code class="language-csharp">IConfigurationBuilder configBuilder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConfigurationBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
configBuilder<span class="token punctuation">.</span><span class="token function">AddJsonFile</span><span class="token punctuation">(</span><span class="token string">"appsettings.json"</span><span class="token punctuation">,</span> optional<span class="token punctuation">:</span> <span class="token keyword">false</span><span class="token punctuation">,</span> reloadOnChange<span class="token punctuation">:</span> <span class="token keyword">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> config <span class="token operator">=</span> configBuilder<span class="token punctuation">.</span><span class="token function">Build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>接着构造容器，注入对象</p>
<pre class="line-numbers language-csharp"><code class="language-csharp">IServiceCollection serviceCollection <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ServiceCollection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// 构造容器</span>
<span class="token comment" spellcheck="true">// 用工厂模式将配置对象注册到容器管理</span>
<span class="token comment" spellcheck="true">// 注入的时候使用了一个委托，意味着容器可以帮我们管理这个对象的生命周期</span>
serviceCollection<span class="token punctuation">.</span><span class="token generic-method function">AddSingleton<span class="token punctuation">&lt;</span>IConfiguration<span class="token punctuation">></span></span><span class="token punctuation">(</span>p <span class="token operator">=</span><span class="token operator">></span> config<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">// 如果将实例直接注入，容器不会帮我们管理</span>
<span class="token comment" spellcheck="true">//serviceCollection.AddSingleton&lt;IConfiguration>(config);</span>

<span class="token comment" spellcheck="true">// AddLogging 往容器里面注册了几个关键对象：</span>
<span class="token comment" spellcheck="true">// ILoggerFactory，泛型模板 typeof (ILogger&lt;>)，Logger 的过滤配置 IConfigureOptions&lt;LoggerFilterOptions></span>
<span class="token comment" spellcheck="true">// 最后一行，configure((ILoggingBuilder) new LoggingBuilder(services)); 就是整个注入我们的委托</span>
serviceCollection<span class="token punctuation">.</span><span class="token function">AddLogging</span><span class="token punctuation">(</span>builder <span class="token operator">=</span><span class="token operator">></span>
<span class="token punctuation">{</span>
    builder<span class="token punctuation">.</span><span class="token function">AddConfiguration</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span><span class="token function">GetSection</span><span class="token punctuation">(</span><span class="token string">"Logging"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// 注册 Logging 配置的 Section</span>
    builder<span class="token punctuation">.</span><span class="token function">AddConsole</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// 先使用一个 Console 的日志输出提供程序</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>AddLogging 源码</p>
<pre class="line-numbers language-csharp"><code class="language-csharp"><span class="token keyword">public</span> <span class="token keyword">static</span> IServiceCollection <span class="token function">AddLogging</span><span class="token punctuation">(</span>
      <span class="token keyword">this</span> IServiceCollection services<span class="token punctuation">,</span>
      Action<span class="token operator">&lt;</span>ILoggingBuilder<span class="token operator">></span> configure<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>services <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ArgumentNullException</span><span class="token punctuation">(</span><span class="token function">nameof</span> <span class="token punctuation">(</span>services<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  services<span class="token punctuation">.</span><span class="token function">AddOptions</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  services<span class="token punctuation">.</span><span class="token function">TryAdd</span><span class="token punctuation">(</span>ServiceDescriptor<span class="token punctuation">.</span><span class="token generic-method function">Singleton<span class="token punctuation">&lt;</span>ILoggerFactory<span class="token punctuation">,</span> LoggerFactory<span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  services<span class="token punctuation">.</span><span class="token function">TryAdd</span><span class="token punctuation">(</span>ServiceDescriptor<span class="token punctuation">.</span><span class="token function">Singleton</span><span class="token punctuation">(</span><span class="token keyword">typeof</span> <span class="token punctuation">(</span>ILogger<span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">typeof</span> <span class="token punctuation">(</span>Logger<span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  services<span class="token punctuation">.</span><span class="token function">TryAddEnumerable</span><span class="token punctuation">(</span>ServiceDescriptor<span class="token punctuation">.</span>Singleton<span class="token operator">&lt;</span>IConfigureOptions<span class="token operator">&lt;</span>LoggerFilterOptions<span class="token operator">></span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">(</span>IConfigureOptions<span class="token operator">&lt;</span>LoggerFilterOptions<span class="token operator">></span><span class="token punctuation">)</span> <span class="token keyword">new</span> <span class="token class-name">DefaultLoggerLevelConfigureOptions</span><span class="token punctuation">(</span>LogLevel<span class="token punctuation">.</span>Information<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">configure</span><span class="token punctuation">(</span><span class="token punctuation">(</span>ILoggingBuilder<span class="token punctuation">)</span> <span class="token keyword">new</span> <span class="token class-name">LoggingBuilder</span><span class="token punctuation">(</span>services<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> services<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>配置文件，appsettings.json</p>
<pre><code>{
  "Logging": {
    "LogLevel": {
      "Default": "Debug",
      "Microsoft": "Warning",
      "Microsoft.Hosting.Lifetime": "Information"
    },
    "Console": {
      "LogLevel": {
        "Default": "Information",
        "Program": "Trace",
        "alogger": "Trace",
        "LoggingSimpleDemo.OrderService": "None"
      }
    }
  }
}</code></pre><p>Logging 里面定义了 Log 的级别，Key 代表 Log 的名称，Value 代表 Logger 的级别</p>
<p>Console 是指针对 Console 的输出提供程序配置的日志级别</p>
<p>下面看一下日志级别的定义，按照严重程度从低到高</p>
<pre class="line-numbers language-csharp"><code class="language-csharp"><span class="token keyword">namespace</span> Microsoft<span class="token punctuation">.</span>Extensions<span class="token punctuation">.</span>Logging
<span class="token punctuation">{</span>
  <span class="token keyword">public</span> <span class="token keyword">enum</span> LogLevel
  <span class="token punctuation">{</span>
    Trace<span class="token punctuation">,</span>
    Debug<span class="token punctuation">,</span>
    Information<span class="token punctuation">,</span>
    Warning<span class="token punctuation">,</span>
    Error<span class="token punctuation">,</span>
    Critical<span class="token punctuation">,</span>
    None<span class="token punctuation">,</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>也就是说我们可以指定日志输出的最低级别</p>
<p>接着 BuildServiceProvider，从容器里面获取 ILoggerFactory</p>
<pre class="line-numbers language-csharp"><code class="language-csharp">IServiceProvider service <span class="token operator">=</span> serviceCollection<span class="token punctuation">.</span><span class="token function">BuildServiceProvider</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
ILoggerFactory loggerFactory <span class="token operator">=</span> service<span class="token punctuation">.</span><span class="token generic-method function">GetService<span class="token punctuation">&lt;</span>ILoggerFactory<span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>ILoggerFactory 的定义</p>
<pre class="line-numbers language-csharp"><code class="language-csharp"><span class="token keyword">namespace</span> Microsoft<span class="token punctuation">.</span>Extensions<span class="token punctuation">.</span>Logging
<span class="token punctuation">{</span>
  <span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">ILoggerFactory</span> <span class="token punctuation">:</span> IDisposable
  <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// 输入的名称是 Logger 的名称，输出的结果是一个 ILogger 的对象，代表日志记录器</span>
    ILogger <span class="token function">CreateLogger</span><span class="token punctuation">(</span><span class="token keyword">string</span> categoryName<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// 这个方法通常不会用到它，因为通常情况下注册容器提供程序会在 AddLogging 委托里面去注册，而不会用 AddProvider 方法</span>
    <span class="token keyword">void</span> <span class="token function">AddProvider</span><span class="token punctuation">(</span>ILoggerProvider provider<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>获取到 ILoggerFactory 之后就可以创建日志记录器</p>
<pre class="line-numbers language-csharp"><code class="language-csharp">ILogger alogger <span class="token operator">=</span> loggerFactory<span class="token punctuation">.</span><span class="token function">CreateLogger</span><span class="token punctuation">(</span><span class="token string">"alogger"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

alogger<span class="token punctuation">.</span><span class="token function">LogDebug</span><span class="token punctuation">(</span><span class="token number">2001</span><span class="token punctuation">,</span> <span class="token string">"aiya"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
alogger<span class="token punctuation">.</span><span class="token function">LogInformation</span><span class="token punctuation">(</span><span class="token string">"hello"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> ex <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Exception</span><span class="token punctuation">(</span><span class="token string">"出错了"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
alogger<span class="token punctuation">.</span><span class="token function">LogError</span><span class="token punctuation">(</span>ex<span class="token punctuation">,</span> <span class="token string">"出错了"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>因为配置文件中 alogger 的级别是 Trace</p>
<pre><code>"alogger": "Trace",</code></pre><p>所以这三行都会被打印出来</p>
<p>启动程序，输出如下：</p>
<pre><code>dbug: alogger[2001]
      aiya
info: alogger[0]
      hello
fail: alogger[0]
      出错了
System.Exception: 出错了</code></pre><p>方括号的内容是 EventID，也就是针对每一个记录的位置事件，可以为它分配一个事件 ID，代码中在 LogDebug 的时候定义了一个事件 ID 是2001</p>
<p>假如说把 alogger 的日志级别调整成 Information</p>
<pre><code>"alogger": "Information",</code></pre><p>那么 Debug 级别的信息没有输出的</p>
<pre><code>info: alogger[0]
      hello
fail: alogger[0]
      出错了
System.Exception: 出错了</code></pre><p>除了使用 CreateLogger 指定 logger 的名称，实际上还可以借助容器来构造 logger，通常情况下我们会定义自己的类</p>
<pre class="line-numbers language-csharp"><code class="language-csharp"><span class="token keyword">namespace</span> LoggingSimpleDemo
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OrderService</span>
    <span class="token punctuation">{</span>
        ILogger<span class="token operator">&lt;</span>OrderService<span class="token operator">></span> _logger<span class="token punctuation">;</span>

        <span class="token keyword">public</span> <span class="token function">OrderService</span><span class="token punctuation">(</span>ILogger<span class="token operator">&lt;</span>OrderService<span class="token operator">></span> logger<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            _logger <span class="token operator">=</span> logger<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">Show</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            _logger<span class="token punctuation">.</span><span class="token function">LogInformation</span><span class="token punctuation">(</span><span class="token string">"Show Time{time}"</span><span class="token punctuation">,</span> DateTime<span class="token punctuation">.</span>Now<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>接着，将 OrderService 注入到容器中</p>
<pre class="line-numbers language-csharp"><code class="language-csharp">serviceCollection<span class="token punctuation">.</span><span class="token generic-method function">AddTransient<span class="token punctuation">&lt;</span>OrderService<span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
IServiceProvider service <span class="token operator">=</span> serviceCollection<span class="token punctuation">.</span><span class="token function">BuildServiceProvider</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> order <span class="token operator">=</span> service<span class="token punctuation">.</span><span class="token generic-method function">GetService<span class="token punctuation">&lt;</span>OrderService<span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
order<span class="token punctuation">.</span><span class="token function">Show</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>日志级别设置为 Trace</p>
<pre><code>"LoggingSimpleDemo.OrderService": "Trace"</code></pre><p>启动程序，输出如下：</p>
<pre><code>info: LoggingSimpleDemo.OrderService[0]
      Show Time03/06/2020 23:41:38</code></pre><p>这样做的意义是什么呢？</p>
<p>通常情况下并不会用 ILoggerFactory 来构造日志记录器，而是用强类型的这种依赖注入的方式来去管理我们的日志，也就是说用构造函数将泛型的 ILogger 注入进来的方式</p>
<p>这样的方式有个好处就是我们不需要去为 logger 定义名字，它会默认将我们类型的名称作为记录器的名字，命名空间加上类名 LoggingSimpleDemo.OrderService ，那也就是可以在配置文件里面设置日志级别</p>
<pre><code>"LoggingSimpleDemo.OrderService": "None"</code></pre><p>这样子就没有输出</p>
<p>这里面有一个小技巧，需要大家特别注意，就是当我们在记录日志的时候，尽量使用模板的方式</p>
<pre class="line-numbers language-csharp"><code class="language-csharp">_logger<span class="token punctuation">.</span><span class="token function">LogInformation</span><span class="token punctuation">(</span><span class="token string">"Show Time{time}"</span><span class="token punctuation">,</span> DateTime<span class="token punctuation">.</span>Now<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>以下两种方式效果相同，但是字符串拼接的时机不同</p>
<pre class="line-numbers language-csharp"><code class="language-csharp">_logger<span class="token punctuation">.</span><span class="token function">LogInformation</span><span class="token punctuation">(</span><span class="token string">"Show Time{time}"</span><span class="token punctuation">,</span> DateTime<span class="token punctuation">.</span>Now<span class="token punctuation">)</span><span class="token punctuation">;</span>
_logger<span class="token punctuation">.</span><span class="token function">LogInformation</span><span class="token punctuation">(</span>$<span class="token string">"Show Time{DateTime.Now}"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>第一行代码是在我们决定要输出的时候，也就是在 LogInformation 内部 console 要输出的时候才做拼接的动作</p>
<p>第二行代码是指我们在字符串拼接好以后，输入给了 LogInformation</p>
<p>如果我们把日志级别关掉</p>
<pre class="line-numbers language-csharp"><code class="language-csharp"><span class="token string">"LoggingSimpleDemo.OrderService"</span><span class="token punctuation">:</span> <span class="token string">"None"</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>两行代码都不会有输出，但是第一行代码字符串拼接的动作不会执行，第二行代码已经执行了，第一行代码节省了运行资源</p>
<p>另外一个就是，在记录日志的时候，不要把敏感信息记录到日志中，记录日志的目的是为了调试或者定位问题</p>
<p>总结一下</p>
<ol>
<li>日志级别定义</li>
</ol>
<p>日志级别会从严重程度的低到高定义，可以决定输出的最低级别</p>
<ol start="2">
<li>日志对象获取</li>
</ol>
<p>可以通过 ILoggerFactory 的方式获取日志对象，对它指定一个名字，也可以通过 ILogger 泛型的模式，从容器中获取日志对象，最推荐的就是强类型的泛型模式</p>
<ol start="3">
<li>日志过滤的配置逻辑</li>
</ol>
<p>可以针对 logger 的名称来进行任意的配置，日志的开关以及日志的级别</p>
<ol start="4">
<li>日志记录的方法</li>
</ol>
<p>LogInformation，LogDebug，还有一些小技巧，使用模板的方式记录日志，而不是提前拼接字符串输入给日志系统</p>
<ol start="5">
<li>避免记录敏感信息，如密码、密钥，规避安全风险</li>
</ol>
<h2 id="19-日志作用域：解决不同请求之间的日志干扰"><a href="#19-日志作用域：解决不同请求之间的日志干扰" class="headerlink" title="19 | 日志作用域：解决不同请求之间的日志干扰"></a>19 | 日志作用域：解决不同请求之间的日志干扰</h2><p>开始之前先看一下上一节的代码</p>
<pre class="line-numbers language-csharp"><code class="language-csharp"><span class="token comment" spellcheck="true">// 配置的框架</span>
<span class="token keyword">var</span> configBuilder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConfigurationBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
configBuilder<span class="token punctuation">.</span><span class="token function">AddCommandLine</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span>
configBuilder<span class="token punctuation">.</span><span class="token function">AddJsonFile</span><span class="token punctuation">(</span><span class="token string">"appsettings.json"</span><span class="token punctuation">,</span> optional<span class="token punctuation">:</span> <span class="token keyword">false</span><span class="token punctuation">,</span> reloadOnChange<span class="token punctuation">:</span> <span class="token keyword">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> config <span class="token operator">=</span> configBuilder<span class="token punctuation">.</span><span class="token function">Build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
IServiceCollection serviceCollection <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ServiceCollection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
serviceCollection<span class="token punctuation">.</span><span class="token generic-method function">AddSingleton<span class="token punctuation">&lt;</span>IConfiguration<span class="token punctuation">></span></span><span class="token punctuation">(</span>p <span class="token operator">=</span><span class="token operator">></span> config<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">// 日志的框架</span>
serviceCollection<span class="token punctuation">.</span><span class="token function">AddLogging</span><span class="token punctuation">(</span>builder <span class="token operator">=</span><span class="token operator">></span>
<span class="token punctuation">{</span>
    builder<span class="token punctuation">.</span><span class="token function">AddConfiguration</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span><span class="token function">GetSection</span><span class="token punctuation">(</span><span class="token string">"Logging"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// 注册 Logging 配置的 Section</span>
    builder<span class="token punctuation">.</span><span class="token function">AddConsole</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// 先使用一个 Console 的日志输出提供程序</span>
    builder<span class="token punctuation">.</span><span class="token function">AddDebug</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>我们可以观察到配置的框架和日志的框架，它们的设计模式是很相似的</p>
<p>区别就是：</p>
<p>配置的框架是从不同的数据源读取数据并且供给我们结构化的数据可以读取</p>
<p>日志框架是用统一的记录方式，让我们可以把日志记录到不同的地方去，输出到不同的地方去</p>
<p>接下来演示一下关于日志的作用域的部分</p>
<p>日志作用域几个常用场景：</p>
<ol>
<li>一个事务包含多条操作时：比如说在一个事务里面去操作的时候，会需要记录多条日志，需要把多条日志串联在一起，而不是记录成一行</li>
<li>复杂流程的日志关联时：比如说工作流流程里面去进入这个日志</li>
<li>调用链追踪与请求处理过程对应时：如果在调用链追踪过程中记录了多条日志，希望把日志串联在一起的时候，作用域就发挥了作用</li>
</ol>
<p>主程序</p>
<pre class="line-numbers language-csharp"><code class="language-csharp"><span class="token keyword">namespace</span> LoggingScopeDemo
<span class="token punctuation">{</span>
    <span class="token keyword">class</span> <span class="token class-name">Program</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">Main</span><span class="token punctuation">(</span><span class="token keyword">string</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token keyword">var</span> configBuilder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConfigurationBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            configBuilder<span class="token punctuation">.</span><span class="token function">AddCommandLine</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span>
            configBuilder<span class="token punctuation">.</span><span class="token function">AddJsonFile</span><span class="token punctuation">(</span><span class="token string">"appsettings.json"</span><span class="token punctuation">,</span> optional<span class="token punctuation">:</span> <span class="token keyword">false</span><span class="token punctuation">,</span> reloadOnChange<span class="token punctuation">:</span> <span class="token keyword">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">var</span> config <span class="token operator">=</span> configBuilder<span class="token punctuation">.</span><span class="token function">Build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            IServiceCollection serviceCollection <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ServiceCollection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            serviceCollection<span class="token punctuation">.</span><span class="token function">AddSingleton</span><span class="token punctuation">(</span>p <span class="token operator">=</span><span class="token operator">></span> config<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//用工厂模式将配置对象注册到容器管理</span>
            serviceCollection<span class="token punctuation">.</span><span class="token function">AddLogging</span><span class="token punctuation">(</span>builder <span class="token operator">=</span><span class="token operator">></span>
            <span class="token punctuation">{</span>
                builder<span class="token punctuation">.</span><span class="token function">AddConfiguration</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span><span class="token function">GetSection</span><span class="token punctuation">(</span><span class="token string">"Logging"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                builder<span class="token punctuation">.</span><span class="token function">AddConsole</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                builder<span class="token punctuation">.</span><span class="token function">AddDebug</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            IServiceProvider service <span class="token operator">=</span> serviceCollection<span class="token punctuation">.</span><span class="token function">BuildServiceProvider</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">var</span> logger <span class="token operator">=</span> service<span class="token punctuation">.</span>GetService<span class="token operator">&lt;</span>ILogger<span class="token operator">&lt;</span>Program<span class="token operator">></span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment" spellcheck="true">// 相当于记录了一条上下文串联的日志</span>
            <span class="token keyword">using</span> <span class="token punctuation">(</span>logger<span class="token punctuation">.</span><span class="token function">BeginScope</span><span class="token punctuation">(</span><span class="token string">"ScopeId:{scopeId}"</span><span class="token punctuation">,</span> Guid<span class="token punctuation">.</span><span class="token function">NewGuid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                logger<span class="token punctuation">.</span><span class="token function">LogInformation</span><span class="token punctuation">(</span><span class="token string">"这是Info"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                logger<span class="token punctuation">.</span><span class="token function">LogError</span><span class="token punctuation">(</span><span class="token string">"这是Error"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                logger<span class="token punctuation">.</span><span class="token function">LogTrace</span><span class="token punctuation">(</span><span class="token string">"这是Trace"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>配置文件</p>
<pre class="line-numbers language-csharp"><code class="language-csharp"><span class="token punctuation">{</span>
  <span class="token string">"Logging"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
    <span class="token string">"LogLevel"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
      <span class="token string">"Default"</span><span class="token punctuation">:</span> <span class="token string">"Debug"</span><span class="token punctuation">,</span>
      <span class="token string">"Microsoft"</span><span class="token punctuation">:</span> <span class="token string">"Warning"</span><span class="token punctuation">,</span>
      <span class="token string">"Microsoft.Hosting.Lifetime"</span><span class="token punctuation">:</span> <span class="token string">"Information"</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token string">"Console"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
      <span class="token string">"IncludeScopes"</span><span class="token punctuation">:</span> <span class="token keyword">false</span><span class="token punctuation">,</span>
      <span class="token string">"LogLevel"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
        <span class="token string">"Default"</span><span class="token punctuation">:</span> <span class="token string">"Information"</span><span class="token punctuation">,</span>
        <span class="token string">"LoggingScopeDemo.Program"</span><span class="token punctuation">:</span> <span class="token string">"Trace"</span><span class="token punctuation">,</span>
        <span class="token string">"alogger"</span><span class="token punctuation">:</span> <span class="token string">"Trace"</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>启动程序，输出如下：</p>
<pre class="line-numbers language-csharp"><code class="language-csharp">info<span class="token punctuation">:</span> LoggingScopeDemo<span class="token punctuation">.</span>Program<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
      这是Info
fail<span class="token punctuation">:</span> LoggingScopeDemo<span class="token punctuation">.</span>Program<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
      这是Error
trce<span class="token punctuation">:</span> LoggingScopeDemo<span class="token punctuation">.</span>Program<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
      这是Trace
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>和之前一样的输出，接着修改配置文件</p>
<pre><code>"IncludeScopes": true,
</code></pre><p>启动程序，输出如下：</p>
<pre><code>info: LoggingScopeDemo.Program[0]
      =&gt; ScopeId:b8ef7682-6c6d-4f74-83c8-b9fd4613c623
      这是Info
fail: LoggingScopeDemo.Program[0]
      =&gt; ScopeId:b8ef7682-6c6d-4f74-83c8-b9fd4613c623
      这是Error
trce: LoggingScopeDemo.Program[0]
      =&gt; ScopeId:b8ef7682-6c6d-4f74-83c8-b9fd4613c623
      这是Trace</code></pre><p>可以看到，日志里面有 scope，并且三条日志都包含了相同的 ScopeId，这个是由我们决定 Scope 的内容是什么，一般推荐使用一个唯一标识，比如 HTTP 请求的 id，或者是 session 的 id，或者是事务的 id</p>
<p>接着修改为循环</p>
<pre class="line-numbers language-csharp"><code class="language-csharp"><span class="token comment" spellcheck="true">// 只要输入不是 Esc 就循环执行</span>
<span class="token keyword">while</span> <span class="token punctuation">(</span>Console<span class="token punctuation">.</span><span class="token function">ReadKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>Key <span class="token operator">!=</span> ConsoleKey<span class="token punctuation">.</span>Escape<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// 相当于记录了一条上下文串联的日志</span>
    <span class="token keyword">using</span> <span class="token punctuation">(</span>logger<span class="token punctuation">.</span><span class="token function">BeginScope</span><span class="token punctuation">(</span><span class="token string">"ScopeId:{scopeId}"</span><span class="token punctuation">,</span> Guid<span class="token punctuation">.</span><span class="token function">NewGuid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        logger<span class="token punctuation">.</span><span class="token function">LogInformation</span><span class="token punctuation">(</span><span class="token string">"这是Info"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        logger<span class="token punctuation">.</span><span class="token function">LogError</span><span class="token punctuation">(</span><span class="token string">"这是Error"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        logger<span class="token punctuation">.</span><span class="token function">LogTrace</span><span class="token punctuation">(</span><span class="token string">"这是Trace"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">"============分割线============="</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
Console<span class="token punctuation">.</span><span class="token function">ReadKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>启动程序，输出如下：</p>
<pre><code>info: LoggingScopeDemo.Program[0]
      =&gt; ScopeId:cc25dd86-d3fe-41e8-b607-61912c65bde7
      这是Info
============分割线=============
fail: LoggingScopeDemo.Program[0]
      =&gt; ScopeId:cc25dd86-d3fe-41e8-b607-61912c65bde7
      这是Error
trce: LoggingScopeDemo.Program[0]
      =&gt; ScopeId:cc25dd86-d3fe-41e8-b607-61912c65bde7
      这是Trace</code></pre><p>这里可以看到分割线有点错乱，这是因为 Console 的提供程序实际上内部是用异步的方式在记录，那也就是这里遇到并发的问题</p>
<p>调整一下代码，让主线程休息一下</p>
<pre class="line-numbers language-csharp"><code class="language-csharp">System<span class="token punctuation">.</span>Threading<span class="token punctuation">.</span>Thread<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">"============分割线============="</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>这样子启动之后顺序就正确了</p>
<p>在程序启动的情况下，修改 Debug 目录下的配置文件</p>
<pre><code>"IncludeScopes": false,</code></pre><p>修改保存后在控制台输入回车，可以看到配置生效了，意味着可以使用配置热更新能力来动态修改配置的输出，调整配置输出的级别</p>
<p>比如将</p>
<pre><code>"LoggingScopeDemo.Program": "Trace",</code></pre><p>修改为</p>
<pre><code>"LoggingScopeDemo.Program": "Error",</code></pre><p>修改保存后在控制台输入回车，只会输出 Error 级别</p>
<p>这是在控制台里面的效果，接下来看一下在一个 ASP.NET Core Web 应用下面的日志是什么样子。</p>
<p>这是一个默认的工程，仅仅在应用程序里面加了两行代码</p>
<pre class="line-numbers language-csharp"><code class="language-csharp"><span class="token punctuation">[</span>HttpGet<span class="token punctuation">]</span>
<span class="token keyword">public</span> <span class="token keyword">async</span> Task<span class="token operator">&lt;</span>IEnumerable<span class="token operator">&lt;</span>WeatherForecast<span class="token operator">></span><span class="token operator">></span> <span class="token function">Get</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    _logger<span class="token punctuation">.</span><span class="token function">LogInformation</span><span class="token punctuation">(</span><span class="token string">"开始Get了"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    _logger<span class="token punctuation">.</span><span class="token function">LogInformation</span><span class="token punctuation">(</span><span class="token string">"Get睡醒了"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">var</span> rng <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> Enumerable<span class="token punctuation">.</span><span class="token function">Range</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Select</span><span class="token punctuation">(</span>index <span class="token operator">=</span><span class="token operator">></span> <span class="token keyword">new</span> <span class="token class-name">WeatherForecast</span>
    <span class="token punctuation">{</span>
        Date <span class="token operator">=</span> DateTime<span class="token punctuation">.</span>Now<span class="token punctuation">.</span><span class="token function">AddDays</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">,</span>
        TemperatureC <span class="token operator">=</span> rng<span class="token punctuation">.</span><span class="token function">Next</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">20</span><span class="token punctuation">,</span> <span class="token number">55</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        Summary <span class="token operator">=</span> Summaries<span class="token punctuation">[</span>rng<span class="token punctuation">.</span><span class="token function">Next</span><span class="token punctuation">(</span>Summaries<span class="token punctuation">.</span>Length<span class="token punctuation">)</span><span class="token punctuation">]</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">ToArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>日志级别</p>
<pre><code>"Console": {
      "IncludeScopes": true
    }</code></pre><p>启动程序，输出如下：</p>
<pre><code>info: LoggingDemo.Controllers.WeatherForecastController[0]
      =&gt; RequestPath:/weatherforecast RequestId:0HLU2MTQ99HO2:00000001, SpanId:|7bb9cb12-4a0fe499cae27707., TraceId:7bb9cb12-4a0fe499cae27707, ParentId: =&gt; LoggingDemo.Controllers.WeatherForecastController.Get (LoggingDemo)
      开始Get了
info: LoggingDemo.Controllers.WeatherForecastController[0]
      =&gt; RequestPath:/weatherforecast RequestId:0HLU2MTQ99HO2:00000001, SpanId:|7bb9cb12-4a0fe499cae27707., TraceId:7bb9cb12-4a0fe499cae27707, ParentId: =&gt; LoggingDemo.Controllers.WeatherForecastController.Get (LoggingDemo)
      Get睡醒了
</code></pre><p>可以看到，记录的 开始Get了 以及 Get睡醒了，都包含了 RequestPath，RequestId，SpanId，TraceId 这些信息，这些信息是当前请求的上下文</p>
<p>也就意味着可以在记录日志的时候，用请求上下文把日志串联起来，多个请求的日志可以区分开来，无论记录了多条还是单条</p>
<p>也就意味着可以在事务处理的过程中，复杂的流程的过程中，或者调用链的处理过程中，当然还有其他的场景任意的需要将多条日志串联起来的场景，都可以用作用域来实现这个能力。</p>
<h2 id="20-结构化日志组件Serilog：记录对查询分析友好的日志"><a href="#20-结构化日志组件Serilog：记录对查询分析友好的日志" class="headerlink" title="20 | 结构化日志组件Serilog：记录对查询分析友好的日志"></a>20 | 结构化日志组件Serilog：记录对查询分析友好的日志</h2><p>之前讲解的日志框架，记录的日志都是文本，而且是非结构化的，这样一串串文本实际上不利于我们去做分析</p>
<p>结构化的日志它的好处就显而易见，它可以让我们更易于去检索，更易于与现有的分析系统进行结合</p>
<p>结构化日志的主要场景：</p>
<ol>
<li>实现日志告警</li>
<li>实现上下文的关联：可以在日志系统里面对一段业务逻辑输出的日志进行分析</li>
<li>实现与追踪系统集成：在调用链的系统里面看到有问题的情况下，可以追踪到调用链过程中间的所有的日志信息</li>
</ol>
<p>这里创建的依然是一个默认的 ASP.NET Core 的工程</p>
<p>引用包：Serilog.AspNetCore</p>
<p>这个包实际上依赖了 Serilog 很多的内置的包</p>
<p>比如核心的 Serilog (2.8.0)</p>
<p>配置 Serilog.Settings.Configuration (3.1.0)</p>
<p>Console 的输出 Serilog.Sinks.Console (3.1.1)</p>
<p>Debug 的输出 Serilog.Sinks.Debug (1.0.1)</p>
<p>File 的输出 Serilog.Sinks.File (4.0.0)</p>
<p>我们在 Program 这里提前读取一下配置，然后传递给 Serilog 的初始化过程，这里我们把 Main 函数进行了稍微的改造，以让 Serilog 可以接替整个默认的日志记录框架</p>
<pre class="line-numbers language-csharp"><code class="language-csharp"><span class="token keyword">namespace</span> LoggingSerilogDemo
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Program</span>
    <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// 读取配置</span>
        <span class="token keyword">public</span> <span class="token keyword">static</span> IConfiguration Configuration <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConfigurationBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">SetBasePath</span><span class="token punctuation">(</span>Directory<span class="token punctuation">.</span><span class="token function">GetCurrentDirectory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">AddJsonFile</span><span class="token punctuation">(</span><span class="token string">"appsettings.json"</span><span class="token punctuation">,</span> optional<span class="token punctuation">:</span> <span class="token keyword">false</span><span class="token punctuation">,</span> reloadOnChange<span class="token punctuation">:</span> <span class="token keyword">true</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">AddJsonFile</span><span class="token punctuation">(</span>$<span class="token string">"appsettings.{Environment.GetEnvironmentVariable("</span>ASPNETCORE_ENVIRONMENT<span class="token string">") ?? "</span>Production<span class="token string">"}.json"</span><span class="token punctuation">,</span> optional<span class="token punctuation">:</span> <span class="token keyword">true</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">AddEnvironmentVariables</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">Build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">Main</span><span class="token punctuation">(</span><span class="token keyword">string</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// 将配置传递给 Serilog 的初始化过程</span>
            Log<span class="token punctuation">.</span>Logger <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LoggerConfiguration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>ReadFrom<span class="token punctuation">.</span><span class="token function">Configuration</span><span class="token punctuation">(</span>Configuration<span class="token punctuation">)</span>
            <span class="token punctuation">.</span>MinimumLevel<span class="token punctuation">.</span><span class="token function">Debug</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span>Enrich<span class="token punctuation">.</span><span class="token function">FromLogContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span>WriteTo<span class="token punctuation">.</span><span class="token function">Console</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">RenderedCompactJsonFormatter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span>WriteTo<span class="token punctuation">.</span><span class="token function">File</span><span class="token punctuation">(</span>formatter<span class="token punctuation">:</span> <span class="token keyword">new</span> <span class="token class-name">CompactJsonFormatter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"logs\\myapp.txt"</span><span class="token punctuation">,</span> rollingInterval<span class="token punctuation">:</span> RollingInterval<span class="token punctuation">.</span>Day<span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">CreateLogger</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">try</span>
            <span class="token punctuation">{</span>
                Log<span class="token punctuation">.</span><span class="token function">Information</span><span class="token punctuation">(</span><span class="token string">"Starting web host"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">CreateHostBuilder</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> ex<span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                Log<span class="token punctuation">.</span><span class="token function">Fatal</span><span class="token punctuation">(</span>ex<span class="token punctuation">,</span> <span class="token string">"Host terminated unexpectedly"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">finally</span>
            <span class="token punctuation">{</span>
                Log<span class="token punctuation">.</span><span class="token function">CloseAndFlush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">public</span> <span class="token keyword">static</span> IHostBuilder <span class="token function">CreateHostBuilder</span><span class="token punctuation">(</span><span class="token keyword">string</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span>
            Host<span class="token punctuation">.</span><span class="token function">CreateDefaultBuilder</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">ConfigureWebHostDefaults</span><span class="token punctuation">(</span>webBuilder <span class="token operator">=</span><span class="token operator">></span>
                <span class="token punctuation">{</span>
                    webBuilder<span class="token punctuation">.</span><span class="token generic-method function">UseStartup<span class="token punctuation">&lt;</span>Startup<span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">UseSerilog</span><span class="token punctuation">(</span>dispose<span class="token punctuation">:</span> <span class="token keyword">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// dispose 设置为 true，它就会在退出时帮我们释放我们的日志对象</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>启动程序，输出如下:</p>
<pre><code>{"@t":"2020-03-08T15:47:40.2569100Z","@m":"Starting web host","@i":"4872fd06"}
{"@t":"2020-03-08T15:47:44.1978171Z","@m":"Get 随机创建数据","@i":"6936e72c","SourceContext":"LoggingSerilogDemo.Controllers.WeatherForecastController","ActionId":"8d8ebb60-2211-4acb-bc91-a079be45a689","ActionName":"LoggingSerilogDemo.Controllers.WeatherForecastController.Get (LoggingSerilogDemo)","RequestId":"0HLU3F052RUUN:00000001","RequestPath":"/weatherforecast","SpanId":"|99917a4d-4ccf47636d09b066.","TraceId":"99917a4d-4ccf47636d09b066","ParentId":""}
</code></pre><p>可以看到每一行都是一个 json，也就是将日志输出为 json 格式，这就意味着可以在整个日志系统里面以 json 的格式去检索数据，比如 SourceContext 就是 Logger 的 name</p>
<p>它还记录了请求上下文，并且输出了 RequestId，SpanId，TraceId，ParentId</p>
<p>RequestId 与 SpanId 的作用就是与追踪系统可以结合</p>
<p>我们记录的日志的方式实际上是与之前是一样的，Controller 里面还是注入了 ILogger，依然使用 ILogger 来记录日志</p>
<pre class="line-numbers language-csharp"><code class="language-csharp"><span class="token keyword">namespace</span> LoggingSerilogDemo<span class="token punctuation">.</span>Controllers
<span class="token punctuation">{</span>
    <span class="token punctuation">[</span>ApiController<span class="token punctuation">]</span>
    <span class="token punctuation">[</span><span class="token function">Route</span><span class="token punctuation">(</span><span class="token string">"[controller]"</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
    <span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">WeatherForecastController</span> <span class="token punctuation">:</span> ControllerBase
    <span class="token punctuation">{</span>
        <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">readonly</span> <span class="token keyword">string</span><span class="token punctuation">[</span><span class="token punctuation">]</span> Summaries <span class="token operator">=</span> <span class="token keyword">new</span><span class="token punctuation">[</span><span class="token punctuation">]</span>
        <span class="token punctuation">{</span>
            <span class="token string">"Freezing"</span><span class="token punctuation">,</span> <span class="token string">"Bracing"</span><span class="token punctuation">,</span> <span class="token string">"Chilly"</span><span class="token punctuation">,</span> <span class="token string">"Cool"</span><span class="token punctuation">,</span> <span class="token string">"Mild"</span><span class="token punctuation">,</span> <span class="token string">"Warm"</span><span class="token punctuation">,</span> <span class="token string">"Balmy"</span><span class="token punctuation">,</span> <span class="token string">"Hot"</span><span class="token punctuation">,</span> <span class="token string">"Sweltering"</span><span class="token punctuation">,</span> <span class="token string">"Scorching"</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>

        <span class="token keyword">private</span> <span class="token keyword">readonly</span> ILogger<span class="token operator">&lt;</span>WeatherForecastController<span class="token operator">></span> _logger<span class="token punctuation">;</span>

        <span class="token keyword">public</span> <span class="token function">WeatherForecastController</span><span class="token punctuation">(</span>ILogger<span class="token operator">&lt;</span>WeatherForecastController<span class="token operator">></span> logger<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            _logger <span class="token operator">=</span> logger<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token punctuation">[</span>HttpGet<span class="token punctuation">]</span>
        <span class="token keyword">public</span> IEnumerable<span class="token operator">&lt;</span>WeatherForecast<span class="token operator">></span> <span class="token function">Get</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>

            _logger<span class="token punctuation">.</span><span class="token function">LogInformation</span><span class="token punctuation">(</span><span class="token string">"Get 随机创建数据"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">var</span> rng <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> Enumerable<span class="token punctuation">.</span><span class="token function">Range</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Select</span><span class="token punctuation">(</span>index <span class="token operator">=</span><span class="token operator">></span> <span class="token keyword">new</span> <span class="token class-name">WeatherForecast</span>
            <span class="token punctuation">{</span>
                Date <span class="token operator">=</span> DateTime<span class="token punctuation">.</span>Now<span class="token punctuation">.</span><span class="token function">AddDays</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">,</span>
                TemperatureC <span class="token operator">=</span> rng<span class="token punctuation">.</span><span class="token function">Next</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">20</span><span class="token punctuation">,</span> <span class="token number">55</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                Summary <span class="token operator">=</span> Summaries<span class="token punctuation">[</span>rng<span class="token punctuation">.</span><span class="token function">Next</span><span class="token punctuation">(</span>Summaries<span class="token punctuation">.</span>Length<span class="token punctuation">)</span><span class="token punctuation">]</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">ToArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>也就是说可以通过简单的配置和几行代码的设置就可以替换官方提供的日志框架，让我们具备记录结构化日志的能力</p>
<p>我们刚才看到日志输出到 Console，同时输出到文件，可以看到 logs 目录已经产生了一个 myapp20200308.txt 文件</p>
<pre><code>{"@t":"2020-03-08T15:47:40.2569100Z","@mt":"Starting web host"}
{"@t":"2020-03-08T15:47:44.1978171Z","@mt":"Get 随机创建数据","SourceContext":"LoggingSerilogDemo.Controllers.WeatherForecastController","ActionId":"8d8ebb60-2211-4acb-bc91-a079be45a689","ActionName":"LoggingSerilogDemo.Controllers.WeatherForecastController.Get (LoggingSerilogDemo)","RequestId":"0HLU3F052RUUN:00000001","RequestPath":"/weatherforecast","SpanId":"|99917a4d-4ccf47636d09b066.","TraceId":"99917a4d-4ccf47636d09b066","ParentId":""}
</code></pre><p>这个文件可以看到每一行是一条日志，每一条日志都是一个 json 对象，包括刚才我们记录的 Get 随机创建数据，已经输出出来了</p>
<p>我们可以调整日志级别，打开配置文件</p>
<pre><code>{
  "Logging": {
    "LogLevel": {
      "Default": "Information",
      "Microsoft": "Warning",
      "Microsoft.Hosting.Lifetime": "Information"
    }
  },
  "Serilog": {
    "MinimumLevel": {
      "Default": "Information",
      "Override": {
        "Microsoft": "Error",
        "System": "Information"
      }
    }
  },
  "AllowedHosts": "*"
}</code></pre><p>Serilog 需要单独配置，它与之前的配置方式略有不同，它需要配置最小的日志输出级别，默认是 Information</p>
<p>Override 是重载上面 Logging 定义的日志级别</p>
<p>设置 Microsoft 为 Error 之后会把 Microsoft 默认的日志输出级别过滤掉</p>
<p>也意味着整个的配置和输出的方式与之前是级别类似的，我们可以把日志输出到 Console，也可以把日志输出到文件，当然实际上 Serilog 还提供了很多的这种输出的提供程序，还可以与 EFK，ELK 这种日志的套件进行集成，把日志输出到分析系统里面</p>
<h2 id="21-中间件：掌控请求处理过程的关键"><a href="#21-中间件：掌控请求处理过程的关键" class="headerlink" title="21 | 中间件：掌控请求处理过程的关键"></a>21 | 中间件：掌控请求处理过程的关键</h2><p>这一节主要解释如何通过中间件来管理请求处理过程</p>
<p>中间件工作原理</p>
<p><img src="https://cdn.jsdelivr.net/gh/shw2018/cdn@1.0/sakura/img/loader/orange.progress-bar-stripe-loader.svg" data-original="https://img2020.cnblogs.com/blog/1412316/202003/1412316-20200310004233177-1820172818.jpg" alt=""></p>
<p>next 表示后面有一个委托，每一层每一层套下去可以在任意的中间件来决定在后面的中间件之前执行什么，或者说在所有中间件执行完之后执行什么</p>
<p>整个中间件的处理过程实际上有两个核心对象：</p>
<p>IApplicationBuilder</p>
<p>RequestDelegate：处理整个请求的委托</p>
<p>IApplicationBuilder</p>
<pre class="line-numbers language-csharp"><code class="language-csharp"><span class="token keyword">namespace</span> Microsoft<span class="token punctuation">.</span>AspNetCore<span class="token punctuation">.</span>Builder
<span class="token punctuation">{</span>
  <span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">IApplicationBuilder</span>
  <span class="token punctuation">{</span>
    IServiceProvider ApplicationServices <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>

    IDictionary<span class="token operator">&lt;</span><span class="token keyword">string</span><span class="token punctuation">,</span> <span class="token keyword">object</span><span class="token operator">></span> Properties <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>

    IFeatureCollection ServerFeatures <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">// 最终它会 Build 返回一个委托</span>
    <span class="token comment" spellcheck="true">// 这个委托就是把所有的中间件串起来之后，合并成一个委托方法</span>
    <span class="token comment" spellcheck="true">// 这个方法的入参可以看下方委托的定义</span>
    RequestDelegate <span class="token function">Build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    IApplicationBuilder <span class="token function">New</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// 它可以让我们去注册我们的中间件，把委托注册进去，每一个委托的入参也是一个委托</span>
    <span class="token comment" spellcheck="true">// 这也就意味着可以把这些委托注册成一个链，就像上面的图显示的那样</span>
    IApplicationBuilder <span class="token function">Use</span><span class="token punctuation">(</span>Func<span class="token operator">&lt;</span>RequestDelegate<span class="token punctuation">,</span> RequestDelegate<span class="token operator">></span> middleware<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>委托的定义</p>
<pre class="line-numbers language-csharp"><code class="language-csharp"><span class="token keyword">namespace</span> Microsoft<span class="token punctuation">.</span>AspNetCore<span class="token punctuation">.</span>Http
<span class="token punctuation">{</span>
  <span class="token comment" spellcheck="true">// 委托的入参是 HttpContext，所有的注册中间件的委托实际上都是对 HttpContext 的处理</span>
  <span class="token keyword">public</span> <span class="token keyword">delegate</span> Task <span class="token function">RequestDelegate</span><span class="token punctuation">(</span>HttpContext context<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>接着让我们看一下应用程序里面是怎么让它工作的？</p>
<p>之前讲过 Configure 方法是用来注册中间件的</p>
<pre class="line-numbers language-csharp"><code class="language-csharp">app<span class="token punctuation">.</span><span class="token function">UseMyMiddleware</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token function">UseHttpsRedirection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token function">UseRouting</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token function">UseAuthorization</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token function">UseEndpoints</span><span class="token punctuation">(</span>endpoints <span class="token operator">=</span><span class="token operator">></span>
<span class="token punctuation">{</span>
    endpoints<span class="token punctuation">.</span><span class="token function">MapControllers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>根据刚才流程图表示的话，实际上中间件的执行顺序是跟注册顺序有关系的，最早注册的中间件它的权力是最大的，它可以越早的发生作用</p>
<p>中间件的注册实际上不仅仅是有上面展示的已有内置的中间件，实际上还可以用注册委托的方法来注册我们的逻辑</p>
<pre class="line-numbers language-csharp"><code class="language-csharp">app<span class="token punctuation">.</span><span class="token function">Use</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span>context<span class="token punctuation">,</span> next<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span>
<span class="token punctuation">{</span>
    <span class="token keyword">await</span> context<span class="token punctuation">.</span>Response<span class="token punctuation">.</span><span class="token function">WriteAsync</span><span class="token punctuation">(</span><span class="token string">"Hello"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>因为这个中间件注册最早，而且不对后续的 next 做任何操作，所以启动之后无论输入什么都会输出 Hello</p>
<p>如果需要后续的中间件执行，那就意味着需要调用 next，可以在中间件执行之后再次 Hello 一次</p>
<pre class="line-numbers language-csharp"><code class="language-csharp">app<span class="token punctuation">.</span><span class="token function">Use</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span>context<span class="token punctuation">,</span> next<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span>
<span class="token punctuation">{</span>
    <span class="token keyword">await</span> context<span class="token punctuation">.</span>Response<span class="token punctuation">.</span><span class="token function">WriteAsync</span><span class="token punctuation">(</span><span class="token string">"Hello"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">await</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">await</span> context<span class="token punctuation">.</span>Response<span class="token punctuation">.</span><span class="token function">WriteAsync</span><span class="token punctuation">(</span><span class="token string">"Hello2"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>启动程序报错：</p>
<pre><code>System.InvalidOperationException: Headers are read-only, response has already started.</code></pre><p>意味着一旦应用程序已经对 Response 输出内容，我们就不能对 header 进行操作了，但是可以在 Response 后续继续写出信息</p>
<pre class="line-numbers language-csharp"><code class="language-csharp">app<span class="token punctuation">.</span><span class="token function">Use</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span>context<span class="token punctuation">,</span> next<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span>
<span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">//await context.Response.WriteAsync("Hello");</span>
    <span class="token keyword">await</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">await</span> context<span class="token punctuation">.</span>Response<span class="token punctuation">.</span><span class="token function">WriteAsync</span><span class="token punctuation">(</span><span class="token string">"Hello2"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>实际上除了 Use 这种方式的话，还有 Map 的方式</p>
<pre class="line-numbers language-csharp"><code class="language-csharp">app<span class="token punctuation">.</span><span class="token function">Map</span><span class="token punctuation">(</span><span class="token string">"/abc"</span><span class="token punctuation">,</span> abcBuilder <span class="token operator">=</span><span class="token operator">></span>
<span class="token punctuation">{</span>
    abcBuilder<span class="token punctuation">.</span><span class="token function">Use</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span>context<span class="token punctuation">,</span> next<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span>
    <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">//await context.Response.WriteAsync("Hello");</span>
        <span class="token keyword">await</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">await</span> context<span class="token punctuation">.</span>Response<span class="token punctuation">.</span><span class="token function">WriteAsync</span><span class="token punctuation">(</span><span class="token string">"Hello2"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>启动程序不会直接看到 Hello 输出，如果把地址改为 localhost:5001/abc，我们的输出就会变成 Hello2</p>
<p>也就是说当我们需要对特定的路径进行指定中间件的时候可以这样做</p>
<p>如果在 Map 的时候逻辑复杂一点，不仅仅判断它的 URL 地址，而且要做特殊的判断的话，可以这么做把判断逻辑变成一个委托</p>
<p>我们要判断当我们的请求地址包含 abc 的时候，输出 new abc</p>
<pre class="line-numbers language-csharp"><code class="language-csharp">app<span class="token punctuation">.</span><span class="token function">MapWhen</span><span class="token punctuation">(</span>context <span class="token operator">=</span><span class="token operator">></span>
<span class="token punctuation">{</span>
    <span class="token keyword">return</span> context<span class="token punctuation">.</span>Request<span class="token punctuation">.</span>Query<span class="token punctuation">.</span>Keys<span class="token punctuation">.</span><span class="token function">Contains</span><span class="token punctuation">(</span><span class="token string">"abc"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> builder <span class="token operator">=</span><span class="token operator">></span>
<span class="token punctuation">{</span>
    builder<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span><span class="token keyword">async</span> context <span class="token operator">=</span><span class="token operator">></span>
    <span class="token punctuation">{</span>
        <span class="token keyword">await</span> context<span class="token punctuation">.</span>Response<span class="token punctuation">.</span><span class="token function">WriteAsync</span><span class="token punctuation">(</span><span class="token string">"new abc"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>启动程序，没有任何输出</p>
<p>当我们在默认启动地址后面输入 ?abc=1 的时候，可以看到输出了 new abc</p>
<p>这里用到了一个 Run 的方法，上一节用到的是 Use 方法</p>
<pre class="line-numbers language-csharp"><code class="language-csharp">app<span class="token punctuation">.</span><span class="token function">Map</span><span class="token punctuation">(</span><span class="token string">"/abc"</span><span class="token punctuation">,</span> abcBuilder <span class="token operator">=</span><span class="token operator">></span>
<span class="token punctuation">{</span>
    abcBuilder<span class="token punctuation">.</span><span class="token function">Use</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span>context<span class="token punctuation">,</span> next<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span>
    <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">//await context.Response.WriteAsync("Hello");</span>
        <span class="token keyword">await</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">await</span> context<span class="token punctuation">.</span>Response<span class="token punctuation">.</span><span class="token function">WriteAsync</span><span class="token punctuation">(</span><span class="token string">"Hello2"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>Run 和 Use 的区别是什么呢？</p>
<p>Use 是指我们可以像注册一个完整的中间件一样，将 next 注入进来，我们可以去决定是否执行后续的中间件</p>
<p>Run 的含义就表示我们这里就是中间件执行的末端，也就不在执行后面的中间件了，在这里将返回请求</p>
<p>那我们如何像 UseRouting UseEndpoints 一样来设计我们自己的中间件呢？</p>
<p>这里定义好了一个 MyMiddleware</p>
<pre class="line-numbers language-csharp"><code class="language-csharp"><span class="token keyword">namespace</span> MiddlewareDemo<span class="token punctuation">.</span>Middlewares
<span class="token punctuation">{</span>
    <span class="token keyword">class</span> <span class="token class-name">MyMiddleware</span>
    <span class="token punctuation">{</span>
        RequestDelegate _next<span class="token punctuation">;</span>
        ILogger _logger<span class="token punctuation">;</span>
        <span class="token keyword">public</span> <span class="token function">MyMiddleware</span><span class="token punctuation">(</span>RequestDelegate next<span class="token punctuation">,</span> ILogger<span class="token operator">&lt;</span>MyMiddleware<span class="token operator">></span> logger<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            _next <span class="token operator">=</span> next<span class="token punctuation">;</span>
            _logger <span class="token operator">=</span> logger<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">public</span> <span class="token keyword">async</span> Task <span class="token function">InvokeAsync</span><span class="token punctuation">(</span>HttpContext context<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token keyword">using</span> <span class="token punctuation">(</span>_logger<span class="token punctuation">.</span><span class="token function">BeginScope</span><span class="token punctuation">(</span><span class="token string">"TraceIdentifier:{TraceIdentifier}"</span><span class="token punctuation">,</span> context<span class="token punctuation">.</span>TraceIdentifier<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                _logger<span class="token punctuation">.</span><span class="token function">LogDebug</span><span class="token punctuation">(</span><span class="token string">"开始执行"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token keyword">await</span> <span class="token function">_next</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>

                _logger<span class="token punctuation">.</span><span class="token function">LogDebug</span><span class="token punctuation">(</span><span class="token string">"执行结束"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>定义中间件是用了一个约定的方式，中间件的类包含一个方法 Invoke 或者 InvokeAsync 这样一个方法，它的返回是一个 Task，入参是一个 HttpContext，实际上可以理解成与中间件的委托是一样的，只要我们的类包含这样一个方法，就可以把它作为一个中间件注册进去，并被框架识别到</p>
<p>这里还定义了一个 MyBuilderExtensions</p>
<pre class="line-numbers language-csharp"><code class="language-csharp"><span class="token keyword">namespace</span> Microsoft<span class="token punctuation">.</span>AspNetCore<span class="token punctuation">.</span>Builder
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">MyBuilderExtensions</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">public</span> <span class="token keyword">static</span> IApplicationBuilder <span class="token function">UseMyMiddleware</span><span class="token punctuation">(</span><span class="token keyword">this</span> IApplicationBuilder app<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token keyword">return</span> app<span class="token punctuation">.</span><span class="token generic-method function">UseMiddleware<span class="token punctuation">&lt;</span>MyMiddleware<span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>把我们的中间件注册进去，这个方法就是 UseMyMiddleware</p>
<p>通过这样的定义，我们就可以使用自己的中间件</p>
<pre class="line-numbers language-csharp"><code class="language-csharp">app<span class="token punctuation">.</span><span class="token function">UseMyMiddleware</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>启动程序，输出如下：</p>
<p>控制台输出</p>
<pre><code>dbug: MiddlewareDemo.Middlewares.MyMiddleware[0]
      =&gt; RequestPath:/weatherforecast RequestId:0HLU50UEM3M9F:00000001, SpanId:|77f92fe8-4a6d800968327989., TraceId:77f92fe8-4a6d800968327989, ParentId: =&gt; TraceIdentifier:0HLU50UEM3M9F:00000001
      开始执行
dbug: MiddlewareDemo.Middlewares.MyMiddleware[0]
      =&gt; RequestPath:/weatherforecast RequestId:0HLU50UEM3M9F:00000001, SpanId:|77f92fe8-4a6d800968327989., TraceId:77f92fe8-4a6d800968327989, ParentId: =&gt; TraceIdentifier:0HLU50UEM3M9F:00000001
      执行结束</code></pre><p>网页控制器输出</p>
<pre><code>[{"date":"2020-03-11T23:30:55.3411696+08:00","temperatureC":20,"temperatureF":67,"summary":"Warm"},{"date":"2020-03-12T23:30:55.3417863+08:00","temperatureC":52,"temperatureF":125,"summary":"Bracing"},{"date":"2020-03-13T23:30:55.3417916+08:00","temperatureC":-3,"temperatureF":27,"summary":"Mild"},{"date":"2020-03-14T23:30:55.341792+08:00","temperatureC":35,"temperatureF":94,"summary":"Balmy"},{"date":"2020-03-15T23:30:55.3417923+08:00","temperatureC":37,"temperatureF":98,"summary":"Sweltering"}]Hello2</code></pre><p>如果要实现一个断路器，就是不执行后续逻辑，注释掉一行</p>
<pre><code>_logger.LogDebug("开始执行");

//await _next(context);

_logger.LogDebug("执行结束");</code></pre><p>启动程序，页面不会输出任何内容，只会在控制台打印出中间件的执行过程，后续的控制器不会执行</p>
<p>这样就实现了一个断路器，也就意味着可以使用自己的中间件做请求的控制，而且时非常灵活的控制</p>
<p>在使用中间件的过程中，需要非常注意的是注册中间件的顺序，这些顺序就决定了中间件执行的时机，某些中间件会是断路器的作用，某些中间件会做一些请求内容的处理</p>
<p>还有一个比较关键的要点是指应用程序一旦开始向 Response write 的时候，后续的中间件就不能再去操作它的 header，这一点是需要注意的</p>
<p>可以通过 Context.Response.HasStarted 来判断是否已经开始向响应的 body 输出内容，一旦输出了内容，就不要再操作 header</p>
<h2 id="22-异常处理中间件：区分真异常与逻辑异常"><a href="#22-异常处理中间件：区分真异常与逻辑异常" class="headerlink" title="22 | 异常处理中间件：区分真异常与逻辑异常"></a>22 | 异常处理中间件：区分真异常与逻辑异常</h2><p>这一节我们来探讨一下错误处理的最佳实践</p>
<p>系统里面异常处理，ASP.NET Core 提供了四种方式</p>
<ol>
<li>异常处理页</li>
<li>异常处理匿名委托方法</li>
<li>IExceptionFilter</li>
<li>ExceptionFilterAttribute</li>
</ol>
<p>Startup 的 Configure 方法</p>
<pre class="line-numbers language-csharp"><code class="language-csharp"><span class="token keyword">if</span> <span class="token punctuation">(</span>env<span class="token punctuation">.</span><span class="token function">IsDevelopment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// 开发环境下的异常处理页</span>
    app<span class="token punctuation">.</span><span class="token function">UseDeveloperExceptionPage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>控制器抛出异常</p>
<pre class="line-numbers language-csharp"><code class="language-csharp"><span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Exception</span><span class="token punctuation">(</span><span class="token string">"报个错"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>启动程序，可以看到一个错误页</p>
<p><img src="https://cdn.jsdelivr.net/gh/shw2018/cdn@1.0/sakura/img/loader/orange.progress-bar-stripe-loader.svg" data-original="https://img2020.cnblogs.com/blog/1412316/202003/1412316-20200311235228335-93227035.jpg" alt=""></p>
<p>这个错误页会输出我们当前请求的详细信息和错误的详细信息，这种页面是不适合给用户看到的，所以这样的错误页在生产环境是需要关闭的</p>
<p>以下是正常处理错误页的方式：</p>
<pre class="line-numbers language-csharp"><code class="language-csharp"><span class="token comment" spellcheck="true">// 第一种方式就是定义错误页的方式</span>
app<span class="token punctuation">.</span><span class="token function">UseExceptionHandler</span><span class="token punctuation">(</span><span class="token string">"/error"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>定义一个接口 IKnownException</p>
<pre class="line-numbers language-csharp"><code class="language-csharp"><span class="token keyword">namespace</span> ExceptionDemo<span class="token punctuation">.</span>Exceptions
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">IKnownException</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">public</span> <span class="token keyword">string</span> Message <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>

        <span class="token keyword">public</span> <span class="token keyword">int</span> ErrorCode <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>

        <span class="token keyword">public</span> <span class="token keyword">object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> ErrorData <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>默认实现 KnownException</p>
<pre class="line-numbers language-csharp"><code class="language-csharp"><span class="token keyword">namespace</span> ExceptionDemo<span class="token punctuation">.</span>Exceptions
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">KnownException</span> <span class="token punctuation">:</span> IKnownException
    <span class="token punctuation">{</span>
        <span class="token keyword">public</span> <span class="token keyword">string</span> Message <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">private</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>

        <span class="token keyword">public</span> <span class="token keyword">int</span> ErrorCode <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">private</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>

        <span class="token keyword">public</span> <span class="token keyword">object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> ErrorData <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">private</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>

        <span class="token keyword">public</span> <span class="token keyword">readonly</span> <span class="token keyword">static</span> IKnownException Unknown <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">KnownException</span> <span class="token punctuation">{</span> Message <span class="token operator">=</span> <span class="token string">"未知错误"</span><span class="token punctuation">,</span> ErrorCode <span class="token operator">=</span> <span class="token number">9999</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>

        <span class="token keyword">public</span> <span class="token keyword">static</span> IKnownException <span class="token function">FromKnownException</span><span class="token punctuation">(</span>IKnownException exception<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">KnownException</span> <span class="token punctuation">{</span> Message <span class="token operator">=</span> exception<span class="token punctuation">.</span>Message<span class="token punctuation">,</span> ErrorCode <span class="token operator">=</span> exception<span class="token punctuation">.</span>ErrorCode<span class="token punctuation">,</span> ErrorData <span class="token operator">=</span> exception<span class="token punctuation">.</span>ErrorData <span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>为什么需要定义这样一个类型呢？</p>
<p>因为通常情况下我们系统里面的异常和我们业务逻辑的异常是不同的，业务逻辑上面的判断异常，比如说输入的参数，订单的状态不符合条件，当前账户余额不足，这样子的信息我们有两种处理方式：</p>
<p>一种处理方式就是对不同的逻辑输出不同的业务对象</p>
<p>还有一种方式就是对于异常的这种业务逻辑，输出一个异常，用异常来承载逻辑的特殊分支，这个时候就需要识别出来哪些是业务的异常，哪些是不确定的未知的异常，比如说网络的请求出现了异常，MySql 的连接闪断了，Redis 的连接出现了异常</p>
<p>接着通过定义一个错误页来承载错误信息，比如我们的 ErrorController，它只有一个页面，它的作用就是输出错误信息</p>
<pre class="line-numbers language-csharp"><code class="language-csharp"><span class="token keyword">namespace</span> ExceptionDemo<span class="token punctuation">.</span>Controllers
<span class="token punctuation">{</span>
    <span class="token punctuation">[</span>AllowAnonymous<span class="token punctuation">]</span>
    <span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ErrorController</span> <span class="token punctuation">:</span> Controller
    <span class="token punctuation">{</span>
        <span class="token punctuation">[</span><span class="token function">Route</span><span class="token punctuation">(</span><span class="token string">"/error"</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
        <span class="token keyword">public</span> IActionResult <span class="token function">Index</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// 获取当前上下文里面报出的异常信息</span>
            <span class="token keyword">var</span> exceptionHandlerPathFeature <span class="token operator">=</span> HttpContext<span class="token punctuation">.</span>Features<span class="token punctuation">.</span><span class="token generic-method function">Get<span class="token punctuation">&lt;</span>IExceptionHandlerPathFeature<span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">var</span> ex <span class="token operator">=</span> exceptionHandlerPathFeature<span class="token operator">?</span><span class="token punctuation">.</span>Error<span class="token punctuation">;</span>

            <span class="token comment" spellcheck="true">// 特殊处理，尝试转换为 IKnownException</span>
            <span class="token keyword">var</span> knownException <span class="token operator">=</span> ex <span class="token keyword">as</span> IKnownException<span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// 对于未知异常，我们并不应该把错误异常完整地输出给客户端，而是应该定义一个特殊的信息 Unknown 传递给用户</span>
            <span class="token comment" spellcheck="true">// Unknown 其实也是一个 IKnownException 的实现，它的 Message = "未知错误", ErrorCode = 9999</span>
            <span class="token comment" spellcheck="true">// 也就是说我们在控制器 throw new Exception("报个错"); 就会看到错误信息</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>knownException <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                <span class="token keyword">var</span> logger <span class="token operator">=</span> HttpContext<span class="token punctuation">.</span>RequestServices<span class="token punctuation">.</span>GetService<span class="token operator">&lt;</span>ILogger<span class="token operator">&lt;</span>MyExceptionFilterAttribute<span class="token operator">></span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// 我们看到的信息是未知错误，但是在我们的日志系统里面，我们还是记录的原有的异常信息</span>
                logger<span class="token punctuation">.</span><span class="token function">LogError</span><span class="token punctuation">(</span>ex<span class="token punctuation">,</span> ex<span class="token punctuation">.</span>Message<span class="token punctuation">)</span><span class="token punctuation">;</span>
                knownException <span class="token operator">=</span> KnownException<span class="token punctuation">.</span>Unknown<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">else</span><span class="token comment" spellcheck="true">// 当识别到异常是已知的业务异常时，输出已知的异常，包括异常消息，错误状态码和错误信息，就是在 IKnownException 中的定义</span>
            <span class="token punctuation">{</span>
                knownException <span class="token operator">=</span> KnownException<span class="token punctuation">.</span><span class="token function">FromKnownException</span><span class="token punctuation">(</span>knownException<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> <span class="token function">View</span><span class="token punctuation">(</span>knownException<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>View</p>
<pre class="line-numbers language-html"><code class="language-html">@model ExceptionDemo.Exceptions.IKnownException
@{
    ViewData["Title"] = "Index";
}

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span><span class="token punctuation">></span></span>错误信息<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">></span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">></span></span>Message:<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>label</span><span class="token punctuation">></span></span>@Model.Message<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>label</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">></span></span>ErrorCode<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>label</span><span class="token punctuation">></span></span>@Model.ErrorCode<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>label</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>启动程序之后可以看到自定义的错误页已经成功渲染出来了</p>
<p><img src="https://cdn.jsdelivr.net/gh/shw2018/cdn@1.0/sakura/img/loader/orange.progress-bar-stripe-loader.svg" data-original="https://img2020.cnblogs.com/blog/1412316/202003/1412316-20200311235252348-1169360247.jpg" alt=""></p>
<p>这就是第一种处理错误的方式</p>
<p>接下来介绍使用代理方法的方式，也就是说把 ErrorController 整段逻辑直接定义在注册的地方，使用一个匿名委托来处理，这里的逻辑与之前的逻辑是相同的</p>
<pre class="line-numbers language-csharp"><code class="language-csharp">app<span class="token punctuation">.</span><span class="token function">UseExceptionHandler</span><span class="token punctuation">(</span>errApp <span class="token operator">=</span><span class="token operator">></span>
<span class="token punctuation">{</span>
    errApp<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span><span class="token keyword">async</span> context <span class="token operator">=</span><span class="token operator">></span>
    <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// 在 Features 里面获取异常</span>
        <span class="token keyword">var</span> exceptionHandlerPathFeature <span class="token operator">=</span> context<span class="token punctuation">.</span>Features<span class="token punctuation">.</span><span class="token generic-method function">Get<span class="token punctuation">&lt;</span>IExceptionHandlerPathFeature<span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 识别异常是否为 IKnownException</span>
        IKnownException knownException <span class="token operator">=</span> exceptionHandlerPathFeature<span class="token punctuation">.</span>Error <span class="token keyword">as</span> IKnownException<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>knownException <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// 如果不是则记录并且把错误的响应码响应成 Http 500</span>
            <span class="token keyword">var</span> logger <span class="token operator">=</span> context<span class="token punctuation">.</span>RequestServices<span class="token punctuation">.</span>GetService<span class="token operator">&lt;</span>ILogger<span class="token operator">&lt;</span>MyExceptionFilterAttribute<span class="token operator">></span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            logger<span class="token punctuation">.</span><span class="token function">LogError</span><span class="token punctuation">(</span>exceptionHandlerPathFeature<span class="token punctuation">.</span>Error<span class="token punctuation">,</span> exceptionHandlerPathFeature<span class="token punctuation">.</span>Error<span class="token punctuation">.</span>Message<span class="token punctuation">)</span><span class="token punctuation">;</span>
            knownException <span class="token operator">=</span> KnownException<span class="token punctuation">.</span>Unknown<span class="token punctuation">;</span>
            context<span class="token punctuation">.</span>Response<span class="token punctuation">.</span>StatusCode <span class="token operator">=</span> StatusCodes<span class="token punctuation">.</span>Status500InternalServerError<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span>
        <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// 如果捕获到的是一个业务逻辑的异常，Http 响应码应该给是 200</span>
            knownException <span class="token operator">=</span> KnownException<span class="token punctuation">.</span><span class="token function">FromKnownException</span><span class="token punctuation">(</span>knownException<span class="token punctuation">)</span><span class="token punctuation">;</span>
            context<span class="token punctuation">.</span>Response<span class="token punctuation">.</span>StatusCode <span class="token operator">=</span> StatusCodes<span class="token punctuation">.</span>Status200OK<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// 然后再把响应信息通过 json 的方式输出出去</span>
        <span class="token keyword">var</span> jsonOptions <span class="token operator">=</span> context<span class="token punctuation">.</span>RequestServices<span class="token punctuation">.</span>GetService<span class="token operator">&lt;</span>IOptions<span class="token operator">&lt;</span>JsonOptions<span class="token operator">></span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        context<span class="token punctuation">.</span>Response<span class="token punctuation">.</span>ContentType <span class="token operator">=</span> <span class="token string">"application/json; charset=utf-8"</span><span class="token punctuation">;</span>
        <span class="token keyword">await</span> context<span class="token punctuation">.</span>Response<span class="token punctuation">.</span><span class="token function">WriteAsync</span><span class="token punctuation">(</span>System<span class="token punctuation">.</span>Text<span class="token punctuation">.</span>Json<span class="token punctuation">.</span>JsonSerializer<span class="token punctuation">.</span><span class="token function">Serialize</span><span class="token punctuation">(</span>knownException<span class="token punctuation">,</span> jsonOptions<span class="token punctuation">.</span>Value<span class="token punctuation">.</span>JsonSerializerOptions<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>为什么对于未知的异常要输出 Http 500，而对于业务逻辑的异常，建议输出 Http 200？</p>
<p>因为监控系统实际上会对 Http 的响应码进行识别，当监控系统识别到 Http 响应是 500 的比例比较高的情况下，会认为系统的可用性有问题，这个时候告警系统就会发出警告</p>
<p>对于已知的业务逻辑的这种正常的识别的话，用正常的 Http 200 来处理是一个正常的行为，这样就可以让监控系统更好的工作，正确的识别出系统的一些未知的错误信息，错误的告警，让告警系统更加的灵敏，也避免了业务逻辑的异常干扰告警系统</p>
<p>接下来看一下第三种，通过异常过滤器的方式</p>
<p>这种方式实际上是作用在 MVC 的整个框架的体系下面的，它并不是在中间件的最早期发生作用的，它是在 MVC 的整个生命周期里面发生作用，也就是说它只能工作在 MVC Web API 的请求周期里面</p>
<p>首先自定义一个 MyExceptionFilter</p>
<pre class="line-numbers language-csharp"><code class="language-csharp"><span class="token keyword">namespace</span> ExceptionDemo<span class="token punctuation">.</span>Exceptions
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyExceptionFilter</span> <span class="token punctuation">:</span> IExceptionFilter
    <span class="token punctuation">{</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">OnException</span><span class="token punctuation">(</span>ExceptionContext context<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            IKnownException knownException <span class="token operator">=</span> context<span class="token punctuation">.</span>Exception <span class="token keyword">as</span> IKnownException<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>knownException <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                <span class="token keyword">var</span> logger <span class="token operator">=</span> context<span class="token punctuation">.</span>HttpContext<span class="token punctuation">.</span>RequestServices<span class="token punctuation">.</span>GetService<span class="token operator">&lt;</span>ILogger<span class="token operator">&lt;</span>MyExceptionFilterAttribute<span class="token operator">></span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                logger<span class="token punctuation">.</span><span class="token function">LogError</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span>Exception<span class="token punctuation">,</span> context<span class="token punctuation">.</span>Exception<span class="token punctuation">.</span>Message<span class="token punctuation">)</span><span class="token punctuation">;</span>
                knownException <span class="token operator">=</span> KnownException<span class="token punctuation">.</span>Unknown<span class="token punctuation">;</span>
                context<span class="token punctuation">.</span>HttpContext<span class="token punctuation">.</span>Response<span class="token punctuation">.</span>StatusCode <span class="token operator">=</span> StatusCodes<span class="token punctuation">.</span>Status500InternalServerError<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">else</span>
            <span class="token punctuation">{</span>
                knownException <span class="token operator">=</span> KnownException<span class="token punctuation">.</span><span class="token function">FromKnownException</span><span class="token punctuation">(</span>knownException<span class="token punctuation">)</span><span class="token punctuation">;</span>
                context<span class="token punctuation">.</span>HttpContext<span class="token punctuation">.</span>Response<span class="token punctuation">.</span>StatusCode <span class="token operator">=</span> StatusCodes<span class="token punctuation">.</span>Status200OK<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            context<span class="token punctuation">.</span>Result <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">JsonResult</span><span class="token punctuation">(</span>knownException<span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                ContentType <span class="token operator">=</span> <span class="token string">"application/json; charset=utf-8"</span>
            <span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>处理逻辑与之前的相同</p>
<p>接着注册 Filters</p>
<pre class="line-numbers language-csharp"><code class="language-csharp">services<span class="token punctuation">.</span><span class="token function">AddMvc</span><span class="token punctuation">(</span>mvcOptions <span class="token operator">=</span><span class="token operator">></span>
<span class="token punctuation">{</span>
    mvcOptions<span class="token punctuation">.</span>Filters<span class="token punctuation">.</span><span class="token generic-method function">Add<span class="token punctuation">&lt;</span>MyExceptionFilter<span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">AddJsonOptions</span><span class="token punctuation">(</span>jsonoptions <span class="token operator">=</span><span class="token operator">></span>
<span class="token punctuation">{</span>
    jsonoptions<span class="token punctuation">.</span>JsonSerializerOptions<span class="token punctuation">.</span>Encoder <span class="token operator">=</span> System<span class="token punctuation">.</span>Text<span class="token punctuation">.</span>Encodings<span class="token punctuation">.</span>Web<span class="token punctuation">.</span>JavaScriptEncoder<span class="token punctuation">.</span>UnsafeRelaxedJsonEscaping<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>启动程序，输出如下：</p>
<pre><code>{"message":"未知错误","errorCode":9999,"errorData":null}
</code></pre><p>输出与之前的一致，因为这是在 Controller 里面输出了错误</p>
<p>如果在 MVC 的中间件之前输出错误的话，它是没办法处理的</p>
<p>这个场景一般情况下是指需要对 Controller 进行特殊的异常处理，而对于中间件整体来讲的话，又要用另一种特殊的逻辑来处理的时候，可以用 ExceptionFilter 的方式处理</p>
<p>这种方式还可以通过 Attribute 的方式</p>
<p>自定义一个 MyExceptionFilterAttribute</p>
<pre class="line-numbers language-csharp"><code class="language-csharp"><span class="token keyword">namespace</span> ExceptionDemo<span class="token punctuation">.</span>Exceptions
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyExceptionFilterAttribute</span> <span class="token punctuation">:</span> ExceptionFilterAttribute
    <span class="token punctuation">{</span>
        <span class="token keyword">public</span> <span class="token keyword">override</span> <span class="token keyword">void</span> <span class="token function">OnException</span><span class="token punctuation">(</span>ExceptionContext context<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            IKnownException knownException <span class="token operator">=</span> context<span class="token punctuation">.</span>Exception <span class="token keyword">as</span> IKnownException<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>knownException <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                <span class="token keyword">var</span> logger <span class="token operator">=</span> context<span class="token punctuation">.</span>HttpContext<span class="token punctuation">.</span>RequestServices<span class="token punctuation">.</span>GetService<span class="token operator">&lt;</span>ILogger<span class="token operator">&lt;</span>MyExceptionFilterAttribute<span class="token operator">></span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                logger<span class="token punctuation">.</span><span class="token function">LogError</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span>Exception<span class="token punctuation">,</span> context<span class="token punctuation">.</span>Exception<span class="token punctuation">.</span>Message<span class="token punctuation">)</span><span class="token punctuation">;</span>
                knownException <span class="token operator">=</span> KnownException<span class="token punctuation">.</span>Unknown<span class="token punctuation">;</span>
                context<span class="token punctuation">.</span>HttpContext<span class="token punctuation">.</span>Response<span class="token punctuation">.</span>StatusCode <span class="token operator">=</span> StatusCodes<span class="token punctuation">.</span>Status500InternalServerError<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">else</span>
            <span class="token punctuation">{</span>
                knownException <span class="token operator">=</span> KnownException<span class="token punctuation">.</span><span class="token function">FromKnownException</span><span class="token punctuation">(</span>knownException<span class="token punctuation">)</span><span class="token punctuation">;</span>
                context<span class="token punctuation">.</span>HttpContext<span class="token punctuation">.</span>Response<span class="token punctuation">.</span>StatusCode <span class="token operator">=</span> StatusCodes<span class="token punctuation">.</span>Status200OK<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            context<span class="token punctuation">.</span>Result <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">JsonResult</span><span class="token punctuation">(</span>knownException<span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                ContentType <span class="token operator">=</span> <span class="token string">"application/json; charset=utf-8"</span>
            <span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>在 Controller 上面标注 MyExceptionFilter</p>
<pre class="line-numbers language-csharp"><code class="language-csharp"><span class="token punctuation">[</span>MyExceptionFilter<span class="token punctuation">]</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">WeatherForecastController</span> <span class="token punctuation">:</span> ControllerBase<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>启动运行之后效果相同</p>
<p>这两种方式的效果是对等的，区别在于说可以更细粒度的对异常处理进行控制，可以指定部分的 Controller 或者 Exception，来决定我们的异常处理，也可以在全局注册 ExceptionFilter</p>
<p>当然因为 ExceptionFilterAttribute 也实现了 IExceptionFilter，所以它也可以注册到全局，也可以把它当作全局异常处理的过滤器来使用，Controller 上面也就不需要标记了</p>
<p>注册 Filters</p>
<pre class="line-numbers language-csharp"><code class="language-csharp">services<span class="token punctuation">.</span><span class="token function">AddMvc</span><span class="token punctuation">(</span>mvcOptions <span class="token operator">=</span><span class="token operator">></span>
<span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">//mvcOptions.Filters.Add&lt;MyExceptionFilter>();</span>
    mvcOptions<span class="token punctuation">.</span>Filters<span class="token punctuation">.</span><span class="token generic-method function">Add<span class="token punctuation">&lt;</span>MyExceptionFilterAttribute<span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">AddJsonOptions</span><span class="token punctuation">(</span>jsonoptions <span class="token operator">=</span><span class="token operator">></span>
<span class="token punctuation">{</span>
    jsonoptions<span class="token punctuation">.</span>JsonSerializerOptions<span class="token punctuation">.</span>Encoder <span class="token operator">=</span> System<span class="token punctuation">.</span>Text<span class="token punctuation">.</span>Encodings<span class="token punctuation">.</span>Web<span class="token punctuation">.</span>JavaScriptEncoder<span class="token punctuation">.</span>UnsafeRelaxedJsonEscaping<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>在 Controller 上面取消标注 MyExceptionFilter</p>
<pre class="line-numbers language-csharp"><code class="language-csharp"><span class="token comment" spellcheck="true">//[MyExceptionFilter]</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">WeatherForecastController</span> <span class="token punctuation">:</span> ControllerBase<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>启动程序，输出结果一致</p>
<p>这个场景对于我们定义一些 API，然后对 API 进行定义我们的异常处理的约定是很有帮助的</p>
<p><strong>总结一下</strong></p>
<ol>
<li><p>首先我们需要定义特定的异常类或者接口，我们可以定义抽象类，也可以用接口的方式，例子中是通过接口的方式表示业务逻辑的异常</p>
</li>
<li><p>对于业务逻辑的异常，实际上需要定义全局的错误码</p>
</li>
<li><p>对于未知的异常，应该输出特定的输出信息和错误码，然后记录完整的日志，我们不应该把系统内部的一些比如说异常堆栈这些信息输出给用户</p>
</li>
<li><p>对于已知的业务逻辑的异常，用 Http 200 的方式，对于未知的异常，用 Http 500 的方式，这样可以让监控系统更好的工作</p>
</li>
<li><p>另外一个建议就是尽量记录所有的异常的详细信息，以供后续对日志进行分析，也供监控系统做一些特定的监控警告</p>
</li>
</ol>
<h2 id="23-静态文件中间件：前后端分离开发合并部署骚操作"><a href="#23-静态文件中间件：前后端分离开发合并部署骚操作" class="headerlink" title="23 | 静态文件中间件：前后端分离开发合并部署骚操作"></a>23 | 静态文件中间件：前后端分离开发合并部署骚操作</h2><p>我们先来看一下静态文件中间件有哪些能力</p>
<ol>
<li><p>支持指定相对路径</p>
</li>
<li><p>支持目录的浏览</p>
</li>
<li><p>支持设置默认文档</p>
</li>
<li><p>支持多目录映射</p>
</li>
</ol>
<p>首先使用静态文件中间件</p>
<pre class="line-numbers language-csharp"><code class="language-csharp"><span class="token comment" spellcheck="true">// 通过这一行代码就可以访问到静态配置文件</span>
app<span class="token punctuation">.</span><span class="token function">UseStaticFiles</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>这样就可以将 wwwroot 目录映射出来，这是一个默认的配置，也就是说，当我们需要使用中间件静态文件输出的时候，首选就是应该把静态文件放在 wwwroot 下面</p>
<p>我们在这个目录下面放了几个文件：index.html，app.js，a 目录下面也有一个 index.html 和一个 a.js，这两个 index.html 的内容是不一样的</p>
<p>a/index.html</p>
<pre class="line-numbers language-html"><code class="language-html"><span class="token doctype">&lt;!DOCTYPE html></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">charset</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>utf-8<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">></span></span>/a/index<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>a.js<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token script language-javascript"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span><span class="token punctuation">></span></span>这是/a/index<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">></span></span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>index.html</p>
<pre class="line-numbers language-html"><code class="language-html"><span class="token doctype">&lt;!DOCTYPE html></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">charset</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>utf-8<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">></span></span>静态首页<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>app.js<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token script language-javascript"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span><span class="token punctuation">></span></span>这是静态首页<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">></span></span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>启动程序，由于我们没有指定相对路径，所以说我们的根目录是/，就代表访问到了 wwwroot，输入 index.html，可以看到 javaScript 执行</p>
<pre><code>https://localhost:5001/index.html</code></pre><p><img src="https://cdn.jsdelivr.net/gh/shw2018/cdn@1.0/sakura/img/loader/orange.progress-bar-stripe-loader.svg" data-original="https://img2020.cnblogs.com/blog/1412316/202003/1412316-20200313235013142-304736164.jpg" alt=""></p>
<p><img src="https://cdn.jsdelivr.net/gh/shw2018/cdn@1.0/sakura/img/loader/orange.progress-bar-stripe-loader.svg" data-original="https://img2020.cnblogs.com/blog/1412316/202003/1412316-20200313235020959-1360760602.jpg" alt=""></p>
<p>如果把地址换一下，会得到另一个页面</p>
<pre><code>https://localhost:5001/a/index.html</code></pre><p><img src="https://cdn.jsdelivr.net/gh/shw2018/cdn@1.0/sakura/img/loader/orange.progress-bar-stripe-loader.svg" data-original="https://img2020.cnblogs.com/blog/1412316/202003/1412316-20200313235058542-458749199.jpg" alt=""></p>
<p><img src="https://cdn.jsdelivr.net/gh/shw2018/cdn@1.0/sakura/img/loader/orange.progress-bar-stripe-loader.svg" data-original="https://img2020.cnblogs.com/blog/1412316/202003/1412316-20200313235105447-1275734374.jpg" alt=""></p>
<p>如果默认情况下都是访问 index.html，怎么做呢？</p>
<pre class="line-numbers language-csharp"><code class="language-csharp">app<span class="token punctuation">.</span><span class="token function">UseDefaultFiles</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>这个方法还有一个重载</p>
<pre class="line-numbers language-csharp"><code class="language-csharp"><span class="token keyword">namespace</span> Microsoft<span class="token punctuation">.</span>AspNetCore<span class="token punctuation">.</span>Builder
<span class="token punctuation">{</span>
  <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">DefaultFilesExtensions</span>
  <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> IApplicationBuilder <span class="token function">UseDefaultFiles</span><span class="token punctuation">(</span>
      <span class="token keyword">this</span> IApplicationBuilder app<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> IApplicationBuilder <span class="token function">UseDefaultFiles</span><span class="token punctuation">(</span>
      <span class="token keyword">this</span> IApplicationBuilder app<span class="token punctuation">,</span>
      DefaultFilesOptions options<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> IApplicationBuilder <span class="token function">UseDefaultFiles</span><span class="token punctuation">(</span>
      <span class="token keyword">this</span> IApplicationBuilder app<span class="token punctuation">,</span>
      <span class="token keyword">string</span> requestPath<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>DefaultFilesOptions</p>
<pre class="line-numbers language-csharp"><code class="language-csharp"><span class="token keyword">namespace</span> Microsoft<span class="token punctuation">.</span>AspNetCore<span class="token punctuation">.</span>Builder
<span class="token punctuation">{</span>
  <span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DefaultFilesOptions</span> <span class="token punctuation">:</span> SharedOptionsBase
  <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token function">DefaultFilesOptions</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token function">DefaultFilesOptions</span><span class="token punctuation">(</span>SharedOptions sharedOptions<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> IList<span class="token operator">&lt;</span><span class="token keyword">string</span><span class="token operator">></span> DefaultFileNames <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>可以设置 DefaultFileNames，默认 index.html 是在里面的，所以这里可以不输入任何参数</p>
<p>启动程序，访问根目录的时候，应该输出首页的 index</p>
<pre><code>https://localhost:5001/</code></pre><p>访问 a 目录会输出 a 的 index</p>
<p>还有一种场景就是我们需要浏览我们的目录</p>
<p>在 ConfigureServices 注册 AddDirectoryBrowser</p>
<pre class="line-numbers language-csharp"><code class="language-csharp"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">ConfigureServices</span><span class="token punctuation">(</span>IServiceCollection services<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    services<span class="token punctuation">.</span><span class="token function">AddControllers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    services<span class="token punctuation">.</span><span class="token function">AddDirectoryBrowser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>然后在 Configure 里面启用</p>
<pre class="line-numbers language-csharp"><code class="language-csharp">app<span class="token punctuation">.</span><span class="token function">UseDirectoryBrowser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>启动程序，访问根目录</p>
<p><img src="https://cdn.jsdelivr.net/gh/shw2018/cdn@1.0/sakura/img/loader/orange.progress-bar-stripe-loader.svg" data-original="https://img2020.cnblogs.com/blog/1412316/202003/1412316-20200313235125777-1228639546.jpg" alt=""></p>
<p>可以看到浏览器上面显示了目录的文件，当我们点击其中的一个文件的时候，实际上是访问这个文件，我们还可以浏览它的子目录</p>
<p>这是我们在使用 wwwroot 的情况下，实际上我们还可以使用其他的目录，把其他的目录也注册进来</p>
<p>我们在应用程序的 file 目录下面另外添加了一个 page.html</p>
<pre class="line-numbers language-html"><code class="language-html"><span class="token doctype">&lt;!DOCTYPE html></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">charset</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>utf-8<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">></span></span>page<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span><span class="token punctuation">></span></span>page<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>我们也期望可以访问到这个文件，我们就可以这样去做</p>
<pre class="line-numbers language-csharp"><code class="language-csharp">app<span class="token punctuation">.</span><span class="token function">UseStaticFiles</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token function">UseStaticFiles</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">StaticFileOptions</span>
<span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// 注入我们的物理文件提供程序，把我们的当前目录加 file，就是 file 目录，赋值给我们的提供程序</span>
    <span class="token comment" spellcheck="true">// 这样子的效果就是我们的 wwwroot 会优先去寻找我们的文件，如果没有的话就会执行下一个中间件</span>
    <span class="token comment" spellcheck="true">// 然后在这个中间件里面再找我们的文件是否存在，如果没有的话，它会去执行后面的路由和 MVC 的 Web API 的 Controller</span>
    FileProvider <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PhysicalFileProvider</span><span class="token punctuation">(</span>Path<span class="token punctuation">.</span><span class="token function">Combine</span><span class="token punctuation">(</span>Directory<span class="token punctuation">.</span><span class="token function">GetCurrentDirectory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"file"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>因为这里我们入参并没有设置相对路径，也就是说我们根目录对应的也是 file 这个目录，我们这里可以输出 page.html</p>
<pre><code>https://localhost:5001/page.html</code></pre><p><img src="https://cdn.jsdelivr.net/gh/shw2018/cdn@1.0/sakura/img/loader/orange.progress-bar-stripe-loader.svg" data-original="https://img2020.cnblogs.com/blog/1412316/202003/1412316-20200314000345050-2945666.jpg" alt=""></p>
<p>我们的 page.html 就可以访问到了</p>
<p>还有一种情况是我们希望把我们的静态目录映射为某一个特定的 URL 地址目录下面，我们可以这样去做</p>
<pre class="line-numbers language-csharp"><code class="language-csharp">app<span class="token punctuation">.</span><span class="token function">UseStaticFiles</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token function">UseStaticFiles</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">StaticFileOptions</span>
<span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// 我们希望把我们的静态目录映射为某一个特定的 URL 地址目录下面</span>
    RequestPath <span class="token operator">=</span> <span class="token string">"/files"</span><span class="token punctuation">,</span>
    <span class="token comment" spellcheck="true">// 注入我们的物理文件提供程序，把我们的当前目录加 file，就是 file 目录，赋值给我们的提供程序</span>
    <span class="token comment" spellcheck="true">// 这样子的效果就是我们的 wwwroot 会优先去寻找我们的文件，如果没有的话就会执行下一个中间件</span>
    <span class="token comment" spellcheck="true">// 然后在这个中间件里面再找我们的文件是否存在，如果没有的话，它会去执行后面的路由和 MVC 的 Web API 的 Controller</span>
    FileProvider <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PhysicalFileProvider</span><span class="token punctuation">(</span>Path<span class="token punctuation">.</span><span class="token function">Combine</span><span class="token punctuation">(</span>Directory<span class="token punctuation">.</span><span class="token function">GetCurrentDirectory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"file"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>访问以下路径就可以看到我们的静态文件页面</p>
<pre><code>https://localhost:5001/files/page.html</code></pre><p>也就是说我们可以把任意的文件目录映射为任意的 URL 地址</p>
<p>这里还有一个比较特殊的用法</p>
<p>一般情况下，我们前后端分离的架构，前端会编译成一个 index.html 文件和若干个 CSS 文件和 JavaScript 和图片文件</p>
<p>CSS 文件和 JavaScript 和图片文件一般会部署在 CDN 服务器上，这个 index 文件就需要我们建立一个宿主来 host 它</p>
<p>并且前端的一般路由的话，我们现在都会用 HTML5 的 History 的路由模式</p>
<p>这个时候前端就会对后端有一个特殊的诉求，除了 API 的请求以外，其他的请求的响应都应该是 index.html 这个静态文件</p>
<p>要达到这个目的，我们可以借助我们的中间件的执行原理来实现</p>
<p>首先假设我们的 index.html 就是我们前端编译好的静态文件，我们放置在 wwwroot 下面，前端编译的任何文件都放在 wwwroot 下面</p>
<p>然后我们再做一件事件就是 UseStaticFiles，我们把目录访问整个去掉</p>
<pre><code>//services.AddDirectoryBrowser();</code></pre><p>首先映射静态文件</p>
<pre class="line-numbers language-csharp"><code class="language-csharp">app<span class="token punctuation">.</span><span class="token function">UseStaticFiles</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>静态文件映射出来之后实际上还有一个诉求，就是当我们访问其他特殊的页面地址的时候，比如说 /order/get 这样子的页面的时候，也应该响应我们的静态文件</p>
<p>这个时候我们可以把这样一段逻辑加入进来</p>
<pre class="line-numbers language-csharp"><code class="language-csharp"><span class="token comment" spellcheck="true">// 判断我们当前的请求是否满足条件</span>
app<span class="token punctuation">.</span><span class="token function">MapWhen</span><span class="token punctuation">(</span>context <span class="token operator">=</span><span class="token operator">></span>
<span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// 如果我们的请求不是以 API 开头的请求</span>
    <span class="token keyword">return</span> <span class="token operator">!</span>context<span class="token punctuation">.</span>Request<span class="token punctuation">.</span>Path<span class="token punctuation">.</span>Value<span class="token punctuation">.</span><span class="token function">StartsWith</span><span class="token punctuation">(</span><span class="token string">"/api"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> appBuilder <span class="token operator">=</span><span class="token operator">></span>
<span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// 如果满足条件，我就走我下面这一段中间件的逻辑</span>
    <span class="token keyword">var</span> option <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RewriteOptions</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">// 重写为 /index.html</span>
    option<span class="token punctuation">.</span><span class="token function">AddRewrite</span><span class="token punctuation">(</span><span class="token string">".*"</span><span class="token punctuation">,</span> <span class="token string">"/index.html"</span><span class="token punctuation">,</span> <span class="token keyword">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    appBuilder<span class="token punctuation">.</span><span class="token function">UseRewriter</span><span class="token punctuation">(</span>option<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// 重写完之后再使用我们的静态文件中间件</span>
    appBuilder<span class="token punctuation">.</span><span class="token function">UseStaticFiles</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这样子可以达到一个效果就是我们访问任意的非 API 目录的时候，我们都可以得到 index.html</p>
<p>启动程序</p>
<pre><code>https://localhost:5001/api/weatherforecast</code></pre><p>可以正常访问</p>
<p>API 的请求我们都是让它通过的，不是 API 的时候才会拦截</p>
<p>这个时候如果访问</p>
<pre><code>https://localhost:5001/order</code></pre><p>会发现获得的是静态文件</p>
<p>如果说静态文件是存在的，这个时候实际上会响应原有的静态文件，比如说访问</p>
<pre><code>https://localhost:5001/a/index.html</code></pre><p>这样子就可以发现我们能让静态文件的目录正常工作，并且能将其他的我们需要的地址都重定向到 index.html</p>
<p>当然这里还有另外一种写法，就是不用 UseRewriter 的方式，而是用 Run 的方式，也是就用断路器的方式</p>
<pre class="line-numbers language-csharp"><code class="language-csharp"><span class="token comment" spellcheck="true">// 判断我们当前的请求是否满足条件</span>
app<span class="token punctuation">.</span><span class="token function">MapWhen</span><span class="token punctuation">(</span>context <span class="token operator">=</span><span class="token operator">></span>
<span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// 如果我们的请求不是以 API 开头的请求</span>
    <span class="token keyword">return</span> <span class="token operator">!</span>context<span class="token punctuation">.</span>Request<span class="token punctuation">.</span>Path<span class="token punctuation">.</span>Value<span class="token punctuation">.</span><span class="token function">StartsWith</span><span class="token punctuation">(</span><span class="token string">"/api"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> appBuilder <span class="token operator">=</span><span class="token operator">></span>
<span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">//// 如果满足条件，我就走我下面这一段中间件的逻辑</span>
    <span class="token comment" spellcheck="true">//var option = new RewriteOptions();</span>
    <span class="token comment" spellcheck="true">//// 重写为 /index.html</span>
    <span class="token comment" spellcheck="true">//option.AddRewrite(".*", "/index.html", true);</span>
    <span class="token comment" spellcheck="true">//appBuilder.UseRewriter(option);</span>

    <span class="token comment" spellcheck="true">//// 重写完之后再使用我们的静态文件中间件</span>
    <span class="token comment" spellcheck="true">//appBuilder.UseStaticFiles();</span>

    appBuilder<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span><span class="token keyword">async</span> c <span class="token operator">=</span><span class="token operator">></span>
    <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// 读取静态文件，并且输出给我们的 Response</span>
        <span class="token keyword">var</span> file <span class="token operator">=</span> env<span class="token punctuation">.</span>WebRootFileProvider<span class="token punctuation">.</span><span class="token function">GetFileInfo</span><span class="token punctuation">(</span><span class="token string">"index.html"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        c<span class="token punctuation">.</span>Response<span class="token punctuation">.</span>ContentType <span class="token operator">=</span> <span class="token string">"text/html"</span><span class="token punctuation">;</span>
        <span class="token keyword">using</span> <span class="token punctuation">(</span><span class="token keyword">var</span> fileStream <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileStream</span><span class="token punctuation">(</span>file<span class="token punctuation">.</span>PhysicalPath<span class="token punctuation">,</span> FileMode<span class="token punctuation">.</span>Open<span class="token punctuation">,</span> FileAccess<span class="token punctuation">.</span>Read<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token keyword">await</span> StreamCopyOperation<span class="token punctuation">.</span><span class="token function">CopyToAsync</span><span class="token punctuation">(</span>fileStream<span class="token punctuation">,</span> c<span class="token punctuation">.</span>Response<span class="token punctuation">.</span>Body<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> BufferSize<span class="token punctuation">,</span> c<span class="token punctuation">.</span>RequestAborted<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这种写法有一个缺点就是，没办法像静态文件中间件那样，输出正确的 Http 请求头</p>
<p>对比一下两种方式的输出的请求头的不同</p>
<p>启动程序，访问</p>
<pre><code>https://localhost:5001/order</code></pre><p>打开调试工具，可以看到对 order 的我们的响应头就只有 4 个</p>
<p><img src="https://cdn.jsdelivr.net/gh/shw2018/cdn@1.0/sakura/img/loader/orange.progress-bar-stripe-loader.svg" data-original="https://img2020.cnblogs.com/blog/1412316/202003/1412316-20200315001215172-405775898.jpg" alt=""></p>
<p>其他的静态文件，响应头会多出来 etag，data，last-modified</p>
<p><img src="https://cdn.jsdelivr.net/gh/shw2018/cdn@1.0/sakura/img/loader/orange.progress-bar-stripe-loader.svg" data-original="https://img2020.cnblogs.com/blog/1412316/202003/1412316-20200315001225473-1810727767.png" alt=""></p>
<p>这些的话就是我们关于 HTTP 缓存可以用到的头，所以说我们还是推荐使用上面这种方式，静态中间件的方式，而不是自己输出文件的方式</p>
<h2 id="24-文件提供程序：让你可以将文件放在任何地方"><a href="#24-文件提供程序：让你可以将文件放在任何地方" class="headerlink" title="24 | 文件提供程序：让你可以将文件放在任何地方"></a>24 | 文件提供程序：让你可以将文件放在任何地方</h2><p>文件提供程序核心类型：</p>
<ol>
<li><p>IFileProvider</p>
</li>
<li><p>IFileInfo</p>
</li>
<li><p>IDirectoryContents</p>
</li>
</ol>
<p>IFileProvider 是访问各种各样文件提供程序的接口</p>
<p>通过这样子抽象的定义，让我们与具体的抽象文件的读取的代码进行了隔离</p>
<p>这样的好处是我们可以从不同的地方去读取文件，不仅仅是我们的物理文件，也可以是嵌入式文件，甚至可以说是云端上面的其他 API 提供的文件</p>
<p>内置的提供程序有三种：</p>
<p>（1）PhysicalFileProvider：物理文件的提供程序</p>
<p>（2）EmbeddedFileProvider：嵌入式的提供程序</p>
<p>（3）CompositeFileProvider：组合文件的提供程序</p>
<p>组合文件的提供程序是指当我们有多种文件数据来源的时候，可以将这些源合并为一个目录一样，让我们像在使用同一个目录一样使用我们的文件系统</p>
<p>首先我们可以看一下 IFileProvider 的定义</p>
<pre class="line-numbers language-csharp"><code class="language-csharp"><span class="token keyword">namespace</span> Microsoft<span class="token punctuation">.</span>Extensions<span class="token punctuation">.</span>FileProviders
<span class="token punctuation">{</span>
  <span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">IFileProvider</span>
  <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// 输入是一个相对的路径</span>
    IFileInfo <span class="token function">GetFileInfo</span><span class="token punctuation">(</span><span class="token keyword">string</span> subpath<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// 获取指定目录下的目录信息</span>
    IDirectoryContents <span class="token function">GetDirectoryContents</span><span class="token punctuation">(</span><span class="token keyword">string</span> subpath<span class="token punctuation">)</span><span class="token punctuation">;</span>

    IChangeToken <span class="token function">Watch</span><span class="token punctuation">(</span><span class="token keyword">string</span> filter<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>IDirectoryContents</p>
<pre class="line-numbers language-csharp"><code class="language-csharp"><span class="token keyword">namespace</span> Microsoft<span class="token punctuation">.</span>Extensions<span class="token punctuation">.</span>FileProviders
<span class="token punctuation">{</span>
  <span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">IDirectoryContents</span> <span class="token punctuation">:</span> IEnumerable<span class="token operator">&lt;</span>IFileInfo<span class="token operator">></span><span class="token punctuation">,</span> IEnumerable
  <span class="token punctuation">{</span>
    <span class="token keyword">bool</span> Exists <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这个接口实际上就是 IFileInfo 的一个集合，还有一个属性是否存在，表示当前目录是否存在，如果存在的话，我们可以从它内部枚举到我们的所有文件</p>
<p>IFileInfo</p>
<pre class="line-numbers language-csharp"><code class="language-csharp"><span class="token keyword">namespace</span> Microsoft<span class="token punctuation">.</span>Extensions<span class="token punctuation">.</span>FileProviders
<span class="token punctuation">{</span>
  <span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">IFileInfo</span>
  <span class="token punctuation">{</span>
    <span class="token keyword">bool</span> Exists <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>

    <span class="token keyword">long</span> Length <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>

    <span class="token keyword">string</span> PhysicalPath <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>

    <span class="token keyword">string</span> Name <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>

    DateTimeOffset LastModified <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>

    <span class="token keyword">bool</span> IsDirectory <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>

    Stream <span class="token function">CreateReadStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>IFileInfo 有几个属性：是否存在，文件长度，物理地址，文件名，最后修改时间，是否是一个目录（有可能获取到的文件并不是一个真实的文件，它可能是一个目录，那也就是用 IFileInfo 来代替的），读取文件流</p>
<p>接下来通过代码看一下</p>
<pre class="line-numbers language-csharp"><code class="language-csharp"><span class="token comment" spellcheck="true">// 定义一个物理文件的提供程序，把我们当前应用程序的根目录映射出来</span>
IFileProvider provider1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PhysicalFileProvider</span><span class="token punctuation">(</span>AppDomain<span class="token punctuation">.</span>CurrentDomain<span class="token punctuation">.</span>BaseDirectory<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">// 获取到这个目录下面的所有内容</span>
<span class="token keyword">var</span> contents <span class="token operator">=</span> provider1<span class="token punctuation">.</span><span class="token function">GetDirectoryContents</span><span class="token punctuation">(</span><span class="token string">"/"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token keyword">var</span> item <span class="token keyword">in</span> contents<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// 打印文件名</span>
    Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span>item<span class="token punctuation">.</span>Name<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>启动程序可以看到控制台输出了编译目录下面的文件</p>
<pre><code>FileProviderDemo.deps.json
FileProviderDemo.dll
FileProviderDemo.exe
FileProviderDemo.pdb
FileProviderDemo.runtimeconfig.dev.json
FileProviderDemo.runtimeconfig.json
Microsoft.Extensions.FileProviders.Abstractions.dll
Microsoft.Extensions.FileProviders.Composite.dll
Microsoft.Extensions.FileProviders.Embedded.dll
Microsoft.Extensions.FileProviders.Physical.dll
Microsoft.Extensions.FileSystemGlobbing.dll
Microsoft.Extensions.Primitives.dll</code></pre><p>如果我们要读文件流的话，可以通过 CreateReadStream</p>
<pre class="line-numbers language-csharp"><code class="language-csharp"><span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token keyword">var</span> item <span class="token keyword">in</span> contents<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// 读取文件流</span>
    <span class="token keyword">var</span> stream <span class="token operator">=</span> item<span class="token punctuation">.</span><span class="token function">CreateReadStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">// 打印文件名</span>
    Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span>item<span class="token punctuation">.</span>Name<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>接下来看一下嵌入式的提供程序，它是指编译时把文件嵌入到程序集内部，就像源文件一样，但是与通常的资源文件不同的是，我们可以像读取目录一样读取我们的文件</p>
<pre class="line-numbers language-csharp"><code class="language-csharp">IFileProvider provider2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">EmbeddedFileProvider</span><span class="token punctuation">(</span><span class="token keyword">typeof</span><span class="token punctuation">(</span>Program<span class="token punctuation">)</span><span class="token punctuation">.</span>Assembly<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>这里我们创建了一个 emb.html</p>
<pre class="line-numbers language-html"><code class="language-html"><span class="token doctype">&lt;!DOCTYPE html></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span> <span class="token attr-name">lang</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>en<span class="token punctuation">"</span></span> <span class="token attr-name">xmlns</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>http://www.w3.org/1999/xhtml<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">charset</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>utf-8<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">></span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>然后把它的属性设置为嵌入的资源，而不是内容</p>
<p>这样的设置的话，我们可以看一下对工程文件有什么影响</p>
<p>编辑项目可以看到我们把这个文件定义为嵌入式资源</p>
<pre class="line-numbers language-csharp"><code class="language-csharp">  <span class="token operator">&lt;</span>ItemGroup<span class="token operator">></span>
    <span class="token operator">&lt;</span>EmbeddedResource Include<span class="token operator">=</span><span class="token string">"emb.html"</span> <span class="token operator">/</span><span class="token operator">></span>
  <span class="token operator">&lt;</span><span class="token operator">/</span>ItemGroup<span class="token operator">></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>再次读取这个文件</p>
<pre class="line-numbers language-csharp"><code class="language-csharp">IFileProvider provider2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">EmbeddedFileProvider</span><span class="token punctuation">(</span><span class="token keyword">typeof</span><span class="token punctuation">(</span>Program<span class="token punctuation">)</span><span class="token punctuation">.</span>Assembly<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> html <span class="token operator">=</span> provider2<span class="token punctuation">.</span><span class="token function">GetFileInfo</span><span class="token punctuation">(</span><span class="token string">"emb.html"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>断点调试查看文件信息</p>
<p><img src="https://cdn.jsdelivr.net/gh/shw2018/cdn@1.0/sakura/img/loader/orange.progress-bar-stripe-loader.svg" data-original="https://img2020.cnblogs.com/blog/1412316/202003/1412316-20200316000118155-1345658313.png" alt=""></p>
<p>可以看到 html 这个文件是否存在，是否目录，最后修改时间，长度，名字，物理路径</p>
<p>这就是可以通过嵌入式的文件提供程序来读取编译时构建到程序集里面的资源</p>
<p>最后一个就是组合文件提供程序，它的作用就是将各种提供程序组合成一个目录，让我们可以访问它</p>
<pre class="line-numbers language-csharp"><code class="language-csharp"><span class="token comment" spellcheck="true">// 传入前面的两种文件提供程序到组合提供程序里面，它可以传入多个文件提供程序</span>
IFileProvider provider <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CompositeFileProvider</span><span class="token punctuation">(</span>provider1<span class="token punctuation">,</span> provider2<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> contents <span class="token operator">=</span> provider<span class="token punctuation">.</span><span class="token function">GetDirectoryContents</span><span class="token punctuation">(</span><span class="token string">"/"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token keyword">var</span> item <span class="token keyword">in</span> contents<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span>item<span class="token punctuation">.</span>Name<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>启动程序可以看到，不仅输出了程序集，编译构建出来的文件，同时还输出资源文件 emb.html</p>
<pre><code>FileProviderDemo.deps.json
FileProviderDemo.dll
FileProviderDemo.exe
FileProviderDemo.pdb
FileProviderDemo.runtimeconfig.dev.json
FileProviderDemo.runtimeconfig.json
Microsoft.Extensions.FileProviders.Abstractions.dll
Microsoft.Extensions.FileProviders.Composite.dll
Microsoft.Extensions.FileProviders.Embedded.dll
Microsoft.Extensions.FileProviders.Physical.dll
Microsoft.Extensions.FileSystemGlobbing.dll
Microsoft.Extensions.Primitives.dll
emb.html</code></pre><p>这就说明可以像在访问同一个目录一样，访问不同的文件提供程序目录，这就意味着实际上是可以通过实现简单的 IFileProvider 和 IFileInfo 就可以实现自己的文件提供程序</p>
<p>这些文件提供程序举一个场景比如说可以通过 OSS 的这种远程存储的方式将文件读取出来并且提供给应用程序，但是应用程序并不需要做特殊的配置，只需要把 OSS 提供的程序注入到系统里面，只需要按照 IFileProvider 提供的接口来读取文件，就可以做到像在读取本地文件一样，也就是说可以借助这套框架读取任意位置的文件</p>
<h2 id="25-路由与终结点：如何规划好你的Web-API"><a href="#25-路由与终结点：如何规划好你的Web-API" class="headerlink" title="25 | 路由与终结点：如何规划好你的Web API"></a>25 | 路由与终结点：如何规划好你的Web API</h2><p>路由系统在 ASP.NET MVC 框架里面就已经存在了，在 ASP.NET Core 框架里面进行了改进</p>
<p>路由系统的核心作用是指 URL 和 应用程序 Controller 的对应关系的一种映射</p>
<p><strong>这个映射关系实际上有两种作用：</strong></p>
<ol>
<li><p>把 URL 映射到对应的 Controller 对应的 action 上面去</p>
</li>
<li><p>根据 Controller 和 action 的名字来生产 URL</p>
</li>
</ol>
<p><strong>.NET Core 提供了两种路由注册的方式：</strong></p>
<ol>
<li><p>路由模板的方式</p>
</li>
<li><p>RouteAttribute 方式</p>
</li>
</ol>
<p>这两种方式分别适用于的场景是不一样的</p>
<p>路由模板的方式是之前传统的方式，可以用来作为 MVC 的页面 Web 配置</p>
<p>现在用的比较多的前后端分离的架构，定义 Web API 的时候使用 RouteAttribute 方式去做</p>
<p>在定义路由，注册路由的过程中间，有一个重要的特性就是路由约束，是指路由如何匹配</p>
<p>有以下简单的几种约束：</p>
<ol>
<li>类型约束</li>
<li>范围约束</li>
<li>正则表达式</li>
<li>是否必选</li>
<li>自定义 IRouteConstraint</li>
</ol>
<p>另外路由系统提供了两个关键的类，用来反向根据路由的信息生产 URL 地址</p>
<ol>
<li>LinkGenerator</li>
<li>IUrlHelper</li>
</ol>
<p>IUrlHelper 与 MVC 框架里面的 MVCHelper 很像</p>
<p>而 LinkGenerator 是全新提供的一个链接生成的对象，可以从容器里面，在任意的位置都可以获取到这个对象，然后根据需要生成 URL 地址</p>
<p>为了方便演示，这里先注册了一组 Swagger 的代码，将 Web API 通过 Swagger 的可视化界面输出出来</p>
<p>引入 Swagger 对应 ASP.NET Core 的包</p>
<pre><code>Swashbuckle.AspNetCore</code></pre><p>将代码文档 XML 文档注入给 Swagger</p>
<pre class="line-numbers language-csharp"><code class="language-csharp">services<span class="token punctuation">.</span><span class="token function">AddSwaggerGen</span><span class="token punctuation">(</span>c <span class="token operator">=</span><span class="token operator">></span>
<span class="token punctuation">{</span>
    c<span class="token punctuation">.</span><span class="token function">SwaggerDoc</span><span class="token punctuation">(</span><span class="token string">"v1"</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">OpenApiInfo</span> <span class="token punctuation">{</span> Title <span class="token operator">=</span> <span class="token string">"My API"</span><span class="token punctuation">,</span> Version <span class="token operator">=</span> <span class="token string">"v1"</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">var</span> xmlFile <span class="token operator">=</span> $<span class="token string">"{Assembly.GetExecutingAssembly().GetName().Name}.xml"</span><span class="token punctuation">;</span>
    <span class="token keyword">var</span> xmlPath <span class="token operator">=</span> Path<span class="token punctuation">.</span><span class="token function">Combine</span><span class="token punctuation">(</span>AppContext<span class="token punctuation">.</span>BaseDirectory<span class="token punctuation">,</span> xmlFile<span class="token punctuation">)</span><span class="token punctuation">;</span>
    c<span class="token punctuation">.</span><span class="token function">IncludeXmlComments</span><span class="token punctuation">(</span>xmlPath<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>在中间件里面注册 Swagger</p>
<pre class="line-numbers language-csharp"><code class="language-csharp">app<span class="token punctuation">.</span><span class="token function">UseSwagger</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span><span class="token function">UseSwaggerUI</span><span class="token punctuation">(</span>c <span class="token operator">=</span><span class="token operator">></span>
<span class="token punctuation">{</span>
    c<span class="token punctuation">.</span><span class="token function">SwaggerEndpoint</span><span class="token punctuation">(</span><span class="token string">"/swagger/v1/swagger.json"</span><span class="token punctuation">,</span> <span class="token string">"My API V1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这样子就可以在界面上看到 Swagger 的界面，并且浏览我们定义的 API</p>
<p>接着是路由的定义 OrderController</p>
<pre class="line-numbers language-csharp"><code class="language-csharp"><span class="token keyword">namespace</span> RoutingDemo<span class="token punctuation">.</span>Controllers
<span class="token punctuation">{</span>
    <span class="token punctuation">[</span><span class="token function">Route</span><span class="token punctuation">(</span><span class="token string">"api/[controller]/[action]"</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token comment" spellcheck="true">// RouteAttribute 的方式</span>
    <span class="token punctuation">[</span>ApiController<span class="token punctuation">]</span>
    <span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OrderController</span> <span class="token punctuation">:</span> ControllerBase
    <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">/// &lt;summary></span>
        <span class="token comment" spellcheck="true">/// </span>
        <span class="token comment" spellcheck="true">/// &lt;/summary></span>
        <span class="token comment" spellcheck="true">/// &lt;param name="id">必须可以转为long&lt;/param></span>
        <span class="token comment" spellcheck="true">/// &lt;returns>&lt;/returns></span>
        <span class="token punctuation">[</span><span class="token function">HttpGet</span><span class="token punctuation">(</span><span class="token string">"{id:MyRouteConstraint}"</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token comment" spellcheck="true">// 这里使用了自定义的约束</span>
        <span class="token keyword">public</span> <span class="token keyword">bool</span> <span class="token function">OrderExist</span><span class="token punctuation">(</span><span class="token keyword">object</span> id<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token keyword">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment" spellcheck="true">/// &lt;summary></span>
        <span class="token comment" spellcheck="true">/// </span>
        <span class="token comment" spellcheck="true">/// &lt;/summary></span>
        <span class="token comment" spellcheck="true">/// &lt;param name="id">最大20&lt;/param></span>
        <span class="token comment" spellcheck="true">/// &lt;returns>&lt;/returns></span>
        <span class="token punctuation">[</span><span class="token function">HttpGet</span><span class="token punctuation">(</span><span class="token string">"{id:max(20)}"</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token comment" spellcheck="true">// 这里使用了 Max 的约束</span>
        <span class="token keyword">public</span> <span class="token keyword">bool</span> <span class="token function">Max</span><span class="token punctuation">(</span><span class="token keyword">long</span> id<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token keyword">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment" spellcheck="true">/// &lt;summary></span>
        <span class="token comment" spellcheck="true">/// </span>
        <span class="token comment" spellcheck="true">/// &lt;/summary></span>
        <span class="token comment" spellcheck="true">/// &lt;param name="ss">必填&lt;/param></span>
        <span class="token comment" spellcheck="true">/// &lt;returns>&lt;/returns></span>
        <span class="token punctuation">[</span><span class="token function">HttpGet</span><span class="token punctuation">(</span><span class="token string">"{name:required}"</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token comment" spellcheck="true">// 必填约束</span>
        <span class="token keyword">public</span> <span class="token keyword">bool</span> <span class="token function">Reque</span><span class="token punctuation">(</span><span class="token keyword">string</span> name<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token keyword">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment" spellcheck="true">/// &lt;summary></span>
        <span class="token comment" spellcheck="true">/// </span>
        <span class="token comment" spellcheck="true">/// &lt;/summary></span>
        <span class="token comment" spellcheck="true">/// &lt;param name="number">以三个数字开始&lt;/param></span>
        <span class="token comment" spellcheck="true">/// &lt;returns>&lt;/returns></span>
        <span class="token punctuation">[</span><span class="token function">HttpGet</span><span class="token punctuation">(</span><span class="token string">"{number:regex(^\\d{{3}}$)}"</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token comment" spellcheck="true">// 正则表达式约束</span>
        <span class="token keyword">public</span> <span class="token keyword">bool</span> <span class="token function">Number</span><span class="token punctuation">(</span><span class="token keyword">string</span> number<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token keyword">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>上面用到了自定义约束 MyRouteConstraint</p>
<pre class="line-numbers language-csharp"><code class="language-csharp"><span class="token keyword">namespace</span> RoutingDemo<span class="token punctuation">.</span>Constraints
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyRouteConstraint</span> <span class="token punctuation">:</span> IRouteConstraint
    <span class="token punctuation">{</span>
        <span class="token keyword">public</span> <span class="token keyword">bool</span> <span class="token function">Match</span><span class="token punctuation">(</span>HttpContext httpContext<span class="token punctuation">,</span> IRouter route<span class="token punctuation">,</span> <span class="token keyword">string</span> routeKey<span class="token punctuation">,</span> RouteValueDictionary values<span class="token punctuation">,</span> RouteDirection routeDirection<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>RouteDirection<span class="token punctuation">.</span>IncomingRequest <span class="token operator">==</span> routeDirection<span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                <span class="token keyword">var</span> v <span class="token operator">=</span> values<span class="token punctuation">[</span>routeKey<span class="token punctuation">]</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">.</span><span class="token function">TryParse</span><span class="token punctuation">(</span>v<span class="token punctuation">.</span><span class="token function">ToString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">out</span> <span class="token keyword">var</span> <span class="token keyword">value</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">{</span>
                    <span class="token keyword">return</span> <span class="token keyword">true</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> <span class="token keyword">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>注册 MyRouteConstraint</p>
<pre class="line-numbers language-csharp"><code class="language-csharp">services<span class="token punctuation">.</span><span class="token function">AddRouting</span><span class="token punctuation">(</span>options <span class="token operator">=</span><span class="token operator">></span>
<span class="token punctuation">{</span>
    options<span class="token punctuation">.</span>ConstraintMap<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token string">"MyRouteConstraint"</span><span class="token punctuation">,</span> <span class="token keyword">typeof</span><span class="token punctuation">(</span>MyRouteConstraint<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>让它生效之前，需要在中间件注册的位置注入 UseEndpoints，然后对 UseEndpoints 使用 MapControllers</p>
<pre class="line-numbers language-csharp"><code class="language-csharp">app<span class="token punctuation">.</span><span class="token function">UseEndpoints</span><span class="token punctuation">(</span>endpoints <span class="token operator">=</span><span class="token operator">></span>
<span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// 使用 RouteAttribute</span>
    endpoints<span class="token punctuation">.</span><span class="token function">MapControllers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>通过这样子的方式把 OrderController 的路由注入进来</p>
<p>启动程序，可以看到一共有五个接口</p>
<p><img src="https://cdn.jsdelivr.net/gh/shw2018/cdn@1.0/sakura/img/loader/orange.progress-bar-stripe-loader.svg" data-original="https://img2020.cnblogs.com/blog/1412316/202003/1412316-20200317001713757-1265321257.jpg" alt=""></p>
<p>第一个接口是我们实现的自定义约束，点击 try it out 后输入参数</p>
<p><img src="https://cdn.jsdelivr.net/gh/shw2018/cdn@1.0/sakura/img/loader/orange.progress-bar-stripe-loader.svg" data-original="https://img2020.cnblogs.com/blog/1412316/202003/1412316-20200317001729042-1464811470.jpg" alt=""></p>
<p>第二个接口约束最大为20</p>
<p>输入5，执行</p>
<p><img src="https://cdn.jsdelivr.net/gh/shw2018/cdn@1.0/sakura/img/loader/orange.progress-bar-stripe-loader.svg" data-original="https://img2020.cnblogs.com/blog/1412316/202003/1412316-20200317001738633-2115884875.jpg" alt=""></p>
<p>可以看到响应码是 200</p>
<p>输入25，执行</p>
<p><img src="https://cdn.jsdelivr.net/gh/shw2018/cdn@1.0/sakura/img/loader/orange.progress-bar-stripe-loader.svg" data-original="https://img2020.cnblogs.com/blog/1412316/202003/1412316-20200317001747690-246658702.jpg" alt=""></p>
<p>可以看到响应码是 404，也就说路由匹配失败了</p>
<p>第三个接口因为参数是必须的，所以没办法输入空值，有一个前端的验证</p>
<p>第四个接口以三个数字开始，输入 234，符合正则表达式，响应码 200</p>
<p>自定义约束实现了路由约束接口，它只有一个 Match 方法，这个方法传入了 Http 当前的 httpContext，route，routeKey</p>
<p>这个 routeKey 就是我们要验证的 key 值</p>
<p>后面两个参数 RouteValueDictionary 就是当前可以获取到的这个 routeKey 对应的传入的值是什么值，这样就可以验证我们传入的信息</p>
<p>routeDirection 这个枚举的作用是当前验证是用来验证 URL 请求进来，验证是否路由匹配，还是用来生成 URL，是进还是出的这样一个定义，在不同的场景下面可能响应的逻辑是不一样的</p>
<p>下面的逻辑是如果路由是进来的，也就是通过 URL 配置 action 的情况，就做一个判断，根据 routeKey 取到当前输入的这个值，然后判断它是否可以转成 long，这个其实模拟了类型验证，比如说 long 型验证的方式</p>
<pre class="line-numbers language-csharp"><code class="language-csharp"><span class="token keyword">namespace</span> RoutingDemo<span class="token punctuation">.</span>Constraints
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyRouteConstraint</span> <span class="token punctuation">:</span> IRouteConstraint
    <span class="token punctuation">{</span>
        <span class="token keyword">public</span> <span class="token keyword">bool</span> <span class="token function">Match</span><span class="token punctuation">(</span>HttpContext httpContext<span class="token punctuation">,</span> IRouter route<span class="token punctuation">,</span> <span class="token keyword">string</span> routeKey<span class="token punctuation">,</span> RouteValueDictionary values<span class="token punctuation">,</span> RouteDirection routeDirection<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>RouteDirection<span class="token punctuation">.</span>IncomingRequest <span class="token operator">==</span> routeDirection<span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                <span class="token keyword">var</span> v <span class="token operator">=</span> values<span class="token punctuation">[</span>routeKey<span class="token punctuation">]</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">.</span><span class="token function">TryParse</span><span class="token punctuation">(</span>v<span class="token punctuation">.</span><span class="token function">ToString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">out</span> <span class="token keyword">var</span> <span class="token keyword">value</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">{</span>
                    <span class="token keyword">return</span> <span class="token keyword">true</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> <span class="token keyword">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>RouteDirection</p>
<pre class="line-numbers language-csharp"><code class="language-csharp"><span class="token keyword">namespace</span> Microsoft<span class="token punctuation">.</span>AspNetCore<span class="token punctuation">.</span>Routing
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">enum</span> RouteDirection
    <span class="token punctuation">{</span>
        IncomingRequest <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span>
        UrlGeneration <span class="token operator">=</span> <span class="token number">1</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>接下来看一下约束是如何注入到我们系统里生效的</p>
<p>可以给我们的约束起一个名字 isLong，这个名字就是用来 Attribute 上面标识约束的</p>
<pre class="line-numbers language-csharp"><code class="language-csharp">services<span class="token punctuation">.</span><span class="token function">AddRouting</span><span class="token punctuation">(</span>options <span class="token operator">=</span><span class="token operator">></span>
<span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">//options.ConstraintMap.Add("MyRouteConstraint", typeof(MyRouteConstraint));</span>
    options<span class="token punctuation">.</span>ConstraintMap<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token string">"isLong"</span><span class="token punctuation">,</span> <span class="token keyword">typeof</span><span class="token punctuation">(</span>MyRouteConstraint<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>OrderController 里面也修改为 isLong</p>
<pre class="line-numbers language-csharp"><code class="language-csharp"><span class="token comment" spellcheck="true">/// &lt;summary></span>
<span class="token comment" spellcheck="true">/// </span>
<span class="token comment" spellcheck="true">/// &lt;/summary></span>
<span class="token comment" spellcheck="true">/// &lt;param name="id">必须可以转为long&lt;/param></span>
<span class="token comment" spellcheck="true">/// &lt;returns>&lt;/returns></span>
<span class="token comment" spellcheck="true">//[HttpGet("{id:MyRouteConstraint}")]// 这里使用了自定义的约束</span>
<span class="token punctuation">[</span><span class="token function">HttpGet</span><span class="token punctuation">(</span><span class="token string">"{id:isLong}"</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
<span class="token comment" spellcheck="true">//public bool OrderExist(object id)</span>
<span class="token keyword">public</span> <span class="token keyword">bool</span> <span class="token function">OrderExist</span><span class="token punctuation">(</span><span class="token punctuation">[</span>FromRoute<span class="token punctuation">]</span> <span class="token keyword">string</span> id<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>启动程序，输入34，返回响应码200，输入abc，返回响应码404，也就是自定义约束生效了</p>
<p>接下来讲一下链接生成的过程</p>
<pre class="line-numbers language-csharp"><code class="language-csharp"><span class="token comment" spellcheck="true">/// &lt;summary></span>
<span class="token comment" spellcheck="true">/// </span>
<span class="token comment" spellcheck="true">/// &lt;/summary></span>
<span class="token comment" spellcheck="true">/// &lt;param name="id">最大20&lt;/param></span>
<span class="token comment" spellcheck="true">/// &lt;param name="linkGenerator">&lt;/param></span>
<span class="token comment" spellcheck="true">/// &lt;returns>&lt;/returns></span>
<span class="token punctuation">[</span><span class="token function">HttpGet</span><span class="token punctuation">(</span><span class="token string">"{id:max(20)}"</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token comment" spellcheck="true">// 这里使用了 Max 的约束</span>
<span class="token comment" spellcheck="true">//public bool Max(long id)</span>
<span class="token keyword">public</span> <span class="token keyword">bool</span> <span class="token function">Max</span><span class="token punctuation">(</span><span class="token punctuation">[</span>FromRoute<span class="token punctuation">]</span><span class="token keyword">long</span> id<span class="token punctuation">,</span> <span class="token punctuation">[</span>FromServices<span class="token punctuation">]</span>LinkGenerator linkGenerator<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// 这两行就是分别获取完整 Uri 和 path 的代码</span>
    <span class="token comment" spellcheck="true">// 它还有不同的重载，可以根据需要传入不同的路由的值</span>
    <span class="token keyword">var</span> path <span class="token operator">=</span> linkGenerator<span class="token punctuation">.</span><span class="token function">GetPathByAction</span><span class="token punctuation">(</span>HttpContext<span class="token punctuation">,</span>
        action<span class="token punctuation">:</span> <span class="token string">"Reque"</span><span class="token punctuation">,</span>
        controller<span class="token punctuation">:</span> <span class="token string">"Order"</span><span class="token punctuation">,</span>
        values<span class="token punctuation">:</span> <span class="token keyword">new</span> <span class="token punctuation">{</span> name <span class="token operator">=</span> <span class="token string">"abc"</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// 因为下面对 name 有一个必填的约束，所以这里需要传值</span>

    <span class="token keyword">var</span> uri <span class="token operator">=</span> linkGenerator<span class="token punctuation">.</span><span class="token function">GetUriByAction</span><span class="token punctuation">(</span>HttpContext<span class="token punctuation">,</span>
        action<span class="token punctuation">:</span> <span class="token string">"Reque"</span><span class="token punctuation">,</span>
        controller<span class="token punctuation">:</span> <span class="token string">"Order"</span><span class="token punctuation">,</span>
        values<span class="token punctuation">:</span> <span class="token keyword">new</span> <span class="token punctuation">{</span> name <span class="token operator">=</span> <span class="token string">"abc"</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token keyword">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">/// &lt;summary></span>
<span class="token comment" spellcheck="true">/// </span>
<span class="token comment" spellcheck="true">/// &lt;/summary></span>
<span class="token comment" spellcheck="true">/// &lt;param name="ss">必填&lt;/param></span>
<span class="token comment" spellcheck="true">/// &lt;returns>&lt;/returns></span>
<span class="token punctuation">[</span><span class="token function">HttpGet</span><span class="token punctuation">(</span><span class="token string">"{name:required}"</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token comment" spellcheck="true">// 必填约束</span>
<span class="token keyword">public</span> <span class="token keyword">bool</span> <span class="token function">Reque</span><span class="token punctuation">(</span><span class="token keyword">string</span> name<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>启动程序，端点调试，输入1，点击执行，可以看到</p>
<p>path 的值为</p>
<pre><code>/api/Order/Reque/abc</code></pre><p>uri 的值为</p>
<pre><code>https://localhost:5001/api/Order/Reque/abc</code></pre><p>在定义 Controller 的时候，实际上还会做一些接口废弃的过程，通过 [Obsolete]</p>
<pre class="line-numbers language-csharp"><code class="language-csharp"><span class="token comment" spellcheck="true">/// &lt;summary></span>
<span class="token comment" spellcheck="true">/// </span>
<span class="token comment" spellcheck="true">/// &lt;/summary></span>
<span class="token comment" spellcheck="true">/// &lt;param name="ss">必填&lt;/param></span>
<span class="token comment" spellcheck="true">/// &lt;returns>&lt;/returns></span>
<span class="token punctuation">[</span><span class="token function">HttpGet</span><span class="token punctuation">(</span><span class="token string">"{name:required}"</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token comment" spellcheck="true">// 必填约束</span>
<span class="token punctuation">[</span>Obsolete<span class="token punctuation">]</span>
<span class="token keyword">public</span> <span class="token keyword">bool</span> <span class="token function">Reque</span><span class="token punctuation">(</span><span class="token keyword">string</span> name<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>我们不必直接删除我们的接口，它还可以正常工作，但是我们可以把它标记为已废弃，在 Swagger 上面会有体现</p>
<p><img src="https://cdn.jsdelivr.net/gh/shw2018/cdn@1.0/sakura/img/loader/orange.progress-bar-stripe-loader.svg" data-original="https://img2020.cnblogs.com/blog/1412316/202003/1412316-20200317233508400-149310093.jpg" alt=""></p>
<p>可以看到这个接口已经被标记为废弃的，但是它的调用还是可以工作的</p>
<p>总结一下</p>
<ol>
<li><p>Restful 不是必须的，只要约束好 Http 方法以及 URL 地址，还有 Http 响应码，响应的 Json 格式，这些约定只要适合团队的协作习惯就可以了，也就是说需要定义好 API 的表达契约</p>
</li>
<li><p>建议是把 API 都约束在特定的目录下面，与其他功能性页面进行隔离，比如说 /api /api 加版本号这样子的方式</p>
</li>
<li><p>在废弃 API 的过程中间，应该是间隔版本的方式废弃，也就是说先将即将废弃的 API 标记为已废弃，但是它还是可以工作，间隔几个版本之后将代码删除掉</p>
</li>
</ol>
<script>
        document.querySelectorAll('.github-emoji')
          .forEach(el => {
            if (!el.dataset.src) { return; }
            const img = document.createElement('img');
            img.style = 'display:none !important;';
            img.src = el.dataset.src;
            img.addEventListener('error', () => {
              img.remove();
              el.style.color = 'inherit';
              el.style.backgroundImage = 'none';
              el.style.background = 'none';
            });
            img.addEventListener('load', () => {
              img.remove();
            });
            document.body.appendChild(img);
          });
      </script>
            </div>
            <hr/>

            

    <div class="reprint" id="reprint-statement">
        
            <div class="reprint__author">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-user">
                        文章作者:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="https://www.zhengchaoqiang.com" rel="external nofollow noreferrer">Chaoqiang</a>
                </span>
            </div>
            <div class="reprint__type">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-link">
                        文章链接:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="https://www.zhengchaoqiang.com/2020/04/19/netcore-programing-and-practice/">https://www.zhengchaoqiang.com/2020/04/19/netcore-programing-and-practice/</a>
                </span>
            </div>
            <div class="reprint__notice">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-copyright">
                        版权声明:
                    </i>
                </span>
                <span class="reprint-info">
                    本博客所有文章除特別声明外，均采用
                    <a href="https://creativecommons.org/licenses/by/4.0/deed.zh" rel="external nofollow noreferrer" target="_blank">CC BY 4.0</a>
                    许可协议。转载请注明来源
                    <a href="https://www.zhengchaoqiang.com" target="_blank">Chaoqiang</a>
                    !
                </span>
            </div>
        
    </div>

    <script async defer>
      document.addEventListener("copy", function (e) {
        let toastHTML = '<span>复制成功，请遵循本文的转载规则</span><button class="btn-flat toast-action" onclick="navToReprintStatement()" style="font-size: smaller">查看</a>';
        M.toast({html: toastHTML})
      });

      function navToReprintStatement() {
        $("html, body").animate({scrollTop: $("#reprint-statement").offset().top - 80}, 800);
      }
    </script>



            <div class="tag_share" style="display: block;">
                <div class="post-meta__tag-list" style="display: inline-block;">
                    
                        <div class="article-tag">
                            
                                <a href="/tags/Net-Core/">
                                    <span class="chip bg-color">Net Core</span>
                                </a>
                            
                        </div>
                    
                </div>
                <div class="post_share" style="zoom: 80%; width: fit-content; display: inline-block; float: right; margin: -0.15rem 0;">
                    <link rel="stylesheet" type="text/css" href="/libs/share/css/share.min.css">

<div id="article-share">
    
    
    <div class="social-share" data-sites="twitter,facebook,google,qq,qzone,wechat,weibo,douban,linkedin" data-wechat-qrcode-helper="<p>微信扫一扫即可分享！</p>"></div>
    <script src="/libs/share/js/social-share.min.js"></script>
    

    

</div>

                </div>
            </div>
            
                <style>
    #reward {
        margin: 40px 0;
        text-align: center;
    }

    #reward .reward-link {
        font-size: 1.4rem;
        line-height: 38px;
    }

    #reward .btn-floating:hover {
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.2), 0 5px 15px rgba(0, 0, 0, 0.2);
    }

    #rewardModal {
        width: 320px;
        height: 350px;
    }

    #rewardModal .reward-title {
        margin: 15px auto;
        padding-bottom: 5px;
    }

    #rewardModal .modal-content {
        padding: 10px;
    }

    #rewardModal .close {
        position: absolute;
        right: 15px;
        top: 15px;
        color: rgba(0, 0, 0, 0.5);
        font-size: 1.3rem;
        line-height: 20px;
        cursor: pointer;
    }

    #rewardModal .close:hover {
        color: #ef5350;
        transform: scale(1.3);
        -moz-transform:scale(1.3);
        -webkit-transform:scale(1.3);
        -o-transform:scale(1.3);
    }

    #rewardModal .reward-tabs {
        margin: 0 auto;
        width: 210px;
    }

    .reward-tabs .tabs {
        height: 38px;
        margin: 10px auto;
        padding-left: 0;
    }

    .reward-content ul {
        padding-left: 0 !important;
    }

    .reward-tabs .tabs .tab {
        height: 38px;
        line-height: 38px;
    }

    .reward-tabs .tab a {
        color: #fff;
        background-color: #ccc;
    }

    .reward-tabs .tab a:hover {
        background-color: #ccc;
        color: #fff;
    }

    .reward-tabs .wechat-tab .active {
        color: #fff !important;
        background-color: #22AB38 !important;
    }

    .reward-tabs .alipay-tab .active {
        color: #fff !important;
        background-color: #019FE8 !important;
    }

    .reward-tabs .reward-img {
        width: 210px;
        height: 210px;
    }
</style>

<div id="reward">
    <a href="#rewardModal" class="reward-link modal-trigger btn-floating btn-medium waves-effect waves-light red">赏</a>

    <!-- Modal Structure -->
    <div id="rewardModal" class="modal">
        <div class="modal-content">
            <a class="close modal-close"><i class="fas fa-times"></i></a>
            <h4 class="reward-title">你要请我吃糖嘛!</h4>
            <div class="reward-content">
                <div class="reward-tabs">
                    <ul class="tabs row">
                        <li class="tab col s6 alipay-tab waves-effect waves-light"><a href="#alipay">支付宝</a></li>
                        <li class="tab col s6 wechat-tab waves-effect waves-light"><a href="#wechat">微 信</a></li>
                    </ul>
                    <div id="alipay">
                        <img src="" class="reward-img" alt="支付宝打赏二维码">
                    </div>
                    <div id="wechat">
                        <img src="/medias/reward/wechatpay.png" class="reward-img" alt="微信打赏二维码">
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    $(function () {
        $('.tabs').tabs();
    });
</script>
            
        </div>
    </div>

    

    

    

    

    
        <style>
    .valine-card {
        margin: 1.5rem auto;
    }

    .valine-card .card-content {
        padding: 20px 20px 5px 20px;
    }

    #vcomments textarea {
        box-sizing: border-box;
        background: url("/medias/comment_bg.png") 100% 100% no-repeat;
    }

    #vcomments p {
        margin: 2px 2px 10px;
        font-size: 1.05rem;
        line-height: 1.78rem;
    }

    #vcomments blockquote p {
        text-indent: 0.2rem;
    }

    #vcomments a {
        padding: 0 2px;
        color: #4cbf30;
        font-weight: 500;
        text-decoration: none;
    }

    #vcomments img {
        max-width: 100%;
        height: auto;
        cursor: pointer;
    }

    #vcomments ol li {
        list-style-type: decimal;
    }

    #vcomments ol,
    ul {
        display: block;
        padding-left: 2em;
        word-spacing: 0.05rem;
    }

    #vcomments ul li,
    ol li {
        display: list-item;
        line-height: 1.8rem;
        font-size: 1rem;
    }

    #vcomments ul li {
        list-style-type: disc;
    }

    #vcomments ul ul li {
        list-style-type: circle;
    }

    #vcomments table, th, td {
        padding: 12px 13px;
        border: 1px solid #dfe2e5;
    }

    #vcomments table, th, td {
        border: 0;
    }

    table tr:nth-child(2n), thead {
        background-color: #fafafa;
    }

    #vcomments table th {
        background-color: #f2f2f2;
        min-width: 80px;
    }

    #vcomments table td {
        min-width: 80px;
    }

    #vcomments h1 {
        font-size: 1.85rem;
        font-weight: bold;
        line-height: 2.2rem;
    }

    #vcomments h2 {
        font-size: 1.65rem;
        font-weight: bold;
        line-height: 1.9rem;
    }

    #vcomments h3 {
        font-size: 1.45rem;
        font-weight: bold;
        line-height: 1.7rem;
    }

    #vcomments h4 {
        font-size: 1.25rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    #vcomments h5 {
        font-size: 1.1rem;
        font-weight: bold;
        line-height: 1.4rem;
    }

    #vcomments h6 {
        font-size: 1rem;
        line-height: 1.3rem;
    }

    #vcomments p {
        font-size: 1rem;
        line-height: 1.5rem;
    }

    #vcomments hr {
        margin: 12px 0;
        border: 0;
        border-top: 1px solid #ccc;
    }

    #vcomments blockquote {
        margin: 15px 0;
        border-left: 5px solid #42b983;
        padding: 1rem 0.8rem 0.3rem 0.8rem;
        color: #666;
        background-color: rgba(66, 185, 131, .1);
    }

    #vcomments pre {
        font-family: monospace, monospace;
        padding: 1.2em;
        margin: .5em 0;
        background: #272822;
        overflow: auto;
        border-radius: 0.3em;
        tab-size: 4;
    }

    #vcomments code {
        font-family: monospace, monospace;
        padding: 1px 3px;
        font-size: 0.92rem;
        color: #e96900;
        background-color: #f8f8f8;
        border-radius: 2px;
    }

    #vcomments pre code {
        font-family: monospace, monospace;
        padding: 0;
        color: #e8eaf6;
        background-color: #272822;
    }

    #vcomments pre[class*="language-"] {
        padding: 1.2em;
        margin: .5em 0;
    }

    #vcomments code[class*="language-"],
    pre[class*="language-"] {
        color: #e8eaf6;
    }

    #vcomments [type="checkbox"]:not(:checked), [type="checkbox"]:checked {
        position: inherit;
        margin-left: -1.3rem;
        margin-right: 0.4rem;
        margin-top: -1px;
        vertical-align: middle;
        left: unset;
        visibility: visible;
    }

    #vcomments b,
    strong {
        font-weight: bold;
    }

    #vcomments dfn {
        font-style: italic;
    }

    #vcomments small {
        font-size: 85%;
    }

    #vcomments cite {
        font-style: normal;
    }

    #vcomments mark {
        background-color: #fcf8e3;
        padding: .2em;
    }

    #vcomments table, th, td {
        padding: 12px 13px;
        border: 1px solid #dfe2e5;
    }

    table tr:nth-child(2n), thead {
        background-color: #fafafa;
    }

    #vcomments table th {
        background-color: #f2f2f2;
        min-width: 80px;
    }

    #vcomments table td {
        min-width: 80px;
    }

    #vcomments [type="checkbox"]:not(:checked), [type="checkbox"]:checked {
        position: inherit;
        margin-left: -1.3rem;
        margin-right: 0.4rem;
        margin-top: -1px;
        vertical-align: middle;
        left: unset;
        visibility: visible;
    }
</style>

<div class="card valine-card" data-aos="fade-up">
    <div class="comment_headling" style="font-size: 20px; font-weight: 700; position: relative; left: 20px; top: 15px; padding-bottom: 5px;">
        <i class="fas fa-comments fa-fw" aria-hidden="true"></i>
        <span>评论</span>
    </div>
    <div id="vcomments" class="card-content" style="display: grid">
    </div>
</div>

<script src="/libs/valine/av-min.js"></script>
<script src="/libs/valine/Valine.min.js"></script>
<script>
    new Valine({
        el: '#vcomments',
        appId: 'n7QWLgVufdyFqbDlUDEznVhx-gzGzoHsz',
        appKey: 'YGPdAIijkOPzqgi0LlHI52ex',
        notify: 'true' === 'true',
        verify: 'true' === 'true',
        visitor: 'true' === 'true',
        avatar: 'mm',
        pageSize: '10',
        lang: 'zh-cn',
        placeholder: 'just go go'
    });
</script>

    

    

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge left-badge text-color">
                <i class="fas fa-chevron-left"></i>&nbsp;上一篇</div>
            <div class="card">
                <a href="/2020/05/02/netcore-programing-and-practice2/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/4.jpg" class="responsive-img" alt="NetCore 开发实战（2）——微服务实战">
                        
                        <span class="card-title">NetCore 开发实战（2）——微服务实战</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            26 | 工程结构概览：定义应用分层及依赖关系从这一节开始进入微服务实战部分
这一节主要探讨工程的结构和应用的分层
在应用的分层这里定义了四个层次：

领域模型层

基础设施层

应用层

共享层


可以通过代码来看一下
共享层一共建立三
                        
                    </div>
                    <div class="publish-info">
                        <span class="publish-date">
                            <i class="far fa-clock fa-fw icon-date"></i>2020-05-02
                        </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/NetCore-开发实战/" class="post-category">
                                    NetCore 开发实战
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/Net-Core/">
                        <span class="chip bg-color">Net Core</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge right-badge text-color">
                下一篇&nbsp;<i class="fas fa-chevron-right"></i>
            </div>
            <div class="card">
                <a href="/2020/04/06/dotnet-advanced-series-3-3-netcoresourcecode/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/12.jpg" class="responsive-img" alt="DotNet-Advanced-Series-3-3-NetCoreSourceCode">
                        
                        <span class="card-title">DotNet-Advanced-Series-3-3-NetCoreSourceCode</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            编译的目的debug版本的运行时，调试源码，一行不差。
.NET Core 源码编译https://github.com/dotnet 这是一个合并过后的仓库，包括四个项目：

coreclr
installer
libraries 
mo
                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="far fa-clock fa-fw icon-date"></i>2020-04-06
                            </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/Net-Core-Learning-Series/" class="post-category">
                                    .Net Core Learning Series
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/Net-Core/">
                        <span class="chip bg-color">Net Core</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
    </div>
</article>

</div>


<script>
    $('#articleContent').on('copy', function (e) {
        // IE8 or earlier browser is 'undefined'
        if (typeof window.getSelection === 'undefined') return;

        var selection = window.getSelection();
        // if the selection is short let's not annoy our users.
        if (('' + selection).length < Number.parseInt('120')) {
            return;
        }

        // create a div outside of the visible area and fill it with the selected text.
        var bodyElement = document.getElementsByTagName('body')[0];
        var newdiv = document.createElement('div');
        newdiv.style.position = 'absolute';
        newdiv.style.left = '-99999px';
        bodyElement.appendChild(newdiv);
        newdiv.appendChild(selection.getRangeAt(0).cloneContents());

        // we need a <pre> tag workaround.
        // otherwise the text inside "pre" loses all the line breaks!
        if (selection.getRangeAt(0).commonAncestorContainer.nodeName === 'PRE') {
            newdiv.innerHTML = "<pre>" + newdiv.innerHTML + "</pre>";
        }

        var url = document.location.href;
        newdiv.innerHTML += '<br />'
            + '来源: chaoqiang&#39;s Blog<br />'
            + '文章作者: chaoqiang<br />'
            + '文章链接: <a href="' + url + '">' + url + '</a><br />'
            + '本文章著作权归作者所有，任何形式的转载都请注明出处。';

        selection.selectAllChildren(newdiv);
        window.setTimeout(function () {bodyElement.removeChild(newdiv);}, 200);
    });
</script>


<!-- 代码块功能依赖 -->
<script type="text/javascript" src="/libs/codeBlock/codeBlockFuction.js"></script>

<!-- 代码语言 -->

<script type="text/javascript" src="/libs/codeBlock/codeLang.js"></script>


<!-- 代码块复制 -->

<script type="text/javascript" src="/libs/codeBlock/codeCopy.js"></script>


<!-- 代码块收缩 -->

<script type="text/javascript" src="/libs/codeBlock/codeShrink.js"></script>


<!-- 代码块折行 -->

<style type="text/css">
code[class*="language-"], pre[class*="language-"] { white-space: pre !important; }
</style>


    </div>
    <div id="toc-aside" class="expanded col l3 hide-on-med-and-down">
        <div class="toc-widget">
            <div class="toc-title"><i class="far fa-list-alt"></i>&nbsp;&nbsp;目录</div>
            <div id="toc-content"></div>
        </div>
    </div>
</div>

<!-- TOC 悬浮按钮. -->

<div id="floating-toc-btn" class="hide-on-med-and-down">
    <a class="btn-floating btn-large bg-color">
        <i class="fas fa-list-ul"></i>
    </a>
</div>


<script src="/libs/tocbot/tocbot.min.js"></script>
<script>
    $(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            collapseDepth: Number('0'),
            headingSelector: 'h2, h3, h4'
        });

        // modify the toc link href to support Chinese.
        let i = 0;
        let tocHeading = 'toc-heading-';
        $('#toc-content a').each(function () {
            $(this).attr('href', '#' + tocHeading + (++i));
        });

        // modify the heading title id to support Chinese.
        i = 0;
        $('#articleContent').children('h2, h3, h4').each(function () {
            $(this).attr('id', tocHeading + (++i));
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });

        
        /* 修复文章卡片 div 的宽度. */
        let fixPostCardWidth = function (srcId, targetId) {
            let srcDiv = $('#' + srcId);
            if (srcDiv.length === 0) {
                return;
            }

            let w = srcDiv.width();
            if (w >= 450) {
                w = w + 21;
            } else if (w >= 350 && w < 450) {
                w = w + 18;
            } else if (w >= 300 && w < 350) {
                w = w + 16;
            } else {
                w = w + 14;
            }
            $('#' + targetId).width(w);
        };

        // 切换TOC目录展开收缩的相关操作.
        const expandedClass = 'expanded';
        let $tocAside = $('#toc-aside');
        let $mainContent = $('#main-content');
        $('#floating-toc-btn .btn-floating').click(function () {
            if ($tocAside.hasClass(expandedClass)) {
                $tocAside.removeClass(expandedClass).hide();
                $mainContent.removeClass('l9');
            } else {
                $tocAside.addClass(expandedClass).show();
                $mainContent.addClass('l9');
            }
            fixPostCardWidth('artDetail', 'prenext-posts');
        });
        
    });
</script>

    

</main>



    <footer class="page-footer bg-color">
    <div class="container row center-align">
        <div class="col s12 m8 l8 copy-right">
            <span>
                <div>
                    <span style="color:#ffffff;">Copyright&copy; 2020 chaoqiang. All Rights Reserved</span>
                </div>
                
                <div style="width:500px;margin:0 auto; padding:0px 0;">
                    <a target="_blank" href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=32050702010849" style="display:inline-block;text-decoration:none;height:20px;line-height:20px;">
                        <img src="https://blog-icp-1257411902.cos.ap-shanghai.myqcloud.com/icp.png" style="float:left;"/>
                        <span style="float:left;height:20px;line-height:20px;margin: 0px 0px 0px 5px; color:#ffffff;">苏公网安备 32050702010849号 苏ICP备20017637号</span>
                    </a>
                    <!-- <span style="height:20px;line-height:20px;margin: 0px 0px 0px 5px; color:#ffffff;"> 苏ICP备20017637号</span> -->
                </div>
            </span>
            <span id="sitetime"></span>
        </div>

    
    </div>
</footer>

<div class="progress-bar"></div>

<script language=javascript>
    function siteTime() {
        window.setTimeout("siteTime()", 1000);
        var seconds = 1000;
        var minutes = seconds * 60;
        var hours = minutes * 60;
        var days = hours * 24;
        var years = days * 365;
        var today = new Date();
        var todayYear = today.getFullYear();
        var todayMonth = today.getMonth() + 1;
        var todayDate = today.getDate();
        var todayHour = today.getHours();
        var todayMinute = today.getMinutes();
        var todaySecond = today.getSeconds();

        /* Date.UTC() -- 返回date对象距世界标准时间(UTC)1970年1月1日午夜之间的毫秒数(时间戳)
        year - 作为date对象的年份，为4位年份值
        month - 0-11之间的整数，做为date对象的月份
        day - 1-31之间的整数，做为date对象的天数
        hours - 0(午夜24点)-23之间的整数，做为date对象的小时数
        minutes - 0-59之间的整数，做为date对象的分钟数
        seconds - 0-59之间的整数，做为date对象的秒数
        microseconds - 0-999之间的整数，做为date对象的毫秒数 */

        var t1 = Date.UTC(2019, 08, 10, 00, 00, 00); //北京时间2019-8-1 00:00:00
        var t2 = Date.UTC(todayYear, todayMonth, todayDate, todayHour, todayMinute, todaySecond);
        var diff = t2 - t1;
        var diffYears = Math.floor(diff / years);
        var diffDays = Math.floor((diff / days) - diffYears * 365);
        var diffHours = Math.floor((diff - (diffYears * 365 + diffDays) * days) / hours);
        var diffMinutes = Math.floor((diff - (diffYears * 365 + diffDays) * days - diffHours * hours) / minutes);
        var diffSeconds = Math.floor((diff - (diffYears * 365 + diffDays) * days - diffHours * hours - diffMinutes *
            minutes) / seconds);
        document.getElementById("sitetime").innerHTML = "本站已勉强运行 " + diffYears + " 年 " + diffDays + " 天 " + diffHours +
            " 小时 " + diffMinutes + " 分钟 " + diffSeconds + " 秒" ;
    } /*因为建站时间还没有一年，就将之注释掉了。需要的可以取消*/
    siteTime();
</script>






    <!-- 搜索遮罩框 -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fas fa-search"></i>&nbsp;&nbsp;搜索</span>
            <input type="search" id="searchInput" name="s" placeholder="请输入搜索的关键字"
                   class="search-input">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script src="/js/search.js"></script>
<script type="text/javascript">
$(function () {
    searchFunc("/" + "search.xml", 'searchInput', 'searchResult');
});
</script>
    <!-- 回到顶部按钮 -->
<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fas fa-arrow-up"></i>
    </a>
</div>


    <script src="/libs/materialize/materialize.min.js"></script>
    <script src="/libs/masonry/masonry.pkgd.min.js"></script>
    <script src="/libs/aos/aos.js"></script>
    <script src="/libs/scrollprogress/scrollProgress.min.js"></script>
    <script src="/libs/lightGallery/js/lightgallery-all.min.js"></script>
    <script src="/js/matery.js"></script>

    <!-- Global site tag (gtag.js) - Google Analytics -->


    <!-- Baidu Analytics -->

    <!-- Baidu Push -->

<script>
    (function () {
        var bp = document.createElement('script');
        var curProtocol = window.location.protocol.split(':')[0];
        if (curProtocol === 'https') {
            bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
        } else {
            bp.src = 'http://push.zhanzhang.baidu.com/push.js';
        }
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(bp, s);
    })();
</script>

    
    <script src="/libs/others/clicklove.js" async="async"></script>
    
    
    <script async src="/libs/others/busuanzi.pure.mini.js"></script>
    

    

    

    
    <script type="text/javascript" color="0,0,255"
        pointColor="0,0,255" opacity='0.7'
        zIndex="-1" count="99"
        src="/libs/background/canvas-nest.js"></script>
    

    

    
    
    
    <script src="/libs/instantpage/instantpage.js" type="module"></script>
    

     <!-- Chaoqiang shw2018 add 2019.08.28 -->
     <script type="text/javascript">
        var OriginTitile = document.title,
            st;
        document.addEventListener("visibilitychange", function () {
            document.hidden ? (document.title = "看不见我🙈~看不见我🙈~", clearTimeout(st)) : (document.title =
                "(๑•̀ㅂ•́) ✧被发现了～", st = setTimeout(function () {
                    document.title = OriginTitile
                }, 3e3))
        })
    </script>

    <!-- 鼠标点击烟花爆炸效果  Chaoqiang shw2018 add 2019.09.09 -->
    
        <canvas class="fireworks" style="position: fixed; left: 0; top: 0; z-index: 1; pointer-events: none;"></canvas>
        <script type="text/javascript" src="//cdn.bootcss.com/animejs/2.2.0/anime.min.js"></script>
        <script type="text/javascript" src="/js/fireworks.js"></script>
    

    <!-- 背景雪花飘落特效Chaoqiang shw2018 add 2019.09.10 -->
    

    <!-- 鼠标点击文字特效 Chaoqiang shw2018 add 2019.09.10-->
    
        <script src="/js/wenzi.js" type="text/javascript"></script>
    

    <!-- 背景雪花飘落特效 Chaoqiang shw2018 add 2019.09.10 -->
    

    <!-- 在线聊天工具  Chaoqiang shw2018 add 2019.09.11 -->
    

<script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"log":false,"model":{"jsonPath":"/live2dw/assets/wanko.model.json"},"display":{"position":"left","width":150,"height":200},"mobile":{"show":false},"react":{"opacity":0.7}});</script><script>
            window.imageLazyLoadSetting = {
                isSPA: false,
                preloadRatio: 1,
                processImages: null,
            };
        </script><script>window.addEventListener("load",function(){var t=/\.(gif|jpg|jpeg|tiff|png)$/i,r=/^data:image\/[a-z]+;base64,/;Array.prototype.slice.call(document.querySelectorAll("img[data-original]")).forEach(function(a){var e=a.parentNode;"A"===e.tagName&&(e.href.match(t)||e.href.match(r))&&(e.href=a.dataset.original)})});</script><script>!function(n){n.imageLazyLoadSetting.processImages=o;var e=n.imageLazyLoadSetting.isSPA,i=n.imageLazyLoadSetting.preloadRatio||1,r=Array.prototype.slice.call(document.querySelectorAll("img[data-original]"));function o(){e&&(r=Array.prototype.slice.call(document.querySelectorAll("img[data-original]")));for(var t,a=0;a<r.length;a++)0<=(t=(t=r[a]).getBoundingClientRect()).bottom&&0<=t.left&&t.top<=(n.innerHeight*i||document.documentElement.clientHeight*i)&&function(){var t,e,n,i,o=r[a];t=o,e=function(){r=r.filter(function(t){return o!==t})},n=new Image,i=t.getAttribute("data-original"),n.onload=function(){t.src=i,e&&e()},t.src!==i&&(n.src=i)}()}o(),n.addEventListener("scroll",function(){var t,e;t=o,e=n,clearTimeout(t.tId),t.tId=setTimeout(function(){t.call(e)},500)})}(this);</script></body>

</html>
